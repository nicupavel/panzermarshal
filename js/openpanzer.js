var unitType={none:-1,soft:0,hard:1,air:2,sea:3},unitTypeNames=["Soft","Hard","Air","Sea"],unitClass={none:0,infantry:1,tank:2,recon:3,antiTank:4,flak:5,fortification:6,groundTransport:7,artillery:8,airDefence:9,fighter:10,tacticalBomber:11,levelBomber:12,airTransport:13,submarine:14,destroyer:15,battleship:16,carrier:17,navalTransport:18,battleCruiser:19,cruiser:20,lightCruiser:21},unitClassNames="No Class;Infantry;Tank;Recon;Anti Tank;Flak;Fortification;Ground Transport;Artillery;Air Defence;Fighter Aircraft;Tactical Bomber;Level Bomber;Air Transport;Submarine;Destroyer;Battleship;Aircraft Carrier;Naval Transport;Battle Cruiser;Cruiser;Light Cruiser".split(";"),
unitEntrenchRate=[0,3,1,2,2,1,1,1,2,2,0,0,0,0,0,0,0,0,0,0,0,0],roadType={none:0,north:1,northeast:2,eastunused:4,southeast:8,south:16,southwest:32,westunused:64,northwest:128},direction={S:0,SSE:1,SE:2,ESE:3,E:4,ENE:5,NE:6,NNE:7,N:8,NNW:9,NW:10,WNW:11,W:12,WSW:13,SW:14,SSW:15},terrainType={Clear:0,City:1,Airfield:2,Forest:3,Bocage:4,Hill:5,Mountain:6,Sand:7,Swamp:8,Ocean:9,River:10,Fortification:11,Port:12,Stream:13,Escarpment:14,impassableRiver:15,Rough:16},terrainNames="Clear;City;Airfield;Forest;Bocage;Hill;Mountain;Sand;Swamp;Ocean;River;Fortification;Port;Stream;Escarpment;Impassable river;Rough".split(";"),
terrainEntrenchment=[0,3,0,2,2,1,2,0,0,0,0,4,1,0,0,0,2],terrainInitiative=[99,1,99,3,3,5,1,99,2,99,99,3,5,99,99,99,3,1],groundCondition={dry:0,frozen:1,mud:2},groundConditionNames=["Dry","Frozen","Mud"],groundFontEncoding=["6","8","7"],weatherCondition={fair:0,overcast:1,rain:2,snow:3},weatherConditionNames=["Fair","Overcast","Raining","Snowing"],weatherFontEncoding=["4","5","1","2"],playerSide={axis:0,allies:1},sideNames=["Axis","Allies"],movMethod={tracked:0,halfTracked:1,wheeled:2,leg:3,towed:4,
air:5,deepnaval:6,costal:7,allTerrainTracked:8,amphibious:9,naval:10,allTerrainLeg:11},movMethodNames="Tracked;Half Tracked;Wheeled;Leg;Towed;Air;Deep Naval;Costal;All Terrain;Amphibious;Naval;Mountain Leg".split(";"),outcomeNames={lose:"Defeat",victory:"Victory",tactical:"Tactical Victory",briliant:"Brilliant Victory"},embarkType={none:0,naval:1,airmobile:2,airborne:3},movTableDry=[[1,1,1,2,4,2,254,1,4,255,254,1,1,2,255,255,2,1],[1,1,1,2,254,2,254,1,4,255,254,1,1,2,255,255,2,1],[2,1,1,4,254,3,254,
3,254,255,254,2,1,4,255,255,2,1],[1,1,1,2,2,2,254,2,2,255,254,1,1,1,255,255,2,1],[1,1,1,1,1,1,254,1,255,255,254,1,1,254,255,255,1,1],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[255,255,255,255,255,255,255,255,255,1,255,255,1,255,255,255,255,255],[255,255,255,255,255,255,255,255,255,2,1,255,1,255,255,255,255,255],[1,1,1,2,3,3,254,2,254,255,254,1,1,1,255,255,3,1],[1,1,1,2,4,2,254,1,3,254,3,1,1,2,255,255,2,1],[255,255,255,255,255,255,255,255,255,1,255,255,1,255,255,255,255,255],[1,1,1,1,2,1,1,2,2,255,254,
1,1,1,255,255,1,1]],movTableFrozen=[[1,1,1,2,4,2,254,1,2,255,2,1,1,2,255,255,2,1],[1,1,1,2,254,3,254,1,2,255,2,1,1,2,255,255,3,1],[2,2,2,254,254,254,254,3,3,255,3,3,2,4,255,255,4,2],[1,1,1,2,2,2,254,2,1,255,2,1,1,1,255,255,2,1],[1,1,1,1,1,1,254,1,1,255,254,1,1,254,255,255,1,1],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[255,255,255,255,255,255,255,255,255,1,255,255,1,255,255,255,255,255],[255,255,255,255,255,255,255,255,255,2,255,255,1,255,255,255,255,255],[1,1,1,2,3,3,254,2,3,255,2,1,1,1,255,255,3,1],
[1,1,1,2,4,3,254,1,3,254,2,2,1,2,255,255,3,1],[255,255,255,255,255,255,255,255,255,1,255,255,1,255,255,255,255,255],[1,1,1,1,2,1,2,2,1,255,2,1,1,1,255,255,2,1]],movTableMud=[[2,1,1,2,4,3,254,1,254,255,254,2,1,2,255,255,3,2],[3,1,1,2,254,3,254,1,254,255,254,2,1,2,255,255,3,2],[4,2,2,254,254,254,254,3,254,255,254,4,2,4,255,255,254,2],[2,1,1,2,2,2,254,2,1,255,254,2,1,1,255,255,3,1],[2,1,1,1,1,2,254,1,255,255,254,21,1,254,255,255,2,2],[2,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[255,255,255,255,255,255,255,
255,255,1,255,255,1,255,255,255,255,255],[255,255,255,255,255,255,255,255,255,2,255,255,1,255,255,255,255,255],[2,1,1,2,3,3,254,2,3,255,255,2,1,1,255,255,4,2],[1,1,1,2,4,3,254,1,3,254,3,2,1,2,255,255,3,1],[255,255,255,255,255,255,255,255,255,1,255,255,1,255,255,255,255,255],[2,1,1,1,3,1,3,2,1,255,254,2,1,1,255,255,3,1]],movTable=movTableDry,directionToRadians=[Math.PI,5*Math.PI/6,3*Math.PI/4,2*Math.PI/3,Math.PI/2,Math.PI/3,Math.PI/4,Math.PI/6,0,11*Math.PI/6,7*Math.PI/4,5*Math.PI/3,3*Math.PI/2,4*Math.PI/
3,5*Math.PI/4,7*Math.PI/6],playerType={humanLocal:0,humanNetwork:1,aiLocal:2,aiServer:3,aiScripted:4},actionType={move:0,attack:1,resupply:2,reinforce:3,upgrade:4,buy:5,deploy:6,mount:7,umount:8,select:9,endturn:10,message:11,viewport:12},prestigeGains={flagCapture:50,objectiveCapture:150},scoreGains={coreUnit:-15,normalUnit:-5,objectivePerTurn:1E3,flagCapture:50,objectiveCapture:100,endTurn:-10,damage:10,casualty:-5,casualtyCore:-10,reinforce:-5,resupply:-10},uiSettings={airMode:!1,strategicZoom:!1,
strategicZoomLevel:1,mapZoom:!1,zoomLevel:1,uiScale:1,uiSize:840,uiSmallSize:470,hexGrid:!1,showGridTerrain:!1,muteUnitSounds:!1,deployMode:!1,markCombatUnits:!0,markOwnUnits:!1,markEnemyUnits:!1,markFOW:!1,noFOW:!1,quickAnimation:!1,hasTouch:!1,use3D:!1,useRetina:!1,allowZoom:!1,isAI:[0,0,0,0],shownEndTurnTip:!1,unitInfoVisibility:!1,lastCloudSave:[],showInfoToolTips:!0,showDetailInfoToolTips:!1,showHiddenVictoryHexes:!0},endGameType={moveCapture:"moveCapture",noTurnsLeft:"noTurnsLeft",noEnemyLeft:"noEnemyLeft"},
endGameLossText={moveCapture:"Enemy has captured all your objectives !<br>",noTurnsLeft:"You don't have any turns left !<br>",noEnemyLeft:"All your units had been destroyed !<br>"},leaderType={mechanizedVeteran:1,tankKiller:2,marksman:3,skilledInterceptor:4,tenaciousDefense:5,eliteReconVeteran:6,skilledAssault:7,aggressiveTankManeuver:8,aggressiveAttack:9,aggressiveManeuver:10,allWeatherCombat:11,alpineTraining:12,battlefieldIntelligence:13,bridging:14,combatSupport:15,determinedDefense:16,devastatingFire:17,
ferociousDefense:18,fireDiscipline:19,firstStrike:20,forestCamouflage:21,infiltrationTactics:22,influence:23,liberator:24,overwatch:25,overwhelmingAttack:26,reconMovement:27,resilience:28,shockTactics:29,skilledGroundAttack:30,skilledReconnaissance:31,streetFighter:32,superiorManeuver:33},difficultyType={historical:0,tactical:1,operational:2},difficultyModifiers={0:{startPrestige:0,turnPrestige:0,extraTurns:1,scoreCoef:1},1:{startPrestige:0.2,turnPrestige:0.1,extraTurns:1.2,scoreCoef:0.8},2:{startPrestige:0.5,
turnPrestige:0.25,extraTurns:1.5,scoreCoef:0.5}};function Cell(a,f){this.row=a;this.col=f}function extendedCell(a,f){Cell.call(this,a,f);this.cost=this.cout=this.cin=this.range=0;this.canPass=this.canMove=!1}extendedCell.prototype=new Cell;function pathCell(a){Cell.call(this,a.row,a.col);this.cost=1;this.prev=null;this.dist=Infinity}pathCell.prototype=new Cell;function movementResults(){this.isVisible=!1;this.surpriseCell=[];this.isVictorySide=-1;this.passedCells=[];this.isCapture=!1}
function combatResults(){this.defExpGained=this.atkExpGained=this.defSuppress=this.atkSuppress=this.losses=this.kills=0;this.defcanfire=!0;this.isRugged=this.isOverrun=this.defLeaderGain=this.atkLeaderGain=!1}function Supply(a,f,d,l){this.ammo=a;this.fuel=f;this.transportAmmo=d||0;this.transportFuel=l||0}function mouseInfo(a,f,d){this.x=a;this.y=f;this.rclick=d}function screenPos(a,f){this.x=a;this.y=f}function major_version(a){return a.split(".").slice(0,2).join(".")}
var UNIT_MAX_EXPERIENCE=600,UNIT_RETREAT_THRESHOLD=0.6,CURRENCY_MULTIPLIER=12,UPGRADE_PENALTY=1.2,OVERSTRENGTH_PENALTY=1.2,SCENARIO_START_PRESTIGE=2E3,PROTOTYPE_MIN_COST=200,DEBUG_CAMPAIGN=!1,DEBUG_AI_MOVES=!1,VERSION="3.2.11",MAJOR_VERSION=major_version(VERSION),NATIVE_PLATFORM="generic",NATIVE_PLATFORM="generic",DEBUG_CAMPAIGN=!1;function GameState(a){function f(a,g){if(isChromeApp()){if(g){var b={};b[a]=g;chrome.storage.local.get(function(a){});chrome.storage.local.set(b)}}else localStorage&&g&&localStorage.setItem(a,JSON.stringify(g))}function d(a,g,b,s){var k=null;if(isChromeApp())chrome.storage.local.get(a,function(k){chrome.runtime.lastError&&(k=null);m(g,b,a,k,s)});else return localStorage&&(k=localStorage.getItem(a)),m(g,b,a,JSON.parse(k),s)}function l(a){isChromeApp()?chrome.storage.local.remove(a):localStorage&&localStorage.removeItem(a)}
function n(g){var b=null;try{b=JSON.parse(g)}catch(s){return!1}if(!b||!b.hasOwnProperty("scenario"))return!1;a.cleanup();k(b.scenario,b.players,b.campaign,a.setupGameState.bind(a));return!0}function k(g,s,m,k){a.scenario=new Scenario(g.file);g.eqp&&(Equipment.name=g.eqp);Equipment.addPlayersEquipment(s,b.bind(null,g,s,m,k))}function b(p,b,s,m){if(!--Equipment.equipmentToLoad){for(var k=0;k<b.length;k++){var f=new Player;f.copy(b[k]);a.scenario.map.addPlayer(f)}a.scenario.copy(p);a.scenario.isLoaded=
!0;defined(s)?(p=s.id,s.hasOwnProperty("file")&&(p=Campaign.findCampaignByFile(s.file),0>p&&(p=s.id)),a.campaign=new Campaign(p,s.difficulty||0,g.bind(null,s,m))):(a.campaign=null,m())}}function g(g,b){var s=a.scenario.map;a.campaign.setScenarioById(g.scenario);var m=s.getPlayersByCountry(g.country)[0];s.restoreCoreUnitList(m,g.coreUnits);b()}function m(a,g,b,m,f){isChromeApp()?s[b]=m[b]:s[b]=m;if(Object.keys(s).length==f){b=s[r.scenario];m=s[r.players];var d=s[r.campaign],q=s[r.settings];if(void 0!==
q&&q){if(1==f)return x(q);x(q)}return void 0!==b&&void 0!==m&&(null!==b&&null!==m)&&b.file?k(b,m,d,a):g()}}function x(a){uiSettings.markOwnUnits=a.markOwnUnits;uiSettings.markEnemyUnits=a.markEnemyUnits;uiSettings.use3D=a.use3D;uiSettings.useRetina=a.useRetina;uiSettings.showGridTerrain=a.showGridTerrain;uiSettings.muteUnitSounds=a.muteUnitSounds;uiSettings.noFOW=a.noFOW;uiSettings.quickAnimation=a.quickAnimation;uiSettings.uiScale=a.uiScale;uiSettings.uiSize=a.uiSize;uiSettings.zoomLevel=a.zoomLevel;
uiSettings.shownEndTurnTip=a.shownEndTurnTip;uiSettings.showDetailInfoToolTips=a.showDetailInfoToolTips||!1;uiSettings.showHiddenVictoryHexes=a.showHiddenVictoryHexes||!1;uiSettings.lastCloudSave=[];if(a.hasOwnProperty("lastCloudSave"))for(var g=0;g<a.lastCloudSave.length;g++)uiSettings.lastCloudSave[g]=a.lastCloudSave[g];for(g=0;g<a.isAI.length;g++)uiSettings.isAI[g]=a.isAI[g]}function q(){var g=null;null!==a.campaign&&(g={id:a.campaign.id,file:a.campaign.file,scenario:a.campaign.getCurrentScenario().id,
country:a.campaign.country,difficulty:a.campaign.difficulty,coreUnits:a.getCampaignPlayer().getCoreUnitList()});return g}var r={scenario:"openpanzer-scenario-"+MAJOR_VERSION,players:"openpanzer-players-"+MAJOR_VERSION,settings:"openpanzer-settings-"+MAJOR_VERSION,campaign:"openpanzer-campaign-"+MAJOR_VERSION},s={};this.save=function(){f(r.scenario,a.scenario);f(r.players,a.scenario.map.getPlayers())};this.saveToCloud=function(a,g){var b=this.exportGameState(),s={description:game.scenario.name+"-"+
game.scenario.map.turn,"public":!0,files:{}},m=!0,k=a.value;if(""==k||"undefined"===typeof k)m=!1;s.files["openpanzer-save.json"]={};s.files["openpanzer-save.json"].content=b;b=new XMLHttpRequest;m?(a.value="Overwriting cloud save "+k+" ...",b.open("PATCH","https://api.github.com/gists/"+k,!0)):(a.value="Creating new cloud save ...",b.open("POST","https://api.github.com/gists",!0));b.setRequestHeader("Accept","application/vnd.github.raw");b.setRequestHeader("Content-Type","application/json");b.setRequestHeader("Authorization",
"bearer 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");b.onreadystatechange=function(){if(4==this.readyState){if(200<=this.status&&300>this.status||304==this.status){var b=JSON.parse(this.responseText);if(!b)return g("Bad response from server");a.value=b.id;return g(null,b.id)}a.value="";a.setAttribute("placeholder","Cannot create save !");return g("Cannot create save")}};b.send(JSON.stringify(s))};this.restore=function(a,g){d(r.settings,a,g,4);d(r.scenario,a,g,4);d(r.players,a,g,4);d(r.campaign,a,g,
4)};this.restoreFromString=function(a){return n(a)};this.restoreFromFile=function(a,g,b){var s=new FileReader;s.onloadend=function(){if(!n(this.result))return"function"===typeof b&&b(),!1;"function"===typeof g&&g()};s.readAsText(a);return!0};this.restoreFromCloud=function(a,g){var b=a.value;if(""==b||"undefined"===typeof b)return a.setAttribute("placeholder","No ID specified"),!1;var s=new XMLHttpRequest;a.value="Loading ...";s.open("GET","https://api.github.com/gists/"+b,!0);s.onreadystatechange=
function(){if(4==this.readyState)if(200<=this.status&&300>this.status||304==this.status){var s=JSON.parse(this.responseText);if(!s||!s.files.hasOwnProperty("openpanzer-save.json"))return a.value="",a.setAttribute("placeholder","Cannot parse reply !"),!1;if(!n(s.files["openpanzer-save.json"].content))return a.value="",a.setAttribute("placeholder","Cannot find game data in the save file"),!1;delete s;a.value=b;"function"===typeof g&&g()}else return a.value="",a.setAttribute("placeholder","Cannot load game !"),
!1};s.send();return!0};this.clear=function(){l(r.scenario);l(r.players);l(r.campaign)};this.saveCampaign=function(){f(r.campaign,q())};this.saveSettings=function(){f(r.settings,uiSettings)};this.restoreSettings=function(){d(r.settings,null,function(){},1)};this.exportGameState=function(){var g={},b={unit:null,airunit:null,terrain:0,road:0,owner:-1,flag:-1,isDeployment:-1,victorySide:-1,name:"",isMoveSel:!1,isAttackSel:!1};g.scenario=a.scenario;g.players=a.scenario.map.getPlayers();g.campaign=q();
return JSON.stringify(g,function(a,g){if("player"!==a||!this.hasOwnProperty("eqid")){if(g&&g.hasOwnProperty("terrain")&&g.hasOwnProperty("terrain")){var p=!0,s;for(s in b)if(!g.hasOwnProperty(s)||g[s]!==b[s]){p=!1;break}if(p)return{}}return g}})}};var CombatLog=function(a){a.log={};a.log.combat={};a.log.reinforce=[];a.log.leaders=[];a.log.resupply={};a.log.objectives=[];a.combatRound={};a.uniqueID=0;a.reset=function(){a.log={};a.log.combat={};a.log.reinforce=[];a.log.leaders=[];a.log.resupply={};a.log.objectives=[];a.combatRound={};a.uniqueID=0};a.addCombatStart=function(f,d,l){a.uniqueID++;a.combatRound[a.uniqueID]={attacker:{id:f.id,eqid:f.eqid,side:f.player.side,str:f.strength,xp:f.experience,entrench:f.entrenchment,pos:f.getPos(),isMounted:f.isMounted,
isSurprised:f.isSurprised},defender:{id:d.id,eqid:d.eqid,side:d.player.side,str:d.strength,xp:d.experience,entrench:d.entrenchment,pos:d.getPos(),isMounted:d.isMounted},turn:l};return a.uniqueID};a.addCombatEnd=function(f,d,l,n){c=a.combatRound[l];if("undefined"===typeof c)return!1;var k=c.attacker.id,b=c.defender.id,g=a.log.combat[k],m=a.log.combat[b];g&&"undefined"!==typeof g||(a.log.combat[k]=new a.combatUnitInfo,g=a.log.combat[k]);m&&"undefined"!==typeof m||(a.log.combat[b]=new a.combatUnitInfo,
m=a.log.combat[b]);g.id=k;g.eqid=+c.attacker.eqid;g.side=+c.attacker.side;g.losses+=+c.attacker.str-f.strength;g.str=+f.strength;g.xp+=+f.experience-c.attacker.xp;g.ammo=+f.ammo;g.entrenchLost+=+c.attacker.entrench-f.entrenchment;g.entrench=+f.entrenchment;g.pos=c.attacker.pos;g.isSurprised=c.attacker.isSurprised;g.isCore=f.isCore;g.isSupport=c.attacker.isSupport;n?g.supports++:g.assaults++;g.unitCombatList.push(b);m.id=b;m.eqid=+c.defender.eqid;m.side=+c.defender.side;m.losses+=+c.defender.str-d.strength;
m.str=+d.strength;m.xp+=+d.experience-c.defender.xp;m.ammo=+d.ammo;m.entrenchLost+=+c.defender.entrench-f.entrenchment;m.entrench=+d.entrenchment;m.pos=c.defender.pos;m.isCore=d.isCore;m.defends++;m.unitCombatList.push(k);g.kills=m.losses;m.kills=g.losses;m.unitCombatList.push(k);a.combatRound[l]={};delete a.combatRound[l];return!0};a.addReinforcement=function(f){if("undefined"!==typeof f.player&&null!==f.player){var d={};d.eqid=f.eqid;d.pos=f.getPos();d.side=f.player.side;a.log.reinforce.push(d)}};
a.addLeader=function(f){if("undefined"!==typeof f.player&&null!==f.player){var d={};d.id=f.id;d.eqid=f.eqid;d.isCore=f.isCore;d.pos=f.getPos();d.leader=f.leader;d.classLeader=Leaders.getUnitClassLeader(f);d.side=f.player.side;a.log.leaders.push(d)}};a.addResupply=function(f){var d=f.id;if(d&&"undefined"!==typeof d&&"undefined"!==typeof f.player&&null!==f.player){var l=a.log.resupply[d];l&&"undefined"!==typeof l||(a.log.resupply[d]=new a.unitEndTurnInfo,l=a.log.resupply[d]);l.eqid=f.eqid;l.ammo=f.ammo;
l.fuel=f.fuel;l.isCore=f.isCore;l.side=f.player.side}};a.addObjectiveCapture=function(f,d){var l={};l.pos=new Cell(f.row,f.col);l.side=d;a.log.objectives.push(l)};a.combatUnitInfo=function(){this.eqid=this.id=0;this.side=-1;this.ammo=this.entrench=this.entrenchLost=this.xp=this.kills=this.losses=this.str=0;this.pos=new Cell(0,0);this.supports=this.defends=this.assaults=0;this.isCore=this.isSurprised=this.isMounted=!1;this.unitCombatList=[]};a.unitEndTurnInfo=function(){this.eqid=0;this.fuel=this.ammo=
this.side=-1;this.isCore=!1};return a}(CombatLog||{});var Equipment=function(a){function f(f,k){var b=a.equipmentPath+a.name+"/"+(a.filePrefix+f+".json"),g=new XMLHttpRequest;l&&(g.onload=function(){4===g.readyState&&(200!==g.status&&0!==g.status||a.parseCountryEquipment(f,JSON.parse(g.responseText)),k())});g.open("GET",b,l);g.send(null);if(!l&&null!==g.responseText)return a.parseCountryEquipment(f,JSON.parse(g.responseText))}function d(f,k){var b=1;k&&(b=-1);return function(g,m){return a.equipment[g][f]<a.equipment[m][f]?-1*b:a.equipment[g][f]>a.equipment[m][f]?
1*b:(g-m)*b}}a.equipment={};a.equipmentIndexes={};a.equipmentPath="resources/equipment/";a.filePrefix="equipment-country-";a.defaultName="eqp-adlerkorps";a.name=a.defaultName;a.equipmentToLoadSet={};a.equipmentToLoad=0;a.countryNames={"eqp-adlerkorps":"Slovakia;Belgium;Bulgaria;Czechoslovakia;Denmark;Finland;France;Germany;Greece;USA;Hungary;Turkey;Italy;Netherlands;Norway;Poland;Portugal;Romania;Croatia;Russia;Sweden;Allied Yugoslavia;United Kingdom;Yugoslavia;Nationalist Spain;Republican Spain;Australia;Canada;Ethiopia;New Zealand;South Africa".split(";"),
"eqp-pacific":"New Zealand;Panzerzug;India;Australia;Hungary;Japan;France;Germany;Bulgaria;U.S. Army;Canada;Turkey;Italy;Romania;Thailand;Nationalist Chinese;Philippines;Netherlands;Afrika Korps;Russia;Poland;Communist Chinese;United Kingdom;Mongolia;Manchukuo;U.S. Marines;Republican;Allied Forces;Captured Equipment;Axis Forces;Arab Countries".split(";")};var l=!0;a.getCountryName=function(f){return a.countryNames[a.name][f]};a.getCountryNameByEqp=function(f,k){return a.countryNames[k][f]};a.resetEquipment=
function(){a.equipment={};a.equipmentIndexes={};a.equipmentToLoadSet={};a.equipmentToLoad=0};a.addPlayersEquipment=function(f,k){a.resetEquipment();a.equipmentToLoadSet[-1]=!0;for(var b=0;b<f.length;b++){var g=f[b];a.equipmentToLoadSet[g.country]=!0;for(var m=0;m<g.supportCountries.length;m++){var d=g.supportCountries[m];0<d&&(a.equipmentToLoadSet[d-1]=!0)}}a.equipmentToLoad=Object.keys(a.equipmentToLoadSet).length;for(var q in a.equipmentToLoadSet)a.addCountryEquipment(+q,k)};a.addCountryEquipment=
function(a,k){f(a+1,k)};a.parseCountryEquipment=function(f,k){a.equipmentIndexes[f]=k.indexes;for(var b in k.units){a.equipment[b]={gunrange:0,icon:0,yearexpired:0,cost:0,initiative:0,spotrange:0,hardatk:0,softatk:0,uclass:0,airdef:0,fuel:0,airseaweight:0,rangedefmod:0,airatk:0,groundweight:0,movmethod:0,navalatk:0,movpoints:0,grounddef:0,target:0,yearavailable:0,name:0,country:0,closedef:0,ammo:0,attr:0};a.equipment[b].__proto__=null;for(var g=0;g<k.parsehints.length;g++)a.equipment[b][k.parsehints[g]]=
k.units[b][g]}delete k.parsehints;delete k.indexes;delete k.units;return!0};a.getCountryEquipmentByClass=function(f,k,b,g){var m=[];"undefined"!==typeof a.equipmentIndexes[k]&&(a.equipmentIndexes[k].hasOwnProperty("unitclass")&&(m=a.equipmentIndexes[k].unitclass[f]),b&&m.sort(d(b,g)));return m};a.getCountryEquipmentByYearRange=function(f,k,b){var g=[],m,d=0;if("undefined"===typeof a.equipmentIndexes[b])return g;for(d in a.equipment)m=a.equipment[d],m.country==b&&(m.yearavailable>=f&&m.yearavailable<=
k)&&g.push(+d);return g};a.addUnitsToEquipment=function(a){};a.isBridge=function(f){return"undefined"===typeof a.equipment[f]?!1:0!=(a.equipment[f].attr&8)?!0:!1};a.ignoresEntrenchment=function(f){return"undefined"===typeof a.equipment[f]?!1:0!=(a.equipment[f].attr&4)?!0:!1};a.isPurchasable=function(f){return"undefined"===typeof a.equipment[f]?!1:0!=(a.equipment[f].attr&262144)?!0:!1};a.canInitiateAttackOnUnitType=function(f,k){if(!defined(a.equipment[f])||!defined(a.equipment[k]))return!1;var b=
a.equipment[f].uclass,g=a.equipment[k].target;return a.equipment[k].uclass==unitClass.submarine&&b!=unitClass.destroyer&&b!=unitClass.tacticalBomber||g==unitType.soft&&0!=(a.equipment[f].attr&16)||g==unitType.hard&&0!=(a.equipment[f].attr&32)||g==unitType.air&&(0!=(a.equipment[f].attr&64)||b!=unitClass.airDefence&&b!=unitClass.fighter&&b!=unitClass.levelBomber&&b!=unitClass.tacticalBomber&&b!=unitClass.battleship&&b!=unitClass.battleCruiser&&b!=unitClass.lightCruiser&&b!=unitClass.airTransport&&0==
(a.equipment[f].attr&32768))?!1:!0};return a}(Equipment||{});function defined(a){return"undefined"!==typeof a&&null!==a}function $(a){return document.getElementById(a)}function $$(a,f){1==arguments.length&&(f=a,a=document);a||(a=document);return a.querySelector(f)}function addTag(a,f){var d,l=document.createElement(f);d="string"===typeof a?$(a):a;null!==d&&d.appendChild(l);return l}function insertTag(a,f,d){f=document.createElement(f);a="string"===typeof a?$(a):a;d="string"===typeof d?$(d):d;null!==a&&a.insertBefore(f,d);return f}
function delTag(a){a&&a.parentNode&&a.parentNode.removeChild(a)}function clearTag(a){for(a="string"===typeof a?$(a):a;a&&a.hasChildNodes();)a.removeChild(a.lastChild)}function clearStyle(a,f){var d;d="string"===typeof a?$(a):a;defined(f)?d.style.removeProperty(f):d.removeAttribute("style")}function insertTemplate(a,f){for(var d=$$("#"+a),l=0;l<d.children.length;l++)f.appendChild(d.children[l].cloneNode(!0))}
function getPosition(a){var f={};isVisible(a)?f=$(a).getBoundingClientRect():(makeVisible(a),f=$(a).getBoundingClientRect(),makeHidden(a));return f}function getCoordinates(a){a=a.getBoundingClientRect();var f=document.body.getBoundingClientRect();return{x:a.left-f.left+window.scrollX,y:a.top-f.top+window.scrollY}}function addSelectOption(a,f,d,l){if(void 0===l||null===l)l=!1;a=addTag(a,"option");a.value=d;a.textContent=f;a.selected=l}
function setSelectOption(a,f){for(var d=a.options,l=0;l<d.length;l++)if(d[l].selected=!1,f.trim()===d[l].text.trim())return d[l].selected=!0,a.onchange(),!0;return!1}function hasTouch(){return"ontouchstart"in window}function isChromeApp(){return window.chrome&&chrome.app&&chrome.app.runtime}function toggleRightClick(a){window.oncontextmenu=function(){return a}}
function hasBrokenScroll(){var a=navigator.userAgent;return a.match(/android 2/i)&&a.match(/applewebkit/i)||a.match(/android 4/i)&&a.match(/chrome/i)&&a.match(/applewebkit/i)?!0:!1}function hasBrokenClearRect(){var a=navigator.userAgent;return a.match(/android 4/i)&&!a.match(/chrome/i)?!0:!1}function hoverin(a){if(a&&"undefined"!==typeof a){var f=a.src.substring(0,a.src.lastIndexOf("/")+1);a.src=f+a.id+"-over.png"}}
function hoverout(a){if(a&&"undefined"!==typeof a){var f=a.src.substring(0,a.src.lastIndexOf("/")+1);a.src=f+a.id+".png"}}function toggleButton(a,f){if(!a)return!1;var d=a.innerHTML;f?(a.setAttribute("selected","on"),a.hasSelectedGlyph&&(a.innerHTML=d.toUpperCase())):(a.removeAttribute("selected"),a.hasSelectedGlyph&&(a.innerHTML=d.toLowerCase()));return!0}function toggleButtonWithImage(a,f){var d;d=a&&"undefined"!==typeof a.firstChild?a.firstChild:a;f?hoverin(d):hoverout(d)}
function toggleCheckbox(a){if(!a)return!1;var f=a.innerHTML;f===f.toUpperCase()?a.innerHTML=f.toLowerCase():a.innerHTML=f.toUpperCase();return!0}function toggleCheckboxWithImage(a){if(a&&a.src){var f=a.src.substring(0,a.src.lastIndexOf("/")+1),d=a.src.lastIndexOf("-checked"),d=-1<d?a.src.substring(a.src.lastIndexOf("/")+1,d):a.src.substring(a.src.lastIndexOf("/")+1,a.src.lastIndexOf("."))+"-checked";a.src=f+d+".png"}}function isVisible(a){a=$(a).style.display;return""!=a&&"none"!=a?!0:!1}
function makeVisible(a){$(a).style.display="inline";$(a).focus()}function makeHidden(a){$(a).style.display="none";$("game").focus()}
function bounceText(a,f,d,l){var n=addTag("game","div"),k=addTag(n,"div");n.style.cssText="position:absolute; top:"+f+"px; left:"+a+"px; z-index:200;";1!=+uiSettings.uiScale&&(a="scale("+uiSettings.uiScale+","+uiSettings.uiScale+")",n.style.webkitTransformOrigin="50% 50%",n.style.mozTransformOrigin="50% 50%",n.style.transformOrigin="50% 50%",n.style.webkitTransform=a,n.style.MozTransform=a,n.style.transform=a);k.addEventListener("animationend",function(){delTag(this.parentNode)},!1);k.addEventListener("webkitAnimationEnd",
function(){delTag(this.parentNode)},!1);k.className=l?"textBounceGreen":"textBounceRed";k.innerHTML=d}
function touchScroll(a){var f=0,d=0;$(a).addEventListener("touchstart",function(a){f=this.scrollTop+a.touches[0].pageY;d=this.scrollLeft+a.touches[0].pageX},!1);$(a).addEventListener("touchmove",function(a){(this.scrollTop<this.scrollHeight-this.offsetHeight&&this.scrollTop+a.touches[0].pageY<f-5||0!=this.scrollTop&&this.scrollTop+a.touches[0].pageY>f+5)&&a.preventDefault();(this.scrollLeft<this.scrollWidth-this.offsetWidth&&this.scrollLeft+a.touches[0].pageX<d-5||0!=this.scrollLeft&&this.scrollLeft+
a.touches[0].pageX>d+5)&&a.preventDefault();this.scrollTop=f-a.touches[0].pageY;this.scrollLeft=d-a.touches[0].pageX},!1)}function addStyleSheet(a){var f=document.createElement("link");f.setAttribute("rel","stylesheet");f.setAttribute("type","text/css");f.setAttribute("href","css/"+a);if(!f||"undefined"===typeof f)return!1;document.getElementsByTagName("head")[0].appendChild(f);return!0}
function getStyleSheet(a){for(var f=0;f<document.styleSheets.length;f++)for(var d=document.styleSheets[f].cssRules,l=0;l<d.length;l++)if(defined(d[l].styleSheet))for(var n=0;n<d[l].styleSheet.cssRules.length;n++){var k=d[l].styleSheet.cssRules[n];if(k.selectorText===a)return k.style}else if(d[l].selectorText===a)return d[l].style}function isDesktop(){try{nw.Window.get()}catch(a){return!1}return!0}
function changeViewPort(){var a,f=null,d=1,l=1,n="width=device-width, ",k=window.devicePixelRatio||1,b=document.getElementsByTagName("meta");(new GameState(null)).restoreSettings();for(a=0;a<b.length;a++)"viewport"==b[a].name&&(f=b[a]);null===f&&(f=addTag(document.getElementsByTagName("head")[0],"meta"),f.id="viewport",f.name="viewport");navigator.userAgent.match(/(iPhone|iPod)/i)&&(n="",1==k&&(k=2));1<k&&2>k&&(k=2);uiSettings.useRetina&&(l=d=1/k);f.content=n+"initial-scale="+d+",maximum-scale="+
l+" , user-scalable=1"}changeViewPort();function AIUnit(a){this.unit=a;this.didResupplyReinforce=this.didMove=this.didAttack=this.noResupply=this.noReinforce=this.noMove=this.noAttack=!1;this.newPosition=null}function EnemyUnit(a){this.unit=a;this.isAttacked=!1;this.losses=0;this.isKilled=!1}
function AI(a,f){function d(a,g){I.push({type:a,param:g})}function l(a){var g=a.unit;if(!GameRules.canReinforce(f.map,g)||(a.didResupplyReinforce||a.didAttack||a.didMove)||g.unitData().uclass==unitClass.fortification||0>=F)return a.noReinforce=!0,!1;if(a.noAttack&&a.noMove||g.strength<Q){var b=GameRules.calculateUnitCostPerStrength(g),p=GameRules.getReinforceValue(f.map,g),s=F/b>>0;s>p&&(s=p);if(0<p&&0<s)return d(actionType.reinforce,[g]),F-=s*b,a.didResupplyReinforce=!0}a.noAttack&&a.noMove&&(a.noReinforce=
!0);return!1}function n(a){var p=a.unit;if(a.didMove||a.didResupplyReinforce||!p)return a.noMove=!0,!1;var s=GameRules.getMoveRange(f,p);if(!s||0==s.length)return a.noMove=!0,!1;var k=p.getPos();k.canMove=!0;var q=g(p,k);if(GameRules.isGround(p))var y=m(k),q=q+y.score;for(var q=q+p.entrenchment*z,y=b(p,k),q=q+y,k=null,l=0,r=0;r<s.length;r++)y=m(s[r]),GameRules.isAir(p)&&(y.score*=0.3),GameRules.isSea(p)&&(y.score=0),l=g(p,s[r])+y.score,-2E3>l||(y=b(p,s[r]),l+=y,l>q&&(k=s[r],q=l));if(null!==k){var s=
k,q=p.getPos(),D;J.push(s);0<=(D=x(s))&&L.splice(D,1);L.push(q);d(actionType.move,[p,k]);a.didMove=!0;a.newPosition=k;return!0}a.noMove=!0;return!1}function k(a,g,p){var b=0,s=0;g=f.map[g.row][g.col].getAttackableUnit(a,!1);var m=g.getHex();if(g&&GameRules.canInitiateAttack(a,g)){if("undefined"!==typeof y[g.id]&&null!==y[g.id]){s=y[g.id];if(s.isKilled)return p?{score:0,kills:0}:{score:C,kills:0};s.isAttacked&&(b+=100)}var k=GameRules.calculateCombatResults(a,g,f.getUnits(),!0,!0),b=b+(k.kills*O[g.unitData().uclass]-
k.losses*A[a.unitData().uclass]),s=k.kills;if(k.losses>=a.strength||a.strength/k.losses<H)return p?{score:b,kills:k.kills}:{score:C,kills:k.kills};-1!==m.victorySide&&(b+=350);m.isSpotted(a.player.side)||(b*=B)}return{score:b*W[q(0,7)],kills:s}}function b(a,g){var p=0,b=0,s=a.getHex();a.setHex(f.map[g.row][g.col]);for(var m=GameRules.getUnitAttackCells(f.map,a,f.rows,f.cols),d=0;d<m.length;d++)p=k(a,m[d],!0),b+=p.score;a.setHex(s);return b}function g(g,p){var b=0,s=g.getHex(),m=g.unitData().uclass,
k=g.player.side,d=~k&1,l=!1,D;a:{for(D=0;D<J.length;D++)if(J[D].row==p.row&&J[D].col==p.col)break a;D=-1}if(0<=D)return-5E3;0<=x(p)&&(l=!0);if(!p.canMove&&!l)return-5E3;D=f.map[p.row][p.col];D.isSpotted(d)||(b-=40);D.isSpotted(k)||(b+=30);d=D.isDeployment;-1==D.victorySide&&(-1<d&&d==a.id)&&(b-=100);if(m==unitClass.fighter||m==unitClass.tacticalBomber||m==unitClass.levelBomber)return b*W[q(0,7)];GameRules.canEntrench(g)&&g.entrenchment<terrainEntrenchment[D.terrain]&&(b+=50);terrainInitiative[s.terrain]<
terrainInitiative[D.terrain]&&(b+=20);D.terrain!=terrainType.River&&D.terrain!=terrainType.Stream||D.road!=roadType.none||(b-=70);GameRules.isCloseCombatTerrain(D.terrain)&&(b=m==unitClass.infantry?b+120:m==unitClass.artillery||m==unitClass.antiTank||m==unitClass.airDefence?b+10:b-50);-1!=D.flag&&(D.flag!=g.player.country&&GameRules.isGround(g))&&(b+=50);(s=-1!=D.victorySide)&&!(s=null===D.unit)&&(l||(l=D.unit.id==g.id)||(l=null===D.unit?!0:"undefined"!==typeof y[D.unit.id]&&null!==y[D.unit.id]&&
y[D.unit.id].isKilled?!0:!1),s=l);s&&(s=f.getPlayer(D.owner).side==k,b=m==unitClass.artillery?b+50:m==unitClass.infantry?b+600:m==unitClass.tank?b+350:b+300);l=GameRules.getAdjacent(p.row,p.col);for(D=0;D<l.length;D++)0>l[D].row||0>l[D].col||(l[D].row>=f.rows-1||l[D].col>=f.cols-1)||(s=f.map[l[D].row][l[D].col],(d=s.getUnit())&&d.id!==g.id&&(!GameRules.isEnemy(g,d)&&0>x(l[D])?(b+=20,d.unitData().uclass==unitClass.artillery&&(b+=80)):b=m==unitClass.artillery?b-100:b+40),-1!=s.victorySide&&(s=f.getPlayer(s.owner).side==
k,b=m==unitClass.artillery||m==unitClass.flak?b+50:m==unitClass.infantry?s?b+70:b+100:s?b+50:b+70));return b*W[q(0,7)]}function m(a,g){var b=M;defined(g)&&!g&&(b=G);for(var p={cell:null,score:0},s=0;s<b.length;s++){var m=GameRules.distance(a.row,a.col,b[s].row,b[s].col);if(0<m)m=N/m,m>p.score&&(p.score=m,p.cell=b[s]);else return{cell:a,score:N+100}}p.score=Math.round(p.score);return p}function x(a){for(var g=0;g<L.length;g++)if(L[g].row==a.row&&L[g].col==a.col)return g;return-1}function q(a,g){return Math.floor(Math.random()*
(g-a+1)+a)}function r(g,b){for(var p=[],s=a.country+1,m=0,k=!1;0<g;){if(m>b.length-1){if(k)break;m=0}for(var k=Equipment.getCountryEquipmentByClass(b[m],s),f=k.length-1;0<=f;f--){var d=GameRules.calculateUnitCosts(k[f]);(d>g||d>X||d<S||Equipment.equipment[k[f]].movmethod==movMethod.deepnaval||Equipment.equipment[k[f]].yearavailable>game.scenario.date.getFullYear())&&k.splice(f,1)}0<k.length?(d=q(0,k.length-1),k=k[d],d=GameRules.calculateUnitCosts(k),g-=d,p.push(k),k=!1):k=!0;m++}return{prestige:g,
units:p}}var s=[],p=[],y={},I=[],J=[],L=[],G=[],M=[],F=a.prestige;this.buildActions=function(){F=a.prestige;var g=a.prestige;if(!(g<=T)){var g=g-T,b=g*P;300>b&&(b=0);for(var g=g-b,b=r(b,Y),g=r(g,v),m=b.units,q=m.length-1;0<=q;q--)a.buyUnit(m[q]);b.units=[];m=g.units;for(q=m.length-1;0<=q;q--)a.buyUnit(m[q]);g.units=[]}b=a.getCoreUnitList();g=f.getDeployHexes(a.side);for(h=0;h<g.length;h++)for(m=0;m<b.length;m++)b[m].isDeployed||(q=g[h],f.deployPlayerUnit(a,m,q.row,q.col));for(m=0;m<b.length;m++);
game.ui.handleReinforcementDeployment();s=f.getUnits();J=[];L=[];M=f.sidesVictoryHexes[a.side];G=f.sidesVictoryHexes[+!a.side];y={};p=[];for(b=0;b<s.length;b++)s[b].player.id==a.id&&(s[b].unitData().uclass==unitClass.artillery||s[b].unitData().uclass==unitClass.fortification||GameRules.isAir(s[b])&&s[b].unitData().uclass!=unitClass.airTransport||GameRules.isSea(s[b])&&s[b].unitData().uclass!=unitClass.navalTransport?p.unshift(new AIUnit(s[b])):p.push(new AIUnit(s[b])));for(b=null;0<p.length;){b=p[0];
l(b);g=b;m=g.unit;!GameRules.canResupply(f.map,m)||g.didResupplyReinforce||g.didAttack||g.didMove?g.noResupply=!0:g.noAttack&&g.noMove||m.ammo<U||GameRules.unitUsesFuel(m)&&m.fuel<E?(d(actionType.resupply,[m]),g.didResupplyReinforce=!0):g.noAttack&&g.noMove&&(g.noResupply=!0);n(b);g=b;m=g.unit;if(m.hasFired||g.didAttack||g.didResupplyReinforce)g.noAttack=!0;else{var q=null,x=void 0,I=void 0,R={},R=null,z=m.getHex(),D=null,D=z,x=-(w*A[m.unitData().uclass]),I=0;g.didMove&&null!==g.newPosition&&(D=f.map[g.newPosition.row][g.newPosition.col],
m.setHex(D));-1!=D.victorySide&&(x-=50);for(var D=GameRules.getUnitAttackCells(f.map,m,f.rows,f.cols),da=0;da<D.length;da++)R=k(m,D[da],!1),R.score>x&&(x=R.score,I=R.kills,R=f.map[D[da].row][D[da].col],q=R.getAttackableUnit(m,!1));g.didMove&&null!==z&&m.setHex(z);if(q){if(x=q)"undefined"===typeof y[x.id]&&(y[x.id]=new EnemyUnit(x)),y[x.id].isAttacked=!0,y[x.id].losses+=I,y[x.id].losses>x.strength&&(y[x.id].isKilled=!0);d(actionType.attack,[m,q]);g.didAttack=g.noResupplyReinforce=!0}else if(g.noMove||
g.didMove)g.noAttack=!0}b.noReinforce&&(b.noResupply&&b.noAttack&&b.noMove)&&p.shift()}};this.getAction=function(){if(0==I.length)return null;var a=I[0];I.splice(0,1);return a};var Q=4,U=2,E=5,N=4E3,w=4,z=50,H=2.5,C=-1E3,B=0.3,W=[0.8,0.85,0.9,0.95,1,1.1,1.15,1.2],T=1E3,P=0.3,X=900,S=120,Y=[unitClass.fighter,unitClass.tacticalBomber],v=[unitClass.infantry,unitClass.infantry,unitClass.artillery,unitClass.antiTank,unitClass.tank,unitClass.infantry,unitClass.tank],A=[0,5,5,10,10,5,10,40,20,10,5,30,30,
40,15,10,10,40,40,10,10,10],O=[0,50,25,30,10,10,5,150,150,10,50,100,100,150,50,50,50,100,150,50,50,50]};function AIScripted(a,f){function d(a,g){n.push({type:a,param:g})}function l(){switch(f.turn){case 1:if(a.side==playerSide.axis){d(actionType.message,["The objective of the game is to conquer all enemy positions marked by a golden frame and enemy flag. This is one of the positions. Moving one of your units into this position will capture this city and raise your flag over it.",{row:8,col:15}]);d(actionType.message,["This is the second primary objective since it has your enemy flag (Republican Spain) and a golden frame around. Capturing primary objectives gives you a good amount of points called prestige which can be used to upgrade or buy new troops.",
{row:16,col:8}]);d(actionType.message,["This is an optional objective with your enemy flag. Although capturing these  objectives won't count towards victory is good to do so for extra prestige and troops experience. Also troops are better reinforced or resupplied in a city.",{row:11,col:22}]);var b=k.axis.legioninf;d(actionType.select,[b]);d(actionType.message,["This is one of your units and usually represent a historical battalion, the number below is battalion size, usually named strength. Since you are playing as Axis the number is on a grey box. Your enemies (Allied Side) will have this number box in green.",
{row:4,col:2}]);d(actionType.message,["Units have several stats, click the <span class='smallButtonSubMenu'>i</span> button on the right menu to open a panel with unit stats on the bottom of the screen. Notice the movement range <span class='statsGlyph'>?</span> for this unit is 3. The grey hexes around this unit represent this movement range.",{row:4,col:2}]);d(actionType.message,["This unit has a transport, shown by the <span class='smallButtonSubMenu'>[</span> button on the bottom of the screen. While on transports moving range is increased but, except infantry, units become vulnerable to enemy fire. I will now mount and move this unit for you toward objective.",
{row:4,col:2}]);d(actionType.mount,[b]);d(actionType.select,[b]);d(actionType.move,[b,{row:7,col:9}]);b=k.axis.recon;d(actionType.select,[b]);d(actionType.message,["This is a recon unit. Recon units can move multiple times per turn and have bigger spotting range <span class='statsGlyph'>'</span> as the game will only show enemy units in the spotting range of your units. Let's check if there aren't any hidden units near the city.",{row:8,col:12}]);d(actionType.move,[b,{row:10,col:14}]);d(actionType.message,
["The objective is lightly defended by just one infantry unit. Let's move the rest of the units into fire range, destroy the defender and capture the city. When units move watch how the strength number color changes indicating that unit has moved.",{row:8,col:15}]);b=k.axis.pz2a;d(actionType.move,[b,{row:7,col:11}]);b=k.axis.ssinf1;d(actionType.mount,[b]);d(actionType.move,[b,{row:7,col:15}]);b=k.axis.ssinf2;d(actionType.mount,[b]);d(actionType.move,[b,{row:8,col:14}]);b=k.axis.ssinf3;d(actionType.mount,
[b]);d(actionType.move,[b,{row:9,col:14}]);b=k.axis.arty;d(actionType.mount,[b]);d(actionType.move,[b,{row:7,col:13}]);d(actionType.message,["As we moved all our units and no the targets are in fire range, we should end turn <span class='smallButtonSubMenu'>t</span>which will start enemy turn. If we don't capture all primary objectives in the maximum number of turns (shown left of the top bar) the scenario will end in defeat.",{row:7,col:13}])}else d(actionType.attack,[k.allies.inf1,k.axis.ssinf1]);
break;case 2:if(a.side==playerSide.axis){d(actionType.message,["Notice how this infantry unit jumped out of transport when attacked, instead of staying in the vulnerable transport. Only infantry units will do this others will not dismount when attached. All units are dismounted at the start of your turn.",{row:7,col:15}]);d(actionType.message,["This is an artillery unit, depending on it's fire range <span class='statsGlyph'>&gt;</span> it can fire on enemy positions from afar without suffering losses. Also each attack will soften enemy positions reducing their <span class='statsGlyph'>&quot;</span> entrenchment.",
{row:7,col:13}]);var b=k.axis.arty,g=k.allies.inf1;d(actionType.attack,[b,g]);d(actionType.message,["We inflicted losses to at least 1 company from the enemy battalion and reduced their entrenchment. Both attacker and defender received combat experience <span class='statsGlyph'>@</span> the later only a small amount since it hasn't inflicted any casualties.",{row:8,col:15}]);d(actionType.message,["Entrenchment <span class='statsGlyph'>&quot;</span> of a unit is important as it can avoid loses completely. It's a good idea to always check and reduce entrenchment with artillery or bombers before attacking in close combat. Entrenchment is automatically increased depending on terrain each turn when a unit doesn't move.",
{row:8,col:15}]);b=f.map[8][14].getUnit(!1);d(actionType.message,["Notice the small circle on the left of the unit strength box. The presence of this circle signifies that the unit hasn't fired yet and can do so. Some units like mounted artillery and mobile air defense can't move and fire in the same turn.",{row:8,col:14}]);d(actionType.attack,[b,g]);d(actionType.message,["Infantry units are usually good at defending cities, as they force attacker in close combat <span class='statsGlyph'>6</span> instead of normal ground combat defense <span class='statsGlyph'>5</span>. Other terrain types (shown right of the top bar) influence combat differently for each unit type.",
{row:8,col:15}]);b=f.map[9][14].getUnit(!1);d(actionType.attack,[b,g]);b=f.map[7][15].getUnit(!1);d(actionType.attack,[b,g]);d(actionType.message,["Since the unit defending the city was destroyed or retreated because of heavy casualties we can now move one of our units to capture this objective and get our prestige reward.",{row:8,col:15}]);b=f.map[7][11].getUnit(!1);d(actionType.move,[b,{row:8,col:15}]);d(actionType.message,["The city is now ours, and it's flag changed to your flag. This objective capture also increased your prestige by 150&nbsp;"+
UIBuilder.currencyIcon+". You can check prestige, score, remaining turns  and objectives by clicking anywhere on the top bar.",{row:8,col:15}]);d(actionType.attack,[b,g]);d(actionType.message,["This is the last remaining primary objective. Let's gamble and try capturing it without trying to spot enemy. Capturing objectives in early turns gives a better score.",{row:16,col:8}]);b=f.map[10][14].getUnit(!1);d(actionType.select,[b]);d(actionType.move,[b,{row:16,col:8}]);d(actionType.message,["Our unit was surprised by an enemy unit. This happens when you move a unit into an unspotted hex that's occupied by an enemy unit. Surprise attack reduces unit defense and attack values resulting in heavy casualties. Let move to the next turn.",
{row:15,col:10}]);d(actionType.select,[b])}break;case 3:a.side==playerSide.axis&&(u=f.map[15][10].getUnit(!1),d(actionType.select,[u]),d(actionType.message,["You can reinforce this unit casualties by clicking on the <span class='smallButtonSubMenu'>#</span> button at the bottom of the screen. Reinforcements costs prestige and the amount is reduced by enemy units adjacent to your unit. After reinforce unit can no longer attack or move.",{row:15,col:10}]),d(actionType.reinforce,[u]),u=f.map[7][15].getUnit(!1),
d(actionType.select,[u]),d(actionType.message,["Let's move the rest of the units towards the objective, note how terrain influence movement range. The longest move range is on road or clear terrain but it also depends on unit movement type shown with symbol <span class='statsGlyph' style='float:none;'>~</span>",{row:7,col:15}]),d(actionType.mount,[u]),d(actionType.move,[u,{row:14,col:11}]),u=f.map[8][14].getUnit(!1),d(actionType.mount,[u]),d(actionType.select,[u]),d(actionType.move,[u,{row:14,col:9}]),
u=f.map[9][14].getUnit(!1),d(actionType.mount,[u]),d(actionType.select,[u]),d(actionType.move,[u,{row:14,col:8}]),u=f.map[7][9].getUnit(!1),d(actionType.mount,[u]),d(actionType.select,[u]),d(actionType.move,[u,{row:11,col:9}]),u=f.map[7][13].getUnit(!1),d(actionType.mount,[u]),d(actionType.select,[u]),d(actionType.move,[u,{row:13,col:13}]),u=f.map[8][15].getUnit(!1),d(actionType.select,[u]),d(actionType.move,[u,{row:12,col:12}]));break;case 4:if(a.side==playerSide.axis){u=f.map[14][9].getUnit(!1);
d(actionType.select,[u]);d(actionType.message,["Let's attack the weakest enemy unit on the front line. The attack cursor gives an estimate of your casualties on the left and enemy casualties on the right below the flags of the units involved in combat.",{row:15,col:9}]);e=f.map[15][9].getUnit(!1);d(actionType.attack,[u,e]);d(actionType.message,["This artillery unit has automatically fired when we attacked. That's because artillery provides support fire to friendly units in their range if attacked. Other units with combat support include air defense and fighter planes when attacked by an enemy plane.",
{row:16,col:7}]);d(actionType.message,["Luckily our artillery unit has a bigger range than enemy artillery so we can safely move it into fire range without making us vulnerable to enemy fire while in transport.",{row:13,col:13}]);u=f.map[13][13].getUnit(!1);d(actionType.mount,[u]);d(actionType.move,[u,{row:14,col:12}]);d(actionType.message,["Armored units are considered hard targets <span class='statsGlyph'>`</span> and will take less casualties from artillery fire than a soft target like infantry or artillery. In some cases armored units are used to deplete the ammo of the defending artillery.",
{row:12,col:12}]);u=f.map[12][12].getUnit(!1);d(actionType.move,[u,{row:14,col:7}]);e=f.map[15][8].getUnit(!1);d(actionType.attack,[u,e]);if(u=f.map[15][10].getUnit(!1))u.fuel=0;d(actionType.select,[u]);d(actionType.message,["This unit it's out of fuel and it can no longer move.You can always supply ammo <span class='statsGlyph'></span> and fuel to your units by clicking on the <span class='smallButtonSubMenu'>!</span>   button on the bottom of the screen",{row:15,col:10}]);d(actionType.resupply,
[u]);game.ui&&game.ui.mainMenuButton("mainmenu");d(actionType.message,["This concludes the tutorial and gives you the control of the army to capture the last objective. Remember to use your prestige to upgrade or buy new units by clicking on the <span class='smallButtonSubMenu'>w</span>  button from the menu on the right side of the screen.",{row:16,col:8}]);d(actionType.message,["You should attack enemy artillery with your own artillery and move your tanks and attack the enemy artillery. There is a possibility that your armor attack will result in an OverRun which completely destroys an unit and allows your armor to continue move and attack.",
{row:16,col:8}]);d(actionType.message,["Remember to tap or click the <span class='smallButtonSubMenu'>t</span> end turn button twice to end your turns. Depending on scenario you or the enemy might also receive reinforcements. On this tutorial you will receive reinforcements next turn.",{row:16,col:8}])}break;default:0==a.side?(a.handler=null,a.type=playerType.humanLocal):(a.handler=new AI(a,game.scenario.map),a.type=playerType.aiLocal)}}var n=[],k={axis:{},allies:{}};k.axis.recon=f.map[8][12].getUnit(!1);
k.axis.legioninf=f.map[4][2].getUnit(!1);k.axis.pz2a=f.map[9][6].getUnit(!1);k.axis.ssinf1=f.map[8][6].getUnit(!1);k.axis.ssinf2=f.map[9][5].getUnit(!1);k.axis.ssinf3=f.map[9][4].getUnit(!1);k.axis.arty=f.map[8][4].getUnit(!1);k.allies.inf1=f.map[8][15].getUnit(!1);l();this.buildActions=function(){l();firstTurn=!1};this.getAction=function(){if(0==n.length)return null;var a=n[0];n.splice(0,1);return a}};var hexstyle={move:{fillColor:"rgba(120,100,100,0.5)",lineColor:"rgba(0,0,0,0.4)",lineWidth:1,lineJoin:"miter"},movespotted:{fillColor:"rgba(128,128,128,0.5)",lineColor:"rgba(0,0,0,0.4)",lineWidth:1,lineJoin:"miter"},attack:{fillColor:null,lineColor:"rgba(239, 0, 0,0.8)",lineWidth:3,lineJoin:"miter"},current:{fillColor:null,lineColor:"rgba(255, 240, 0, 0.8)",lineWidth:3,lineJoin:"round"},currentstroke:{fillColor:null,lineColor:"rgba(0, 0, 0, 0.9)",lineWidth:2,shadowOffsetX:1,shadowOffsetY:2,shadowColor:"black",
lineJoin:"round"},generic:{fillColor:null,lineColor:"rgba(39,44,47,0.9)",lineWidth:0.4,lineJoin:"miter"},deploy:{fillColor:"rgba(128,128,128,0.8)",lineColor:"rgba(0,0,0,0.4)",lineWidth:1,lineJoin:"miter"},ownunit:{fillColor:"rgba(30,144,255,0.3)",lineColor:"rgba(0,0,0,0.4)",lineWidth:0,lineJoin:"miter"},airunit:{fillColor:"rgba(30,144,255,0.3)",lineColor:"rgba(50, 110, 240,0.6)",lineWidth:2,lineJoin:"miter"},combat:{fillColor:"rgba(255, 255, 255,0.15)",lineColor:"rgba(239,0,0,0.7)",lineWidth:2,lineJoin:"miter"}},
unitstyle={axisBox:"#383838",alliedBox:"#808000",axisBorder:"rgba(211, 211, 211, 1)",alliedBorder:"rgba(127, 255, 0, 1)",enemyBoxMarked:"#FF0000",playerText:"white",alliedPlayerText:"#696969",movedUnitText:"#BDBDBD",terrainText:"#333333",terrainTextStroke:"#f8e064"},tooltipColor={player:0,enemy:1},tooltipStyle={text:0,pin:1},terrainencoding="ABCDDEFGHIJKLMNOQ".split("");var soundData={track:new soundSprite("resources/sounds/move/track.wav"),htrack:new soundSprite("resources/sounds/move/htrack.wav"),leg:new soundSprite("resources/sounds/move/leg.wav"),air:new soundSprite("resources/sounds/move/air.wav"),naval:new soundSprite("resources/sounds/move/naval.wav"),gun:new soundSprite("resources/sounds/fire/gun.wav"),smallgun:new soundSprite("resources/sounds/fire/smallgun.wav"),explosion:new soundSprite("resources/sounds/fire/explosion.wav"),dummy:new soundSprite("")},
moveSoundByMoveMethod="track htrack htrack leg leg air naval naval leg track naval leg".split(" ");function soundSprite(a){var f;try{f=new Audio(a),f.load()}catch(d){}this.play=function(){if(f&&!uiSettings.muteUnitSounds){try{f.currentTime=0}catch(a){}return f.play()}}};function AnimationChain(){var a=[],f=0;this.add=function(f){a.push(new Animation(f))};this.clear=function(){a=[];f=0};this.start=function(d){var l=this;f<a.length?(a[f].start(),setTimeout(function(){l.start(d)},a[f].getDuration()+500),f++):(null!==d&&"undefined"!==typeof d&&d.cbfunc(d),setTimeout(function(){l.clear()},100))}}
function Animation(a){function f(){l?a.ctx.clearRect(a.x,a.y,a.sprite.width,a.sprite.image.height):d(a,k-1,"destination-out");k>a.sprite.frames&&clearInterval(n);k<=a.sprite.frames&&d(a,k,"source-over");k++}function d(a,g,m){0>g||!a||(a.ctx.save(),a.ctx.globalCompositeOperation=m,a.ctx.translate(a.x+a.sprite.width/2,a.y+a.sprite.image.height/2),a.ctx.rotate(a.rotate),a.ctx.drawImage(a.sprite.image,a.sprite.width*g,0,a.sprite.width,a.sprite.image.height,-a.sprite.width/2,-a.sprite.image.height/2,a.sprite.width,
a.sprite.image.height),a.ctx.restore())}var l=!1,n,k=0;this.delay=uiSettings.quickAnimation?50:150;this.start=function(){a.sprite.sound.play();n=setInterval(f,this.delay)};this.getDuration=function(){return this.delay*a.sprite.frames}}
var animationsData={explosion:new animationSprite("resources/animations/explosions.png",12,120,"explosion"),gun:new animationSprite("resources/animations/fire-gun.png",5,150,"gun"),smallgun:new animationSprite("resources/animations/fire-smallgun.png",7,80,"smallgun")},attackAnimationByClass="none smallgun gun gun gun gun smallgun smallgun gun gun smallgun smallgun smallgun none gun gun gun none none gun gun gun".split(" ");
function animationSprite(a,f,d,l){this.image=new Image;this.image.src=a;this.width=d;this.frames=f-1;this.sound=l&&"undefined"!==typeof l?soundData[l]:soundData.dummy};var GameRules=function(a){function f(b,p,m,k,f){var d=m.unitData().uclass;b-=p;p=15;var q=0;4<b&&(b=4+(2*b-8)/5);Leaders.unitHasLeader(m,leaderType.overwhelmingAttack)&&(b+=2);Leaders.unitHasLeader(k,leaderType.resilience)&&(b-=2);if(d==unitClass.artillery||d==unitClass.levelBomber||d==unitClass.fortification||g(m)&&!g(k))p=19;if(f)q=b+21-p,1>q&&(q=1),19<q&&(q=19),q=(5*q*m.strength+50)/100;else for(k=0;k<m.strength;k++)f=a.rollDice(1,20),1<f&&20>f&&(f+=b),f>=p&&q++;Leaders.unitHasLeader(m,leaderType.overwhelmingAttack)&&
(q+=1);return Math.round(q)}function d(g,p){return null===g||g.destroyed||0>=g.getAmmo()||(null===p||p.destroyed)||!a.isEnemy(g,p)||b(p)&&0>=g.unitData().airatk?!1:!0}function l(a,p,k){a=a[k.row][k.col];return(m(p)||g(p))&&null===a.unit||b(p)&&null===a.airunit?!0:!1}function n(a,p,k){a=a[k.row][k.col];if(m(p)||g(p))if(null===a.unit||a.unit.player.side==p.player.side)return!0;return!b(p)||null!==a.airunit&&a.airunit.player.side!=p.player.side?!1:!0}function k(a,g){var b=g.getPos(),m=a[b.row][b.col];
if(null===m)return!1;if(m.terrain==terrainType.Airfield&&m.flag==g.player.country||null!==m.unit&&m.unit.unitData().uclass==unitClass.carrier&&m.unit.owner==g.player.id)return!0;var b=q(b.row,b.col),k;for(k in b){var m=b[k].row,f=b[k].col;if(!(0>m||!defined(a[m])||0>f||!defined(a[m][f])||a[m][f].terrain!=terrainType.Airfield||a[m][f].flag!=g.player.country))return!0}return!1}function b(a){return null===a?!1:a.unitData().movmethod==movMethod.air?!0:!1}function g(a){if(null===a)return!1;a=a.unitData();
return a.uclass>=unitClass.submarine&&a.uclass<=unitClass.lightCruiser?!0:!1}function m(a){return null===a?!1:a.unitData().uclass<=unitClass.airDefence?!0:!1}function x(a,g,b,m){return a-1+g%2==b&&g-1==m||a+g%2==b&&g-1==m||a-1==b&&g==m||a+1==b&&g==m||a-1+g%2==b&&g+1==m||a+g%2==b&&g+1==m?!0:!1}function q(a,g){var b=[];b.push(new Cell(1*a-1,g));b.push(new Cell(a-1+g%2,g-1));b.push(new Cell(1*a+g%2,g-1));b.push(new Cell(1*a+1,g));b.push(new Cell(1*a+g%2,1*g+1));b.push(new Cell(1*a-1+g%2,1*g+1));return b}
function r(g,b,m,k,f,d){var q=[],x=null;if(0>=m)return q;for(var l=g-m,r=g+m,n=l;n<=r;n++)0>n||(n>=k||n==g)||(d?(x=new extendedCell(n,b),x.range=Math.abs(g-n)):x=new Cell(n,b),q.push(x));for(var E=1;E<=m;E++)for(1==(b+E)%2?0<r&&r--:l<k&&l++,n=l;n<=r;n++)0>n||n>=k||(b+E<f&&(d?(x=new extendedCell(n,b+E),x.range=a.distance(g,b,n,b+E)):x=new Cell(n,b+E),q.push(x)),0<b-E&&(d?(x=new extendedCell(n,b-E),x.range=a.distance(g,b,n,b-E)):x=new Cell(n,b-E),q.push(x)));return q}a.getMoveRange=function(g,m){var k=
0,f=g.map,d=g.rows,q=g.cols,G=null,M=[];if(null===m||m.hasMoved)return[];for(var G=m.getPos(),F=m.unitData(),Q=a.getUnitMoveRange(m),F=movTable[F.movmethod],U=m.player.side,E=~U&1,N=a.isTrain(m),w=r(G.row,G.col,Q,d,q,!0),z=w.length-1;0<=z;z--){var H=!1;0==w[z].row&&0==w[z].col%2&&(H=!0);g.isLastColPartial&&w[z].col==q-1&&(H=!0);g.isLastRowPartial&&w[z].row==d-1&&1==w[z].col%2&&(H=!0);H&&w.splice(z,1)}if(b(m)){for(z=0;z<w.length;z++)if(G=f[w[z].row][w[z].col],!(G.isSpotted(U)||null!==G.airunit&&G.airunit.tempSpotted)||
l(f,m,w[z]))w[z].canMove=!0,w[z].cost=1,M.push(w[z]);return M}for(w.push(new extendedCell(G.row,G.col));k<=Q;){for(z=0;z<w.length;z++)if(w[z].range==k)for(d=0;d<w.length;d++)!(w[d].range<k)&&x(w[z].row,w[z].col,w[d].row,w[d].col)&&(G=f[w[d].row][w[d].col],!N&&G.road>roadType.none||a.isBridgeForSide(G,U)?w[d].cost=F[17]:w[d].cost=F[G.terrain],(G.isSpotted(U)||null!==G.unit&&G.unit.tempSpotted)&&(G.isZOC(E)&&254>w[d].cost)&&(w[d].cost=254),0==w[d].cin&&(w[d].cin=w[z].cout),0==w[d].cout&&(w[d].cout=
w[d].cin+w[d].cost),w[d].cin>w[z].cout&&254>=w[d].cost&&(w[d].cin=w[z].cout,w[d].cout=w[d].cin+w[d].cost),w[d].cout<=Q||254>=w[d].cost&&w[d].cin<=Q)&&(n(f,m,w[d])&&(w[d].canPass=!0),!(G.isSpotted(U)||null!==G.unit&&G.unit.tempSpotted)||l(f,m,w[d]))&&(w[d].canMove=!0);k++}for(z=0;z<w.length;z++)(w[z].canPass||w[z].canMove)&&M.push(w[z]);return M};a.getUnitMoveRange=function(g){var b=g.getMovesLeft(),m=g.unitData();a.unitUsesFuel(g)&&g.getFuel()<b&&(b=g.getFuel());Leaders.unitHasLeader(g,leaderType.aggressiveTankManeuver)&&
(b+=1);Leaders.unitHasLeader(g,leaderType.aggressiveManeuver)&&(b+=1);m.movmethod==movMethod.towed&&(null===g.transport&&0==b&&m.uclass!=unitClass.fortification)&&(b=1);return b};a.getUnitAttackCells=function(g,b,m,k){var f=[],d=null;if(null===b||b.hasFired||0>=b.getAmmo())return[];var q=b.getPos(),x=a.getUnitAttackRange(b);m=r(q.row,q.col,x,m,k,!1);m.push(new Cell(q.row,q.col));for(k=0;k<m.length;k++){var l=m[k],n=g[l.row][l.col];if(null!==n.getAttackableUnit(b,0))if(a.isAir(b)&&1>=x)q.row==l.row&&
q.col==l.col&&f.push(l);else{f.push(l);continue}null!==(d=n.getAttackableUnit(b,1))&&(a.isAir(b)?a.isAir(d)&&f.push(l):f.push(l))}return f};a.getUnitAttackRange=function(a){if(!a)return 0;var g=a.unitData().gunrange;0==g&&(g=1);Leaders.unitHasLeader(a,leaderType.marksman)&&(g+=1);return g};a.setZOCRange=function(a,g,m,k,f){if(g&&!b(g)){var d=g.getPos();if(d){g=g.player.side;var x,l=q(d.row,d.col),r;for(r in l)d=l[r].row,x=l[r].col,d>=k||0>d||x>=f||0>x||a[d][x].setZOC(g,m)}}};a.setSpotRange=function(g,
b,m,k,f){if(!b)return 0;var d=b.getPos();if(d){var q=b.player.side,x=a.getUnitSpotRange(b);b=0;k=r(d.row,d.col,x,k,f,!1);k.push(new Cell(d.row,d.col));for(x=0;x<k.length;x++){d=k[x].row;f=k[x].col;if(m&&!g[d][f].isSpotted(q)){var l=g[d][f].getUnit(!1);l&&l.player.side!=q&&(b++,l.tempSpotted=!0)}g[d][f].setSpotted(q,m)}return b}};a.getUnitSpotRange=function(a){if(!a)return 0;var g=a.unitData().spotrange;Leaders.unitHasLeader(a,leaderType.eliteReconVeteran)&&(g+=2);Leaders.unitHasLeader(a,leaderType.skilledReconnaissance)&&
(g+=1);return g};a.getShortestPath=function(a,g,b){var m=[],k=[],f=[],d=null,q=0,l=new pathCell(a);l.dist=0;l.prev=l;m.push(l);for(l=0;l<b.length;l++)d=new pathCell(b[l]),d.cost=b[l].cost,m.push(d);for(;0<m.length;){q=0;d=m[0];for(l=1;l<m.length;l++)Infinity!=m[l].dist&&m[l].dist<=d.dist&&(d=m[l],q=l);if(Infinity==d.dist)break;for(l=0;l<m.length;l++)x(d.row,d.col,m[l].row,m[l].col)&&(Infinity==m[l].dist||d.dist+d.cost<m[l].dist)&&(m[l].dist=d.dist+d.cost,m[l].prev=d);if(d.row==g.row&&d.col==g.col){for(g=
d;;){f.unshift(g);if(g.row==a.row&&g.col==a.col)break;if(null!==g.prev||"undefined"!==typeof g)g=g.prev;else break}return f}k.push(m[q]);m.splice(q,1)}return[]};a.calculateCombatResults=function(g,b,m,k,f){var d=[],q=0,l=0,x=0,r=0,n=g.player.side;g.isSurprised||(d=a.getSupportFireUnits(m,g,b));for(var E in d){var N=d[E].getHex();m=a.calculateAttackResults(d[E],g,f);if(N.isSpotted(n)||d[E].tempSpotted)x+=m.kills,r+=m.losses;q+=m.kills;l+=m.losses}m=a.calculateAttackResults(g,b,f);x+=m.losses;r+=m.kills;
q+=m.losses;l+=m.kills;k?(m.losses=q,m.kills=l):(m.losses=Math.min(x,g.strength),m.kills=Math.min(r,b.strength));return m};a.calculateAttackResults=function(k,p,q){var l=k.getPos(),x=p.getPos(),r=k.unitData(),n=p.unitData(),M=r.target,F=n.target,Q=k.getHex(),U=p.getHex(),E=k.experience/100>>0,N=p.experience/100>>0,w=0,z=0,H=0,C=0,B=new combatResults,l=a.distance(l.row,l.col,x.row,x.col),W=Q.terrain,T=U.terrain;b(k)&&(W=terrainType.Clear);b(p)&&(T=terrainType.Clear);p.isMounted&&(!p.isSurprised&&p.unitData(!0).uclass==
unitClass.infantry)&&(n=Equipment.equipment[p.eqid]);var x=a.isEntrenchmentIntact(k,p,T),P=a.isEntrenchmentIntact(p,k,W);switch(M){case unitType.air:H=n.airatk;C=n.airdef;break;case unitType.soft:H=n.softatk;C=n.grounddef;break;case unitType.hard:H=n.hardatk;C=n.grounddef;break;case unitType.sea:H=n.navalatk,C=n.grounddef,n.uclass==unitClass.submarine&&(z=r.closedef)}switch(F){case unitType.air:w=r.airatk;z=r.airdef;break;case unitType.soft:w=r.softatk;z=r.grounddef;break;case unitType.hard:w=r.hardatk;
z=r.grounddef;break;case unitType.sea:w=r.navalatk,z=r.grounddef,r.uclass==unitClass.submarine&&(C=n.closedef)}var X=(a.isCloseCombatTerrain(T)||n.uclass==unitClass.fortification)&&r.uclass==unitClass.infantry;X&&(C=n.closedef,n.uclass==unitClass.infantry?z=r.closedef:w+=4);Leaders.unitHasLeader(k,leaderType.aggressiveAttack)&&(w+=4,z+=2);Leaders.unitHasLeader(p,leaderType.aggressiveAttack)&&(H+=2,C+=2);Leaders.unitHasLeader(k,leaderType.determinedDefense)&&(z+=2);Leaders.unitHasLeader(p,leaderType.determinedDefense)&&
(H+=2,C+=4);Leaders.unitHasLeader(k,leaderType.tenaciousDefense)&&F!=unitType.air&&(z+=4);Leaders.unitHasLeader(p,leaderType.tenaciousDefense)&&M!=unitType.air&&(C+=4);b(k)&&(Leaders.unitHasLeader(k,leaderType.skilledGroundAttack)&&m(p))&&(w+=4);n.uclass==unitClass.artillery&&(z+=3);T==terrainType.City&&(C+=4);T!=terrainType.River&&T!=terrainType.Stream||U.road!=roadType.none||(w+=4,z+=4);W!=terrainType.River&&W!=terrainType.Stream||Q.road!=roadType.none||(H+=4,C+=4);F=M=0;P&&!X&&(M=k.entrenchment);
x&&(F=p.entrenchment);Leaders.unitHasLeader(k,leaderType.infiltrationTactics)&&!Leaders.unitHasLeader(p,leaderType.ferociousDefense)&&(F=0);Leaders.unitHasLeader(p,leaderType.infiltrationTactics)&&!Leaders.unitHasLeader(k,leaderType.ferociousDefense)&&(M=0);z+=M;C+=F;n.uclass==unitClass.infantry&&a.isCloseCombatTerrain(T)&&!X&&r.uclass>unitClass.infantry&&r.uclass<unitClass.groundTransport&&(C+=F);w+=E;z+=E;H+=N;C+=N;r.uclass!=unitClass.artillery&&(r.uclass!=unitClass.fortification&&(r.uclass<unitClass.submarine||
r.uclass>unitClass.lightCruiser))&&(E=2*p.hits,C=C<=E?0:C-E);E=r.uclass==unitClass.antiTank&&k.hasMoved&&!Leaders.unitHasLeader(k,leaderType.tankKiller);m(k)&&(m(p)&&!X)&&(1>=l||a.getUnitAttackRange(p)<l?(E||(z+=r.rangedefmod>>1),C+=n.rangedefmod>>1):(E||(z+=r.rangedefmod),C+=n.rangedefmod));aInitiative=r.initiative;dInitiative=n.initiative;E=r.initiative-n.initiative;Leaders.unitHasLeader(k,leaderType.firstStrike)&&(E=Math.abs(E));Leaders.unitHasLeader(p,leaderType.firstStrike)&&(E=-Math.abs(E));
0<=E?(z+=4,w+=Math.min(4,E)):(C+=4,H+=Math.min(4,-E));1==l&&(x&&a.isRuggedDefense(k,p))&&(B.isRugged=!0);if(k.isSurprised||B.isRugged)z=0,w/=2;1<l&&!(g(k)&&g(p)&&n.gunrange>=l)&&(B.defcanfire=!1);d(p,k)||(B.defcanfire=!1);B.kills=f(w,C,k,p,q);B.defcanfire&&(B.losses=f(H,z,p,k,q));r.uclass==unitClass.tank&&(1>=B.losses&&B.kills>=p.strength&&1==l&&!k.isSurprised)&&(B.isOverrun=!0);q=H+6-z;r=w+6-C;1>q&&(q=1);1>r&&(r=1);w=C+6-w;z=z+6-H;1>w&&(w=1);1>z&&(z=1);B.atkExpGained=(q*(p.strength/10)+w)*B.kills>>
0;B.defExpGained=2*B.kills>>0;B.defcanfire&&(B.atkExpGained+=+(2*B.losses),B.defExpGained+=+((r*(k.strength/10)+z)*B.losses));k.experience+B.atkExpGained>UNIT_MAX_EXPERIENCE&&(B.atkExpGained=UNIT_MAX_EXPERIENCE-k.experience);p.experience+B.defExpGained>UNIT_MAX_EXPERIENCE&&(B.defExpGained=UNIT_MAX_EXPERIENCE-p.experience);return B};a.isLossOverRetreatThreshold=function(a,g){return(g-a)/g>=UNIT_RETREAT_THRESHOLD-(10-g)/2/10?!0:!1};a.shouldDefenderRetreat=function(g,b,k){var d=g.unitData().uclass;return m(g)&&
m(b)&&d!=unitClass.artillery&&d!=unitClass.tacticalBomber&&d!=unitClass.fortification?a.isLossOverRetreatThreshold(b.strength,k):!1};a.getRetreatPosition=function(g,b,m,k){if(!b)return null;var d=b.unitData();k=movTable[d.movmethod];if(0==d.movpoints)return null;d=b.getPos();b=Math.abs(b.facing-8);var f=a.facingToAdjacentIndex(b);b=q(d.row,d.col);b.unshift(b[f]);for(var l in b)if(d=b[l].row,f=b[l].col,(0!=d||0!=f%2)&&(d!=m-1||1!=f%2)&&"undefined"!==typeof g[d]&&"undefined"!==typeof g[d][f]&&null===
g[d][f].unit&&255>k[g[d][f].terrain])return new Cell(d,f);return null};a.isRuggedDefense=function(a,g){var b=(a.experience/100>>0)+2,m=(g.experience/100>>0)+2;Leaders.unitHasLeader(a,leaderType.tenaciousDefense)&&(b+=2);Leaders.unitHasLeader(g,leaderType.tenaciousDefense)&&(m+=2);var k=unitEntrenchRate[a.unitData().uclass]+1,d=unitEntrenchRate[g.unitData().uclass]+1;return 50<5*(50*m/b)*d*g.entrenchment/(50*k)};a.isEntrenchmentIntact=function(a,g,b){return Leaders.unitHasLeader(g,leaderType.ferociousDefense)?
!0:Equipment.ignoresEntrenchment(a.eqid)||(Leaders.unitHasLeader(a,leaderType.infiltrationTactics)||Leaders.unitHasLeader(a,leaderType.streetFighter))&&(b==terrainType.City||b==terrainType.Rough||b==terrainType.Port)?!1:!0};a.getResupplyValue=function(m,k,d){"undefined"===typeof d&&(d=!1);if(!a.canResupply(m,k))return new Supply(0,0);var f=k.unitData(!0).ammo-k.ammo,l=k.unitData(!0).fuel-k.fuel,x=k.getHex().terrain;if(b(k)||g(k))return new Supply(f,l);var r=0,n=0;null!==k.transport&&(r=k.transport.unitData().ammo-
k.transport.ammo,n=k.transport.unitData().fuel-k.transport.fuel);var F=k.getPos(),F=q(F.row,F.col),Q=0,U;for(U in F){var E=F[U].row,N=F[U].col;"undefined"!==typeof m[E]&&"undefined"!==typeof m[E][N]&&null!=m[E][N].unit&&m[E][N].unit.player.side!=k.player.side&&Q++}if(d&&(0<Q||x!=terrainType.City))return new Supply(0,0);x!=terrainType.City&&(f/=1.3,l/=1.3,r/=1.3,n/=1.3);0<Q&&2>=Q&&(f/=1.5,l/=1.5,r/=1.5,n/=1.5);2<Q&&(f/=3,l/=3,r/=3,n/=3);1>f&&(f=1);1>l&&(l=1);return new Supply(Math.round(f),Math.round(l),
Math.round(r),Math.round(n))};a.getReinforceValue=function(g,m,k){defined(k)||(k=!1);if(!a.canReinforce(g,m,k))return 0;var d=10-m.strength;k&&(d=10+Math.round(m.experience/100)-m.strength);if(b(m))return d;k=m.getPos();k=q(k.row,k.col);var f=0,l;for(l in k){var x=k[l].row,r=k[l].col;"undefined"!==typeof g[x]&&"undefined"!==typeof g[x][r]&&null!==g[x][r].unit&&g[x][r].unit.player.side!=m.player.side&&f++}m.getHex().terrain!=terrainType.City&&(d/=1.3);0<f&&2>=f&&(d/=1.5);2<f&&(d/=3);return Math.round(d)};
a.canInitiateAttack=function(g,b){var m;if(null===g||g.destroyed||null===b||b.destroyed)m=!1;else{m=g.getEqid();var k=b.getEqid();m=a.isEnemy(g,b)&&!Equipment.canInitiateAttackOnUnitType(m,k)?!1:d(g,b)}return m};a.canFire=function(a,g){return d(a,g)};a.canPassInto=function(a,g,b){return n(a,g,b)};a.isBridgeForSide=function(a,g){return!a||!a.unit||a.terrain!=terrainType.River&&a.terrain!=terrainType.Stream||a.unit.isMounted||a.unit.player.side!=g?!1:Equipment.isBridge(a.unit.eqid)};a.canResupply=function(a,
d){if(d.hasMoved||d.hasFired||d.hasResupplied)return!1;var f=d.ammo<d.unitData(!0).ammo,q=d.fuel<d.unitData(!0).fuel;null!==d.transport&&(f=f||d.transport.ammo<d.transport.unitData().ammo,q=q||d.transport.fuel<d.transport.unitData().fuel);return f||q?m(d)||b(d)&&k(a,d)||g(d)&&d.getHex().terrain!=terrainType.Port?!0:!1:!1};a.canReinforce=function(a,d,f){defined(f)||(f=!1);if(d.hasOverstrength)return!1;if(f){if(10>d.strength||100>d.experience||d.strength>=10+Math.round(d.experience/100))return!1}else if(d.hasResupplied||
10<=d.strength)return!1;d.unitData(!0);return m(d)||b(d)&&k(a,d)||g(d)&&d.getHex().terrain!=terrainType.Port?!0:!1};a.canCapture=function(a){var g=a.unitData().uclass;return b(a)||a.isMounted&&(g==unitClass.antiTank||g==unitClass.flak||g==unitClass.artillery||g==unitClass.airDefence)?!1:!0};a.canEntrench=function(a){if(null===a||0!=a.carrier)return!1;a=a.unitData().uclass;return 0<unitEntrenchRate[a]?!0:!1};a.isEnemy=function(a,g){return null===a||null===g?!1:a.player.side!=g.player.side?!0:!1};a.getSupportFireUnits=
function(g,m,k){var f=m.getPos(),q=k.getPos();if(1<a.distance(f.row,f.col,q.row,q.col))return[];var q=[],l=null,x;for(x in g)if(l=g[x],l.player.side==k.player.side&&l.id!=k.id){var r=l.getPos(),n=l.unitData(),Q=n.gunrange;0==Q&&(Q=1);a.distance(r.row,r.col,f.row,f.col)>Q||(b(m)?n.uclass!=unitClass.flak&&n.uclass!=unitClass.airDefence&&n.uclass!=unitClass.fighter||!d(l,m)||q.push(l):n.uclass==unitClass.artillery&&d(l,m)&&q.push(l))}return q};a.isInAttackRange=function(g,b){var m=g.getPos(),k=b.getPos(),
d=a.getUnitAttackRange(g);return defined(m)&&defined(k)?a.distance(m.row,m.col,k.row,k.col)<=d?!0:!1:!1};a.getEmbarkType=function(a,g){var b=g.getPos(),b=a[b.row][b.col],m=g.unitData();return b.terrain==terrainType.Airfield&&0<g.player.airTransports&&m.embark>embarkType.naval&&null===b.airunit?unitClass.airTransport:b.terrain==terrainType.Port&&0<g.player.navalTransports&&m.embark>embarkType.none?unitClass.navalTransport:unitClass.none};a.getDisembarkPositions=function(a,g){var b=[],m=g.unitData();
if(!g.hasMoved&&(m.uclass==unitClass.airTransport||m.uclass==unitClass.navalTransport)){var k=g.getPos(),m=movTable[Equipment.equipment[g.eqid].movmethod],k=q(k.row,k.col),d;for(d in k){var f=k[d].row,l=k[d].col;"undefined"!==typeof a[f]&&"undefined"!==typeof a[f][l]&&(f=a[f][l],null===f.unit&&255>m[f.terrain]&&b.push(k[d]))}}return b};a.getReinforcementDeployPositions=function(a,g,b,m){g.unitData();var k=movTable[Equipment.equipment[g.eqid].movmethod],d=q(b,m);d.unshift(new Cell(b,m));for(var f in d)if(b=
d[f].row,m=d[f].col,defined(a[b])&&defined(a[b][m])&&!(0>b||0>m)&&(b=a[b][m],l(a,g,d[f])&&255>k[b.terrain]))return d[f];return null};a.canEmbark=function(g,b){return 0<a.getEmbarkType(g,b)||0>b.carrier?!0:!1};a.canDisembark=function(g,b){return 0<a.getDisembarkPositions(g,b).length?!0:!1};a.canMount=function(a){return!a.hasMoved&&m(a)&&null!==a.transport?!0:!1};a.canUnmount=function(a){return!a.hasMoved&&a.isMounted?!0:!1};a.isTransportable=function(a){return 1>a||"undefined"===typeof a||0==Equipment.equipment[a].groundweight?
!1:!0};a.isAir=function(a){return b(a)};a.isSea=function(a){return g(a)};a.isGround=function(a){return m(a)};a.isTrain=function(a){if(null===a)return!1;var g=a.unitData();return m(a)&&g.movmethod==movMethod.deepnaval?!0:!1};a.isCloseCombatTerrain=function(a){return a==terrainType.City||a==terrainType.Forest||a==terrainType.Mountain||a==terrainType.Fortification?!0:!1};a.unitUsesFuel=function(a){if(0==a.unitData().fuel)return!1;a=a.unitData().movmethod;return a==movMethod.leg||a==movMethod.towed||
a==movMethod.allTerrainLeg?!1:!0};a.unitLowFuel=function(g,b){if(!a.unitUsesFuel(g))return!1;if(!g.isMounted){if(g.fuel<b)return!0}else if(g.transport.fuel<b)return!0;return!1};a.unitUsesAmmo=function(a){return 0==a.unitData().ammo?!1:!0};a.unitLowAmmo=function(g,b){if(!a.unitUsesAmmo(g))return!1;if(!g.isMounted){if(g.ammo<b)return!0}else if(g.transport.ammo<b)return!0;return!1};a.calculateUnitCosts=function(a,g){var b=0;0<a&&"undefined"!==typeof a&&(b+=Equipment.equipment[a].cost*CURRENCY_MULTIPLIER);
0<g&&"undefined"!==typeof g&&(b+=Equipment.equipment[g].cost*CURRENCY_MULTIPLIER);return b};a.calculateUpgradeCosts=function(g,b,m){if(null===g)return 0;var k=0,d=0,f=0,d="undefined"!==typeof b&&0<b?g.eqid==b?a.calculateUnitCosts(g.eqid,-1):a.calculateUnitCosts(b,-1)*UPGRADE_PENALTY:a.calculateUnitCosts(g.eqid,-1);"undefined"!==typeof m&&0<m&&(f=null!==g.transport&&g.transport.eqid==m?a.calculateUnitCosts(-1,m):a.calculateUnitCosts(-1,m)*UPGRADE_PENALTY);k=null!==g.transport?-1==m?a.calculateUnitCosts(g.eqid,
-1):a.calculateUnitCosts(g.eqid,g.transport.eqid):a.calculateUnitCosts(g.eqid,-1);return d+f-k>>0};a.calculateUnitCostPerStrength=function(a){return null===a?-1:a.unitData().cost*CURRENCY_MULTIPLIER/10>>0};a.calculateUnitSellCost=function(g){if(!defined(g))return-1;var b=-1;defined(g.transport)&&(b=g.transport.eqid);return a.calculateUnitCosts(g.eqid,b)/UPGRADE_PENALTY/10*g.strength>>0};a.getDirection=function(a,g,b,m){g&1&&a==b&&a++;m&1&&a==b&&b++;a-=b;g-=m;m=0;b=1;0!=a&&(b=Math.abs(g/a));3<b&&(m=
1);0>b&&(m=-1);if(0<a){if(0<g)return direction.NW+m;if(0>g)return direction.NE+m;if(0==g)return direction.N}if(0>a){if(0<g)return direction.SW+m;if(0>g)return direction.SE+m;if(0==g)return direction.S}if(0==a){if(0<=g)return direction.W;if(0>g)return direction.E}};a.distance=function(a,g,b,m){a=Math.abs((m%2?2*b+1:2*b)-(g%2?2*a+1:2*a));g=Math.abs(m-g);return a>g?(a-g)/2+g>>0:g};a.getAdjacent=function(a,g){return q(a,g)};a.facingToAdjacentIndex=function(a){return a==direction.N?0:a==direction.NW||
a==direction.NNW||a==direction.WNW||a==direction.W?1:a==direction.SW||a==direction.WSW||a==direction.SSW?2:a==direction.S?3:a==direction.SE||a==direction.SSE||a==direction.ESE?4:a==direction.NE||a==direction.E||a==direction.ENE||a==direction.NNE?5:0};a.rollDice=function(a,g){a=Math.ceil(a);g=Math.floor(g);return Math.floor(Math.random()*(g-a+1))+a};return a}(GameRules||{});function Transport(a){this.eqid="undefined"===typeof Equipment.equipment[a]?Object.keys(Equipment.equipment)[0]:a;this.ammo=Equipment.equipment[this.eqid].ammo;this.fuel=Equipment.equipment[this.eqid].fuel;this.icon=Equipment.equipment[this.eqid].icon}Transport.prototype.copy=function(a){null!==a&&(this.eqid=a.eqid,this.ammo=a.ammo,this.fuel=a.fuel)};Transport.prototype.unitData=function(){return Equipment.equipment[this.eqid]};
function Unit(a){this.eqid="undefined"===typeof Equipment.equipment[a]?Object.keys(Equipment.equipment)[0]:a;this.owner=this.id=-1;this.tempSpotted=this.isCore=this.isDeployed=this.isSurprised=this.isMounted=this.hasOverstrength=this.hasResupplied=this.hasFired=this.hasMoved=!1;this.strength=10;this.facing=2;this.flag=this.owner;this.destroyed=!1;this.transport=this.player=null;this.carrier=0;this.moveLeft=Equipment.equipment[this.eqid].movpoints;this.ammo=Equipment.equipment[this.eqid].ammo;this.fuel=
Equipment.equipment[this.eqid].fuel;this.hasAnimation=!1;this.entrenchTicks=this.entrenchment=this.experience=this.hits=0;this.leader=-1;this.getHex=function(){return f};this.setHex=function(a){f=a;null!==a&&(this.isDeployed=!0)};this.getPos=function(){return null===f?null:f.getPos()};var f=null}
Unit.prototype.copy=function(a){null!==a&&(this.eqid="undefined"===typeof Equipment.equipment[a.eqid]?Object.keys(Equipment.equipment)[0]:a.eqid,this.id=a.id,this.owner=a.owner,this.hasMoved=a.hasMoved,this.hasFired=a.hasFired,this.hasOverstrength=a.hasOverstrength,this.hasResupplied=a.hasResupplied,this.isMounted=a.isMounted,this.isSurprised=a.isSurprised,this.isDeployed=a.isDeployed,this.isCore=a.isCore,this.carrier=a.carrier,this.moveLeft=a.moveLeft,this.ammo=a.ammo,this.fuel=a.fuel,this.strength=
a.strength,this.facing=a.facing,this.flag=a.flag,this.destroyed=a.destroyed,this.hits=a.hits,this.experience=a.experience,this.entrenchment=a.entrenchment,this.entrenchTicks=a.entrenchTicks,this.leader=a.leader,this.player=new Player,this.player.copy(game.scenario.map.getPlayer(this.owner)),null!==a.transport&&(this.transport=new Transport(a.transport.eqid),this.transport.copy(a.transport)))};
Unit.prototype.getEqid=function(a){return 0<this.carrier&&!a?this.carrier:this.isMounted&&null!==this.transport&&!a?this.transport.eqid:this.eqid};Unit.prototype.unitData=function(a){defined(a)||(a=!1);return Equipment.equipment[this.getEqid(a)]};Unit.prototype.getMovesLeft=function(){return 0<this.carrier?Equipment.equipment[this.carrier].movpoints:this.isMounted&&null!==this.transport?Equipment.equipment[this.transport.eqid].movpoints:this.hasMoved?0:this.moveLeft};
Unit.prototype.getAmmo=function(){return this.isMounted&&null!==this.transport?this.transport.ammo:this.ammo};Unit.prototype.getFuel=function(){return this.isMounted&&null!==this.transport?this.transport.fuel:this.fuel};Unit.prototype.hit=function(a){this.strength-=a;this.hits++;0<this.entrenchment&&this.entrenchment--;0>=this.strength&&(this.destroyed=!0)};Unit.prototype.fire=function(a){this.tempSpotted=!0;this.ammo--;a&&(this.hasOverstrength=this.hasFired=!0)};
Unit.prototype.move=function(a){var f=this.entrenchment=0,f=254<=a?a/254+a%254>>0:a;this.isMounted&&null!==this.transport?(this.hasFired=!0,GameRules.unitUsesFuel(this.transport)&&(this.transport.fuel-=f),this.moveLeft=0):(GameRules.unitUsesFuel(this)&&0==this.carrier&&(this.fuel-=f),this.moveLeft-=f);if(this.unitData().uclass!=unitClass.recon||0>=this.moveLeft)this.hasOverstrength=this.hasMoved=!0;0>this.carrier&&(this.carrier=0)};
Unit.prototype.upgrade=function(a,f){0>=a&&(a=this.eqid);var d=Equipment.equipment[this.eqid].uclass,l=Equipment.equipment[a].uclass;d==unitClass.flak&&l==unitClass.airDefence&&(d=unitClass.airDefence);if(d!=l)return!1;this.eqid=a;GameRules.isTransportable(this.eqid)?0<f&&this.setTransport(f):null!==this.transport&&(this.transport=null);this.refillAmmoFuel();this.entrenchment=0;this.isDeployed&&(this.hasMoved=this.hasFired=this.hasOverstrength=this.hasResupplied=!0);return!0};
Unit.prototype.resupply=function(a){this.ammo+=a.ammo;this.fuel+=a.fuel;null!==this.transport&&(this.transport.ammo+=a.transportAmmo,this.transport.fuel+=a.transportFuel);this.hasMoved=this.hasFired=this.hasResupplied=!0};Unit.prototype.reinforce=function(a,f){this.strength+=a;this.hasMoved=this.hasFired=this.hasRessuplied=!0;f&&(this.hasOverstrength=!0)};Unit.prototype.setTransport=function(a){delete this.transport;this.transport=new Transport(a)};Unit.prototype.mount=function(){this.isMounted=!0};
Unit.prototype.unmount=function(){this.isMounted=!1};Unit.prototype.embark=function(a){a=Equipment.getCountryEquipmentByClass(a,this.player.country+1)[0];if(!a||"undefined"===typeof a)return!1;this.carrier=a;return!0};
Unit.prototype.entrench=function(){var a=null,f=this.unitData().uclass,d=0;if(!GameRules.canEntrench(this))return!1;a=this.getHex();if(!a)return!1;d=terrainEntrenchment[a.terrain];if(this.entrenchment>=terrainEntrenchment[a.terrain]){var a=this.entrenchment-d,l=9*a+4;for(this.entrenchTicks+=+(this.experience/100)+(d+1)*unitEntrenchRate[f];this.entrenchTicks>=l&&this.entrenchment<d+5;)this.entrenchTicks-=l,this.entrenchment++,a++,l=9*a+4}else this.entrenchment=d,this.entrenchTicks=0;return!0};
Unit.prototype.toggleEmbark=function(){this.carrier=-this.carrier};Unit.prototype.getIcon=function(){return this.unitData().icon};Unit.prototype.refillAmmoFuel=function(){this.ammo=Equipment.equipment[this.eqid].ammo;this.fuel=Equipment.equipment[this.eqid].fuel;null!==this.transport&&defined(Equipment.equipment[this.transport.eqid])&&(this.transport.ammo=Equipment.equipment[this.transport.eqid].ammo,this.transport.fuel=Equipment.equipment[this.transport.eqid].fuel)};
Unit.prototype.unitEndTurn=function(){this.entrench();this.moveLeft=Equipment.equipment[this.eqid].movpoints;this.hasOverstrength=this.hasMoved=this.hasFired=this.hasResupplied=this.isSurprised=!1;this.hits=0;if(this.unitData().uclass!==unitClass.fortification){var a=this.getHex();null===a||a.isSpotted(game.spotSide)||(this.tempSpotted=!1)}};Unit.prototype.cleanup=function(){};function Player(){this.country=this.side=this.id=-1;this.score=this.prestige=0;this.dossier={};this.playedTurn=-1;this.type=playerType.humanLocal;this.handler=null;this.navalTransports=this.airTransports=0;this.supportCountries=[];this.prestigePerTurn=[];this.getCoreUnitList=function(){return a};this.addCoreUnit=function(f){if(!f||"undefined"===typeof f)return!1;f.isCore=!0;a.push(f);return!0};this.removeUndeployedCoreUnit=function(f){a.splice(f,1)};this.setCoreUnitList=function(f){if(!f||0==f.length)return!1;
var d;a=[];for(d=0;d<f.length;d++)a.push(f[d]);return!0};var a=[]}
Player.prototype.copy=function(a,f){var d;if(null!==a){defined(f)||(f=!1);this.id=a.id;this.side=a.side;this.country=a.country;this.prestige=a.prestige;this.playedTurn=a.playedTurn;this.type=a.type;if(f)this.score+=a.score;else{this.score=a.score;this.airTransports=a.airTransports;this.navalTransports=a.navalTransports;if(a.supportCountries)for(d=0;d<a.supportCountries.length;d++)this.supportCountries.push(a.supportCountries[d]);if(a.prestigePerTurn)for(d=0;d<a.prestigePerTurn.length;d++)this.prestigePerTurn.push(a.prestigePerTurn[d])}"function"===
typeof a.getCoreUnitList&&this.setCoreUnitList(a.getCoreUnitList());a.hasOwnProperty("dossier")&&a.dossier.hasOwnProperty("units")&&this.copyDossier(a)}};
Player.prototype.initDossier=function(){this.dossier.units={};this.dossier.units.lostaux={};this.dossier.units.lostcore={};this.dossier.units.killed={};for(var a in unitClass){var f=unitClass[a];this.dossier.units.lostaux[f]=0;this.dossier.units.lostcore[f]=0;this.dossier.units.killed[f]=0}this.dossier.outcomes={};for(var d in outcomeNames)this.dossier.outcomes[d]=[]};
Player.prototype.copyDossier=function(a){this.initDossier();for(var f in unitClass){var d=unitClass[f];this.dossier.units.lostaux[d]=a.dossier.units.lostaux[d];this.dossier.units.lostcore[d]=a.dossier.units.lostcore[d];this.dossier.units.killed[d]=a.dossier.units.killed[d]}for(var l in outcomeNames)for(f=0;f<a.dossier.outcomes[l].length;f++)this.dossier.outcomes[l].push(a.dossier.outcomes[l][f])};Player.prototype.getCountryName=function(){return Equipment.getCountryName(this.country)};
Player.prototype.getSideName=function(){return sideNames[this.side]};Player.prototype.hasUndeployedUnits=function(){var a,f=this.getCoreUnitList();for(a=0;a<f.length;a++)if(!f[a].isDeployed)return!0;return!1};Player.prototype.buyUnit=function(a,f){var d=GameRules.calculateUnitCosts(a,f);if(d>this.prestige)return!1;this.acquireUnit(a,f)&&(this.prestige-=d);return!0};
Player.prototype.acquireUnit=function(a,f){var d=new Unit(a);0<f&&"undefined"!==typeof f&&d.setTransport(f);d.owner=this.id;d.flag=1*this.country+1;d.player=this;null===game.campaign&&(d.experience=+game.scenario.getSideUnitsAvgExp(+!this.side));this.addCoreUnit(d);return!0};Player.prototype.upgradeUnit=function(a,f,d){var l=GameRules.calculateUpgradeCosts(a,f,d);if(l>this.prestige||!a.upgrade(f,d))return!1;this.prestige-=l;return!0};
Player.prototype.sellUnit=function(a){if(!defined(a))return!1;a=GameRules.calculateUnitSellCost(a);this.prestige+=a;return!0};Player.prototype.resupplyUnit=function(a,f){this.updateScore(scoreGains.resupply);a.resupply(f)};Player.prototype.reinforceUnit=function(a,f,d){var l=1;d&&(l=OVERSTRENGTH_PENALTY);var l=Math.round(GameRules.calculateUnitCostPerStrength(a)*l),n=this.prestige/l>>0;if(1>n)return 0;n>f&&(n=f);this.prestige-=n*l;this.updateScore(scoreGains.reinforce,f);a.reinforce(n,d);return n};
Player.prototype.updateScore=function(a,f){if(null==f||"undefined"===typeof f)f=1;var d=1;null!==game.campaign&&(d=difficultyModifiers[game.campaign.difficulty].scoreCoef);this.score+=a*f*d>>0};Player.prototype.addDestroyedUnitToDossier=function(a){this.dossier.hasOwnProperty("units")||this.initDossier();var f=a.unitData(!0).uclass;this.id===a.player.id?a.isCore?this.dossier.units.lostcore[f]++:this.dossier.units.lostaux[f]++:this.dossier.units.killed[f]++};
Player.prototype.addOutcomeToDossier=function(a,f){this.dossier.hasOwnProperty("outcomes")||this.initDossier();this.dossier.outcomes[a].push(f)};Player.prototype.endTurn=function(a){this.playedTurn=a;a<this.prestigePerTurn.length&&(this.prestige+=this.prestigePerTurn[a]);this.updateScore(scoreGains.endTurn)};
Player.prototype.setPlayerToHQ=function(){var a,f;this.supportCountries=[];this.prestigePerTurn=[];this.navalTransports=this.airTransports=0;var d=this.getCoreUnitList();for(a=0;a<d.length;a++)f=d[a],f.destroyed?(d[a]=null,d.splice(a,1),a--):(f.unmount(),f.carrier=0,f.hasMoved=f.hasFired=f.hasResupplied=!1,f.isDeployed=!1,10>f.strength&&(f.strength=10),f.refillAmmoFuel(),f.moveLeft=f.unitData().movpoints,f.entrenchment=0,f.hits=0,f.setHex(null))};Player.prototype.cleanup=function(){};
function Hex(a,f){this.airunit=this.unit=null;this.terrain=terrainType.Clear;this.road=roadType.none;this.victorySide=this.isDeployment=this.flag=this.owner=-1;this.name="";this.isAttackSel=this.isMoveSel=!1;this.isZOC=function(a){return a<d.length&&0<d[a]?!0:!1};this.isSpotted=function(a){return uiSettings.noFOW?!0:a<l.length&&0<l[a]?!0:!1};this.setZOC=function(a,k){var b=d;a<b.length&&(k?b[a]++:0<b[a]&&b[a]--)};this.setSpotted=function(a,k){var b=l;a<b.length&&(k?b[a]++:0<b[a]&&b[a]--)};this.getPos=
function(){return new Cell(1*a,1*f)};var d=[0,0],l=[0,0]}Hex.prototype.copy=function(a){null!==a&&(this.terrain=a.terrain,this.road=a.road,this.owner=a.owner,this.flag=a.flag,this.isDeployment=a.isDeployment,this.victorySide=a.victorySide,this.name=a.name,this.setUnit(a.unit),this.setUnit(a.airunit))};Hex.prototype.getUnit=function(a){return null!==this.unit&&null!==this.airunit?a?this.airunit:this.unit:null!==this.unit?this.unit:null!==this.airunit?this.airunit:null};
Hex.prototype.setUnit=function(a){null!==a&&"function"===typeof a.setHex&&(a.setHex(this),GameRules.isAir(a)?this.airunit=a:this.unit=a)};Hex.prototype.delUnit=function(a){null!==a&&"function"===typeof a.setHex&&(a.setHex(null),null!==this.unit&&this.unit.id==a.id&&(this.unit=null),null!==this.airunit&&this.airunit.id==a.id&&(this.airunit=null))};
Hex.prototype.getAttackableUnit=function(a,f){var d=this.isSpotted(a.player.side),l=-1,n=this.getUnit(f);if(n){if((d||n.tempSpotted)&&GameRules.canInitiateAttack(a,n))return n;l=n.id}return(n=this.getUnit(!f))&&n.id!==l&&(d||n.tempSpotted)&&GameRules.canInitiateAttack(a,n)?n:null};Hex.prototype.cleanup=function(){this.unit&&(this.unit.cleanup(),delete this.unit,this.unit=null);this.airunit&&(this.airunit.cleanup(),delete this.airunit,this.airunit=null)};
function Map(){this.cols=this.rows=0;this.isLastColPartial=this.isLastRowPartial=!1;this.terrainImage=this.map=null;this.victoryTurns=[];this.turn=this.maxTurns=1;this.currentUnit=null;this.sidesVictoryHexes=[[],[]];this.currentPlayer=null;var a={},f=[],d=[],l=[],n=[],k=0;this.allocMap=function(){this.map=Array(this.rows);for(var a=0;a<this.rows;a++){this.map[a]=Array(this.cols);for(var b=0;b<this.cols;b++)this.map[a][b]=new Hex(a,b)}};this.addUnit=function(g){g.id=k;k++;l.push(g);a[g.eqid]=Equipment.equipment[g.eqid].icon;
null!==g.transport&&(a[g.transport.eqid]=g.transport.icon);0<g.carrier&&(a[g.carrier]=Equipment.equipment[g.carrier].icon);g.player=this.getPlayer(g.owner);-1==g.flag&&(g.flag=g.player.country+1);GameRules.setZOCRange(this.map,g,!0,this.rows,this.cols);GameRules.setSpotRange(this.map,g,!0,this.rows,this.cols)};this.getUnits=function(){return l};this.getUnitById=function(a){if(0>a||"undefined"===typeof a)return null;for(var b=0;b<l.length;b++)if(null!==l[b]&&l[b].id==a)return l[b];return null};this.getUnitImagesList=
function(){return a};this.hasAliveUnits=function(a){for(var b=0;b<l.length;b++)if(l[b].player.side==a&&!l[b].destroyed)return!0;return!1};this.removeAllSideUnits=function(a){for(var b=0;b<l.length;b++)l[b].player.side==a&&(l[b].destroyed=!0);this.updateUnitList()};this.getPlayers=function(){return n};this.addPlayer=function(g){if(g){n.push(g);null===this.currentPlayer&&(this.currentPlayer=n[0]);if(0<g.airTransports){var b=Equipment.getCountryEquipmentByClass(unitClass.airTransport,g.country+1)[0];
b&&"undefined"!==typeof b&&(a[b]=Equipment.equipment[b].icon)}0<g.navalTransports&&(b=Equipment.getCountryEquipmentByClass(unitClass.navalTransport,g.country+1)[0])&&"undefined"!==typeof b&&(a[b]=Equipment.equipment[b].icon)}};this.getPlayer=function(a){return a<n.length?n[a]:n[0]};this.getPlayersByCountry=function(a){for(var b=[],k=this.getPlayers(),d=0;d<k.length;d++)k[d].country==a&&b.push(k[d]);return b};this.getCountriesBySide=function(a){for(var b=[],k=this.getPlayers(),d=0;d<k.length;d++)if(k[d].side==
a){b.push(k[d].country);for(var f=0;f<k[d].supportCountries.length;f++)0<k[d].supportCountries[f]&&b.push(k[d].supportCountries[f]-1)}return b};this.setCurrentUnit=function(a){this.currentUnit=a};this.delCurrentUnit=function(){null!==this.currentUnit&&0>this.currentUnit.carrier&&this.currentUnit.toggleEmbark();this.currentUnit=null;this.delMoveSel();this.delAttackSel()};this.getUnitNeighbor=function(a,b,k){var d,f=l.length,s=a.id,p=a.owner,n=[];d=-1;for(var I=0;I<f;I++){var J=l[I];null!==J&&J.owner==
p&&(J.id==s?(n.push(J),d=n.length-1):k&&!J.hasMoved&&n.push(J))}return-1!==d?(a=d-1,0==d&&(a=n.length-1),d=(d+1)%n.length,0<b?n[d]:n[a]):a};this.delMoveSel=function(){for(var a=0;a<f.length;a++){var b=f[a];this.map[b.row][b.col].isMoveSel=!1}f=[]};this.delAttackSel=function(){for(var a=0;a<d.length;a++){var b=d[a];this.map[b.row][b.col].isAttackSel=!1}d=[]};this.setHex=function(a,b,k){k&&"undefined"!==typeof k?this.map[a][b].copy(k):k=this.map[a][b];a=k.victorySide;if(-1!=a){-1!=k.owner&&a==this.getPlayer(k.owner).side&&
(a=~a&1);b=k.getPos();for(var d=!1,f=0;f<this.sidesVictoryHexes[a].length;f++){var l=this.sidesVictoryHexes[a][f];if(l.row==b.row&&l.col==b.col){d=!0;break}}d||this.sidesVictoryHexes[a].push(b)}null!==k.unit&&this.addUnit(k.unit);null!==k.airunit&&this.addUnit(k.airunit)};this.updateVictorySides=function(a,b){for(var k=this.sidesVictoryHexes[~a&1],d=this.sidesVictoryHexes[a],f=0,l=d.length-1;0<=l;l--)d[l].row==b.row&&d[l].col==b.col&&(d.splice(l,1),f++);0<f&&k.push(b);return 0==this.sidesVictoryHexes[a].length?
!0:!1};this.setMoveRange=function(a){this.delMoveSel();a=GameRules.getMoveRange(this,a);for(var b=0;b<a.length;b++)f.push(a[b]),a[b].canMove&&(this.map[a[b].row][a[b].col].isMoveSel=!0)};this.getCurrentMoveRange=function(){return f};this.setAttackRange=function(a){this.delAttackSel();a=GameRules.getUnitAttackCells(this.map,a,this.rows,this.cols);for(var b=0;b<a.length;b++)d.push(a[b]),this.map[a[b].row][a[b].col].isAttackSel=!0};this.endTurn=function(){this.delMoveSel();this.delAttackSel();this.delCurrentUnit();
b.clear();this.currentPlayer.endTurn(this.turn);for(var a=this.getPlayers(),m=0;m<a.length;m++)if(a[m].id==this.currentPlayer.id){this.currentPlayer=m+1<a.length?a[m+1]:a[0];break}if(0==this.currentPlayer.id)for(this.turn++,a=0;a<l.length;a++)if(null!==l[a]){l[a].isMounted&&this.unmountUnitHandler(l[a]);m=GameRules.getResupplyValue(this.map,l[a],!0);if(0<m.ammo||0<m.fuel||0<m.transportAmmo||0<m.transportFuel)l[a].resupply(m),CombatLog.addResupply(l[a]);l[a].unitEndTurn()}this.currentPlayer.type!=
playerType.aiLocal&&this.currentPlayer.type!=playerType.aiScripted||this.currentPlayer.handler.buildActions()};this.attackUnit=function(a,m,k,d){if(null===a||null===m)return null;d="undefined"!==typeof d?d:!1;b.unit=null;var f=a.getPos(),l=m.getPos(),p=GameRules.calculateAttackResults(a,m,!1),n=CombatLog.addCombatStart(a,m,map.turn);GameRules.isBridgeForSide(a.getHex(),a.player.side)||(a.facing=GameRules.getDirection(f.row,f.col,l.row,l.col));GameRules.isBridgeForSide(m.getHex(),m.player.side)||(m.facing=
GameRules.getDirection(l.row,l.col,f.row,f.col));m.isMounted&&(!m.isSurprised&&m.unitData(!0).uclass==unitClass.infantry)&&this.unmountUnitHandler(m);d&&(p.kills=m.strength,p.isOverrun=!0,p.defcanfire=!1,0<a.moveLeft&&(a.hasMoved=!1),a.moveLeft+=1);a.experience=Math.round(a.experience+ +p.atkExpGained);m.experience=Math.round(m.experience+ +p.defExpGained);k||d?a.fire(!1):a.fire(!0);m.hit(p.kills);p.defcanfire&&!k&&(m.fire(!1),a.hit(p.losses));k||this.delAttackSel();a.player.updateScore(scoreGains.damage,
p.kills);a.player.updateScore(a.isCore?scoreGains.casualtyCore:scoreGains.casualty,p.losses);m.player.updateScore(scoreGains.damage,p.losses);m.player.updateScore(m.isCore?scoreGains.casualtyCore:scoreGains.casualty,p.kills);d=Leaders.generateLeaderWithChance(a,p.atkExpGained);-1!=d&&(a.leader=d,p.atkLeaderGain=!0,CombatLog.addLeader(a));d=Leaders.generateLeaderWithChance(m,p.defExpGained);-1!=d&&(m.leader=d,p.defLeaderGain=!0,CombatLog.addLeader(m));CombatLog.addCombatEnd(a,m,n,k);return p};this.updateUnitList=
function(){for(var a=0;a<l.length;a++){if(l[a].destroyed){var b=l[a].getPos();b&&(GameRules.setZOCRange(this.map,l[a],!1,this.rows,this.cols),GameRules.setSpotRange(this.map,l[a],!1,this.rows,this.cols),this.map[b.row][b.col].delUnit(l[a]));null!==game.campaign&&(defined(l[a].nodossier)&&!1!=l[a].nodossier||game.getCampaignPlayer().addDestroyedUnitToDossier(l[a]));l.splice(a,1);a--}null===l[a]&&(l.splice(a,1),a--)}};this.moveUnit=function(a,m,k){var d=a.getPos(),l=this.map[d.row][d.col],n=a.player.side,
p=~n&1,y=new movementResults,I=GameRules.canCapture(a),J=0,L=GameRules.getShortestPath(d,new Cell(m,k),f);if(!L||!L[0])return y;a.player.type==playerType.humanLocal&&(b.clear(),b.savedUnit=new Unit(a.eqid),b.savedUnit.copy(a),b.savedUnit.setHex(a.getHex()));for(var G=0;G<L.length;G++){if(0<G&&!GameRules.canPassInto(this.map,a,L[G])){Leaders.unitHasLeader(a,leaderType.battlefieldIntelligence)||Leaders.unitHasLeader(a,leaderType.skilledAssault)||(a.isSurprised=!0,y.surpriseCell=L[G]);break}if(a.player.type==
playerType.humanLocal||a.player.type==playerType.aiScripted||this.map[L[G].row][L[G].col].isSpotted(p))y.isVisible=!0,L[G].isVisible=!0;y.passedCells.push(L[G]);J+=L[G].cost}p=y.passedCells[y.passedCells.length-1];L=this.map[p.row][p.col];p.row==m&&p.col==k&&I&&(m=this.captureHex(L,a),m.isCapture&&(y.isCapture=!0),m.isWin&&(y.isVictorySide=n));if(!J||0>J)J=0;a.move(J);GameRules.setZOCRange(this.map,a,!1,this.rows,this.cols);GameRules.setSpotRange(this.map,a,!1,this.rows,this.cols);l.delUnit(a);L.setUnit(a);
a.facing=GameRules.getDirection(d.row,d.col,p.row,p.col);GameRules.setZOCRange(this.map,a,!0,this.rows,this.cols);d=GameRules.setSpotRange(this.map,a,!0,this.rows,this.cols);this.setMoveRange(a);this.setAttackRange(a);0!=d||a.isSurprised||a.player.type!=playerType.humanLocal?b.clear():b.unit=a;return y};this.retreatUnit=function(a,b){var k=this.currentUnit;f.push(b);var d=a.moveLeft,l=a.hasMoved,n=a.hasOverstrength,p=this.moveUnit(a,b.row,b.col);a.moveLeft=d;a.hasMoved=l;a.hasOverstrength=n;null!==
k&&this.selectUnit(k);return p};this.resupplyUnit=function(a){b.unit=null;var k=GameRules.getResupplyValue(this.map,a);a.player.resupplyUnit(a,k);this.delAttackSel();this.delMoveSel();return k};this.reinforceUnit=function(a,k){b.unit=null;var d=GameRules.getReinforceValue(this.map,a,k),f=GameRules.getResupplyValue(this.map,a),l=a.player;if(0>=(d=l.reinforceUnit(a,d,k)))return{strength:0,ammo:0,fuel:0};l.resupplyUnit(a,f);this.delAttackSel();this.delMoveSel();return{strength:d,ammo:f.ammo,fuel:f.fuel}};
this.mountUnit=function(a){this.mountUnitHandler(a);this.delMoveSel();this.delAttackSel();this.selectUnit(a)};this.mountUnitHandler=function(a){GameRules.setSpotRange(this.map,a,!1,this.rows,this.cols);a.mount();GameRules.setSpotRange(this.map,a,!0,this.rows,this.cols)};this.unmountUnit=function(a){this.delMoveSel();this.delAttackSel();this.unmountUnitHandler(a);this.selectUnit(a)};this.unmountUnitHandler=function(a){GameRules.setSpotRange(this.map,a,!1,this.rows,this.cols);a.unmount();GameRules.setSpotRange(this.map,
a,!0,this.rows,this.cols)};this.embarkUnit=function(a){var b=!1;if(0>a.carrier)a.carrier=-a.carrier,b=!0;else{var k=GameRules.getEmbarkType(this.map,a);if(0<k){if(!a.embark(k))return!1;k==unitClass.airTransport?a.player.airTransports--:k==unitClass.navalTransport&&a.player.navalTransports--;b=!0}}b&&(this.delMoveSel(),this.delAttackSel(),this.selectUnit(a));return b};this.disembarkUnit=function(a){var b=GameRules.getDisembarkPositions(this.map,a);if(0>=b.length)return!1;this.delMoveSel();this.delAttackSel();
for(var k=0;k<b.length;k++)f.push(b[k]),this.map[b[k].row][b[k].col].isMoveSel=!0;a.toggleEmbark();return!0};this.upgradeUnit=function(g,k,d){var f=null;if(null==(f=this.getUnitById(g))||!f.player.upgradeUnit(f,k,d))return!1;b.unit=null;a[f.eqid]=f.getIcon();null!==f.transport&&(a[f.transport.eqid]=f.transport.icon);return!0};this.disbandUnit=function(a){var k=null;if(null==(k=this.getUnitById(a)))return!1;k.destroyed=!0;k.nodossier=!0;b.unit=null;k.player.sellUnit(k);this.delCurrentUnit();this.updateUnitList();
return!0};this.deployPlayerUnit=function(a,b,k,d){if(!a)return!1;a=a.getCoreUnitList();if(0>b||b>=a.length)return!1;b=a[b];if(null===b||b.isDeployed)return!1;k=this.map[k][d];if((d=GameRules.isAir(b))&&null!==k.airunit||!d&&null!==k.unit)return!1;d||k.terrain!=terrainType.Ocean||b.embark(unitClass.navalTransport);k.setUnit(b);this.addUnit(b);return!0};this.deployNewUnitByEqId=function(a,b,k,d){a=new Unit(a);a.owner=d;this.map[b][k].setUnit(a);this.addUnit(a)};this.deployReinforcement=function(a,b,
k){if(!a)return null;b=GameRules.getReinforcementDeployPositions(this.map,a,b,k);if(null===b)return null;this.map[b.row][b.col].setUnit(a);this.addUnit(a);return b};this.selectUnit=function(a){if(null===a||a.player.id!=this.currentPlayer.id)return!1;this.delCurrentUnit();this.delMoveSel();this.delAttackSel();this.setCurrentUnit(a);0>a.carrier&&(a.carrier=-a.carrier,this.disembarkUnit(a));!a.hasMoved&&0<=a.carrier&&this.setMoveRange(a);a.hasFired||this.setAttackRange(a);return!0};this.buildCoreUnitList=
function(a){var b;for(b=0;b<l.length;b++)l[b].player.id==a.id&&l[b].getHex().isDeployment==a.id&&a.addCoreUnit(l[b])};this.restoreCoreUnitList=function(a,b){var k,d;for(k=0;k<l.length;k++)l[k].isCore&&l[k].isDeployed&&a.addCoreUnit(l[k]);for(k=0;k<b.length;k++)b[k].isDeployed||(d=new Unit(b[k].eqid),d.copy(b[k]),a.addCoreUnit(d))};this.removeNonCampaignUnits=function(a){var b,k,d=!1;for(b=0;b<l.length;b++)l[b].player.id!=a.id||l[b].isCore||(k=l[b].getHex())&&k.isDeployment==a.id&&(k.delUnit(l[b]),
l[b].destroyed=!0,d=l[b].nodossier=!0);d&&this.updateUnitList()};this.canUndoMove=function(a){return null!==b.unit&&b.unit.id==a.id?!0:!1};this.undoLastMove=function(){if(null!=b.unit){var a=b.unit,k=b.savedUnit,d=a.getPos(),f=k.getPos(),d=this.map[d.row][d.col],f=this.map[f.row][f.col];a.copy(k);GameRules.setZOCRange(this.map,a,!1,this.rows,this.cols);GameRules.setSpotRange(this.map,a,!1,this.rows,this.cols);d.delUnit(a);f.setUnit(a);GameRules.setZOCRange(this.map,a,!0,this.rows,this.cols);GameRules.setSpotRange(this.map,
a,!0,this.rows,this.cols);this.selectUnit(a);a=this.getPlayer(a.player.id);null!==b.oldOwner&&(d.owner=b.oldOwner);null!==b.oldFlag&&(d.flag=b.oldFlag);null!==b.oldVictorySide&&(this.updateVictorySides(~a.side&1,d.getPos()),d.victorySide=b.oldVictorySide);a.prestige-=b.prestigeGain;a.updateScore(-b.scoreGain);b.clear()}};this.captureHex=function(a,k){var d={isWin:!1,isCapture:!1},f=0,l=1,n=0,p=-1,y=k.player;if(-1==a.owner&&-1==a.flag)return d;-1!=a.owner&&(p=this.getPlayer(a.owner).side);if(p==y.side)return d;
b.oldOwner=a.owner;a.owner=y.id;Leaders.unitHasLeader(k,leaderType.liberator)&&(l=2);-1!=a.flag&&(b.oldFlag=a.flag,a.flag=y.country,-1==a.victorySide&&(f+=prestigeGains.flagCapture*l,n+=scoreGains.flagCapture,d.isCapture=!0));-1!=a.victorySide&&(b.oldVictorySide=a.victorySide,a.victorySide=~y.side&1,this.updateVictorySides(y.side,a.getPos())&&(d.isWin=!0),f+=prestigeGains.objectiveCapture*l,n+=scoreGains.objectiveCapture,d.isCapture=!0,CombatLog.addObjectiveCapture(a.getPos(),y.side));b.prestigeGain=
f;b.scoreGain=n;y.prestige+=f;y.updateScore(n);return d};this.getDeployHexes=function(a){for(var b=[],k=0;k<this.rows;k++)for(var d=0;d<this.cols;d++){var f=this.map[k][d].isDeployment;-1<f&&this.getPlayer(f).side==a&&b.push(this.map[k][d].getPos())}return b};this.copy=function(a){if(null!==a){this.rows=a.rows;this.cols=a.cols;this.terrainImage=a.terrainImage;this.name=a.name;this.turn=a.turn;this.maxTurns=a.maxTurns;this.allocMap();for(var b=0;b<a.rows;b++)for(var k=0;k<a.cols;k++){var d=a.map[b][k],
f=this.map[b][k];if(0!==Object.keys(d).length){f.copy(d);if(null!==d.unit){var l=new Unit(d.unit.eqid);l.copy(d.unit);f.setUnit(l)}null!==d.airunit&&(l=new Unit(d.airunit.eqid),l.copy(d.airunit),f.setUnit(l))}this.setHex(b,k)}this.sidesVictoryHexes=[[],[]];for(b=0;b<a.sidesVictoryHexes[0].length;b++)this.sidesVictoryHexes[0].push(a.sidesVictoryHexes[0][b]);for(b=0;b<a.sidesVictoryHexes[1].length;b++)this.sidesVictoryHexes[1].push(a.sidesVictoryHexes[1][b]);for(b=0;b<a.victoryTurns.length;b++)this.victoryTurns.push(a.victoryTurns[b])}};
this.cleanup=function(){for(var a=0;a<this.rows;a++)for(var b=0;b<this.cols;b++)this.map[a][b].cleanup(),delete this.map[a][b];this.map=null};this.dumpMap=function(){for(var a=0;a<n.length;a++);};var b={unit:null,savedUnit:null,oldOwner:null,oldFlag:null,oldVictorySide:null,prestigeGain:0,scoreGain:0,clear:function(){this.oldVictorySide=this.oldOwner=this.oldFlag=this.unit=this.savedUnit=null;this.scoreGain=this.prestigeGain=0}}};function ScenarioLoader(){function a(a){var g;if(!(g=null==a)){if(g=a.getElementsByTagName("map")[0]){var d=+g.getAttribute("rows"),n=+g.getAttribute("cols"),q=g.getAttribute("eqp"),r=1;game&&game.campaign&&(r=difficultyModifiers[game.campaign.difficulty].extraTurns);k.map.rows=d;k.map.cols=n;q&&(k.eqp=q,Equipment.name=q);k.map.victoryTurns=g.getAttribute("turns").split(", ");for(d=0;d<k.map.victoryTurns.length;d++)k.map.victoryTurns[d]=+k.map.victoryTurns[d];k.map.victoryTurns[2]=Math.round(k.map.victoryTurns[2]*
r);k.map.maxTurns=k.map.victoryTurns[2];k.maxTurns=k.map.victoryTurns[2];k.date.setTime(Date.parse(g.getAttribute("date")));k.atmosferic=+g.getAttribute("atmosferic");k.latitude=+g.getAttribute("latitude");k.ground=+g.getAttribute("ground");k.turnsPerDay=+g.getAttribute("dayturns")||1;k.turnsPerDay*=2;k.map.terrainImage=g.getAttribute("image");l(a);a=!0}else a=!1;g=!a}g&&f()}function f(){k.isLoaded=!1;k.onLoadFinished()}function d(a,g){if(!--Equipment.equipmentToLoad){for(var d=0;d<a.length;d++){var f=
new Player;f.copy(a[d]);k.map.addPlayer(f)}if(d=g.getElementsByTagName("reinforce"))for(var l=0;l<d.length;l++)if(null!==(f=+d[l].getAttribute("turn")))for(var r=0;r<d[l].childNodes.length;r++)if("at"==d[l].childNodes[r].nodeName){var s=d[l].childNodes[r],p=+s.getAttribute("row"),y=+s.getAttribute("col");if(null!=p&&null!=y)for(var I=0;I<s.childNodes.length;I++)"unit"==s.childNodes[I].nodeName&&(u=n(s.childNodes[I]),null!==u&&k.addReinforcement(f,p,y,u))}if(d=g.getElementsByTagName("hex"))for(p=f=
null,s=0;s<d.length;s++)if(l=+d[s].getAttribute("row"),r=+d[s].getAttribute("col"),!(l>=k.map.rows||r>=k.map.cols)&&(f=k.map.map[l][r])&&"undefined"!==typeof f){null!==(p=d[s].getAttribute("terrain"))&&(f.terrain=+p);null!==(p=d[s].getAttribute("road"))&&(f.road=+p);null!==(p=d[s].getAttribute("name"))&&(f.name=p);null!==(p=d[s].getAttribute("flag"))&&(f.flag=+p);null!==(p=d[s].getAttribute("owner"))&&(f.owner=+p);null!==(p=d[s].getAttribute("victory"))&&(f.victorySide=+p);null!==(p=d[s].getAttribute("deploy"))&&
(f.isDeployment=+p);null!==(p=d[s].getAttribute("supply"))&&-1==f.isDeployment&&(f.isDeployment=+p);for(y=0;y<d[s].childNodes.length;y++)"unit"==d[s].childNodes[y].nodeName&&(p=n(d[s].childNodes[y]),null!==p&&f.setUnit(p));k.map.setHex(l,r)}k.isLoaded=!0;k.onLoadFinished()}}function l(a){var g=new Image;g.src=k.map.terrainImage;g.onload=function(f){f=k.map.rows;for(var l=k.map.cols,q=g.width,r=1,n=g.height/50,p=!1,y=!1;30<=q;)q=r%2?q-60:q-30,r++;var p=0>q,q=n,I=n-Math.floor(n);0.39<=I&&0.8>I?(y=!0,
q=Math.ceil(n)):0.8<=I?(y=!1,q=Math.ceil(n)):0.39>I&&(y=!1,q=Math.floor(n));0<q&&(f>q||0==f)&&(f=q);0<r&&(l>r||0==l)&&(l=r);k.map.rows=f;k.map.cols=l;k.map.isLastColPartial=p;k.map.isLastRowPartial=y;k.map.allocMap();f=a.getElementsByTagName("player");l=[];r=0;game&&game.campaign&&(r=Math.round(game.campaign.startprestige*difficultyModifiers[game.campaign.difficulty].turnPrestige));if(f)for(n=0;n<f.length;n++){p=new Player;p.id=+f[n].getAttribute("id");p.side=+f[n].getAttribute("side");p.country=
+f[n].getAttribute("country");p.airTransports=+f[n].getAttribute("airtrans");p.navalTransports=+f[n].getAttribute("navaltrans");p.prestigePerTurn=f[n].getAttribute("turnprestige").split(", ");for(y=0;y<p.prestigePerTurn.length;y++)q=+p.prestigePerTurn[y],p.prestigePerTurn[y]=q,q<r&&(p.prestigePerTurn[y]=r);p.prestige=p.prestigePerTurn[0];p.supportCountries=[];q=f[n].getAttribute("support").split(", ");for(y=0;y<q.length;y++)0<+q[y]&&p.supportCountries.push(+q[y]);l.push(p)}Equipment.addPlayersEquipment(l,
d.bind(null,l,a))};g.onerror=f}function n(a){var g=+a.getAttribute("id"),d=+a.getAttribute("owner"),f=null,l;return 0<=g&&0<=d?(f=new Unit(g),f.owner=d>>0,null!==(g=a.getAttribute("face"))&&(f.facing=+g),null!==(g=a.getAttribute("flag"))&&(f.flag=+g),null!==(l=a.getAttribute("transport"))&&f.setTransport(+l),null!==(l=a.getAttribute("carrier"))&&(f.carrier=+l),null!==(l=a.getAttribute("exp"))&&(f.experience=+l),null!==(l=a.getAttribute("ent"))&&(f.entrenchment=+l),null!==(l=a.getAttribute("str"))&&
(f.strength=+l),null!==a.getAttribute("ldr")&&(f.leader=Leaders.generateLeader(f)),a=f,GameRules.isSea(a)||(l=k.map.getPlayer(a.owner).side,a.unitData(!0),k.unitsCostPerSide[l]+=GameRules.calculateUnitCosts(a.eqid,a.transport?a.transport.eqid:null),k.expPerSide[l].exp+=a.experience,k.expPerSide[l].count++),f):null}var k=null;this.noCache=!0;this.loadScenario=function(b){var g=new XMLHttpRequest;k=b;b=Scenario.scenarioPath+k.file;this.noCache&&(b+="?_="+(new Date).getTime());g.onload=function(){4===
g.readyState&&(200===g.status||0===g.status?a(g.responseXML):a(null))};g.open("GET",b,!0);g.send(null)}};function Render(a){function f(a){var k=0,f=0,m=a.unit,l=a.moveResults.passedCells,p,q,n,r,x,s,K,v=!0;this.movTimer=null;this.delay=uiSettings.quickAnimation?5:30;this.directDraw=function(a,b){T.clearRect(a.x-20,a.y-20,80,70);a.x+=x;a.y+=s;g(T,a.x,a.y,b,!1)};this.cssDraw=function(a,g,k){k&&(X.clearRect(0,0,X.canvas.width,X.canvas.height),b(X,-ba,-ca,g),"none"==C.style.display&&(C.style.display="inline"));a.x+=x;a.y+=s;uiSettings.use3D?(a="translate3d("+1*(a.x+ba)+"px, "+1*(a.y+ca)+"px, 0)","linear"!=
C.style.transition&&(C.style.MozTransition="linear",C.style.webkitTransition="linear",C.style.transition="linear"),C.style.MozTransform=a,C.style.webkitTransform=a,C.style.transform=a):(C.style.top=a.y+ca+"px",C.style.left=a.x+ba+"px")};this.start=function(){k>=l.length-1?(k=f=0,clearInterval(this.movTimer),m.hasAnimation=!1,C.style.display="none",a.cbfunc(a)):(0==f&&(n=l[k],r=l[k+1],p=d(n.row,n.col),q=d(r.row,r.col),x=(q.x-p.x)/5>>0,s=(q.y-p.y)/5>>0,K=GameRules.getDirection(n.row,n.col,r.row,r.col),
1<Math.abs(K-m.facing)&&(m.facing=K,v=!0)),l[k].isVisible&&this.cssDraw(p,m,v),v=!1,f++,5<=f&&(k++,f=0))}}function d(a,b,g){a=b&1?2*a*v+v+ca:2*a*v+ca;b=b*(S+Y)+Y+ba;g&&(g=$("game"),b+=V-g.clientLeft-g.offsetLeft,a+=aa-g.clientTop-g.offsetTop,b*=uiSettings.zoomLevel,a*=uiSettings.zoomLevel);return new screenPos(b,a)}function l(){var a=!1,b=!1,g=0,k=0;V=window.innerWidth/2-y.width/2;0>V&&(V=0);w.style.cssText+="z-index: 0; position:absolute; left: 0px; top: 0px;";N.style.cssText+="z-index: 1; position:absolute; left: 0px; top: 0px;";
z.style.cssText+="z-index: 2; position:absolute; left: 0px; top: 0px;";C.style.cssText+="z-index: 3; position:absolute; left: 0px; top: 0px;";C.style.display="none";w.style.cssText+="background-color: none; background-image:url('"+y.src+"');background-size:"+y.width+"px "+y.height+"px;background-repeat: no-repeat;background-attachment: scroll;";window.innerWidth>=y.width?a=!0:g=10;window.innerHeight>=y.height+aa?b=!0:k=30;a?$("game").style.width=y.width+k+"px":$("game").style.width=window.innerWidth+
"px";b?$("game").style.height=y.height+aa+g+"px":$("game").style.height=window.innerHeight-aa+"px";$("game").style.cssText+="position:absolute;left:"+V+"px;top:"+aa+"px;";$("game").tabIndex=1;$("game").focus()}function n(a,b,g){var k=P.canvas.width,d=P.canvas.height;if(!a||!b)return null;var f=a.flag-1,m=b.flag-1;a=GameRules.calculateCombatResults(a,b,q.getUnits(),!1,!0);P.clearRect(0,0,k,d);P.drawImage(s,k/2-s.width/2,d/2-s.height/2);P.drawImage(p,A*f,0,A,O,0,0,A,O);P.drawImage(p,A*m,0,A,O,k-A,0,
A,O);P.font=R+"px coreUnitFont, sans-serif";P.fillStyle="yellow";P.textBaseline="top";d=A/2-4;f=O;P.strokeText(a.losses,d+1,f+1);P.fillText(a.losses,d,f);d=k-A/2-4;P.strokeText(a.kills,d+1,f+1);P.fillText(a.kills,d,f);if(g)return H.toDataURL();g=document.createElement("canvas");g.width=H.width;g.height=H.height;g.getContext("2d").drawImage(H,0,0);return g}function k(a,b){var g=0,k=Object.keys(a).length,d=!1,f;for(f in a)"undefined"!==typeof r[a[f]]?g++:(d=!0,r[a[f]]=new Image,r[a[f]].onload=function(){g++;
g==k&&b&&b()},r[a[f]].src=a[f]);d||b&&b()}function b(a,b,g,k){if(null===k)return!1;var d=null,d=k.hasAnimation||q.currentUnit&&q.currentUnit.id==k.id||!GameRules.isGround(k)||!GameRules.isBridgeForSide(k.getHex(),k.player.side)?r[k.getIcon()]:L;if(!d)return!1;var f=!1,m=d.width/9,l=d.height;b=b-m/2+S/2>>0;g=g-l/2+v-R>>0;k=k.facing;8<k&&(k=16-k,f=!0);k*=m;if(f){var p=b+m/2;a.save();a.translate(p,0);a.scale(-1,1);a.translate(-p,0)}a.drawImage(d,k,0,m,l,b,g,m,l);f&&a.restore();return!0}function g(a,
g,k,d,f){if(b(a,g,k,d)&&f&&!(1>d.strength)){f=!0;null===game.campaign||d.isCore||(f=!1);a.font=f?R+"px coreUnitFont, sans-serif":R+"px unitInfo, sans-serif";var m=""+d.strength,l=g+Y/2>>0,p=k+2*v-(R+4),ba=1,n=d.player.side,r=19;10>d.strength&&(r=12,ba=2);a.fillStyle=1==n?unitstyle.alliedBox:unitstyle.axisBox;uiSettings.markEnemyUnits&&n!=game.spotSide&&(a.fillStyle=unitstyle.enemyBoxMarked);f&&(a.strokeStyle=1==n?unitstyle.alliedBorder:unitstyle.axisBorder,a.lineWidth=2,a.strokeRect(l,p-1,r,R+4));
a.fillRect(l,p-1,r,R+4);a.fillStyle=d.player.id!=q.currentPlayer.id&&d.player.side==q.currentPlayer.side?unitstyle.alliedPlayerText:unitstyle.playerText;d.hasMoved&&d.player.id==q.currentPlayer.id&&(a.fillStyle=unitstyle.movedUnitText);a.fillText(m,l+ba,p+9);!d.hasFired&&(GameRules.unitUsesAmmo(d)&&n==q.currentPlayer.side)&&(0<d.getAmmo()?a.drawImage(I,g-4,k+2*v-12):a.drawImage(J,g-4,k+2*v-12));-1!=d.leader&&a.drawImage(1==n?M:G,l+r+1,k+2*v-13)}}function m(a,b,g,k,d){a.beginPath();a.moveTo(b,g);a.lineTo(b+
S,g);a.lineTo(b+S+Y,g+v);a.lineTo(b+S,g+2*v);a.lineTo(b,g+2*v);a.lineTo(b-Y,g+v);null!==k.fillColor&&(a.fillStyle=k.fillColor,a.fill());a.closePath();0<k.lineWidth&&(a.lineWidth=k.lineWidth,a.lineJoin=k.lineJoin,a.strokeStyle=k.lineColor,k.hasOwnProperty("shadowColor")?(a.shadowOffsetX=k.shadowOffsetX,a.shadowOffsetY=k.shadowOffsetY,a.shadowColor=k.shadowColor):(a.shadowOffsetX=null,a.shadowOffsetY=null,a.shadowColor=null),a.stroke());if(uiSettings.showGridTerrain&&"undefined"!==typeof d&&d!=terrainType.Clear){var f=
b+Y+Y/2-2>>0,m=g+2*v-12;a.font="24px openpanzer, sans-serif";a.strokeStyle=unitstyle.terrainTextStroke;a.lineWidth=1;a.strokeText(terrainencoding[d],f-1,m-1);a.fillStyle=unitstyle.terrainText;a.fillText(terrainencoding[d],f,m)}k===hexstyle.deploy&&(f=b+4>>0,m=g+2*v-12,a.font="24px openpanzer, sans-serif",a.strokeStyle=unitstyle.terrainTextStroke,a.lineWidth=1,a.strokeText("Z",f-1,m-1),a.fillStyle=unitstyle.terrainText,a.fillText("Z",f,m));uiSettings.showGridTerrain&&k===hexstyle.move&&(m=g+2*v-12,
a.font="26px openpanzer-menu, sans-serif",a.strokeStyle=unitstyle.terrainText,a.lineWidth=1,a.strokeText("'",(b+4>>0)-1,m-1))}function x(a,b,g){var k={srow:0,scol:0,erow:q.rows,ecol:q.cols};if(null===a||null===b)a=b=0;null!==g&&0<=g&&(k.srow=a-g,k.scol=b-g,k.erow=a+g,k.ecol=b+g,0>k.srow&&(k.srow=0),0>k.scol&&(k.scol=0),k.erow>q.rows&&(k.erow=q.rows),k.ecol>q.cols&&(k.ecol=q.cols));return k}var q=a,r={},s=null,p=null,y=null,I=null,J=null,L=null,G=null,M=null,F=!1,Q=null,U=null,E=null,N,w,z,H,C,B=null,
W=null,T=null,P=null,X=null,S=30,Y=S/2,v=25,A=21,O=14,V=0,aa=30,ba=-(S+Y),ca=-v,K=S+Y,Z=S/100,R=8,ea=new AnimationChain;null===(w=$("map"))&&(w=addTag("game","canvas"));w.id="map";null===(N=$("hexes"))&&(N=addTag("game","canvas"));N.id="hexes";null===(z=$("cursor"))&&(z=addTag("game","canvas"));z.id="cursor";H=addTag(null,"canvas");H.id="backbuffer";null===(C=$("unitbackbuffer"))&&(C=addTag("game","canvas"));C.id="unitbackbuffer";W=w.getContext("2d");B=N.getContext("2d");T=z.getContext("2d");P=H.getContext("2d");
X=C.getContext("2d");H.width=H.height=54;C.width=C.height=120;this.render=function(a,b,k){var f,l,r=x(a,b,k+1);a=x(a,b,k+2);var s,K=b=null;k=!1;uiSettings.hexGrid!=F&&(F=k=uiSettings.hexGrid,W.clearRect(0,0,y.width,y.height+65));null!==q.currentUnit&&(b=q.currentUnit.getPos());var R=d(r.srow,r.scol,!1),r=d(r.erow,r.ecol,!1);B.clearRect(R.x,R.y,r.x-R.x,r.y-R.y);for(r=a.srow;r<a.erow;r++)for(R=a.scol;R<a.ecol;R++)if(s=q.map[r][R],l=R&1?2*r*v+v+ca:2*r*v+ca,f=R*(S+Y)+Y+ba,null!==b&&("undefined"!==typeof b&&
r==b.row&&R==b.col)&&(m(B,f,l,hexstyle.currentstroke),m(B,f,l,hexstyle.current)),uiSettings.deployMode&&-1<s.isDeployment&&q.getPlayer(s.isDeployment).side==q.currentPlayer.side&&m(B,f,l,hexstyle.deploy),uiSettings.strategicZoom){f=f+(S-Y)/2-A/2>>0;l=l+v-O-2>>0;var K=-1,Z=0,w=null;B.save();s.isSpotted(q.currentPlayer.side)&&(w=uiSettings.airMode?s.airunit:s.unit,null!==w&&(K=w.player.country,Z=1.4,w.hasMoved&&(B.globalAlpha=0.6)));-1!=s.flag&&-1!=s.victorySide&&(K=s.flag,Z=3);-1!=K&&(B.drawImage(p,
A*K,0,A,O,f,l,Z*S,Z*S/(A/O)),B.restore())}else{if(uiSettings.showHiddenVictoryHexes){var K=f+S/2-A/2>>0,Z=l+2*v-O-2>>0,w=2,z=s.flag;-1!=s.victorySide&&(-1==z&&-1!=s.owner&&(z=q.getPlayer(s.owner).country,w=6),B.beginPath(),B.lineWidth=w,B.strokeStyle="rgba(139,0,0,1)",B.strokeRect(K-1,Z-1,A+2,O+2),B.strokeStyle="rgba(127,255,0,1)",B.strokeRect(K-3,Z-3,A+6,O+6),B.strokeStyle="rgba(0,0,0,1)",B.lineWidth=1,B.strokeRect(K-4,Z-4,A+8,O+8),B.closePath());-1!=z&&B.drawImage(p,A*z,0,A,O,K,Z,A,O)}else K=s,
-1!=K.flag&&(Z=f+S/2-A/2>>0,w=l+2*v-O-2>>0,B.drawImage(p,A*K.flag,0,A,O,Z,w,A,O),-1!=K.victorySide&&(B.beginPath(),B.lineWidth=2,B.strokeStyle="rgba(139,0,0,1)",B.strokeRect(Z-1,w-1,A+2,O+2),B.strokeStyle="rgba(127,255,0,1)",B.strokeRect(Z-3,w-3,A+6,O+6),B.strokeStyle="rgba(0,0,0,1)",B.lineWidth=1,B.strokeRect(Z-4,w-4,A+8,O+8),B.closePath()));k&&m(W,f,l,hexstyle.generic,s.terrain);K=s.getUnit(!uiSettings.airMode);null===K||(K.hasAnimation||!s.isSpotted(game.spotSide)&&!K.tempSpotted&&K.player.side!=
game.spotSide)||(uiSettings.markOwnUnits&&K.player.id==q.currentPlayer.id&&m(B,f,l,hexstyle.ownunit),g(B,f,l,K,!1));K=s.getUnit(uiSettings.airMode);null===K||(K.hasAnimation||!s.isSpotted(game.spotSide)&&!K.tempSpotted&&K.player.side!=game.spotSide)||(uiSettings.airMode&&null!==s.airunit&&m(B,f,l,hexstyle.airunit),g(B,f,l,K,!0));uiSettings.deployMode||q.currentPlayer.side!=game.spotSide||(s.isMoveSel&&(s.isSpotted(q.currentPlayer.side)?m(B,f,l,hexstyle.movespotted):m(B,f,l,hexstyle.move)),s.isAttackSel&&
m(B,f,l,hexstyle.attack));uiSettings.hasTouch&&(s.isAttackSel&&q.currentUnit)&&(f-=S/2,K=q.currentUnit,s=s.getAttackableUnit(K,uiSettings.airMode),B.drawImage(n(K,s,!1),f,l))}};this.drawCursor=function(a){var b=a.row,k=a.col,g=q.map[b][k],d=P.canvas.width,f=P.canvas.height,m=!1;E!==q.currentUnit&&(m=!0);if(g.isAttackSel&&null!==q.currentUnit&&!q.currentUnit.hasFired){if(!0==m||null===Q||null===U||Q.row!=b||Q.col!=k)m=!0,b=q.currentUnit,g=g.getAttackableUnit(b,uiSettings.airMode),E=b,Q=a,U=n(b,g,!0);
if("default"==z.style.cursor||"pointer"==z.style.cursor||"auto"==z.style.cursor||!0==m)z.style.cursor="url('"+U+"') "+d/2+" "+f/2+", auto"}else z.style.cursor="default"};this.drawHexByCell=function(a,b){var k=d(a.row,a.col,!1);m(B,k.x,k.y,b)};this.runAnimation=function(a){ea.start(a)};this.addAnimation=function(a,b,k,g){if(!(k in animationsData))return!1;"undefined"===typeof g&&(g=direction.N);k=animationsData[k];a=d(a,b);ea.add({ctx:T,x:a.x-k.width/2+S/2>>0,y:a.y-k.image.height/2+v>>0,rotate:directionToRadians[g],
sprite:k});return!0};this.moveAnimation=function(a){if(null!==a.unit){var b=new f(a);b.movTimer=setInterval(function(){b.start()},b.delay)}};this.screenToCell=function(a,b){var k,g;uiSettings.mapZoom&&(a/=uiSettings.zoomLevel,b/=uiSettings.zoomLevel);uiSettings.strategicZoom&&(a*=uiSettings.strategicZoomLevel,b*=uiSettings.strategicZoomLevel);g=Math.round((a-ba)/K+Z)-1;k=(b-ca*(~g&1))/v;k=Math.round(k/2-1*(k&1));0>k&&(k=0);k>q.rows-1&&(k=q.rows-1);g>q.cols-1&&(g=q.cols-1);return new Cell(k,g)};this.cellToScreen=
function(a,b,k){return d(a,b,k)};this.cacheImages=function(a){s||(s=new Image,s.src="resources/ui/cursors/attack.png");p||(p=new Image,p.src="resources/ui/flags/"+Equipment.name+"/flags_med.png");I||(I=new Image,I.src="resources/ui/indicators/unit-fire.png");J||(J=new Image,J.src="resources/ui/indicators/unit-fire-no-ammo.png");G||(G=new Image,G.src="resources/ui/indicators/unit-leader-axis.png");M||(M=new Image,M.src="resources/ui/indicators/unit-leader-allied.png");L||(L=new Image,L.src="resources/units/images/bridg.png");
y||(y=new Image,y.src=q.terrainImage,y.onload=function(){w.width=N.width=z.width=y.width;w.height=N.height=z.height=y.height+65;w.style.cssText=N.style.cssText=z.style.cssText="";w.style.width=N.style.width=z.style.width=y.width+"px";w.style.height=N.style.height=z.style.height=y.height+65+"px";W.imageSmoothingEnabled=!1;W.webkitImageSmoothingEnabled=!1;W.mozImageSmoothingEnabled=!1;B.imageSmoothingEnabled=!1;B.webkitImageSmoothingEnabled=!1;B.mozImageSmoothingEnabled=!1;T.imageSmoothingEnabled=!1;
T.webkitImageSmoothingEnabled=!1;T.mozImageSmoothingEnabled=!1;X.imageSmoothingEnabled=!1;X.webkitImageSmoothingEnabled=!1;X.mozImageSmoothingEnabled=!1;l();a()},y.onerror=function(){UIBuilder.message("Error",OSGlue.canvasErrorMsg)});k(q.getUnitImagesList(),a)};this.getHexesCanvas=function(){return N};this.getMapCanvas=function(){return w};this.getCursorCanvas=function(){return z};this.setNewMap=function(a){q=a;F=!1;p=y=null;a=q.getUnitImagesList();for(var b in r)"undefined"===typeof a[r[b]]&&(r[b]=
null,delete r[b])};this.positionLayers=function(){return l()}};Scenario.loader=new ScenarioLoader;Scenario.scenarioPath="resources/scenarios/data/";Scenario.getScenarioDataByFileName=function(a){for(var f=0;f<scenariolist.length;f++)if(scenariolist[f][0]==a)return scenariolist[f];return null};
function Scenario(a){this.name="";this.maxTurns=0;this.date=new Date;this.ground=this.latitude=this.atmosferic=0;this.turnsPerDay=1;this.dayTurn=0;this.reinforcements={};this.map=new Map;this.file=a;this.expPerSide=[{exp:0,count:0},{exp:0,count:0}];this.unitsCostPerSide=[0,0];this.isLoaded=!1;this.eqp="eqp-adlerkorps";var f="",d=null;"undefined"!==typeof a&&(a=Scenario.getScenarioDataByFileName(a))&&(this.name=a[1],f=a[2]);this.load=function(a){d=a;Scenario.loader.loadScenario(this)};this.onLoadFinished=
function(){if(this.isLoaded){this.setMoveTable();for(var a=this.map,f={},k=a.getPlayers(),b=0;b<k.length;b++)f[k[b].id]=a.sidesVictoryHexes[k[b].side].length*scoreGains.objectivePerTurn/a.maxTurns>>0;a=a.getUnits();for(b=0;b<a.length;b++)f[a[b].player.id]+=a[b].isCore?scoreGains.coreUnit:scoreGains.normalUnit;for(b=0;b<k.length;b++)k[b].updateScore(f[k[b].id])}d&&d()};this.addReinforcement=function(a,d,k,b){if(null===this.reinforcements[a]||"undefined"===typeof this.reinforcements[a])this.reinforcements[a]=
[];this.reinforcements[a].push({row:d,col:k,unit:b,turn:a,id:this.reinforcements[a].length+1})};this.getReinforcements=function(a,d){var k=[],b;for(b in this.reinforcements)if(!(b>a)&&null!==this.reinforcements[b]&&"undefined"!==typeof this.reinforcements[b])for(var g=0;g<this.reinforcements[b].length;g++)this.reinforcements[b][g].unit.owner==d&&k.push(this.reinforcements[b][g]);return k};this.removeReinforcement=function(a,d){if(null===this.reinforcements[a]||"undefined"===typeof this.reinforcements[a])return!1;
for(var k=0;k<this.reinforcements[a].length;k++)if(this.reinforcements[a][k].id==d)return this.reinforcements[a].splice(k,1),!0;return!1};this.checkDefeat=function(a,d){if(this.map.turn>=this.map.maxTurns&&(a==d||2==d)){var k;a:{k=this.map.getPlayers();for(var b=0;b<k.length;b++)if(k[b].side==a&&k[b].playedTurn<this.map.maxTurns){k=!1;break a}k=!0}if(k)return!0}return!1};this.checkVictory=function(){return this.map.turn<=this.map.victoryTurns[0]?"briliant":this.map.turn<=this.map.victoryTurns[1]?
"victory":this.map.turn<=this.map.victoryTurns[2]?"tactical":"lose"};this.getDescription=function(){return f};this.setDescription=function(a){f=a};this.endTurn=function(){this.dayTurn++;this.dayTurn>=this.turnsPerDay&&(this.dayTurn=0,this.date.setDate(this.date.getDate()+1));this.map.endTurn()};this.setMoveTable=function(){switch(this.ground){case groundCondition.dry:movTable=movTableDry;break;case groundCondition.frozen:movTable=movTableFrozen;break;case groundCondition.mud:movTable=movTableMud;
break;default:movTable=movTableDry}};this.getPrototypeUnitsAvailable=function(a){var d=this.date.getFullYear()+1;a=Equipment.getCountryEquipmentByYearRange(d,d,a);for(d=0;d<a.length;d++){var k=Equipment.equipment[a[d]],b=k.uclass;if((b<unitClass.tank||b>unitClass.antiTank)&&(b<unitClass.artillery||b>unitClass.tacticalBomber)||k.cost*CURRENCY_MULTIPLIER<PROTOTYPE_MIN_COST)a.splice(d,1),d--}return a};this.getRandomPrototype=function(a){a=this.getPrototypeUnitsAvailable(a);var d=Math.random()*a.length>>
0;return a[d]};this.getBalancedPrestige=function(a){a=SCENARIO_START_PRESTIGE+this.unitsCostPerSide[+!a]-this.unitsCostPerSide[a];a<SCENARIO_START_PRESTIGE&&(a=SCENARIO_START_PRESTIGE);return a};this.getSideUnitsAvgExp=function(a){return Math.round(this.expPerSide[a].exp/+this.expPerSide[a].count||0)};this.showStatistics=function(){};this.copy=function(a){this.maxTurns=a.maxTurns;this.date=new Date(a.date);this.atmosferic=a.atmosferic;this.latitude=a.latitude;this.ground=a.ground;this.turnsPerDay=
a.turnsPerDay;this.eqp=a.eqp;if(a.reinforcements)for(t in a.reinforcements)for(var d=0;d<a.reinforcements[t].length;d++){var k=new Unit(a.reinforcements[t][d].unit.eqid);k.copy(a.reinforcements[t][d].unit);this.addReinforcement(t,a.reinforcements[t][d].row,a.reinforcements[t][d].col,k)}this.map.copy(a.map);this.file=a.file;this.setMoveTable()}};Campaign.findCampaignByFile=function(a){for(var f=0;f<campaignlist.length;f++)if(campaignlist[f].file===a)return f;return-1};
function Campaign(a,f,d){var l=campaignlist[a];this.startprestige=l.prestige+difficultyModifiers[f].startPrestige*l.prestige>>0;this.name=l.title;this.country=l.flag;this.file=l.file;this.id=a;this.difficulty=f;var n=0,k=null;this.isLoaded=!1;(function(a,g){if(null==a||"undefined"===typeof a)return null;var d=new XMLHttpRequest,f=function(){k=JSON.parse(d.responseText);this.isLoaded=!0;g()};d.onload=function(){4===d.readyState&&(200===d.status||0===d.status?f():g())};d.open("GET","resources/campaigns/data/"+
a,!0);d.send(null)})(l.file,d);this.setScenarioById=function(a){a<k.length&&(n=a)};this.setScenarioByName=function(a){var g;g=a.lastIndexOf("/");-1<g&&(a=a.substring(g+1));for(g=0;g<k.length;g++)if(k[g].scenario===a)return n=g,!0;return!1};this.getCurrentScenario=function(){return k[n]};this.loadNextScenario=function(a){a=k[n].outcome[a];return a.goto<k.length?(n=a.goto,k[a.goto]):null};this.getOutcomePrestige=function(a){return k[n].outcome[a].prestige};this.getOutcomeText=function(a){return k[n].outcome[a].text||
"Continue to the next phase."};this.getCampaignFlow=function(){for(var a="",g=0;g<k.length;g++)var d=this.getScenarioNameFromId(g),f=this.getScenarioNameFromId(k[g].outcome.lose.goto),l=this.getScenarioNameFromId(k[g].outcome.tactical.goto),r=this.getScenarioNameFromId(k[g].outcome.victory.goto),n=this.getScenarioNameFromId(k[g].outcome.briliant.goto),a=l==r&&r==n?a+("- <b>"+d+"</b><br/>&nbsp;&nbsp;&nbsp;&nbsp;Lose: "+f+"<br/>&nbsp;&nbsp;&nbsp;&nbsp;Victory: "+l+"<br/><br/>"):a+("- <b>"+d+"</b><br/>&nbsp;&nbsp;&nbsp;&nbsp;Lose: "+
f+"<br/>&nbsp;&nbsp;&nbsp;&nbsp;Tactical: "+l+"<br/>&nbsp;&nbsp;&nbsp;&nbsp;Victory: "+r+"<br/>&nbsp;&nbsp;&nbsp;&nbsp;Brilliant: "+n+"<br/><br/>");return a};this.getScenarioNameFromId=function(a){return 255==a?"Defeat (End Campaign)":254==a?"Victory (End Campaign)":Scenario.getScenarioDataByFileName(k[a].scenario)[1]};this.getCampaignData=function(){return k}};var UIBuilder=function(a){function f(k,b){if(k)return!1;var g=!1,d="(Scenario) ";null!==game.campaign&&(d="(Campaign) ");for(var d=d+(game.scenario.name+" Turn "+game.scenario.map.turn),f=0;f<uiSettings.lastCloudSave.length;f++)if(uiSettings.lastCloudSave[f].id==b){uiSettings.lastCloudSave[f].name=d;g=!0;break}g||(2<uiSettings.lastCloudSave.length&&uiSettings.lastCloudSave.shift(),uiSettings.lastCloudSave.push({name:d,id:b}));game.state.saveSettings();a.fillCloudSavesList();return!0}function d(){$("diskloaderror").textContent=
"Error loading game. Cannot parse save game data."}function l(){makeHidden("smState");makeHidden("smMain");$("diskloaderror").textContent="";game.ui.startMenuButton("continuegame")}a.startMenuImgPath="resources/ui/dialogs/startmenu/images/";a.menuImgPath="resources/ui/menu/images/";a.eqImgPath="resources/ui/dialogs/equipment/images/";a.currencyIcon="<img src='"+a.eqImgPath+"currency.png'/>";a.navalReplacementIcon="resources/units/images/le211.png";a.eqClassButtons={9:["*","Air defence"],4:["/","Anti-tank"],
8:[")","Artillery"],1:["(","Infantry"],3:["=","Recon"],2:["]","Tank"],10:["%","Air Fighter"],11:["4","Air Bomber"]};a.unitContextButtons={mount:"[",embark:"2",resupply:"!",reinforce:"#",overstrength:"J",undo:"_"};a.unitstats=[["uCost","Unit price",1,"cost","B",0],["uStr","Unit strength",0,null,":",0],["uFuel","Unit fuel",0,"fuel",";",0],["uAmmo","Unit Ammo",1,"ammo","<",0],["uGunRange","Firing range",1,"gunrange",">",0],["uMovement","Movement range",1,"movpoints","?",0],["uExp","Combat Experience",
0,null,"@",0],["uEnt","Entrenchment",0,null,'"',0],["uIni","Combat initiative",1,"initiative","|",0],["uSpot","Spotting range",1,"spotrange","'",0],["uAHard","Power vs Hard targets",1,"hardatk","{",0],["uASoft","Power vs Soft targets",1,"softatk","$",0],["uAAir","Power vs Air targets",1,"airatk","&",0],["uANaval","Power vs Naval targets",1,"navalatk","}",0],["uDHard","Defence vs ground attacker",1,"grounddef","5",0],["uDAir","Defence vs air attacker",1,"airdef","3",0],["uDClose","Defence in close combat",
1,"closeddef","6",0],["uDRange","Defence in ranged combat",1,"rangedefmod","7",0],["uMoveType","Movement type",0,null,"~",0],["uTarget","Target type",0,null,"`",0],["uLeader","See unit leader",0,null,null,1],["uTransport","See unit/transport",0,null,null,1],["uCarrier","See naval/air carrier",0,null,null,1],["uNext","Go to next unit",0,null,null,1],["uFlag","country flag",0,null,null,0]];a.smallToolTipList=[];var n=[["gameToolTip",null],["ui-message",null],["startmenu",null],["statusbar",0],["statusbar-extension",
25],["menu",null],["unit-context",-95],["unit-info",-70],["container-unitlist",30],["equipment",125],["combatLog",25],["combatLogButton",25],["statusBarButton",15],["unitsBarButton",95],["dossier",25],["uiToolTip",null]];a.flagStyleSheets=[];a.buildStartMenu=function(){var k=[["newgame","New Game"],["settings","Settings"],["saveload","Save / Load"],["continuegame","Continue Game"]],b=[["newcampaign","Campaigns","Lead your troops to victory over multiple scenarios. Troops gain experience and leaders which will carry over next scenarios. Campaign flow depends on how quickly player conquers all objectives. "],
["newscenario","Scenarios","Play a single scenario. Most scenarios are designed  for campaign mode, this mode is recommended for players that want to learn the specifics of scenarios or try different things. "],["tutorial","Tutorial","Learn the basic mechanics of the game. First turns are automatically played by the computer but later the control is given to the player."]],g=[[difficultyType.historical,"Historical",0],[difficultyType.tactical,"Tactical",1],[difficultyType.operational,"Operational",
0]],d=[["showGridTerrain","Show terrain with Hex Grid"],["quickAnimation","Quick combat and move animations"],["muteUnitSounds","Mute unit combat sounds"],["noFOW","Disable Fog of War"],["useRetina","Zoom to full device resolution"],["markOwnUnits","Mark own units on map"],["markEnemyUnits","Mark enemy strength in red"],["showDetailInfoToolTips","Show optional objectives tooltips"],["showHiddenVictoryHexes","Show hidden victory hexes"]],f,l;isDesktop()&&($("smClose").style.display="inline",$("smClose").onclick=
function(){nw.Window.get().close()});for(f=0;f<k.length;f++)l=addTag("smButtons","div"),l.id=k[f][0],l.title=k[f][1],l.className="smMainButton",l.textContent=k[f][1],l.onclick=function(){game.ui.startMenuButton(this.id)};for(f=0;f<b.length;f++)k=addTag("smNewGameContent","div"),k.className="newGameContainer",f<b.length-1&&(k.style.marginRight="15px"),l=addTag(k,"div"),l.id=b[f][0],l.title=b[f][1],l.className="smMainButtonLight",l.textContent=b[f][1],l.style.margin="0px auto",l.onclick=function(){game.ui.startMenuButton(this.id)};
$("smLogoText").innerHTML="version "+VERSION;$("smCredits").innerHTML="Copyright Nicu Pavel";f=addTag("smCampSel","select");for(b=0;b<campaignlist.length;b++)l=addTag(f,"option"),l.value=b,l.text=campaignlist[b].title;l=addTag($("smCampDif"),"select");l.id="smCampDifSel";l.style.fontSize="14px";l.style.fontWeight="normal";l.style.color="#f8e064";l.style.height="26px";for(b=0;b<g.length;b++)addSelectOption(l,g[b][1],g[b][0],g[b][2]);$("smCampDifHelp").onclick=function(){var a;a="Historical - Highest difficulty<br>Tactical - Medium difficulty +20% starting prestige, +10% starting prestige per turn, +20% extra turns, -20% score.<br>Operational - Lowest difficulty + 50% starting prestige, +25% starting prestige per turn, +50% extra turns. -50% score";
$("smCampDesc").innerHTML=a};f.onchange=function(){var b=this.options[this.selectedIndex].value;$("smCampDesc").innerHTML=campaignlist[b].desc;$("smCampCountry").innerHTML="<b>Country</b><br/>"+Equipment.getCountryNameByEqp(campaignlist[b].flag,campaignlist[b].eqp);$("smCampScenarios").innerHTML="<b>Scenarios</b><br/>"+campaignlist[b].scenarios;$("smCampPrestige").innerHTML="<b>Start prestige</b><br/>"+campaignlist[b].prestige+"&nbsp;"+a.currencyIcon;$("smCamp").selectedCampaign=b};$("smCBackBut").onclick=
function(){makeHidden("smCamp");makeVisible("smMain")};$("smCPlayBut").onclick=function(){var a=$("smCamp").selectedCampaign,b=$("smCampDifSel"),b=b.options[b.selectedIndex].value;a&&(game.newCampaign(a,b),makeHidden("gameToolTip"),makeHidden("smCamp"),makeHidden("startmenu"),toggleButton($("options"),!1),game.state.saveSettings())};$("smCFlowBut").onclick=function(){var a=$("smCamp").selectedCampaign,b=new Campaign(a,difficultyType.historical,function(){$("smCampDesc").innerHTML=b.getCampaignFlow()})};
DEBUG_CAMPAIGN&&($("smCV").onclick=function(){makeHidden("smCamp");makeHidden("startmenu");game.continueCampaign("victory")},$("smCVB").onclick=function(){makeHidden("smCamp");makeHidden("startmenu");game.continueCampaign("briliant")},$("smCVT").onclick=function(){makeHidden("smCamp");makeHidden("startmenu");game.continueCampaign("tactical")},$("smCL").onclick=function(){makeHidden("smCamp");makeHidden("startmenu");game.continueCampaign("lose")});g=addTag("smScenSel","select");for(b=0;b<scenariolist.length;b++)f=
addTag(g,"option"),1==scenariolist[b].length?(f.disabled=!0,f.text="\u00bb\u00a0"+scenariolist[b][0]):(f.value=b,f.text="\u00a0\u00a0\u00a0\u00a0"+scenariolist[b][1]);g.onchange=function(){var b=this.options[this.selectedIndex].value;$("smScenDesc").innerHTML=scenariolist[b][2];clearTag("smSide0");$("smVS").innerHTML="VS";clearTag("smSide1");a.setEquipmentFlags(scenariolist[b][5]);for(var k=0;1>=k;k++){var g=scenariolist[b][3+k],d="smSide"+k,f=addTag(d,"div");f.className="smSideHeader";f.innerHTML=
sideNames[k];addTag(f,"img").src=a.startMenuImgPath+"side"+k+".png";for(f=0;f<g.length;f++){var m=addTag(d,"div");m.className="smPlayerContainer";var l=addTag(m,"div");l.className="playerCountry";l.style.backgroundPosition=""+-21*g[f].country+"px 0px";l=addTag(m,"div");l.className="playerName";l.innerHTML=Equipment.getCountryNameByEqp(g[f].country,scenariolist[b][5]);m=addTag(m,"div");uiSettings.isAI[g[f].id]?(m.innerHTML="d",uiSettings.isAI[g[f].id]=1):m.innerHTML="D";m.id="ai"+g[f].id;m.playerid=
g[f].id;m.className="smallButton right";m.style.marginRight="5px";m.onclick=function(){uiSettings.isAI[this.playerid]=uiSettings.isAI[this.playerid]?0:1;toggleCheckbox(this)}}}$("smScen").selectedScenario=b};$("smSBackBut").onclick=function(){makeHidden("smScen");makeVisible("smMain");a.setEquipmentFlags(game.scenario.eqp)};$("smSPlayBut").onclick=function(){var a=$("smScen").selectedScenario;a&&(game.campaign=null,game.newScenario(scenariolist[a][0],scenariolist[a][2]),makeHidden("gameToolTip"),
makeHidden("smScen"),makeHidden("startmenu"),toggleButton($("options"),!1),game.state.saveSettings())};a.resizeUI(uiSettings.uiSize);a.scaleUI(uiSettings.uiScale);a.setLayoutConstrains(!1);k=addTag("smSettingsContainer","div");k.className="settingContainer left";l=addTag(k,"div");l.className="settingText left";l.textContent="Interface width (px)";l=addTag(k,"div");l.style.float="right";a.createSlider(l,"uiresize",uiSettings.uiSize,10,uiSettings.uiSmallSize,1920,function(){a.resizeUI($("uiresize").value)});
k=addTag("smSettingsContainer","div");k.className="settingContainer left";l=addTag(k,"div");l.className="settingText left";l.textContent="Interface scale";l=addTag(k,"div");l.style.float="right";a.createSlider(l,"uiscale",uiSettings.uiScale,0.1,0.5,3,function(){a.scaleUI($("uiscale").value)});k=addTag("smSettingsContainer","div");k.className="settingContainer left";l=addTag(k,"div");l.className="settingText left";l.textContent="Game Map scale";l=addTag(k,"div");l.style.float="right";a.createSlider(l,
"mapscale",uiSettings.zoomLevel,0.1,1,3,function(){game.ui.scaleMap($("mapscale").value)});for(f=0;f<d.length;f++)k=addTag("smSettingsContainer","div"),k.className="settingContainer left",l=addTag(k,"div"),l.title=d[f][1],l.className="settingText left",l.textContent=d[f][1],l=addTag(k,"div"),l.id=d[f][0],l.className="settingValue right",l.innerHTML=uiSettings[d[f][0]]?"C":"c",l.onclick=function(){uiSettings[this.id]=!uiSettings[this.id];toggleCheckbox(this);"useRetina"==this.id&&($("smSettings").needPageReload=
!0,1<=window.devicePixelRatio&&(uiSettings.useRetina&&1>=uiSettings.uiScale&&($("uiscale").value=1.6),!uiSettings.useRetina&&1.5<=uiSettings.uiScale&&($("uiscale").value=1)))};$("smSetOkBut").onclick=function(){makeHidden("smSettings");makeVisible("startmenu");a.resizeUI($("uiresize").value);a.scaleUI($("uiscale").value);game.state.saveSettings();$("smSettings").needPageReload&&location.reload(!0);$("smSettings").messageHidden&&makeVisible("ui-message")};a.buildGameStateMenu()};a.buildGameStateMenu=
function(){for(var k,b,g=[["disksave","Save to Disk <a id='savedata' hidden download='none'></a>"],["diskload",OSGlue.diskloadHTML],["cloudsave","Cloud Save"],["cloudload","Cloud Load"]],d=["<b>Last saved to disk</b> <div id='disksaveupdate'> none</div><hr>","<input type='text' id='cloudid' style='-webkit-user-select:text;' placeholder='Enter numeric ID to Load from Cloud'><br><b>Last known cloud saves</b><div class='hcenter blackBoxBorder' id='cloudid_lastsaves'></div><div id='diskloaderror' class='smStateDesc'></div>"],
f=0;f<g.length;f++)0==f%2&&(k=addTag("smState","div"),k.className="smCenter"),b=addTag(k,"div"),b.id=g[f][0],b.className="smMainButton",b.innerHTML=g[f][1],"diskload"==b.id?OSGlue.diskloadEvent(b,function(){a.gameStateButton("diskload")}):b.onclick=function(){a.gameStateButton(this.id)},1==f%2&&(b=addTag("smState","div"),b.className="smStateDesc",b.innerHTML=d[(f-1)/2]);a.fillCloudSavesList();$("smStOkBut").onclick=function(){makeHidden("smState");makeVisible("smMain");$("diskloaderror").textContent=
""}};a.fillCloudSavesList=function(){clearTag("cloudid_lastsaves");defined(uiSettings.lastCloudSave)&&0<uiSettings.lastCloudSave.length&&($("cloudid").value=uiSettings.lastCloudSave[uiSettings.lastCloudSave.length-1].id);for(var a=0;3>a;a++)div=addTag($("cloudid_lastsaves"),"div"),div.style.height="22px",defined(uiSettings.lastCloudSave)&&uiSettings.lastCloudSave.length>a?(div.textContent=uiSettings.lastCloudSave[a].name,div.cloudid=uiSettings.lastCloudSave[a].id,div.onclick=function(){$("cloudid").value=
this.cloudid}):(div.textContent="",div.onclick=function(){$("cloudid").value=""})};a.gameStateButton=function(a){switch(a){case "disksave":a=new Date;a=a.toDateString()+" "+a.toLocaleTimeString();var b;b=null!==game.campaign?"(Campaign) ":"(Scenario) ";b+=game.scenario.name+" Turn "+game.scenario.map.turn+" "+a+".json";OSGlue.disksave(b);break;case "diskload":OSGlue.diskload(l,d);break;case "cloudsave":game.state.saveToCloud($("cloudid"),f);break;case "cloudload":game.state.restoreFromCloud($("cloudid"),
l)}};a.buildMainMenu=function(){for(var a=[["inspectunit","Inspect Unit","i",0,0],["endturn","End Turn","t",0,0],["mainmenu","Main  Menu","o",1,0],["buy","Upgrade/Buy Units","w",0,1],["hex","Toggle Hex Grid","h",0,1],["air","Toggle Air Mode On","p",0,1],["zoom","Strategic Map","m",0,1],["options","Options","s",0,1]],b=0;b<a.length;b++){var g;g=a[b][4]?addTag("slidemenu","div"):insertTag("menu","div","slidemenu");g.id=a[b][0];g.title=a[b][1];g.className="smallButtonMenu";"endturn"===a[b][0]&&(g.className+=
" smallButtonEndTurn");g.style.marginTop="3px";g.innerHTML=a[b][2];g.onclick=function(){game.ui.mainMenuButton(this.id)};a[b][3]&&(g.hasSelectedGlyph=!0)}$("combatLogButton").hasSelectedGlyph=!0;$("statusbar").onclick=$("combatLogButton").onclick=function(){UICombatLog.toggleCombatLog(!1,!0)};$("statusBarButton").onclick=function(){game.ui.toggleUnitsAndEquipmentWindow(!1)};$("unitsBarButton").onclick=function(){makeHidden("unitsBarButton");makeVisible("equipment")}};a.setDefaultUserSelections=function(){$("eqSelCountry").country=
0;$("eqSelCountry").owner=0;$("eqUserSel").deployunit=-1;$("eqUserSel").userunit=-1;$("eqUserSel").equnit=-1;$("eqUserSel").eqtransport=-1;$("eqUserSel").sortorder=0;$("eqUserSel").sortproperty="cost"};a.buildEquipmentWindow=function(){a.setDefaultUserSelections();$("eqSortOrderBut").title="Click to change sorting order ascending/descenting";$("eqSortOrderBut").hasSelectedGlyph=!0;$("eqSortOrderBut").onclick=function(){var a=$("eqUserSel").sortorder||0,a=~a&1;$("eqUserSel").sortorder=a;game.ui.updateEquipmentWindow($("eqUserSel").eqclass);
toggleButton($("eqSortOrderBut"),a)};$("eqSortOptionsBut").title="Click to change sort category";$("eqSortOptionsBut").hasSelectedGlyph=!0;$("eqSortOptionsBut").onclick=function(){isVisible("eqSortOptions")?(makeHidden("eqSortOptions"),makeVisible("eqButtonsContainer"),toggleButton($("eqSortOptionsBut"),!1)):(makeHidden("eqButtonsContainer"),makeVisible("eqSortOptions"),toggleButton($("eqSortOptionsBut"),!0))};for(var d in a.eqClassButtons){var b=addTag("eqSelClass","div");b.className="smallButtonSubMenu";
b.title=a.eqClassButtons[d][1];b.id="eqclass-"+d;b.eqclass=d;b.innerHTML=a.eqClassButtons[d][0];b.onclick=function(){$("eqUserSel").userunit=-1;$("eqUserSel").equnit=-1;$("eqUserSel").eqtransport=-1;game.ui.updateEquipmentWindow(this.eqclass)}}$("eqSelCountry").title="Click to change country";$("eqSelCountry").onclick=function(){game.ui.equipmentWindowButtons("changecountry")};$("eqNewBut").title="Buy unit as a new unit";$("eqNewBut").onclick=function(){game.ui.equipmentWindowButtons("buy")};$("eqUpgradeBut").title=
"Upgrade selected unit to this unit";$("eqUpgradeBut").onclick=function(){game.ui.equipmentWindowButtons("upgrade")};$("eqSellBut").title="Disband and sell this unit";$("eqSellBut").onclick=function(){game.ui.equipmentWindowButtons("sell")};$("eqCloseBut").title="Close";$("eqCloseBut").onclick=function(){makeHidden("equipment");isVisible("container-unitlist")&&makeVisible("unitsBarButton")}};a.buildEquipmentSortOptions=function(){$("eqSortInfo").innerHTML="Sort equipment by: ";for(var d=0;d<a.unitstats.length;d++)a.unitstats[d][2]&&
a.unitstats[d][3]&&(div=addTag("eqSortOptionsContainer","div"),div.title=a.unitstats[d][1],div.id="eqsort-"+a.unitstats[d][3],div.className="smallButtonSubMenu",div.style.marginRight="0px",div.sortproperty=a.unitstats[d][3],div.innerHTML=a.unitstats[d][4],div.onclick=function(){$("eqSortOptions").style.display="none";var a=$("eqUserSel").sortproperty||"cost";toggleButton($("eqsort-"+a),!1);$("eqUserSel").sortproperty=this.sortproperty;toggleButton($("eqsort-"+this.sortproperty),!0);game.ui.updateEquipmentWindow($("eqUserSel").eqclass);
$("eqSortInfo").innerHTML="Sorted by: "+this.title;$("eqSortOptions").style.display="inline"});$("eqSortCloseBut").title="Close sorting options";$("eqSortCloseBut").onclick=function(){makeHidden("eqSortOptions");makeVisible("eqButtonsContainer")}};a.buildUnitInfoWindow=function(){var d=addTag("statsRow","div");d.id="uImageBg";d=addTag("uImageBg","div");d.id="uImage";for(var b=0;b<a.unitstats.length;b++)"uCost"!=a.unitstats[b][0]&&(d=a.unitstats[b][5]?addTag("statsRowTop","div"):addTag("statsRow",
"div"),null!==a.unitstats[b][4]&&(d.title=a.unitstats[b][1],d.className="statsGlyph",d.textContent=a.unitstats[b][4],d=addTag(d,"div")),d.id=a.unitstats[b][0],d.className="statsText")};a.showEquipmentCosts=function(d,b,g,f){0<b&&b<=d?($("eqNewText").innerHTML="Buy ",$("eqNewCost").innerHTML=b+a.currencyIcon,$("eqNewBut").style.display="inline"):(b>d?(b-=d,$("eqNewText").innerHTML="<span style='color:#BB7575'>Need "+b+" more prestige to buy.</span>"):$("eqNewText").textContent="",$("eqNewBut").style.display=
"none",$("eqNewCost").textContent="");0<g&&g<=d?($("eqUpgradeText").innerHTML=" Upgrade ",$("eqUpgradeCost").innerHTML=g+a.currencyIcon,$("eqUpgradeBut").style.display="inline"):(g>d?(b=g-d,$("eqUpgradeText").innerHTML="<span style='color:#BB7575'>Need "+b+" more prestige to upgrade.</span>"):$("eqUpgradeText").textContent="",$("eqUpgradeBut").style.display="none",$("eqUpgradeCost").textContent="");0<f?($("eqSellText").innerHTML=" Sell ",$("eqSellCost").innerHTML=f+a.currencyIcon,$("eqSellBut").style.display=
"inline"):($("eqSellBut").style.display="none",$("eqSellCost").textContent="",$("eqSellText").textContent="");800<=window.innerWidth?$("currentPrestige").textContent="Available Prestige: ":$("currentPrestige").textContent="Now: ";$("currentPrestigeAmount").innerHTML=d+a.currencyIcon};a.showAttackInfo=function(a,b){var d=a.unitData(),f=b.unitData(),l;clearTag($("statusmsg"));l=addTag($("statusmsg"),"div");l.className="playerCountry";l.style.marginTop="0px";l.style.backgroundPosition=""+-21*(a.flag-
1)+"px 0px";l=addTag($("statusmsg"),"div");l.className="combatInfoStatusBar";l.innerHTML="<b>"+d.name+"</b> "+unitClassNames[d.uclass];l=addTag($("statusmsg"),"div");l.style.cssFloat="left";l.style.fontFamily="openpanzer";l.style.fontSize="18px";l.innerHTML="&nbsp!&nbsp;";l=addTag($("statusmsg"),"div");l.className="playerCountry";l.style.marginTop="0px";l.style.backgroundPosition=""+-21*(b.flag-1)+"px 0px";l=addTag($("statusmsg"),"div");l.className="combatInfoStatusBar";l.innerHTML="<b>"+f.name+"</b> "+
unitClassNames[f.uclass]};a.showAIStatus=function(a){a?(makeVisible("statusbar-extension"),$("statusbar-extension").className="statusbar-extension-animation",$("statusbar-extension").innerHTML="Computer turn in progress"):(makeVisible("statusbar-extension"),$("statusbar-extension").className="statusbar-extension-animation-reverse",$("statusbar-extension").style.top="-20px",$("statusbar-extension").innerHTML="<span style='color: #33ccff'> Finished computer turn ! </span>")};a.scaleUI=function(a){if("zoom"in
document.body.style)for(var b=0;b<n.length;b++)$(n[b][0]).style.zoom=a;else for(b=0;b<n.length;b++){var d=$(n[b][0]),f="scale("+a+","+a+")";d.style.webkitTransform=f;d.style.MozTransform=f;d.style.transform=f;"menu"==n[b][0]||"startmenu"==n[b][0]||"ui-message"==n[b][0]?(d.style.webkitTransformOrigin="50% 50%",d.style.mozTransformOrigin="50% 50%",d.style.transformOrigin="50% 50%"):(d.style.webkitTransformOrigin="50% 0",d.style.mozTransformOrigin="50% 0",d.style.transformOrigin="50% 0");f=Math.round(n[b][1]*
a);null!==n[b][1]&&0<=n[b][1]&&(d.style.top=f+"px");null!==n[b][1]&&0>n[b][1]&&(d.style.marginTop=f+"px")}uiSettings.uiScale=a};a.createSlider=function(a,b,d,f,l,n,r){function s(a){var d=parseFloat($(b).value),d=d+a;d<l&&(d=l);d>n&&(d=n);0!=d%1&&(d=d.toFixed(1));$(b).value=d}var p;p=addTag(a,"div");p.className="smallButton";p.style.cssFloat="left";p.style.marginBottom="5px";p.innerHTML="-";p.onclick=function(){s(-f);r&&r()};p=addTag(a,"div");p.style.cssFloat="left";p.style.marginTop="5px";p.innerHTML=
"<input type='text' id='"+b+"' style='-webkit-user-select:text; width:80px;' value='"+d+"'>";p=addTag(a,"div");p.className="smallButton";p.style.cssFloat="left";p.innerHTML="+";p.onclick=function(){s(f);r&&r()}};a.resizeUI=function(a){for(var b="statusbar unit-info container-unitlist equipment combatLog dossier".split(" "),d=a,f=0;f<b.length;f++){var l=$(b[f]);"combatLog"==b[f]&&(d=0.95*d>>0);l.style.width=d+"px";l.style.marginLeft=-(d/2>>0)+"px"}uiSettings.uiSize=a};a.setLayoutConstrains=function(a){800>
window.innerWidth&&($("eqInfoText").style.width="0px",$("eqSortInfo").style.width="0px",$("eqSortInfo").style.height="0px",$("eqSelClass").style.marginLeft="0px",$("menu").style.right="1px",n[9][1]=112,$("equipment").style.top="112px",$("eqUpgradeText").style.display="none",$("eqNewText").style.display="none",$("eqSellText").style.display="none",a&&(840==uiSettings.uiSize&&1==uiSettings.uiScale)&&(uiSettings.uiSize=uiSettings.uiSmallSize,uiSettings.uiScale=0.9))};a.message=function(a,b,d){$("title").innerHTML=
a;$("message").innerHTML=b;makeVisible("ui-message");$("message").scrollTop=0;game.uiMessageClicked=!1;"function"!==typeof d?$("uiokbut").onclick=function(){makeHidden("ui-message");game.uiMessageClicked=!0}:$("uiokbut").onclick=d};a.messageDynamic=function(a,b){var d=$("mainbody"),f=addTag(d,"div"),d=addTag(f,"div"),l=addTag(f,"div"),n=addTag(f,"div");f.className="uiMessageBox";f.id="uiMessageBoxDynamic";f.style.zIndex="98";d.className="uiMessageBoxTitle";l.className="uiMessageBoxBody";n.className=
"smallButton uiMessageBoxButton";d.innerHTML=a;l.innerHTML=b;n.innerHTML="1";makeVisible("uiMessageBoxDynamic");n.onclick=function(){clearTag(f);delTag(f)}};a.showPrototypeAwardMessage=function(d){var b="<br>Due to your brilliant tactical performance on previous battle High Command awarded you a prototype core unit available for deployment.";d=Equipment.equipment[d];"undefined"!==typeof d&&d&&(b+="<div class='uImageAnimation' style='margin-left: 120px;background-image: url("+d.icon+")'></div><b>"+
d.name+" "+unitClassNames[d.uclass]+"</b>");a.messageDynamic("You have been awarded a prototype unit",b)};a.gameToolTip=function(a,b,d){var f=$("gameToolTip");f.setAttribute("type","game");f.style.top=d-55+"px";f.style.left=b+55+"px";$("gameToolTipMessage").innerHTML=a;f.setAttribute("orientation","left");makeVisible("gameToolTip");$("gameToolTipOk").onclick=function(){makeHidden("gameToolTip");game.waitUIAnimation=!1}};a.gameSmallToolTip=function(d,b,f,l,n,q){var r=$("game"),r=addTag(r,"div");defined(n)||
(n="gstt"+a.smallToolTipList.length);r.id=n;r.className="smallToolTip";r.setAttribute("orientation","bottom");defined(l)&&l==tooltipColor.enemy&&(r.style.color="#F8F864");defined(q)&&q==tooltipStyle.pin?(r.setAttribute("shape","pin"),r.style.top=f-15+"px",r.style.left=b-8+"px"):(r.style.top=f-15+"px",r.style.left=b-38+"px");r.style.display="inline";r.innerHTML=d;a.smallToolTipList.push(n);r.onclick=function(){var b=a.smallToolTipList.indexOf(this.id);a.smallToolTipList.splice(b,1);delTag(this)}};
a.uiToolTip=function(a,b,d,f){var l=$("uiToolTip");l.setAttribute("type","ui");l.style.top=d+"px";l.style.left=b+"px";$("uiToolTipMessage").innerHTML=a;f?l.setAttribute("orientation","right"):l.setAttribute("orientation","left");makeVisible("uiToolTip");l.onclick=function(){makeHidden("uiToolTip")}};a.uiToolTipAtElement=function(d,b,f){var l=$("uiToolTip");a.uiToolTip(b,0,0,f);d=getCoordinates(d);a.uiToolTip(b,d.x-l.clientWidth-5,d.y,f)};a.unitIDToOrdinal=function(a){var b=a%10;return 0>a?"":0==a?
"101st":1==b&&11!=a?a+"st":2==b&&12!=a?a+"nd":3==b&&13!=a?a+"rd":a+"th"};a.simulateDossier=function(){for(var a=game.scenario.map.currentPlayer,b=a.dossier,d=game.scenario.map.getUnits(),f=0;f<d.length;f++)0.5<Math.random()&&a.addDestroyedUnitToDossier(d[f]);d=game.campaign.getCampaignData();for(f=0;f<d.length;f++){var l=Math.floor(3*Math.random()),l=0==l?"victory":1==l?"tactical":"briliant",n=game.campaign.getScenarioNameFromId(f);a.addOutcomeToDossier(l,n)}return b};a.showCampaignEnd=function(d,
b,f){if(!a.showDossier(!1,f))return!1;var l=$("dossierCampaign");f=addTag(l,"div");var n=addTag(l,"div"),q=addTag(l,"div");addTag(l,"br");l="resources/ui/dossier/campaign_victory.png";f.style.fontSize="40px";f.style.fontWeight="bold";n.style.letterSpacing="10px";n.style.marginBottom="10px";n.style.fontSize="12px";n.textContent="CAMPAIGN FINISHED";"lose"===d?(f.textContent="Defeat",f.style.color="red",l="resources/ui/dossier/campaign_defeat.png"):(f.textContent="Victory",f.style.color="white");q.className=
"hcenter";q.style.color="white";q.style.width="80%";q.innerHTML=b;$("dossier").style.backgroundImage="url('"+l+"')";$("dossier").style.backgroundRepeat="no-repeat";$("dossier").style.backgroundSize="cover";return!0};a.showDossier=function(d,b){if(null===game.campaign)return!1;var f=$("dossier");clearTag(f);d?(insertTemplate("template__dossier",f),f.style.top="25px",f.style.borderTopLeftRadius="0",f.style.borderTopRightRadius="0",f.style.zIndex="200"):(insertTemplate("template__dossier_scroll",f),
insertTemplate("template__dossier",$("dossierScroll")),f.style.top="50%",f.style.borderRadius="5px",f.style.zIndex="290");f.style.display="block";var l=game.getCampaignPlayer(),n=l.dossier;n.hasOwnProperty("units")||l.initDossier();$("dossierTitle").textContent=game.campaign.name+" "+l.getCountryName()+" Campaign";$("dossierTitle").className="combatLogHeader";game.campaign.getCurrentScenario();game.campaign.getCampaignData();for(var q in a.eqClassButtons)l=addTag("dossierClasses","td"),l.className=
"combatLogHeader",l.style.fontFamily="openpanzer-menu",l.style.fontWeight="bold",l.style.fontSize="26px",l.title=a.eqClassButtons[q][1],l.textContent=a.eqClassButtons[q][0],addTag("dossierDestroyed","td").textContent=n.units.killed[q],addTag("dossierLostCore","td").textContent=n.units.lostcore[q],addTag("dossierLostAux","td").textContent=n.units.lostaux[q];q=!1;for(var r in{briliant:0,victory:1,tactical:2,lose:3})if(!(1>n.outcomes[r].length)){l=addTag("dossierMedals","div");l.textContent=outcomeNames[r];
l.style.fontSize="16px";l.style.textAlign="left";l.style.paddingLeft="10%";addTag("dossierMedals","hr");var l=addTag("dossierMedals","div"),s=addTag(l,"div"),l=addTag(l,"div");s.style.display="inline-block";s.style.width="40%";s.style.verticalAlign="top";if("lose"!==r){q=!0;var p=addTag(s,"img"),s=addTag(s,"div");s.className="counterBox";s.textContent=n.outcomes[r].length;p.src="resources/ui/dossier/"+game.campaign.country+"_"+r+".png";p.style.height="150px"}l.style.display="inline-block";l.style.color=
"#33ccff";l.style.fontSize="12px";l.style.textAlign="justify";l.style.width="55%";s="";for(p=0;p<n.outcomes[r].length;p++)s+=n.outcomes[r][p]+"<br>";l.innerHTML=s}q||($("dossierMedals").innerHTML="You have no medals awarded yet. <br><br>");n=getPosition("unit-info");d?(n=Math.round((n.top-30)/uiSettings.uiScale),r=f):(r=$("dossierScroll"),n=Math.round((n.bottom-70)/uiSettings.uiScale),$("dossierCloseBut").onclick=function(){a.closeDossier();defined(b)&&b()});r=r.childNodes[r.childNodes.length-1];
r=r.offsetTop+r.offsetHeight;n>r&&(n=r);f.style.marginTop=d?"0":(-n/2+15>>0)+"px";f.style.height=n+"px";return!0};a.closeDossier=function(){$("dossier").style.display="none"};a.setEquipmentFlags=function(d){defined(d)||(d=Equipment.defaultName);0==a.flagStyleSheets.length&&(a.flagStyleSheets.push(getStyleSheet("#eqSelCountry")),a.flagStyleSheets.push(getStyleSheet(".playerCountry")),a.flagStyleSheets.push(getStyleSheet(".uSmallFlag")));for(var b=0;b<a.flagStyleSheets.length;b++)a.flagStyleSheets[b].backgroundImage=
"url('../resources/ui/flags/"+d+"/flags_med.png')"};a.setDeployOrCombatLogState=function(a){a?(makeHidden("combatLogButton"),makeVisible("statusBarButton"),makeVisible("unitsBarButton"),$("statusbar").onclick=null,$("weathermsg").onclick=$("combatLogButton").onclick):($("statusbar").onclick=$("combatLogButton").onclick,$("weathermsg").onclick=null,makeHidden("statusBarButton"),makeHidden("unitsBarButton"),makeVisible("combatLogButton"))};return a}(UIBuilder||{});var curDown=!1,curYPos=0,curXPos=0;
function UI(a){function f(a){var b=B(aa,a),b=A.screenToCell(b.x,b.y);null==v.currentUnit||uiSettings.strategicZoom||A.drawCursor(b);E(b.row,b.col);$("game");!0===curDown&&($("game").scrollLeft=curXPos-a.pageX,$("game").scrollTop=curYPos-a.pageY)}function d(b){switch(b.code){case "KeyM":V.hasOwnProperty("mount")&&M("mount",v.currentUnit);break;case "KeyE":V.hasOwnProperty("embark")&&M("embark",v.currentUnit);break;case "KeyS":V.hasOwnProperty("resupply")&&M("resupply",v.currentUnit);break;case "KeyR":V.hasOwnProperty("reinforce")&&
M("reinforce",v.currentUnit);break;case "KeyO":V.hasOwnProperty("overstrength")&&M("overstrength",v.currentUnit);break;case "KeyU":V.hasOwnProperty("undo")&&M("undo",v.currentUnit);break;case "KeyN":defined(v.currentUnit)&&G(v.currentUnit,1,!0);break;case "KeyP":defined(v.currentUnit)&&G(v.currentUnit,0,!0);break;case "KeyA":a.ui.mainMenuButton("air");break;case "KeyH":a.ui.mainMenuButton("hex");break;case "KeyB":a.ui.mainMenuButton("buy");break;case "KeyI":a.ui.mainMenuButton("inspectunit");break;
case "KeyZ":a.ui.mainMenuButton("zoom");break;case "KeyL":a.ui.removeAllSmallToolTips()}if("Escape"==b.key||"Esc"==b.key)defined(v.currentUnit)?n():a.ui.mainMenuButton("options")}function l(a,b){var d=$("eqUserSel").deployunit;v.deployPlayerUnit(v.currentPlayer,d,a,b)&&(A.cacheImages(function(){A.render(a,b,1)}),n(),F($("eqUserSel").eqclass))}function n(){if(null!==v.currentUnit){var a=v.currentUnit.getPos(),b=P(v.currentUnit);v.delCurrentUnit();A.render(a.row,a.col,b)}}function k(d,f){if(v.currentPlayer.type!=
playerType.humanLocal)return!1;var g=v.map[d][f],k=g.getUnit(uiSettings.airMode);if(null==k||k.player.id!=v.currentPlayer.id)if(k=g.getUnit(!uiSettings.airMode),null==k||k.player.id!=v.currentPlayer.id)return!1;$("eqUserSel").userunit=k.id;F(k.unitData(!0).uclass);a.ui.removeUnitToolTip(k.id);return b(k)}function b(a){if(null===a)return!1;var b=a.getPos();n();v.selectUnit(a);I(a);E(b.row,b.col);a=P(a);A.render(b.row,b.col,a);return!0}function g(a,b,d){var f=a.unitData().movmethod;GameRules.isTrain(a)&&
(f=movMethod.tracked);var g=P(a),k=a.getPos();b=v.moveUnit(a,b,d);d={unit:a,moveResults:b,cbfunc:m};if(!b.isVisible)return m(d),!1;soundData[moveSoundByMoveMethod[f]].play();a.hasAnimation=!0;A.moveAnimation(d);A.render(k.row,k.col,g);return!0}function m(b){var d=b.moveResults,f=b.unit,g=P(f),k=f.getPos();A.render(k.row,k.col,g);f.isSurprised&&(g=d.surpriseCell,p(g.row,g.col,"Surprised"),q(b.unit,g.row,g.col),f.isSurprised=!1);d.isCapture&&p(k.row,k.col,"Captured",f.player.side==a.spotSide||2==a.spotSide);
0<=d.isVictorySide&&x(d.isVictorySide);a.waitUIAnimation=!1}function x(b){var d=a.scenario.checkVictory();if(null!==a.campaign)a.getCampaignPlayer().side==b?a.continueCampaign(d,endGameType.moveCapture):a.continueCampaign("lose",endGameType.moveCapture);else{var f;v.currentPlayer.type!=playerType.humanLocal?(d="DEFEAT",f="You have lost ! Your enemy "):(d=outcomeNames[d],f="You have won this scenario ! ");H(d,"<br/><br/><br/><br/>"+f+v.currentPlayer.getCountryName()+" on "+sideNames[b]+" side wins by capturing all victory hexes with a final score of <b>"+
v.currentPlayer.score+"</b>. ",function(){a.ui.mainMenuButton("options")});a.gameEnded=!0}}function q(a,b,d){var f=null;return null!==(f=v.map[b][d].getAttackableUnit(a,uiSettings.airMode))?r(a,f):!1}function r(a,b){var d=7,f=a.getPos(),g=b.getPos();if(!f||!g)return!1;var k=g.row,l=g.col,m=a.unitData().uclass,n=b.unitData().uclass,r=!1,q={attacking:{unit:a,cell:f,oldstr:a.strength,newstr:0,leaderGain:!1,attackStopped:!1},defending:{unit:b,cell:g,oldstr:b.strength,newstr:0,leaderGain:!1},cbfunc:s};
UIBuilder.showAttackInfo(a,b);var y=GameRules.calculateAttackResults(a,b,!0);if(!a.isSurprised&&!y.isOverrun){var r=GameRules.getSupportFireUnits(v.getUnits(),a,b),w;for(w in r){var x=r[w].getPos(),z=r[w].unitData().uclass;if(a.destroyed)break;v.attackUnit(r[w],a,!0);A.addAnimation(x.row,x.col,attackAnimationByClass[z],r[w].facing)}}r=GameRules.isLossOverRetreatThreshold(a.strength,q.attacking.oldstr);a.destroyed||r||(y=v.attackUnit(a,b,!1,y.isOverrun),y.isOverrun&&(p(g.row-0.2,g.col-0.6,"OverRun ",
!0),d=1),y.isRugged&&!y.isOverrun&&p(g.row-0.2,g.col-0.6,"Rugged Defense ",!1),A.addAnimation(f.row,f.col,attackAnimationByClass[m],a.facing),!b.destroyed&&y.defcanfire&&A.addAnimation(k,l,attackAnimationByClass[n],b.facing),q.attacking.leaderGain=y.atkLeaderGain,q.defending.leaderGain=y.defLeaderGain);r&&(q.attacking.attackStopped=!0,a.hasFired=!0);A.render(f.row,f.col,d);uiSettings.markCombatUnits&&v.currentPlayer.type==playerType.aiLocal&&(A.drawHexByCell(f,hexstyle.combat),A.drawHexByCell(g,hexstyle.combat));
A.runAnimation(q);q.attacking.newstr=a.strength;q.defending.newstr=b.strength;return!0}function s(b){var d,f,g=!1,k=b.attacking;b=b.defending;var l=GameRules.getUnitAttackRange(k.unit),n=!1,r=!1;d=k.oldstr-k.newstr;0<d&&d<k.oldstr&&p(k.cell.row,k.cell.col,-d);f=b.oldstr-b.newstr;0<f&&f<b.oldstr&&p(b.cell.row,b.cell.col,-f);d>=k.oldstr&&(n=!0,A.addAnimation(k.cell.row,k.cell.col,"explosion"),A.runAnimation(null));f>=b.oldstr&&(r=!0,A.addAnimation(b.cell.row,b.cell.col,"explosion"),A.runAnimation(null));
if(n||r)v.updateUnitList(),g=!0;v.currentUnit&&(k.unit.destroyed&&v.currentUnit.id==k.unit.id?(v.delCurrentUnit(),A.drawCursor(k.cell)):v.selectUnit(v.currentUnit),b.unit.destroyed&&!v.currentUnit.hasMoved&&(v.setMoveRange(v.currentUnit),d=P(v.currentUnit),d>l&&(l=d)));k.attackStopped&&p(k.cell.row-0.2,k.cell.col-0.6,"Attack Stopped ",!1);!n&&(k.leaderGain&&k.unit.player.side==a.spotSide)&&p(k.cell.row-0.2,k.cell.col-0.6,"New Leader",!0);!r&&(b.leaderGain&&b.unit.player.side==a.spotSide)&&p(b.cell.row-
0.2,b.cell.col-0.6,"New Leader",!0);!r&&GameRules.shouldDefenderRetreat(k.unit,b.unit,b.oldstr)&&(g=!0,(n=GameRules.getRetreatPosition(v.map,b.unit,v.rows,v.cols))?(p(n.row-0.2,n.col-0.6,"Retreat ",!1),n=v.retreatUnit(b.unit,n),n={unit:b.unit,moveResults:n,cbfunc:m},b.unit.hasAnimation=!0,A.moveAnimation(n)):(p(b.cell.row-0.2,b.cell.col-0.6,"Surrender ",!1),b.unit.destroyed=!0,v.updateUnitList(),A.addAnimation(b.cell.row,b.cell.col,"explosion"),A.runAnimation(null)));v.hasAliveUnits(playerSide.axis)||
x(playerSide.allies);v.hasAliveUnits(playerSide.allies)||x(playerSide.axis);g&&A.render(k.cell.row,k.cell.col,l);a.waitUIAnimation=!1;z()}function p(a,b,d,f){a=A.cellToScreen(a,b,!0);"undefined"===typeof f&&(f=!1);bounceText(a.x,a.y,d,f)}function y(a){v.currentPlayer.type==playerType.humanLocal&&((a?isVisible("equipment"):isVisible("container-unitlist"))?(makeHidden("equipment"),makeHidden("container-unitlist"),makeHidden("unitsBarButton"),uiSettings.deployMode=!1,toggleButton($("buy"),!1),z()):(L(!0),
makeVisible("container-unitlist"),a&&(makeVisible("equipment"),makeHidden("eqSortOptions"),makeVisible("eqButtonsContainer")),F(unitClass.tank),toggleButton($("buy"),!0),isVisible("equipment")?makeHidden("unitsBarButton"):makeVisible("unitsBarButton"),makeHidden("combatLog")),A.render())}function I(a){var b,d=0;V={};clearTag("unit-context");if(a&&a.player&&a.player.id==v.currentPlayer.id){GameRules.canMount(a)&&(d++,b=addTag("unit-context","div"),b.className="smallButtonSubMenu",b.innerHTML=UIBuilder.unitContextButtons.mount,
b.title="Mount/Umount this unit in/from a transport",b.onclick=function(){M("mount",a)},V.mount=!0);if(GameRules.canEmbark(v.map,a)||GameRules.canDisembark(v.map,a))d++,b=addTag("unit-context","div"),b.className="smallButtonSubMenu",b.innerHTML=UIBuilder.unitContextButtons.embark,b.title="Embark/DisEmbark this unit in/from a air/naval transport",b.onclick=function(){M("embark",a)},V.embark=!0;GameRules.canResupply(v.map,a)&&(d++,b=addTag("unit-context","div"),b.className="smallButtonSubMenu",b.innerHTML=
UIBuilder.unitContextButtons.resupply,b.title="Resupply Ammo and Fuel for this unit",b.onclick=function(){M("resupply",a)},V.resupply=!0);v.currentPlayer.prestige>=GameRules.calculateUnitCostPerStrength(a)&&(GameRules.canReinforce(v.map,a,!1)&&(d++,b=addTag("unit-context","div"),b.className="smallButtonSubMenu",b.innerHTML=UIBuilder.unitContextButtons.reinforce,b.title="Reinforce unit strength",b.onclick=function(){M("reinforce",a)},V.reinforce=!0),GameRules.canReinforce(v.map,a,!0)&&(d++,b=addTag("unit-context",
"div"),b.className="smallButtonSubMenu",b.innerHTML=UIBuilder.unitContextButtons.overstrength,b.title="Overstrength unit",b.onclick=function(){M("overstrength",a)},V.overstrength=!0));v.canUndoMove(a)&&(d++,b=addTag("unit-context","div"),b.className="smallButtonSubMenu",b.innerHTML=UIBuilder.unitContextButtons.undo,b.title="Undo last move",b.onclick=function(){M("undo",a)},V.undo=!0);0<d?makeVisible("unit-context"):makeHidden("unit-context")}else makeHidden("unit-context")}function J(b){var d=!1,
f,g,k="-",l=0,m=0,p="";if(isVisible("unit-info")&&uiSettings.unitInfoVisibility&&(L(!0),clearTag($("uLeader")),clearTag($("uTransport")),clearTag($("uCarrier")),delTag($("leaderInfo")),makeVisible("statsRow"),$("uLeader").className="",$("uTransport").className="",$("uCarrier").className="","undefined"===typeof b.unitData?(d=!0,f=b,b.flag=b.country,b.strength=10,g=b.ammo,0!=b.fuel&&(k=b.fuel),m=l=0):(f=0!=b.carrier?b.isMounted?b.transport.unitData():b.unitData(!0):b.unitData(),g=b.getAmmo(),GameRules.unitUsesFuel(b)&&
(k=b.getFuel()),l=b.experience,m=b.entrenchment,f.uclass!==unitClass.fortification&&(p=UIBuilder.unitIDToOrdinal(b.id))),g<f.ammo/4&&(g="<span style='color: #FF6347'>"+g+"</span>"),k<f.fuel/4&&(k="<span style='color: #FF6347'>"+k+"</span>"),0==f.gunrange&&(f.gunrange=1),$("uImage").style.backgroundImage="url("+f.icon+")",$("uSmallFlag").style.backgroundPosition=""+-21*(b.flag-1)+"px 0px",$("uFlag").style.backgroundImage="url('resources/ui/flags/"+Equipment.name+"/flag_big_"+b.flag+".png')",$("uFlag").textContent=
Equipment.getCountryName(b.flag-1),$("uName").textContent=p+" "+f.name+" "+unitClassNames[f.uclass],d||(b.isCore&&($("uName").innerHTML+=" (Core Unit)"),-1!=b.leader&&($("uName").innerHTML+=" (Leader)")),$("uTarget").textContent=unitTypeNames[f.target],f.uclass<=unitClass.airDefence&&f.movmethod==movMethod.deepnaval?$("uMoveType").textContent="Rail Road":$("uMoveType").textContent=movMethodNames[f.movmethod],$("uStr").textContent=b.strength+"/10",$("uFuel").innerHTML=k,$("uAmmo").innerHTML=g,$("uGunRange").textContent=
f.gunrange,$("uMovement").textContent=f.movpoints,$("uExp").textContent=l,$("uEnt").textContent=m,$("uIni").textContent=f.initiative,$("uSpot").textContent=f.spotrange,$("uAHard").textContent=f.hardatk,$("uASoft").textContent=f.softatk,$("uAAir").textContent=f.airatk,$("uANaval").textContent=f.navalatk,$("uDHard").textContent=f.grounddef,$("uDAir").textContent=f.airdef,$("uDClose").textContent=f.closedef,$("uDRange").textContent=f.rangedefmod,!d)){0!=b.carrier&&($("uCarrier").className="smallButtonSubMenu",
$("uCarrier").innerHTML="2",$("uCarrier").onclick=function(){J(Equipment.equipment[b.carrier])});if(b.transport){var n;$("uTransport").className="smallButtonSubMenu";b.isMounted?($("uTransport").innerHTML="9",n=!1):($("uTransport").innerHTML="8",n=!0);$("uTransport").onclick=function(){var a=b.isMounted;b.isMounted=n;J(b);b.isMounted=a}}-1<b.leader&&($("uLeader").className="smallButtonSubMenu",$("uLeader").textContent="z",$("uLeader").onclick=function(){if(null!==$("leaderInfo"))J(b);else{makeHidden("statsRow");
var a=Leaders.getUnitLeaderDescriptions(b),d=addTag("statsRowContainer","div");d.id="leaderInfo";d.style.paddingLeft="20px";d.style.paddingTop="10px";var f="<b>"+a[0][0]+"</b>: ",f=f+(a[0][1]+"<br/>"),f=f+("<b>"+a[1][0]+"</b>: "),f=f+a[1][1];d.innerHTML=f}});b.player.side===a.spotSide&&($("uNext").className="smallButtonSubMenu",$("uNext").style.fontSize="16px",$("uNext").innerHTML="y",$("uNext").onclick=function(){G(b,1,!0)})}}function L(a){a?makeVisible("unit-info"):makeHidden("unit-info");uiSettings.unitInfoVisibility=
a;toggleButton($("inspectunit"),a)}function G(a,d,f){a=v.getUnitNeighbor(a,d,f);b(a);a&&C(a.getPos());J(a)}function M(a,b){var d=P(b),f=b.getPos(),g=!1,k=!1;switch(a){case "mount":b.isMounted?v.unmountUnit(b):v.mountUnit(b);g=!0;break;case "embark":0<b.carrier?(v.disembarkUnit(b),g=!0):v.embarkUnit(b)&&(g=!0);break;case "resupply":var k=v.resupplyUnit(b),l=b.getPos(),m="";0<k.ammo&&(m+="+"+k.ammo+" ammo ");0<k.fuel&&(m+="+"+k.fuel+" fuel");""==m?p(l.row,l.col,"Can't resupply",!1):p(l.row,l.col,m,
!0);break;case "overstrength":k=!0;case "reinforce":d=v.reinforceUnit(b,k);l=b.getPos();m="";0<d.strength&&(m="+"+d.strength+" units ");0<d.ammo&&(m+="+"+d.ammo+" ammo ");0<d.fuel&&(m+="+"+d.fuel+" fuel");""==m?p(l.row,l.col,k?"No overstrength":"Can't reinforce",!1):p(l.row,l.col,m,!0);break;case "undo":v.undoLastMove(),g=!0}I(b);J(b);A.render(f.row,f.col,d);g&&(d=P(b),f=b.getPos(),A.render(f.row,f.col,d))}function F(d){if(isVisible("container-unitlist")&&v.currentPlayer.side===a.spotSide){clearTag("unitlist");
clearTag("eqUnitList");clearTag("eqTransportList");var f=$("eqSelCountry").country,g=+O[f]+1;$("eqSelCountry").style.backgroundPosition=""+-21*O[f]+"px 0px";var k=a.scenario.date.getFullYear(),l=[],l=[],m,p,n,r,q,s;n=uiSettings.deployMode;v.currentPlayer.hasUndeployedUnits()?(q=$("eqUserSel").deployunit,l=v.currentPlayer.getCoreUnitList(),l.sort(Q(!1)),uiSettings.deployMode=!0,$("statusmsg").innerHTML="Deploy (on map grey hexes) or upgrade your core units"):(q=$("eqUserSel").userunit,l=v.getUnits(),
l.sort(Q(!0)),uiSettings.deployMode=!1,$("statusmsg").innerHTML="Units currently deployed on map.");UIBuilder.setDeployOrCombatLogState(uiSettings.deployMode);n!==uiSettings.deployMode&&A.render();!0==n&&!1==uiSettings.deployMode&&y(!1);for(var w=0;w<l.length;w++)n=l[w],uiSettings.deployMode&&n.isDeployed||(!n||n.player.id!=v.currentPlayer.id)||(r=n.unitData(!0),s=N("unitlist",n),uiSettings.deployMode&&(-1==q||l[q].isDeployed)&&($("eqUserSel").deployunit=q=w),s.unitid=uiSettings.deployMode?w:n.id,
s.uniteqid=n.eqid,s.eqclass=r.uclass,s.country=r.country-1,n.isCore&&s.unitid!=q&&s.setAttribute("coreUnit",r.name),s.unitid==q&&(null===n.transport||-1!=$("eqUserSel").eqtransport||-1!=$("eqUserSel").equnit&&!GameRules.isTransportable($("eqUserSel").equnit)||($("eqUserSel").eqtransport=n.transport.eqid),s.setAttribute("selectedUnit",r.name),uiSettings.deployMode||(b(n),n&&C(n.getPos()),d=r.uclass),m=$("unitlist").offsetWidth-($("container-unitlist").offsetWidth+s.offsetWidth)/2),s.onclick=function(){f=
v.getCountriesBySide(a.spotSide);for(w=0;w<f.length&&f[w]!=this.country;w++);uiSettings.deployMode?($("eqUserSel").deployunit=this.unitid,$("eqUserSel").userunit=-1):($("eqUserSel").userunit=this.unitid,$("eqUserSel").deployunit=-1);$("eqSelCountry").country=w;$("eqUserSel").eqtransport=-1;$("eqUserSel").equnit=this.uniteqid;$("eqUserSel").unitscroll=$("hscroll-unitlist").scrollLeft;var b;b=uiSettings.deployMode?v.currentPlayer.getCoreUnitList()[this.unitid]:v.getUnitById(this.unitid);J(b);F(this.eqclass);
$("hscroll-unitlist").scrollLeft=$("eqUserSel").unitscroll});uiSettings.deployMode||($("hscroll-unitlist").scrollLeft=m);d==unitClass.flak&&(d=unitClass.airDefence);"undefined"===typeof UIBuilder.eqClassButtons[d]&&(d=unitClass.tank);n=$("eqUserSel").eqclass||unitClass.tank;"undefined"!==typeof UIBuilder.eqClassButtons[n]&&toggleButton($("eqclass-"+n),!1);"undefined"!==typeof UIBuilder.eqClassButtons[d]&&toggleButton($("eqclass-"+d),!0);$("eqUserSel").eqclass=d;$("eqInfoText").innerHTML=k+" "+unitClassNames[d]+
" upgrades for "+Equipment.getCountryName(g-1);q=$("eqUserSel").equnit;r=$("eqUserSel").sortorder;for(var x=$("eqUserSel").sortproperty||"cost",l=Equipment.getCountryEquipmentByClass(d,g,x,r),w=0;w<l.length;w++)m=l[w],n=Equipment.equipment[m],n.yearavailable>k||n.yearexpired<k||(s=N("eqUnitList",n),s.equnitid=m,m==q&&(s.setAttribute("selectedUnit",m),p=$("eqUnitList").offsetWidth-($("hscroll-eqUnitList").offsetWidth+s.offsetWidth)/2),s.onclick=function(){$("eqUserSel").equnit=this.equnitid;$("eqUserSel").eqtransport=
-1;$("eqUserSel").eqscroll=$("hscroll-eqUnitList").scrollLeft;J(Equipment.equipment[this.equnitid]);F(d);$("hscroll-eqUnitList").scrollLeft=$("eqUserSel").eqscroll});0<q&&($("hscroll-eqUnitList").scrollLeft=p);p=$("eqUserSel").eqtransport;s=!1;if(GameRules.isTransportable(q)||0<p){n=Equipment.equipment[q];l=Equipment.getCountryEquipmentByClass(unitClass.groundTransport,g,x,r);for(w=0;w<l.length;w++)m=l[w],g=Equipment.equipment[m],g.yearavailable>k||g.yearexpired<k||(!n||0==(n.groundweight&g.groundweight))||
(q=N("eqTransportList",g),q.eqtransportid=m,m==p&&(q.setAttribute("selectedUnit",g.name),s=!0),q.onclick=function(){$("eqUserSel").eqtransport==this.eqtransportid?$("eqUserSel").eqtransport=-2:$("eqUserSel").eqtransport=this.eqtransportid;J(Equipment.equipment[this.eqtransportid]);F(d)});s||($("eqUserSel").eqtransport=-1)}U()}}function Q(a){return function(b,d){var f=b.unitData(!0),g=d.unitData(!0),k=f.uclass-g.uclass;0==k&&(k=f.name<g.name?-1:+(f.name>g.name));0==k&&(k=b.id-d.id);return a?b.isCore?
d.isCore?k:-1:d.isCore?1:k:k}}function U(){var b=$("eqUserSel").userunit,d=$("eqUserSel").deployunit,f=$("eqUserSel").equnit,g=$("eqUserSel").eqtransport,k=0,l=0,m=0,n=v.currentPlayer.prestige,p=null,r=a.scenario.date.getFullYear(),p=-1==d||"undefined"===typeof d?v.getUnitById(b):v.currentPlayer.getCoreUnitList()[d];if("undefined"!==typeof p&&null!==p){var q=p.unitData(!0).uclass,b=p.unitData(!0).country-1;q==unitClass.flak&&(q=unitClass.airDefence);if(0<f&&"undefined"!==typeof f){var d=Equipment.equipment[f].uclass,
s=Equipment.equipment[f].country-1;d==unitClass.flak&&(d=unitClass.airDefence);q==d&&b==s&&(l=GameRules.calculateUpgradeCosts(p,f,g))}if(null==a.campaign||p.isCore)m=GameRules.calculateUnitSellCost(p)}-1!=f&&(s=Equipment.equipment[f].country-1,k=defined(p)&&"undefined"===typeof UIBuilder.eqClassButtons[q]?-1:Equipment.equipment[f].yearavailable>r||Equipment.equipment[f].yearexpired<r?-1:null!==a.campaign&&a.campaign.country!==s?-1:GameRules.calculateUnitCosts(f,g));UIBuilder.showEquipmentCosts(n,
k,l,m)}function E(a,b){var d,f=v.map[a][b];if(!f||"undefined"===typeof f)return!1;var g=terrainNames[f.terrain];f.road>roadType.none&&(g+="/Road");var g=g+(" ("+a+","+b+")"),k="";null!==f.name&&(k=f.name+" ");var l="";f.terrain==terrainType.Airfield&&0<v.currentPlayer.airTransports&&(l=" Air Transports: "+v.currentPlayer.airTransports+" ");f.terrain==terrainType.Port&&0<v.currentPlayer.navalTransports&&(l+="Naval Transports: "+v.currentPlayer.navalTransports+" ");var m="";null!==(d=f.getUnit(uiSettings.airMode))&&
(f.isSpotted(v.currentPlayer.side)||d.tempSpotted||d.player.side==v.currentPlayer.side)&&(m=" Unit: "+d.unitData(!0).name+" ");30<k.length+m.length&&(15<k.length?k=k.slice(0,10)+"... ":m=m.slice(0,20)+" ");$("locmsg").innerHTML=m+k+l+g;return!0}function N(a,b){var d=addTag(a,"div"),f=addTag(d,"img"),g=addTag(d,"div"),k=addTag(d,"div");d.className="eqUnitBox";if("undefined"!==typeof b.unitData){var l=b.unitData(!0);if(l.uclass>unitClass.submarine){var m={};m.name=l.name;m.icon=UIBuilder.navalReplacementIcon;
m.cost=l.cost;l=m}m="";f.src=l.icon;g.textContent=l.name;if(b.isDeployed){if(k.className="eqUnitBoxIconsMenu",b.hasFired||(m+=">"),b.hasMoved||(m+="|"),GameRules.unitUsesFuel(b)&&5>b.fuel||2>b.ammo)m+=";"}else k.className="eqUnitBoxIcons",m="Z";k.textContent=m}else f.src=b.icon,g.textContent=b.name,k.innerHTML+="<b>"+b.cost*CURRENCY_MULTIPLIER+UIBuilder.currencyIcon+"</b>";return d}function w(){makeHidden("statusbar-extension");$("statusbar-extension").style.top="25px";$("statusbar-extension").className=
"";var b=v.currentPlayer;z();b.type==playerType.humanLocal||b.type==playerType.aiScripted?(UICombatLog.toggleCombatLog(!0,!1),a.ui.removeAllSmallToolTips(!0),a.ui.addSmallToolTips(!0)):UIBuilder.showAIStatus(!0)}function z(){clearTag($("statusmsg"));$("statusmsg").innerHTML="&nbsp; "+v.currentPlayer.getCountryName()+" Turn: "+v.turn+"/"+v.maxTurns+" "+a.scenario.name;$("weathermsg").innerHTML=groundFontEncoding[a.scenario.ground]+weatherFontEncoding[a.scenario.atmosferic];$("weathermsg").title=groundConditionNames[a.scenario.ground]+
" ground and "+weatherConditionNames[a.scenario.atmosferic]+" weather"}function H(a,b,d){UIBuilder.message(a,b,d)}function C(a){if(!a||"undefined"===typeof a)return!1;a=A.cellToScreen(a.row,a.col,!0);$("game").scrollLeft=a.x-window.innerWidth/2;$("game").scrollTop=a.y-window.innerHeight/2;return!0}function B(a,b){var d,f=$("game");b.which?d=3==b.which:b.button&&(d=2==b.button);return new mouseInfo(b.pageX-a.offsetLeft-f.clientLeft-f.offsetLeft+f.scrollLeft,b.pageY-a.offsetTop-f.clientTop-f.offsetTop+
f.scrollTop,d)}function W(){A.render();if(v.currentPlayer.type==playerType.humanLocal)for(var a=v.getUnits(),b=0;b<a.length;b++)if(a[b].player.id==v.currentPlayer.id&&a[b].unitData().uclass!=unitClass.fighter&&a[b].unitData().uclass!=unitClass.levelBomber&&a[b].unitData().uclass!=unitClass.tacticalBomber){var d=a[b].getPos();k(d.row,d.col);J(a[b]);break}X()||v.currentUnit&&C(v.currentUnit.getPos());Y(uiSettings.zoomLevel)}function T(){hasBrokenClearRect()?A.cacheImages(function(){window.setTimeout(W,
4E3)}):A.cacheImages(W)}function P(a){if(null===a)return 0;var b=GameRules.getUnitMoveRange(a),d=GameRules.getUnitAttackRange(a);d>b&&(b=d);d=a.unitData().spotrange;d>b&&(b=d);return b}function X(){var a=v.currentPlayer;if(!a.hasUndeployedUnits()||a.type!=playerType.humanLocal)return!1;makeVisible("container-unitlist");a:for(a=0;a<v.rows;a++)for(var b=0;b<v.cols;b++){var d=v.map[a][b];if(d&&-1!=d.isDeployment&&d.isDeployment==v.currentPlayer.id){C({row:a,col:b});break a}}toggleButton($("buy"),!0);
return!0}function S(){var a=$("game"),b=Math.min(100*(window.innerWidth/(aa.width*uiSettings.zoomLevel)),100*(window.innerHeight/(aa.height*uiSettings.zoomLevel)))>>0,d;uiSettings.strategicZoom?(a.style.width=window.innerWidth+"px",a.style.height=window.innerHeight+"px","ios"==NATIVE_PLATFORM?a.style.zoom="100%":(d="",a.style.webkitTransform=d,a.style.MozTransform=d,a.style.transform=d),uiSettings.strategicZoom=!1,uiSettings.strategicZoomLevel=1):("ios"==NATIVE_PLATFORM?a.style.zoom=b+"%":(d="scale("+
b/100+","+b/100+")",a.style.webkitTransform=d,a.style.MozTransform=d,a.style.transform=d),a.style.width=(100*window.innerWidth/b>>0)+"px",a.style.height=(100*window.innerHeight/b>>0)+"px",uiSettings.strategicZoom=!0,uiSettings.strategicZoomLevel=100/b);toggleButton($("zoom"),uiSettings.strategicZoom);A.render()}function Y(a){var b=100*a>>0,d,f,g,k;f=$("map");var l=$("game"),m=uiSettings.zoomLevel;d=f.width;f=f.height;g=l.scrollLeft;k=l.scrollTop;$("map").style.zoom=b+"%";$("hexes").style.zoom=b+"%";
$("cursor").style.zoom=b+"%";$("unitbackbuffer").style.zoom=b+"%";l.scrollLeft=g+d*(a-m)/2;l.scrollTop=k+f*(a-m)/2;uiSettings.mapZoom=1!=a?!0:!1;uiSettings.zoomLevel=a;$("mapscale").value=a;A.positionLayers()}var v=a.scenario.map,A=new Render(v),O=v.getCountriesBySide(a.spotSide),V={};T();var aa=A.getCursorCanvas();uiSettings.hasTouch=hasTouch();uiSettings.hasTouch?(uiSettings.showGridTerrain=!0,hasBrokenScroll()&&(touchScroll("game"),touchScroll("hscroll-unitlist"),touchScroll("hscroll-eqUnitList"),
touchScroll("hscroll-eqTransportList")),UIBuilder.setLayoutConstrains(!0)):(addStyleSheet("scrollbars.css"),aa.addEventListener("mousemove",f,!1),window.addEventListener("mouseup",function(a){curDown=!1},!1),window.addEventListener("keyup",d,!1),window.onresize=function(){A.positionLayers()});aa.addEventListener("mousedown",function(b){if(!a.gameStarted||a.gameEnded)return!1;b=B(aa,b);var d=A.screenToCell(b.x,b.y),f=d.row,m=d.col,p=!1;uiSettings.hasTouch||(curDown=!0,curXPos=b.x,curYPos=b.y);var r=
v.map[f][m];if("undefined"===typeof r)return!0;if(uiSettings.strategicZoom)return S(),C(d),!0;(d=r.getUnit(uiSettings.airMode))&&(r.isSpotted(v.currentPlayer.side)||d.tempSpotted||d.player.side==v.currentPlayer.side||(d=null));if(b.rclick)return d?(L(!0),J(d)):n(),!0;d?(uiSettings.unitInfoVisibility&&makeVisible("unit-info"),J(d),null===v.currentUnit||uiSettings.deployMode?p=k(f,m):r.isAttackSel&&!v.currentUnit.hasFired?q(v.currentUnit,f,m):r.isMoveSel?g(v.currentUnit,f,m):v.currentUnit===d?(n(),
uiSettings.unitInfoVisibility&&makeHidden("unit-info")):p=k(f,m)):uiSettings.deployMode&&-1<r.isDeployment&&v.getPlayer(r.isDeployment).side==v.currentPlayer.side?l(f,m):r.isMoveSel&&!v.currentUnit.hasMoved&&null!==v.currentUnit?g(v.currentUnit,f,m):(n(),uiSettings.unitInfoVisibility&&makeHidden("unit-info"));!p&&uiSettings.hasTouch&&E(f,m);uiSettings.airMode=GameRules.isAir(v.currentUnit);toggleButton($("air"),uiSettings.airMode);I(v.currentUnit);return!1},!1);toggleRightClick(!1);UIBuilder.buildStartMenu();
UIBuilder.buildMainMenu();UIBuilder.buildUnitInfoWindow();UIBuilder.buildEquipmentWindow();UIBuilder.buildEquipmentSortOptions();UIBuilder.setDefaultUserSelections();UIBuilder.setEquipmentFlags(a.scenario.eqp);z();X();F();H(a.scenario.name,a.scenario.getDescription());this.handleReinforcementDeployment=function(){A.cacheImages(function(){A.render()})};this.uiUnitSelect=function(a){return b(a)};this.uiUnitMove=function(a,b,d){return g(a,b,d)};this.uiUnitAttack=function(a,b){return r(a,b)};this.showAlert=
function(a,b,d,f){return p(a,b,d,f)};this.showGameToolTip=function(a,b,d){b=A.cellToScreen(b,d,!0);UIBuilder.gameToolTip(a,b.x,b.y)};this.showSmallToolTip=function(a,b,d,f,g,k){b=A.cellToScreen(b,d,!0);UIBuilder.gameSmallToolTip(a,b.x,b.y,f,g,k)};this.addSmallToolTips=function(a){for(var b=v.map,d=v.currentPlayer,f=d.side,g=0;g<b.length;g++)for(var k=0;k<b[g].length;k++){var l=b[g][k],m=null,n=tooltipColor.enemy,p=tooltipStyle.text;a||(-1==l.flag||-1==l.owner)||(null!==l.name&&""!=l.name?m=l.name:
-1!==l.victorySide&&(m="Objective"),uiSettings.showDetailInfoToolTips||-1!=l.victorySide||(m=null),l.owner==f&&(n=tooltipColor.player),l.terrain==terrainType.Airfield&&0<d.airTransports&&(m=d.airTransports+"&nbsp;<span style='font-family: openpanzer-menu;'>&#xe900;</span> ",p=tooltipStyle.pin),l.terrain==terrainType.Port&&0<d.navalTransports&&(m=d.navalTransports+"&nbsp;<span style='font-family: openpanzer-menu;'>&#xe901;</span>",p=tooltipStyle.pin),m&&this.showSmallToolTip(m,g,k,n,void 0,p));(l=
l.getUnit(uiSettings.airMode))&&(l.player.side==f&&null==m)&&(m="gsttu"+l.id,GameRules.unitLowAmmo(l,1)&&this.showSmallToolTip("No Ammo",g,k,0,m),GameRules.unitLowFuel(l,1)&&this.showSmallToolTip("No Fuel",g,k,0,m))}};this.removeUnitToolTip=function(a){for(var b=UIBuilder.smallToolTipList.length-1;0<=b;b--){var d=UIBuilder.smallToolTipList[b];if(d=="gsttu"+a){delTag($(d));break}}};this.removeAllSmallToolTips=function(a){for(var b=UIBuilder.smallToolTipList.length-1;0<=b;b--){var d=UIBuilder.smallToolTipList[b];
a&&0!==d.lastIndexOf("gsttu",0)||delTag($(d))}UIBuilder.smallToolTipList=[]};this.setNewScenario=function(){v=a.scenario.map;A.setNewMap(v);T();O=v.getCountriesBySide(a.spotSide);UIBuilder.setEquipmentFlags(a.scenario.eqp);UIBuilder.setDefaultUserSelections();CombatLog.reset();makeHidden("combatLog");makeHidden("statusbar-extension");UIBuilder.closeDossier();a.ui.removeAllSmallToolTips();a.ui.addSmallToolTips();F(unitClass.tank);z();X();H(a.scenario.name,a.scenario.getDescription())};this.startMenuButton=
function(b){switch(b){case "newgame":makeVisible("smNewGame");break;case "newcampaign":makeHidden("smNewGame");makeHidden("smMain");makeVisible("smCamp");null===a.campaign?setSelectOption($("smCampSel").firstChild,$("smCampSel").firstChild.options[0].text):setSelectOption($("smCampSel").firstChild,a.campaign.name);$("smCampSel").firstChild.onchange();break;case "newscenario":makeHidden("smNewGame");makeHidden("smMain");makeVisible("smScen");setSelectOption($("smScenSel").firstChild,a.scenario.name);
break;case "tutorial":makeHidden("smMain");makeHidden("startmenu");a.campaign=null;uiSettings.noFOW=!1;uiSettings.isAI[0]=2;uiSettings.isAI[1]=2;a.newScenario(Game.defaultScenario);toggleButton($("options"),!1);break;case "continuegame":makeHidden("startmenu");toggleButton($("options"),!1);break;case "saveload":makeHidden("smMain");makeHidden("smNewGame");makeVisible("smState");break;case "settings":makeHidden("startmenu"),makeHidden("smNewGame"),makeVisible("smSettings"),isVisible("ui-message")&&
(makeHidden("ui-message"),$("smSettings").messageHidden=!0)}};this.mainMenuButton=function(b){switch(b){case "air":uiSettings.airMode&&GameRules.isAir(v.currentUnit)&&n();uiSettings.airMode=!uiSettings.airMode;toggleButton($("air"),uiSettings.airMode);A.render();break;case "hex":uiSettings.hexGrid=!uiSettings.hexGrid;toggleButton($("hex"),uiSettings.hexGrid);this.removeAllSmallToolTips();this.addSmallToolTips();A.render();break;case "zoom":S();A.render();break;case "inspectunit":isVisible("unit-info")?
L(!1):(L(!0),null!==v.currentUnit&&J(v.currentUnit));break;case "buy":y(!0);break;case "endturn":var d=$("endturn");null==d.getAttribute("confirmation")?(d.innerHTML="1",uiSettings.shownEndTurnTip||UIBuilder.uiToolTipAtElement(d,"Tap again to confirm End Turn",1),b=function(){this.removeAttribute("confirmation");d.innerHTML="t";uiSettings.shownEndTurnTip||UIBuilder.uiToolTipAtElement(d,"Tap twice to confirm End Turn",1)},d.setAttribute("confirmation","on"),d.addEventListener("animationend",b,!1),
d.addEventListener("webkitAnimationEnd",b,!1)):(d.innerHTML="t",d.removeAttribute("confirmation"),isVisible("equipment")&&(makeHidden("equipment"),makeHidden("container-unitlist"),uiSettings.deployMode=!1,toggleButton($("buy"),!1)),isVisible("unit-info")&&L(!1),makeHidden("combatLog"),uiSettings.shownEndTurnTip||(makeHidden("uiToolTip"),uiSettings.shownEndTurnTip=!0,a.state.saveSettings()),v.currentPlayer.type==playerType.humanLocal&&(a.endTurn(),a.gameEnded&&a.gameStarted?H("DEFEAT","<br><br>You didn't capture the objectives in time"):
(O=v.getCountriesBySide(a.spotSide),UIBuilder.setDefaultUserSelections(),CombatLog.reset(),F(unitClass.tank),I(),w(),W())));break;case "mainmenu":isVisible("slidemenu")?(makeHidden("slidemenu"),toggleButton($("mainmenu"),!1)):(makeVisible("slidemenu"),toggleButton($("mainmenu"),!0));break;case "options":isVisible("startmenu")?(makeHidden("smMain"),makeHidden("smScen"),makeHidden("smSettings"),makeHidden("smState"),makeHidden("startmenu"),toggleButton($("options"),!1)):(makeVisible("startmenu"),makeVisible("smMain"),
toggleButton($("options"),!0))}};this.toggleUnitsAndEquipmentWindow=y;this.equipmentWindowButtons=function(b){switch(b){case "changecountry":$("eqSelCountry").country>=O.length-1?$("eqSelCountry").country=0:$("eqSelCountry").country++;$("eqUserSel").userunit=-1;$("eqUserSel").equnit=-1;a.ui.updateEquipmentWindow($("eqUserSel").eqclass||unitClass.tank);break;case "buy":var d=$("eqUserSel").equnit,f=$("eqUserSel").eqtransport;if("undefined"===typeof d||0>=d)break;if("undefined"===typeof f||""==f)f=
-1;v.currentPlayer.buyUnit(d,f);F(Equipment.equipment[d].uclass);break;case "upgrade":b=$("eqUserSel").userunit;var g=$("eqUserSel").deployunit,d=$("eqUserSel").equnit,f=$("eqUserSel").eqtransport,k=v.currentPlayer,l=null;if("undefined"===typeof f||""==f)f=-1;"undefined"===typeof b||-1==b?(l=k.getCoreUnitList()[g],k.upgradeUnit(l,d,f)&&F(Equipment.equipment[l.eqid].uclass)):v.upgradeUnit(b,d,f)&&(A.cacheImages(function(){A.render()}),0<d&&F(Equipment.equipment[d].uclass));break;case "sell":k=v.currentPlayer,
l=null,b=$("eqUserSel").userunit,g=$("eqUserSel").deployunit,d=$("eqUserSel").equnit,"undefined"===typeof b||-1==b?(l=k.getCoreUnitList()[g],k.sellUnit(l)&&(k.removeUndeployedCoreUnit(g),F(Equipment.equipment[l.eqid].uclass))):v.disbandUnit(b)&&(A.cacheImages(function(){A.render()}),$("eqUserSel").userunit=-1,0<d&&F(Equipment.equipment[d].uclass))}};this.updateEquipmentWindow=function(a){return F(a)};this.uiEndTurnInfo=function(){A.render();w()};this.uiSetUnitOnViewPort=function(a){return a?C(a.getPos()):
!1};this.uiSetCellOnViewPort=function(a){return C(a)};this.scaleMap=function(a){return Y(a)}};var UICombatLog=function(a){function f(a){return"<span class='combatLogNum'>"+a+"</span>"}a.showCombatLog=function(d){var f=$("combatLog"),n=game.scenario.map.map;clearTag(f);a.buildCombatSummary(f,n);a.buildObjectiveSummary(f,n);a.buildResupplySummary(f,n);a.buildReinforceSummary(f,n);a.buildLeadersSummary(f,n);d||a.buildExtendButton(f);a.buildTurnInfo(f);makeVisible("combatLog");var n=getPosition("unit-info"),n=Math.round((n.top-30)/uiSettings.uiScale),k=f.childNodes[f.childNodes.length-1],k=k.offsetTop+
k.offsetHeight;n>k&&(n=k);d?f.style.height=n+"px":(175<n&&(n=175),f.style.height=n+"px",f.scrollTop=0)};a.buildExtendButton=function(d){d=insertTag(d,"div",d.firstChild);d.className="combatLogHeader";d.style.paddingTop="5px";d.innerHTML="Show Turn Summary";d.innerHTML+="<span style='font-family: openpanzer-menu; font-size: 22px;font-weight: normal;color: #f8e064;line-height: 0px;display: block;'>l</span><br/>";d.onclick=function(){a.showCombatLog(!0)}};a.buildTurnInfo=function(a){var l=game.scenario.map,
n=l.currentPlayer,k=0;a=insertTag(a,"div",a.firstChild);a.className="combatLogHeader";a.style.paddingTop="15px";var b="<span style='font-weight: bold; text-align: center; color: #33ccff;'>"+n.getCountryName()+" Turn "+l.turn+" of "+l.maxTurns+"</span>";null!==game.campaign&&(b+="<span class='smallButtonMenu combatLogInfoButton' style='left: 15px' onclick=\"(function() { makeHidden('combatLog'); UIBuilder.showDossier(true, false); })();\">@</span><br>");b+="<span class='smallButtonMenu combatLogInfoButton' style='right: 15px; font-size: 16px'onclick=\"(function(){ UICombatLog.toggleCombatLog(); UIBuilder.message(game.scenario.name, game.scenario.getDescription());})();\">g</span><hr/><span style='color: #f8e064;text-align: center;font-family: Arial;font-size: 14px;font-weight: normal;'>";
b+="<i>"+game.scenario.name+"</i>, "+game.scenario.date.toDateString()+"<br/> ";b+=f(l.sidesVictoryHexes[n.side].length)+"</b> objectives left to conquer, in ";0<(k=l.victoryTurns[0]-(l.turn-1))&&(b+=f(k)+" turns for <i>"+outcomeNames.briliant+"</i>, ");0<(k=l.victoryTurns[1]-(l.turn-1))&&(b+=f(k)+" turns for <i>"+outcomeNames.victory+"</i> and ");0<(k=l.victoryTurns[2]-(l.turn-1))&&(b+=f(k)+" turns for <i>"+outcomeNames.tactical+"</i>");b+="<br/>Current score is "+f(n.score)+" and ";b+="prestige is "+
f(n.prestige)+"&nbsp;"+UIBuilder.currencyIcon;b+=" gaining "+f(n.prestigePerTurn[l.turn+1])+"&nbsp;"+UIBuilder.currencyIcon+" next turn<br/>";b+="<span style='font-family: openpanzer;color: #33ccff; font-size:22px;'>"+weatherFontEncoding[game.scenario.atmosferic]+"</span> "+weatherConditionNames[game.scenario.atmosferic]+" weather ";b+=" and <span style='font-family: openpanzer; color: #33ccff; font-size: 22px;'>"+groundFontEncoding[game.scenario.ground]+"</span> "+groundConditionNames[game.scenario.ground]+
" ground.";b+="</span>";a.innerHTML=b};a.buildCombatSummary=function(a,l){var n=0,k;for(k in CombatLog.log.combat){var b=CombatLog.log.combat[k];if(b.side==game.spotSide){var g="",m="",x="",q="",r="",s,p,y=Equipment.equipment[b.eqid];n++;p=b.isCore?insertTag(a,"div",a.firstChild):addTag(a,"div");m=addTag(p,"div");s=addTag(p,"div");p.className="combatLogLine";m.className="combatLogUnitBox";s.className="combatLogInfoBox";addTag(m,"img").src=y.uclass>unitClass.airTransport?UIBuilder.navalReplacementIcon:
y.icon;m=b.assaults>=b.defends||b.supports>=b.defends?b.supports>=b.assaults?" provided fire support from ":" while assaulting from ":" while defending ";""!=l[b.pos.row][b.pos.col].name&&(r=l[b.pos.row][b.pos.col].name+" ");l[b.pos.row][b.pos.col].terrain!==terrainType.Clear&&(r+=terrainNames[l[b.pos.row][b.pos.col].terrain]+" ");g=b.isCore?g+f("Core "):g+"Auxiliary ";g+="Unit <b>"+UIBuilder.unitIDToOrdinal(b.id)+" "+y.name+"</b>"+m+r+" <b>("+b.pos.row+","+b.pos.col+")</b> ";0<b.assaults&&(x=" in "+
b.assaults+" assaults",q=" and");q=0<b.defends?q+(" defending from "+b.defends+" attacks "):"";0<b.kills&&(g+=" inflicted "+f(b.kills)+" casualties ");0!=b.losses&&(0<b.kills&&(g+="and "),g+="lost "+f("-"+b.losses)+" strength",0<b.str?g+=" with "+f(b.str)+" surviving ":(g+=" being completely destroyed ",s.className="combatLogInfoBoxRed"));g+=x;g+=q;0!=b.xp&&0<b.str&&(g+=" and gained +"+f(b.xp)+" experience. ");b.ammo<y.ammo/4&&(g+=" Unit is low on ammo "+f(b.ammo+"/"+y.ammo)+" remaining. ");0<b.entrenchLost?
g+=f(b.entrenchLost)+" entrenchments had been destroyed during combat with "+f(b.entrench)+" remaining.":0<b.entrench&&(g+=" Unit has "+f(b.entrench)+" remaining entrenchments");s.innerHTML=g;p.row=b.pos.row;p.col=b.pos.col;p.onclick=function(){return game.ui.uiSetCellOnViewPort({row:this.row,col:this.col})};b.isCore?insertTag(a,"hr",p.nextSibling):addTag(a,"hr")}}k=insertTag(a,"div",a.firstChild);k.className="combatLogHeader";k.innerHTML="Unit Combat Report";insertTag(a,"hr",k.nextSibling);0==n&&
(p=addTag(a,"div"),p.innerHTML="All quiet on this front");return n};a.buildResupplySummary=function(a,l){var n=0,k=addTag(a,"div");k.className="combatLogHeader";k.innerHTML="Resupply Report";insertTag(a,"hr",k.nextSibling);for(var b in CombatLog.log.resupply)if(k=CombatLog.log.resupply[b],k.side==game.spotSide&&!(0>k.ammo&&0>k.fuel&&0>k.entrench)){var g="",m,x,q,r=Equipment.equipment[k.eqid];n++;q=addTag(a,"div");m=addTag(q,"div");x=addTag(q,"div");q.className="combatLogLine";m.className="combatLogUnitBox";
x.className="combatLogInfoBox";addTag(m,"img").src=r.uclass>unitClass.airTransport?UIBuilder.navalReplacementIcon:r.icon;g=k.isCore?g+f("Core "):g+"Auxiliary ";g+="Unit <b>"+UIBuilder.unitIDToOrdinal(b)+" "+r.name+"</b>";0<k.ammo&&(g+=" resupplied automatically with "+f(k.ammo+"/"+r.ammo)+" ammunition ");0<k.fuel&&0<r.fuel&&(0<k.ammo&&(g+="and "),g+=f(k.fuel+"/"+r.fuel)+" fuel.");x.innerHTML=g;addTag(a,"hr")}0==n&&(q=addTag(a,"div"),q.innerHTML="No units had been provided with automatic resupply.");
return n};a.buildReinforceSummary=function(a,f){var n=0,k=addTag(a,"div");k.className="combatLogHeader";k.innerHTML="Reinforcements Report";insertTag(a,"hr",k.nextSibling);for(k=0;k<CombatLog.log.reinforce.length;k++){var b=CombatLog.log.reinforce[k];if(b.side==game.spotSide){var g="",m,x,q,r=Equipment.equipment[b.eqid];n++;q=addTag(a,"div");m=addTag(q,"div");x=addTag(q,"div");q.className="combatLogLine";m.className="combatLogUnitBox";x.className="combatLogInfoBox";addTag(m,"img").src=r.uclass>unitClass.airTransport?
UIBuilder.navalReplacementIcon:r.icon;g+="Unit <b>"+r.name+"</b>";g+=" received as reinforcement at <b>("+b.pos.row+","+b.pos.col+")</b> ";x.innerHTML=g;q.row=b.pos.row;q.col=b.pos.col;q.onclick=function(){return game.ui.uiSetCellOnViewPort({row:this.row,col:this.col})};addTag(a,"hr")}}0==n&&(q=addTag(a,"div"),q.innerHTML="No reinforcements arrived.");return n};a.buildLeadersSummary=function(a,l){var n=0,k=addTag(a,"div");k.className="combatLogHeader";k.innerHTML="Unit Leaders Report";insertTag(a,
"hr",k.nextSibling);for(k=0;k<CombatLog.log.leaders.length;k++){var b=CombatLog.log.leaders[k];if(b.side==game.spotSide){var g="",m,x,q,r=Equipment.equipment[b.eqid];n++;q=addTag(a,"div");m=addTag(q,"div");x=addTag(q,"div");q.className="combatLogLine";m.className="combatLogUnitBox";x.className="combatLogInfoBox";addTag(m,"img").src=r.icon;g=b.isCore?g+f("Core "):g+"Auxiliary ";g+="Unit <b>"+UIBuilder.unitIDToOrdinal(b.id)+" "+r.name+"</b>";g+=" received a new Leader with "+f(Leaders.description[b.classLeader][0]);
g+=" and "+f(Leaders.description[b.leader][0])+" abilities";q.row=b.pos.row;q.col=b.pos.col;x.innerHTML=g;q.onclick=function(){return game.ui.uiSetCellOnViewPort({row:this.row,col:this.col})};addTag(a,"hr")}}0==n&&(q=addTag(a,"div"),q.innerHTML="No units received leaders");return n};a.buildObjectiveSummary=function(a,l){var n=0,k=addTag(a,"div");k.className="combatLogHeader";k.innerHTML="Objectives Report";insertTag(a,"hr",k.nextSibling);for(k=0;k<CombatLog.log.objectives.length;k++){var b=CombatLog.log.objectives[k],
g="",m,x=l[b.pos.row][b.pos.col];x&&"undefined"!==typeof x&&(n++,m=addTag(a,"div"),g=b.side==game.spotSide?g+("Captured objective  "+x.name+" at <b>("+b.pos.row+","+b.pos.col+")</b>, prestige increased by "+f(prestigeGains.objectiveCapture)+"&nbsp;"+UIBuilder.currencyIcon):g+("Lost objective  "+x.name+" at <b>("+b.pos.row+","+b.pos.col+")</b>"),m.innerHTML=g,m.row=b.pos.row,m.col=b.pos.col,m.onclick=function(){return game.ui.uiSetCellOnViewPort({row:this.row,col:this.col})},addTag(a,"hr"))}0==n&&
(m=addTag(a,"div"),m.innerHTML="No objectives has been captured or lost");return n};a.toggleCombatLog=function(d,f){var n=game.scenario.map.currentPlayer;if(n.type==playerType.humanLocal||n.type==playerType.aiScripted)d||!isVisible("combatLog")?(a.showCombatLog(f),toggleButton($("combatLogButton"),!0)):(makeHidden("combatLog"),toggleButton($("combatLogButton"),!1)),UIBuilder.closeDossier()};return a}(UICombatLog||{});var game=new Game;
function Game(){function a(a){var b,d=a.scenario.map.getPlayers();if(null===d)return!1;for(b=0;b<d.length;b++)if(null!==a.campaign)d[b].country!=a.campaign.country?(d[b].type=playerType.aiLocal,d[b].handler=new AI(d[b],a.scenario.map)):(n=d[b],null===k?(k=new Player,k.copy(d[b])):d[b].copy(k,!0));else if(1==uiSettings.isAI[d[b].id]||d[b].type==playerType.aiLocal)d[b].type=playerType.aiLocal,d[b].handler=new AI(d[b],a.scenario.map);else if(2==uiSettings.isAI[d[b].id]||d[b].type==playerType.aiScripted)d[b].type=
playerType.aiScripted,d[b].handler=new AIScripted(d[b],a.scenario.map);return!0}function f(a,b){if(!b)return!1;var d=b.param;if(!d)return!1;switch(b.type){case actionType.move:a.scenario.map.setMoveRange(d[0]);a.waitUIAnimation=!0;a.ui.uiUnitMove(d[0],d[1].row,d[1].col)?a.ui.uiSetUnitOnViewPort(d[0]):a.waitUIAnimation=!1;break;case actionType.attack:a.waitUIAnimation=!0;GameRules.isInAttackRange(d[0],d[1])&&a.ui.uiUnitAttack(d[0],d[1])?a.ui.uiSetUnitOnViewPort(d[0]):a.waitUIAnimation=!1;break;case actionType.resupply:a.scenario.map.resupplyUnit(d[0]);
break;case actionType.reinforce:a.scenario.map.reinforceUnit(d[0],!1);break;case actionType.mount:a.scenario.map.mountUnit(d[0]);break;case actionType.umount:a.scenario.map.unmountUnit(d[0]);break;case actionType.upgrade:break;case actionType.buy:break;case actionType.deploy:break;case actionType.select:a.ui.uiSetUnitOnViewPort(d[0]);a.ui.uiUnitSelect(d[0]);break;case actionType.endturn:return!1;case actionType.message:a.waitUIAnimation=!0;a.ui.showGameToolTip(d[0],d[1].row,d[1].col);a.ui.uiSetCellOnViewPort(d[1]);
break;case actionType.viewport:a.ui.uiSetCellOnViewPort(d[0]);break;default:return!1}return!0}function d(a){for(var b=1,d=-1,f=0;f<a.length;f++)if(a[f].type==playerType.humanLocal||a[f].type==playerType.aiScripted)-1!=d&&d!=a[f].side&&b++,d=a[f].side;1<b&&(d=2);DEBUG_AI_MOVES&&(d=2);return d}this.scenario=this.campaign=this.state=this.ui=null;this.waitUIAnimation=this.gameEnded=this.gameStarted=!1;this.spotSide=-1;this.uiMessageClicked=!1;var l=-1,n=null,k=null,b=!1,g=null,m=!1,x=!1,q=!1;this.init=
function(){this.state=new GameState(this);this.state.restore(this.onScenarioLoadFinished.bind(this,null,!0),this.newScenario.bind(this,"failRestore"))};this.processTurn=function(){if(game.gameStarted&&!game.gameEnded)if(null!==g&&b&&game.uiMessageClicked)game.newScenario(g.scenario,g.intro);else{var a=game.scenario.map.currentPlayer;a&&a.type!=playerType.aiLocal&&a.type!=playerType.aiScripted||!game.waitUIAnimation&&game.uiMessageClicked&&game.processAIActions()}};this.startTurn=function(){};this.processAIActions=
function(){var a=this.scenario.map.currentPlayer.handler.getAction();f(this,a)||(UIBuilder.showAIStatus(!1),game.waitUIAnimation=!0,game.endTurn(),setTimeout(function(){game.gameEnded||game.ui.uiEndTurnInfo()},2500))};this.endTurn=function(){var a=this.scenario.map.currentPlayer.side;this.waitUIAnimation=!1;this.scenario.endTurn();this.scenario.checkDefeat(a,l)?null!==this.campaign?this.continueCampaign("lose",endGameType.noTurnsLeft):this.gameEnded=!0:(this.state.save(),null!==this.campaign&&game.state.saveCampaign(),
this.setCurrentSide(),this.deployReinforcements(this.scenario.map.turn,this.scenario.map.currentPlayer.id))};this.loop=setInterval(this.processTurn,1E3);this.setupGameState=function(){k=null;a(this);l=d(this.scenario.map.getPlayers());this.setCurrentSide();this.gameStarted=!0;b=this.gameEnded=!1;null!==this.campaign&&this.state.saveCampaign();this.state.save();this.ui.setNewScenario()};this.newScenario=function(a,b){if("failRestore"===a){for(var d=0;d<uiSettings.isAI.length;d++)uiSettings.isAI[d]=
Game.defaultScenarioAI[d];a=Game.defaultScenario}this.cleanup();this.scenario=new Scenario(a);this.scenario.load(this.onScenarioLoadFinished.bind(this,b,!1))};this.onScenarioLoadFinished=function(f,g){if(!this.scenario.isLoaded)return UIBuilder.messageDynamic("Error","Error Loading scenario "+this.scenario.file),game.gameEnded=!0,!1;defined(f)&&this.scenario.setDescription(f);a(this);var k=this.scenario.map.getPlayers();l=d(k);this.setCurrentSide();this.waitUIAnimation=!1;this.gameStarted=!0;b=this.gameEnded=
!1;if(null!==this.campaign)q&&(n.prestige=this.campaign.startprestige,n.initDossier(),this.scenario.map.buildCoreUnitList(n)),m&&this.scenario.map.removeNonCampaignUnits(n),x&&(k=this.scenario.getRandomPrototype(n.country+1),"undefined"!==typeof k&&0<k&&(n.acquireUnit(k,0),x=!1,UIBuilder.showPrototypeAwardMessage(k))),this.state.saveCampaign();else if(this.scenario.showStatistics(),!g&&"tutorial.xml"!==this.scenario.file)for(var y=0;y<k.length;y++){var I=k[y];I.prestige=this.scenario.getBalancedPrestige(I.side)}this.state.save();
this.ui?this.ui.setNewScenario():(this.ui=new UI(this),this.ui.mainMenuButton("options"))};this.newCampaign=function(a,b){this.campaign=new Campaign(a,b,this.onCampaignLoadFinished.bind(this))};this.onCampaignLoadFinished=function(){k=null;m=!1;q=!0;var a=this.campaign.getCurrentScenario();this.newScenario(a.scenario,a.intro)};this.continueCampaign=function(a,d){n.prestige+=this.campaign.getOutcomePrestige(a);n.addOutcomeToDossier(a,this.scenario.name);OSGlue.reportScore(n.score);n.setPlayerToHQ();
k.supportCountries=[];k.prestigePerTurn=[];k.copy(n);m=!0;q=!1;var f=this.campaign.getOutcomeText(a);g=this.campaign.loadNextScenario(a);null==g?("lose"==a&&(f=endGameLossText[d]+f),UIBuilder.showCampaignEnd(a,f,function(){game.ui.mainMenuButton("options")}),this.gameEnded=!0,this.gameStarted=!1,"lose"!=a&&OSGlue.reportAchievement(this.campaign.file)):(UIBuilder.message(outcomeNames[a],f),b=!0,"briliant"==a&&(x=!0))};this.getCampaignPlayer=function(){return null!==this.campaign?n:null};this.setCurrentSide=
function(){this.spotSide=2==l?this.scenario.map.currentPlayer.side:l};this.deployReinforcements=function(a,b){var d=!1,f=this.scenario.getReinforcements(a,b);if(0>=f.length)return!1;for(var g=0;g<f.length;g++){var k=null;if(null!==(k=this.scenario.map.deployReinforcement(f[g].unit,f[g].row,f[g].col))&&(d=!0,CombatLog.addReinforcement(f[g].unit),this.scenario.removeReinforcement(f[g].turn,f[g].id),this.scenario.map.map[k.row][k.col].isSpotted(this.spotSide))){var l=this.scenario.map.getPlayer(b).side,
m=!1;this.spotSide==l&&(m=!0);this.ui.showAlert(k.row,k.col,"Reinforced!",m)}}d&&game.ui.handleReinforcementDeployment();return!0};this.cleanup=function(){this.state.clear();this.scenario&&null!==this.scenario.map&&(this.scenario.map.cleanup(),delete this.scenario.map,this.scenario.map=null);delete this.scenario;this.scenario=null}}Game.defaultScenario="tutorial.xml";Game.defaultScenarioAI=[0,1,0,0];function gameStart(){game.init()}window.addEventListener("load",gameStart);var OSGlue=function(a){a.ios=function(){this.diskloadHTML="Load from Disk";this.diskloadEvent=function(a,d){a.addEventListener("click",d,!1)};this.diskload=function(){window.location="openpanzer://loadfromdisk"};this.disksave=function(a){window.location="openpanzer://savetodisk/"+a};this.reportScore=function(a){};this.reportAchievement=function(a){};this.canvasErrorMsg="<b>Couldn't create game surface.</b> <br/>This usually means that your device doesn't allow game surface to be created with dimensions over a certain limit (iPhone 3GS/iPod Touch 4).<br/><br/>You can play smaller scenarios like Huertgen Forest or Bizerte from New Scenario in Main Menu."};
a.generic=function(){this.diskloadHTML="Load from Disk <input id='diskloadfile' type='file'/>";this.diskloadEvent=function(a,d){a.addEventListener("change",d,!1)};this.diskload=function(a,d){game.state.restoreFromFile($("diskloadfile").files[0],a,d);$("diskloadfile").value=""};this.disksave=function(a){$("savedata").download=a;$("savedata").href="data:application/force-download,"+encodeURIComponent(game.state.exportGameState());$("savedata").click();$("disksaveupdate").innerHTML=a};this.reportScore=
function(a){};this.reportAchievement=function(a){};this.canvasErrorMsg="Couldn't load map image !"};return"ios"==NATIVE_PLATFORM||"android"==NATIVE_PLATFORM?new a.ios:new a.generic}(OSGlue||{});var Leaders=function(a){a.unitClassLeaders={};a.description=[];a.LEADER_CHANCE_THRESHOLD=8;a.unitClassLeaders[unitClass.none]=[];a.unitClassLeaders[unitClass.infantry]=[leaderType.tenaciousDefense,leaderType.aggressiveAttack,leaderType.aggressiveManeuver,leaderType.battlefieldIntelligence,leaderType.determinedDefense,leaderType.ferociousDefense,leaderType.firstStrike,leaderType.infiltrationTactics,leaderType.liberator];a.unitClassLeaders[unitClass.tank]=[leaderType.aggressiveTankManeuver,leaderType.aggressiveAttack,
leaderType.aggressiveManeuver,leaderType.battlefieldIntelligence,leaderType.determinedDefense,leaderType.firstStrike,leaderType.infiltrationTactics,leaderType.liberator];a.unitClassLeaders[unitClass.recon]=[leaderType.eliteReconVeteran,leaderType.aggressiveAttack,leaderType.aggressiveManeuver,leaderType.battlefieldIntelligence,leaderType.determinedDefense,leaderType.firstStrike,leaderType.infiltrationTactics,leaderType.liberator];a.unitClassLeaders[unitClass.antiTank]=[leaderType.tankKiller,leaderType.aggressiveAttack,
leaderType.aggressiveManeuver,leaderType.battlefieldIntelligence,leaderType.determinedDefense,leaderType.ferociousDefense,leaderType.firstStrike,leaderType.infiltrationTactics,leaderType.liberator];a.unitClassLeaders[unitClass.flak]=[];a.unitClassLeaders[unitClass.fortification]=[];a.unitClassLeaders[unitClass.groundTransport]=[];a.unitClassLeaders[unitClass.artillery]=[leaderType.marksman,leaderType.aggressiveAttack,leaderType.aggressiveManeuver,leaderType.battlefieldIntelligence,leaderType.determinedDefense,
leaderType.fireDiscipline,leaderType.infiltrationTactics];a.unitClassLeaders[unitClass.airDefence]=[leaderType.mechanizedVeteran,leaderType.aggressiveAttack,leaderType.aggressiveManeuver,leaderType.determinedDefense,leaderType.fireDiscipline,leaderType.infiltrationTactics];a.unitClassLeaders[unitClass.fighter]=[leaderType.skilledInterceptor,leaderType.aggressiveAttack,leaderType.aggressiveManeuver,leaderType.battlefieldIntelligence,leaderType.determinedDefense,leaderType.firstStrike];a.unitClassLeaders[unitClass.tacticalBomber]=
[leaderType.skilledAssault,leaderType.aggressiveAttack,leaderType.aggressiveManeuver,leaderType.determinedDefense,leaderType.fireDiscipline,leaderType.firstStrike];a.unitClassLeaders[unitClass.levelBomber]=[];a.unitClassLeaders[unitClass.airTransport]=[];a.unitClassLeaders[unitClass.submarine]=[];a.unitClassLeaders[unitClass.destroyer]=[];a.unitClassLeaders[unitClass.battleship]=[];a.unitClassLeaders[unitClass.carrier]=[];a.unitClassLeaders[unitClass.navalTransport]=[];a.unitClassLeaders[unitClass.battleCruiser]=
[];a.unitClassLeaders[unitClass.cruiser]=[];a.unitClassLeaders[unitClass.lightCruiser]=[];a.description[leaderType.mechanizedVeteran]=["Mechanized Veteran","Air Defence unit may move and fire in the same turn."];a.description[leaderType.tankKiller]=["Tank Killer","Anti-Tank unit will not receive a penalty for movement into combat."];a.description[leaderType.marksman]=["Marksman","The artillery unit attack range is increased by one hex."];a.description[leaderType.skilledInterceptor]=["Skilled Interceptor",
"Fighter unit can intercept multiple enemy fighters in the defensive phase."];a.description[leaderType.tenaciousDefense]=["Tenacious Defense","The infantry unit ground defense factor is increased by 4."];a.description[leaderType.eliteReconVeteran]=["Elite Recon Veteran","Recon unit spotting range is increased by two hexes."];a.description[leaderType.skilledAssault]=["Skilled Assault","The tactical bomber cannot be surprised (out of the sun) while moving."];a.description[leaderType.aggressiveTankManeuver]=
["Aggressive Tank Maneuver","Tank movement factor is increased by 1."];a.description[leaderType.aggressiveAttack]=["Aggressive Attack","Each of the unit attack values is increased by 2."];a.description[leaderType.aggressiveManeuver]=["Aggressive Maneuver","The unit movement factor is increased by 1."];a.description[leaderType.allWeatherCombat]=["All Weather Combat","The air unit is not affected by weather conditions. Note: This can only be awarded air units."];a.description[leaderType.alpineTraining]=
["Alpine Training","When moving the unit treats forest and mountain hexes as clear terrain."];a.description[leaderType.battlefieldIntelligence]=["Battlefield Intelligence","The unit cannot be surprised."];a.description[leaderType.bridging]=["Bridging","When moving the unit treats passable river hexes as rough terrain."];a.description[leaderType.combatSupport]=["Combat Support","The unit provides both Resilience and Skilled Ground Attack abilities to all adjoining units during combat phases. Will aid inflicting losses and save from loses by 2 to 3 points each battle."];
a.description[leaderType.determinedDefense]=["Determined Defense","Each of the unit defense factors is increased by 2."];a.description[leaderType.devastatingFire]=["Devastating Fire","The unit may fire twice in a turn."];a.description[leaderType.ferociousDefense]=["Ferocious Defense","The unit entrenchment cannot be ignored by enemy units."];a.description[leaderType.fireDiscipline]=["Fire Discipline","The unit will expend only one-half of an ammunition point each time it attacks."];a.description[leaderType.firstStrike]=
["First Strike","The unit will fire first against an enemy unit if it wins the initiative in a combat round."];a.description[leaderType.forestCamouflage]=["Forest Camouflage","If in a forest hex the unit cannot be spotted by enemy units unless they move adjacent to it."];a.description[leaderType.infiltrationTactics]=["Infiltration Tactics","The unit ignores enemy unit entrenchment when calculating combat results."];a.description[leaderType.influence]=["Influence","Allows the unit to upgrade to better equipment at reduced prestige point cost."];
a.description[leaderType.liberator]=["Liberator","You receive double the normal number of prestige points for all objective and victory hexes captured by the unit."];a.description[leaderType.overwatch]=["Overwatch","The unit will fire at any enemy unit that moves within its range. The enemy unit is automatically surprised, allowing your unit to fire first and at the enemy\u2019s close assault, rather than its ground defense, factor."];a.description[leaderType.overwhelmingAttack]=["Overwhelming Attack",
"When attacking the unit will have an indeterminate number of the suppression points it would otherwise inflict converted to kills."];a.description[leaderType.reconMovement]=["Recon Movement","The unit is permitted phased movement, just like reconnaissance units."];a.description[leaderType.resilience]=["Resilience","The unit will suffer 1 to 3 fewer step casualties than normal units when attacked."];a.description[leaderType.shockTactics]=["Shock Tactics","Any suppression which the unit inflicts on an enemy unit will last the entire player turn, not just the specific combat round."];
a.description[leaderType.skilledGroundAttack]=["Skilled Ground Attack","The unit will inflict 1 to 3 more step casualties than normal units when attacking."];a.description[leaderType.skilledReconnaissance]=["Skilled Reconnaissance","The unit spotting range is increased by one hex."];a.description[leaderType.streetFighter]=["Street Fighter","The unit ignores an enemy unit city entrenchment when calculating combat results."];a.description[leaderType.superiorManeuver]=["Superior Maneuver","The unit may bypass enemy unit zones of control."];
a.generateLeader=function(f){if(!f)return-1;f=f.unitData().uclass;var d=a.unitClassLeaders[f].length;if(2>d)return-1;d=Math.floor(Math.random()*(d-1-2))+1;return a.unitClassLeaders[f][d]};a.generateLeaderWithChance=function(f,d){if(!f||-1!=f.leader)return-1;var l=f.experience/100>>0,n=(f.experience-d)/100>>0,k=Math.floor(Math.random()*(10-l+1))+l;return f.experience>=UNIT_MAX_EXPERIENCE?a.generateLeader(f):0>=l-n?-1:k>a.LEADER_CHANCE_THRESHOLD?a.generateLeader(f):-1};a.getUnitClassLeader=function(f){return f&&
-1!=f.leader?a.unitClassLeaders[f.unitData().uclass][0]:-1};a.unitHasLeader=function(f,d){if(!f||-1==f.leader)return!1;if(f.leader==d)return!0;var l=a.getUnitClassLeader(f);return d==l?!0:!1};a.getUnitLeaderDescriptions=function(f){if(!f||-1==f.leader)return[];var d=[],l=a.getUnitClassLeader(f);d.push(a.description[f.leader]);d.push(a.description[l]);return d};return a}(Leaders||{});
