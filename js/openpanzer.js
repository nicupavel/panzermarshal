var unitType={none:-1,soft:0,hard:1,air:2,sea:3},unitTypeNames=["Soft","Hard","Air","Sea"],unitClass={none:0,infantry:1,tank:2,recon:3,antiTank:4,flak:5,fortification:6,groundTransport:7,artillery:8,airDefence:9,fighter:10,tacticalBomber:11,levelBomber:12,airTransport:13,submarine:14,destroyer:15,battleship:16,carrier:17,navalTransport:18,battleCruiser:19,cruiser:20,lightCruiser:21},unitClassNames="No Class;Infantry;Tank;Recon;Anti Tank;Flak;Fortification;Ground Transport;Artillery;Air Defence;Fighter Aircraft;Tactical Bomber;Level Bomber;Air Transport;Submarine;Destroyer;Battleship;Aircraft Carrier;Naval Transport;Battle Cruiser;Cruiser;Light Cruiser".split(";"),
unitEntrenchRate=[0,3,1,2,2,1,1,1,2,2,0,0,0,0,0,0,0,0,0,0,0,0],roadType={none:0,north:1,northeast:2,eastunused:4,southeast:8,south:16,southwest:32,westunused:64,northwest:128},direction={S:0,SSE:1,SE:2,ESE:3,E:4,ENE:5,NE:6,NNE:7,N:8,NNW:9,NW:10,WNW:11,W:12,WSW:13,SW:14,SSW:15},terrainType={Clear:0,City:1,Airfield:2,Forest:3,Bocage:4,Hill:5,Mountain:6,Sand:7,Swamp:8,Ocean:9,River:10,Fortification:11,Port:12,Stream:13,Escarpment:14,impassableRiver:15,Rough:16},terrainNames="Clear;City;Airfield;Forest;Bocage;Hill;Mountain;Sand;Swamp;Ocean;River;Fortification;Port;Stream;Escarpment;Impassable river;Rough".split(";"),
terrainEntrenchment=[0,3,0,2,2,1,2,0,0,0,0,4,1,0,0,0,2],terrainInitiative=[99,1,99,3,3,5,1,99,2,99,99,3,5,99,99,99,3,1],groundCondition={dry:0,frozen:1,mud:2},groundConditionNames=["Dry","Frozen","Mud"],groundFontEncoding=["6","8","7"],weatherCondition={fair:0,overcast:1,rain:2,snow:3},weatherConditionNames=["Fair","Overcast","Raining","Snowing"],weatherFontEncoding=["4","5","1","2"],playerSide={axis:0,allies:1},sideNames=["Axis","Allies"],movMethod={tracked:0,halfTracked:1,wheeled:2,leg:3,towed:4,
air:5,deepnaval:6,costal:7,allTerrainTracked:8,amphibious:9,naval:10,allTerrainLeg:11},movMethodNames="Tracked;Half Tracked;Wheeled;Leg;Towed;Air;Deep Naval;Costal;All Terrain;Amphibious;Naval;Mountain Leg".split(";"),outcomeNames={lose:"Defeat",victory:"Victory",tactical:"Tactical Victory",briliant:"Brilliant Victory"},embarkType={none:0,naval:1,airmobile:2,airborne:3},movTableDry=[[1,1,1,2,4,2,254,1,4,255,254,1,1,2,255,255,2,1],[1,1,1,2,254,2,254,1,4,255,254,1,1,2,255,255,2,1],[2,1,1,4,254,3,254,
3,254,255,254,2,1,4,255,255,2,1],[1,1,1,2,2,2,254,2,2,255,254,1,1,1,255,255,2,1],[1,1,1,1,1,1,254,1,255,255,254,1,1,254,255,255,1,1],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[255,255,255,255,255,255,255,255,255,1,255,255,1,255,255,255,255,255],[255,255,255,255,255,255,255,255,255,2,1,255,1,255,255,255,255,255],[1,1,1,2,3,3,254,2,254,255,254,1,1,1,255,255,3,1],[1,1,1,2,4,2,254,1,3,254,3,1,1,2,255,255,2,1],[255,255,255,255,255,255,255,255,255,1,255,255,1,255,255,255,255,255],[1,1,1,1,2,1,1,2,2,255,254,
1,1,1,255,255,1,1]],movTableFrozen=[[1,1,1,2,4,2,254,1,2,255,2,1,1,2,255,255,2,1],[1,1,1,2,254,3,254,1,2,255,2,1,1,2,255,255,3,1],[2,2,2,254,254,254,254,3,3,255,3,3,2,4,255,255,4,2],[1,1,1,2,2,2,254,2,1,255,2,1,1,1,255,255,2,1],[1,1,1,1,1,1,254,1,1,255,254,1,1,254,255,255,1,1],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[255,255,255,255,255,255,255,255,255,1,255,255,1,255,255,255,255,255],[255,255,255,255,255,255,255,255,255,2,255,255,1,255,255,255,255,255],[1,1,1,2,3,3,254,2,3,255,2,1,1,1,255,255,3,1],
[1,1,1,2,4,3,254,1,3,254,2,2,1,2,255,255,3,1],[255,255,255,255,255,255,255,255,255,1,255,255,1,255,255,255,255,255],[1,1,1,1,2,1,2,2,1,255,2,1,1,1,255,255,2,1]],movTableMud=[[2,1,1,2,4,3,254,1,254,255,254,2,1,2,255,255,3,2],[3,1,1,2,254,3,254,1,254,255,254,2,1,2,255,255,3,2],[4,2,2,254,254,254,254,3,254,255,254,4,2,4,255,255,254,2],[2,1,1,2,2,2,254,2,1,255,254,2,1,1,255,255,3,1],[2,1,1,1,1,2,254,1,255,255,254,21,1,254,255,255,2,2],[2,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[255,255,255,255,255,255,255,
255,255,1,255,255,1,255,255,255,255,255],[255,255,255,255,255,255,255,255,255,2,255,255,1,255,255,255,255,255],[2,1,1,2,3,3,254,2,3,255,255,2,1,1,255,255,4,2],[1,1,1,2,4,3,254,1,3,254,3,2,1,2,255,255,3,1],[255,255,255,255,255,255,255,255,255,1,255,255,1,255,255,255,255,255],[2,1,1,1,3,1,3,2,1,255,254,2,1,1,255,255,3,1]],movTable=movTableDry,directionToRadians=[Math.PI,5*Math.PI/6,3*Math.PI/4,2*Math.PI/3,Math.PI/2,Math.PI/3,Math.PI/4,Math.PI/6,0,11*Math.PI/6,7*Math.PI/4,5*Math.PI/3,3*Math.PI/2,4*Math.PI/
3,5*Math.PI/4,7*Math.PI/6],playerType={humanLocal:0,humanNetwork:1,aiLocal:2,aiServer:3,aiScripted:4},actionType={move:0,attack:1,resupply:2,reinforce:3,upgrade:4,buy:5,deploy:6,mount:7,umount:8,select:9,endturn:10,message:11,viewport:12},prestigeGains={flagCapture:50,objectiveCapture:150},scoreGains={coreUnit:-15,normalUnit:-5,objectivePerTurn:1E3,flagCapture:50,objectiveCapture:100,endTurn:-10,damage:10,casualty:-5,casualtyCore:-10,reinforce:-5,resupply:-10},uiSettings={airMode:!1,strategicZoom:!1,
strategicZoomLevel:1,mapZoom:!1,zoomLevel:1,uiScale:1,uiSize:840,uiSmallSize:470,hexGrid:!1,showGridTerrain:!1,muteUnitSounds:!1,deployMode:!1,markCombatUnits:!0,markOwnUnits:!1,markEnemyUnits:!1,markFOW:!1,noFOW:!1,quickAnimation:!1,hasTouch:!1,use3D:!1,useRetina:!1,allowZoom:!1,isAI:[0,0,0,0],shownEndTurnTip:!1,unitInfoVisibility:!1,lastCloudSave:[],showInfoToolTips:!0,showDetailInfoToolTips:!1,showHiddenVictoryHexes:!0},endGameType={moveCapture:"moveCapture",noTurnsLeft:"noTurnsLeft",noEnemyLeft:"noEnemyLeft"},
endGameLossText={moveCapture:"Enemy has captured all your objectives !<br>",noTurnsLeft:"You don't have any turns left !<br>",noEnemyLeft:"All your units had been destroyed !<br>"},leaderType={mechanizedVeteran:1,tankKiller:2,marksman:3,skilledInterceptor:4,tenaciousDefense:5,eliteReconVeteran:6,skilledAssault:7,aggressiveTankManeuver:8,aggressiveAttack:9,aggressiveManeuver:10,allWeatherCombat:11,alpineTraining:12,battlefieldIntelligence:13,bridging:14,combatSupport:15,determinedDefense:16,devastatingFire:17,
ferociousDefense:18,fireDiscipline:19,firstStrike:20,forestCamouflage:21,infiltrationTactics:22,influence:23,liberator:24,overwatch:25,overwhelmingAttack:26,reconMovement:27,resilience:28,shockTactics:29,skilledGroundAttack:30,skilledReconnaissance:31,streetFighter:32,superiorManeuver:33},difficultyType={historical:0,tactical:1,operational:2},difficultyModifiers={0:{startPrestige:0,turnPrestige:0,extraTurns:1,scoreCoef:1},1:{startPrestige:0.2,turnPrestige:0.1,extraTurns:1.2,scoreCoef:0.8},2:{startPrestige:0.5,
turnPrestige:0.25,extraTurns:1.5,scoreCoef:0.5}};function Cell(a,b){this.row=a;this.col=b}function extendedCell(a,b){Cell.call(this,a,b);this.cost=this.cout=this.cin=this.range=0;this.canPass=this.canMove=!1}extendedCell.prototype=new Cell;function pathCell(a){Cell.call(this,a.row,a.col);this.cost=1;this.prev=null;this.dist=Infinity}pathCell.prototype=new Cell;function movementResults(){this.isVisible=!1;this.surpriseCell=[];this.isVictorySide=-1;this.passedCells=[];this.isCapture=!1}
function combatResults(){this.defExpGained=this.atkExpGained=this.defSuppress=this.atkSuppress=this.losses=this.kills=0;this.defcanfire=!0;this.isRugged=this.isOverrun=this.defLeaderGain=this.atkLeaderGain=!1}function Supply(a,b,f,l){this.ammo=a;this.fuel=b;this.transportAmmo=f||0;this.transportFuel=l||0}function mouseInfo(a,b,f){this.x=a;this.y=b;this.rclick=f}function screenPos(a,b){this.x=a;this.y=b}function major_version(a){return a.split(".").slice(0,2).join(".")}
var UNIT_MAX_EXPERIENCE=600,UNIT_RETREAT_THRESHOLD=0.6,CURRENCY_MULTIPLIER=12,UPGRADE_PENALTY=1.2,OVERSTRENGTH_PENALTY=1.2,SCENARIO_START_PRESTIGE=2E3,PROTOTYPE_MIN_COST=200,DEBUG_CAMPAIGN=!1,DEBUG_AI_MOVES=!1,VERSION="3.2.11",MAJOR_VERSION=major_version(VERSION),NATIVE_PLATFORM="generic",NATIVE_PLATFORM="generic",DEBUG_CAMPAIGN=!1;function GameState(a){function b(a,g){if(isChromeApp()){if(g){var d={};d[a]=g;chrome.storage.local.get(function(a){});chrome.storage.local.set(d)}}else localStorage&&g&&localStorage.setItem(a,JSON.stringify(g))}function f(a,g,d,s){var k=null;if(isChromeApp())chrome.storage.local.get(a,function(k){chrome.runtime.lastError&&(k=null);m(g,d,a,k,s)});else return localStorage&&(k=localStorage.getItem(a)),m(g,d,a,JSON.parse(k),s)}function l(a){isChromeApp()?chrome.storage.local.remove(a):localStorage&&localStorage.removeItem(a)}
function n(g){var d=null;try{d=JSON.parse(g)}catch(s){return!1}if(!d||!d.hasOwnProperty("scenario"))return!1;a.cleanup();k(d.scenario,d.players,d.campaign,a.setupGameState.bind(a));return!0}function k(g,s,m,k){a.scenario=new Scenario(g.file);g.eqp&&(Equipment.name=g.eqp);Equipment.addPlayersEquipment(s,d.bind(null,g,s,m,k))}function d(q,d,s,m){if(!--Equipment.equipmentToLoad){for(var k=0;k<d.length;k++){var b=new Player;b.copy(d[k]);a.scenario.map.addPlayer(b)}a.scenario.copy(q);a.scenario.isLoaded=
!0;defined(s)?(q=s.id,s.hasOwnProperty("file")&&(q=Campaign.findCampaignByFile(s.file),0>q&&(q=s.id)),a.campaign=new Campaign(q,s.difficulty||0,g.bind(null,s,m))):(a.campaign=null,m())}}function g(g,d){var s=a.scenario.map;a.campaign.setScenarioById(g.scenario);var m=s.getPlayersByCountry(g.country)[0];s.restoreCoreUnitList(m,g.coreUnits);d()}function m(a,g,d,m,b){isChromeApp()?s[d]=m[d]:s[d]=m;if(Object.keys(s).length==b){d=s[r.scenario];m=s[r.players];var f=s[r.campaign],p=s[r.settings];if(void 0!==
p&&p){if(1==b)return x(p);x(p)}return void 0!==d&&void 0!==m&&(null!==d&&null!==m)&&d.file?k(d,m,f,a):g()}}function x(a){uiSettings.markOwnUnits=a.markOwnUnits;uiSettings.markEnemyUnits=a.markEnemyUnits;uiSettings.use3D=a.use3D;uiSettings.useRetina=a.useRetina;uiSettings.showGridTerrain=a.showGridTerrain;uiSettings.muteUnitSounds=a.muteUnitSounds;uiSettings.noFOW=a.noFOW;uiSettings.quickAnimation=a.quickAnimation;uiSettings.uiScale=a.uiScale;uiSettings.uiSize=a.uiSize;uiSettings.zoomLevel=a.zoomLevel;
uiSettings.shownEndTurnTip=a.shownEndTurnTip;uiSettings.showDetailInfoToolTips=a.showDetailInfoToolTips||!1;uiSettings.showHiddenVictoryHexes=a.showHiddenVictoryHexes||!1;uiSettings.lastCloudSave=[];if(a.hasOwnProperty("lastCloudSave"))for(var g=0;g<a.lastCloudSave.length;g++)uiSettings.lastCloudSave[g]=a.lastCloudSave[g];for(g=0;g<a.isAI.length;g++)uiSettings.isAI[g]=a.isAI[g]}function p(){var g=null;null!==a.campaign&&(g={id:a.campaign.id,file:a.campaign.file,scenario:a.campaign.getCurrentScenario().id,
country:a.campaign.country,difficulty:a.campaign.difficulty,coreUnits:a.getCampaignPlayer().getCoreUnitList()});return g}var r={scenario:"openpanzer-scenario-"+MAJOR_VERSION,players:"openpanzer-players-"+MAJOR_VERSION,settings:"openpanzer-settings-"+MAJOR_VERSION,campaign:"openpanzer-campaign-"+MAJOR_VERSION},s={};this.save=function(){b(r.scenario,a.scenario);b(r.players,a.scenario.map.getPlayers())};this.saveToCloud=function(a,g){var d=this.exportGameState(),s="ghp_"+"G vr 5l NR5H 8Sq 56W".replace(/\s/g,
"")+"ee yAx 7b 95 hs1 1u2 2o2 4W B".replace(/\s/g,""),m={description:game.scenario.name+"-"+game.scenario.map.turn,"public":!0,files:{}},k=!0,b=a.value;if(""==b||"undefined"===typeof b)k=!1;m.files["openpanzer-save.json"]={};m.files["openpanzer-save.json"].content=d;d=new XMLHttpRequest;k?(a.value="Overwriting cloud save "+b+" ...",d.open("PATCH","https://api.github.com/gists/"+b,!0)):(a.value="Creating new cloud save ...",d.open("POST","https://api.github.com/gists",!0));d.setRequestHeader("Accept",
"application/vnd.github.raw");d.setRequestHeader("Content-Type","application/json");d.setRequestHeader("Authorization","bearer "+s);d.onreadystatechange=function(){if(4==this.readyState){if(200<=this.status&&300>this.status||304==this.status){var d=JSON.parse(this.responseText);if(!d)return g("Bad response from server");a.value=d.id;return g(null,d.id)}a.value="";a.setAttribute("placeholder","Cannot create save !");return g("Cannot create save")}};d.send(JSON.stringify(m))};this.restore=function(a,
g){f(r.settings,a,g,4);f(r.scenario,a,g,4);f(r.players,a,g,4);f(r.campaign,a,g,4)};this.restoreFromString=function(a){return n(a)};this.restoreFromFile=function(a,g,d){var s=new FileReader;s.onloadend=function(){if(!n(this.result))return"function"===typeof d&&d(),!1;"function"===typeof g&&g()};s.readAsText(a);return!0};this.restoreFromCloud=function(a,g){var d=a.value;if(""==d||"undefined"===typeof d)return a.setAttribute("placeholder","No ID specified"),!1;var s=new XMLHttpRequest;a.value="Loading ...";
s.open("GET","https://api.github.com/gists/"+d,!0);s.onreadystatechange=function(){if(4==this.readyState)if(200<=this.status&&300>this.status||304==this.status){var s=JSON.parse(this.responseText);if(!s||!s.files.hasOwnProperty("openpanzer-save.json"))return a.value="",a.setAttribute("placeholder","Cannot parse reply !"),!1;if(!n(s.files["openpanzer-save.json"].content))return a.value="",a.setAttribute("placeholder","Cannot find game data in the save file"),!1;delete s;a.value=d;"function"===typeof g&&
g()}else return a.value="",a.setAttribute("placeholder","Cannot load game !"),!1};s.send();return!0};this.clear=function(){l(r.scenario);l(r.players);l(r.campaign)};this.saveCampaign=function(){b(r.campaign,p())};this.saveSettings=function(){b(r.settings,uiSettings)};this.restoreSettings=function(){f(r.settings,null,function(){},1)};this.exportGameState=function(){var g={},d={unit:null,airunit:null,terrain:0,road:0,owner:-1,flag:-1,isDeployment:-1,victorySide:-1,name:"",isMoveSel:!1,isAttackSel:!1};
g.scenario=a.scenario;g.players=a.scenario.map.getPlayers();g.campaign=p();return JSON.stringify(g,function(a,g){if("player"!==a||!this.hasOwnProperty("eqid")){if(g&&g.hasOwnProperty("terrain")&&g.hasOwnProperty("terrain")){var q=!0,s;for(s in d)if(!g.hasOwnProperty(s)||g[s]!==d[s]){q=!1;break}if(q)return{}}return g}})}};var CombatLog=function(a){a.log={};a.log.combat={};a.log.reinforce=[];a.log.leaders=[];a.log.resupply={};a.log.objectives=[];a.combatRound={};a.uniqueID=0;a.reset=function(){a.log={};a.log.combat={};a.log.reinforce=[];a.log.leaders=[];a.log.resupply={};a.log.objectives=[];a.combatRound={};a.uniqueID=0};a.addCombatStart=function(b,f,l){a.uniqueID++;a.combatRound[a.uniqueID]={attacker:{id:b.id,eqid:b.eqid,side:b.player.side,str:b.strength,xp:b.experience,entrench:b.entrenchment,pos:b.getPos(),isMounted:b.isMounted,
isSurprised:b.isSurprised},defender:{id:f.id,eqid:f.eqid,side:f.player.side,str:f.strength,xp:f.experience,entrench:f.entrenchment,pos:f.getPos(),isMounted:f.isMounted},turn:l};return a.uniqueID};a.addCombatEnd=function(b,f,l,n){c=a.combatRound[l];if("undefined"===typeof c)return!1;var k=c.attacker.id,d=c.defender.id,g=a.log.combat[k],m=a.log.combat[d];g&&"undefined"!==typeof g||(a.log.combat[k]=new a.combatUnitInfo,g=a.log.combat[k]);m&&"undefined"!==typeof m||(a.log.combat[d]=new a.combatUnitInfo,
m=a.log.combat[d]);g.id=k;g.eqid=+c.attacker.eqid;g.side=+c.attacker.side;g.losses+=+c.attacker.str-b.strength;g.str=+b.strength;g.xp+=+b.experience-c.attacker.xp;g.ammo=+b.ammo;g.entrenchLost+=+c.attacker.entrench-b.entrenchment;g.entrench=+b.entrenchment;g.pos=c.attacker.pos;g.isSurprised=c.attacker.isSurprised;g.isCore=b.isCore;g.isSupport=c.attacker.isSupport;n?g.supports++:g.assaults++;g.unitCombatList.push(d);m.id=d;m.eqid=+c.defender.eqid;m.side=+c.defender.side;m.losses+=+c.defender.str-f.strength;
m.str=+f.strength;m.xp+=+f.experience-c.defender.xp;m.ammo=+f.ammo;m.entrenchLost+=+c.defender.entrench-b.entrenchment;m.entrench=+f.entrenchment;m.pos=c.defender.pos;m.isCore=f.isCore;m.defends++;m.unitCombatList.push(k);g.kills=m.losses;m.kills=g.losses;m.unitCombatList.push(k);a.combatRound[l]={};delete a.combatRound[l];return!0};a.addReinforcement=function(b){if("undefined"!==typeof b.player&&null!==b.player){var f={};f.eqid=b.eqid;f.pos=b.getPos();f.side=b.player.side;a.log.reinforce.push(f)}};
a.addLeader=function(b){if("undefined"!==typeof b.player&&null!==b.player){var f={};f.id=b.id;f.eqid=b.eqid;f.isCore=b.isCore;f.pos=b.getPos();f.leader=b.leader;f.classLeader=Leaders.getUnitClassLeader(b);f.side=b.player.side;a.log.leaders.push(f)}};a.addResupply=function(b){var f=b.id;if(f&&"undefined"!==typeof f&&"undefined"!==typeof b.player&&null!==b.player){var l=a.log.resupply[f];l&&"undefined"!==typeof l||(a.log.resupply[f]=new a.unitEndTurnInfo,l=a.log.resupply[f]);l.eqid=b.eqid;l.ammo=b.ammo;
l.fuel=b.fuel;l.isCore=b.isCore;l.side=b.player.side}};a.addObjectiveCapture=function(b,f){var l={};l.pos=new Cell(b.row,b.col);l.side=f;a.log.objectives.push(l)};a.combatUnitInfo=function(){this.eqid=this.id=0;this.side=-1;this.ammo=this.entrench=this.entrenchLost=this.xp=this.kills=this.losses=this.str=0;this.pos=new Cell(0,0);this.supports=this.defends=this.assaults=0;this.isCore=this.isSurprised=this.isMounted=!1;this.unitCombatList=[]};a.unitEndTurnInfo=function(){this.eqid=0;this.fuel=this.ammo=
this.side=-1;this.isCore=!1};return a}(CombatLog||{});var Equipment=function(a){function b(b,k){var d=a.equipmentPath+a.name+"/"+(a.filePrefix+b+".json"),g=new XMLHttpRequest;l&&(g.onload=function(){4===g.readyState&&(200!==g.status&&0!==g.status||a.parseCountryEquipment(b,JSON.parse(g.responseText)),k())});g.open("GET",d,l);g.send(null);if(!l&&null!==g.responseText)return a.parseCountryEquipment(b,JSON.parse(g.responseText))}function f(b,k){var d=1;k&&(d=-1);return function(g,m){return a.equipment[g][b]<a.equipment[m][b]?-1*d:a.equipment[g][b]>a.equipment[m][b]?
1*d:(g-m)*d}}a.equipment={};a.equipmentIndexes={};a.equipmentPath="resources/equipment/";a.filePrefix="equipment-country-";a.defaultName="eqp-adlerkorps";a.name=a.defaultName;a.equipmentToLoadSet={};a.equipmentToLoad=0;a.countryNames={"eqp-adlerkorps":"Slovakia;Belgium;Bulgaria;Czechoslovakia;Denmark;Finland;France;Germany;Greece;USA;Hungary;Turkey;Italy;Netherlands;Norway;Poland;Portugal;Romania;Croatia;Russia;Sweden;Allied Yugoslavia;United Kingdom;Yugoslavia;Nationalist Spain;Republican Spain;Australia;Canada;Ethiopia;New Zealand;South Africa".split(";"),
"eqp-pacific":"New Zealand;Panzerzug;India;Australia;Hungary;Japan;France;Germany;Bulgaria;U.S. Army;Canada;Turkey;Italy;Romania;Thailand;Nationalist Chinese;Philippines;Netherlands;Afrika Korps;Russia;Poland;Communist Chinese;United Kingdom;Mongolia;Manchukuo;U.S. Marines;Republican;Allied Forces;Captured Equipment;Axis Forces;Arab Countries".split(";")};var l=!0;a.getCountryName=function(b){return a.countryNames[a.name][b]};a.getCountryNameByEqp=function(b,k){return a.countryNames[k][b]};a.resetEquipment=
function(){a.equipment={};a.equipmentIndexes={};a.equipmentToLoadSet={};a.equipmentToLoad=0};a.addPlayersEquipment=function(b,k){a.resetEquipment();a.equipmentToLoadSet[-1]=!0;for(var d=0;d<b.length;d++){var g=b[d];a.equipmentToLoadSet[g.country]=!0;for(var m=0;m<g.supportCountries.length;m++){var f=g.supportCountries[m];0<f&&(a.equipmentToLoadSet[f-1]=!0)}}a.equipmentToLoad=Object.keys(a.equipmentToLoadSet).length;for(var p in a.equipmentToLoadSet)a.addCountryEquipment(+p,k)};a.addCountryEquipment=
function(a,k){b(a+1,k)};a.parseCountryEquipment=function(b,k){a.equipmentIndexes[b]=k.indexes;for(var d in k.units){a.equipment[d]={gunrange:0,icon:0,yearexpired:0,cost:0,initiative:0,spotrange:0,hardatk:0,softatk:0,uclass:0,airdef:0,fuel:0,airseaweight:0,rangedefmod:0,airatk:0,groundweight:0,movmethod:0,navalatk:0,movpoints:0,grounddef:0,target:0,yearavailable:0,name:0,country:0,closedef:0,ammo:0,attr:0};a.equipment[d].__proto__=null;for(var g=0;g<k.parsehints.length;g++)a.equipment[d][k.parsehints[g]]=
k.units[d][g]}delete k.parsehints;delete k.indexes;delete k.units;return!0};a.getCountryEquipmentByClass=function(b,k,d,g){var m=[];"undefined"!==typeof a.equipmentIndexes[k]&&(a.equipmentIndexes[k].hasOwnProperty("unitclass")&&(m=a.equipmentIndexes[k].unitclass[b]),d&&m.sort(f(d,g)));return m};a.getCountryEquipmentByYearRange=function(b,k,d){var g=[],m,f=0;if("undefined"===typeof a.equipmentIndexes[d])return g;for(f in a.equipment)m=a.equipment[f],m.country==d&&(m.yearavailable>=b&&m.yearavailable<=
k)&&g.push(+f);return g};a.addUnitsToEquipment=function(a){};a.isBridge=function(b){return"undefined"===typeof a.equipment[b]?!1:0!=(a.equipment[b].attr&8)?!0:!1};a.ignoresEntrenchment=function(b){return"undefined"===typeof a.equipment[b]?!1:0!=(a.equipment[b].attr&4)?!0:!1};a.isPurchasable=function(b){return"undefined"===typeof a.equipment[b]?!1:0!=(a.equipment[b].attr&262144)?!0:!1};a.canInitiateAttackOnUnitType=function(b,k){if(!defined(a.equipment[b])||!defined(a.equipment[k]))return!1;var d=
a.equipment[b].uclass,g=a.equipment[k].target;return a.equipment[k].uclass==unitClass.submarine&&d!=unitClass.destroyer&&d!=unitClass.tacticalBomber||g==unitType.soft&&0!=(a.equipment[b].attr&16)||g==unitType.hard&&0!=(a.equipment[b].attr&32)||g==unitType.air&&(0!=(a.equipment[b].attr&64)||d!=unitClass.airDefence&&d!=unitClass.fighter&&d!=unitClass.levelBomber&&d!=unitClass.tacticalBomber&&d!=unitClass.battleship&&d!=unitClass.battleCruiser&&d!=unitClass.lightCruiser&&d!=unitClass.airTransport&&0==
(a.equipment[b].attr&32768))?!1:!0};return a}(Equipment||{});function defined(a){return"undefined"!==typeof a&&null!==a}function $(a){return document.getElementById(a)}function $$(a,b){1==arguments.length&&(b=a,a=document);a||(a=document);return a.querySelector(b)}function addTag(a,b){var f,l=document.createElement(b);f="string"===typeof a?$(a):a;null!==f&&f.appendChild(l);return l}function insertTag(a,b,f){b=document.createElement(b);a="string"===typeof a?$(a):a;f="string"===typeof f?$(f):f;null!==a&&a.insertBefore(b,f);return b}
function delTag(a){a&&a.parentNode&&a.parentNode.removeChild(a)}function clearTag(a){for(a="string"===typeof a?$(a):a;a&&a.hasChildNodes();)a.removeChild(a.lastChild)}function clearStyle(a,b){var f;f="string"===typeof a?$(a):a;defined(b)?f.style.removeProperty(b):f.removeAttribute("style")}function insertTemplate(a,b){for(var f=$$("#"+a),l=0;l<f.children.length;l++)b.appendChild(f.children[l].cloneNode(!0))}
function getPosition(a){var b={};isVisible(a)?b=$(a).getBoundingClientRect():(makeVisible(a),b=$(a).getBoundingClientRect(),makeHidden(a));return b}function getCoordinates(a){a=a.getBoundingClientRect();var b=document.body.getBoundingClientRect();return{x:a.left-b.left+window.scrollX,y:a.top-b.top+window.scrollY}}function addSelectOption(a,b,f,l){if(void 0===l||null===l)l=!1;a=addTag(a,"option");a.value=f;a.textContent=b;a.selected=l}
function setSelectOption(a,b){for(var f=a.options,l=0;l<f.length;l++)if(f[l].selected=!1,b.trim()===f[l].text.trim())return f[l].selected=!0,a.onchange(),!0;return!1}function hasTouch(){return"ontouchstart"in window}function isChromeApp(){return window.chrome&&chrome.app&&chrome.app.runtime}function toggleRightClick(a){window.oncontextmenu=function(){return a}}
function hasBrokenScroll(){var a=navigator.userAgent;return a.match(/android 2/i)&&a.match(/applewebkit/i)||a.match(/android 4/i)&&a.match(/chrome/i)&&a.match(/applewebkit/i)?!0:!1}function hasBrokenClearRect(){var a=navigator.userAgent;return a.match(/android 4/i)&&!a.match(/chrome/i)?!0:!1}function hoverin(a){if(a&&"undefined"!==typeof a){var b=a.src.substring(0,a.src.lastIndexOf("/")+1);a.src=b+a.id+"-over.png"}}
function hoverout(a){if(a&&"undefined"!==typeof a){var b=a.src.substring(0,a.src.lastIndexOf("/")+1);a.src=b+a.id+".png"}}function toggleButton(a,b){if(!a)return!1;var f=a.innerHTML;b?(a.setAttribute("selected","on"),a.hasSelectedGlyph&&(a.innerHTML=f.toUpperCase())):(a.removeAttribute("selected"),a.hasSelectedGlyph&&(a.innerHTML=f.toLowerCase()));return!0}function toggleButtonWithImage(a,b){var f;f=a&&"undefined"!==typeof a.firstChild?a.firstChild:a;b?hoverin(f):hoverout(f)}
function toggleCheckbox(a){if(!a)return!1;var b=a.innerHTML;b===b.toUpperCase()?a.innerHTML=b.toLowerCase():a.innerHTML=b.toUpperCase();return!0}function toggleCheckboxWithImage(a){if(a&&a.src){var b=a.src.substring(0,a.src.lastIndexOf("/")+1),f=a.src.lastIndexOf("-checked"),f=-1<f?a.src.substring(a.src.lastIndexOf("/")+1,f):a.src.substring(a.src.lastIndexOf("/")+1,a.src.lastIndexOf("."))+"-checked";a.src=b+f+".png"}}function isVisible(a){a=$(a).style.display;return""!=a&&"none"!=a?!0:!1}
function makeVisible(a){$(a).style.display="inline";$(a).focus()}function makeHidden(a){$(a).style.display="none";$("game").focus()}
function bounceText(a,b,f,l){var n=addTag("game","div"),k=addTag(n,"div");n.style.cssText="position:absolute; top:"+b+"px; left:"+a+"px; z-index:200;";1!=+uiSettings.uiScale&&(a="scale("+uiSettings.uiScale+","+uiSettings.uiScale+")",n.style.webkitTransformOrigin="50% 50%",n.style.mozTransformOrigin="50% 50%",n.style.transformOrigin="50% 50%",n.style.webkitTransform=a,n.style.MozTransform=a,n.style.transform=a);k.addEventListener("animationend",function(){delTag(this.parentNode)},!1);k.addEventListener("webkitAnimationEnd",
function(){delTag(this.parentNode)},!1);k.className=l?"textBounceGreen":"textBounceRed";k.innerHTML=f}
function touchScroll(a){var b=0,f=0;$(a).addEventListener("touchstart",function(a){b=this.scrollTop+a.touches[0].pageY;f=this.scrollLeft+a.touches[0].pageX},!1);$(a).addEventListener("touchmove",function(a){(this.scrollTop<this.scrollHeight-this.offsetHeight&&this.scrollTop+a.touches[0].pageY<b-5||0!=this.scrollTop&&this.scrollTop+a.touches[0].pageY>b+5)&&a.preventDefault();(this.scrollLeft<this.scrollWidth-this.offsetWidth&&this.scrollLeft+a.touches[0].pageX<f-5||0!=this.scrollLeft&&this.scrollLeft+
a.touches[0].pageX>f+5)&&a.preventDefault();this.scrollTop=b-a.touches[0].pageY;this.scrollLeft=f-a.touches[0].pageX},!1)}function addStyleSheet(a){var b=document.createElement("link");b.setAttribute("rel","stylesheet");b.setAttribute("type","text/css");b.setAttribute("href","css/"+a);if(!b||"undefined"===typeof b)return!1;document.getElementsByTagName("head")[0].appendChild(b);return!0}
function getStyleSheet(a){for(var b=0;b<document.styleSheets.length;b++)for(var f=document.styleSheets[b].cssRules,l=0;l<f.length;l++)if(defined(f[l].styleSheet))for(var n=0;n<f[l].styleSheet.cssRules.length;n++){var k=f[l].styleSheet.cssRules[n];if(k.selectorText===a)return k.style}else if(f[l].selectorText===a)return f[l].style}function isDesktop(){try{nw.Window.get()}catch(a){return!1}return!0}
function changeViewPort(){var a,b=null,f=1,l=1,n="width=device-width, ",k=window.devicePixelRatio||1,d=document.getElementsByTagName("meta");(new GameState(null)).restoreSettings();for(a=0;a<d.length;a++)"viewport"==d[a].name&&(b=d[a]);null===b&&(b=addTag(document.getElementsByTagName("head")[0],"meta"),b.id="viewport",b.name="viewport");navigator.userAgent.match(/(iPhone|iPod)/i)&&(n="",1==k&&(k=2));1<k&&2>k&&(k=2);uiSettings.useRetina&&(l=f=1/k);b.content=n+"initial-scale="+f+",maximum-scale="+
l+" , user-scalable=1"}changeViewPort();function AIUnit(a){this.unit=a;this.didResupplyReinforce=this.didMove=this.didAttack=this.noResupply=this.noReinforce=this.noMove=this.noAttack=!1;this.newPosition=null}function EnemyUnit(a){this.unit=a;this.isAttacked=!1;this.losses=0;this.isKilled=!1}
function AI(a,b){function f(a,g){I.push({type:a,param:g})}function l(a){var g=a.unit;if(!GameRules.canReinforce(b.map,g)||(a.didResupplyReinforce||a.didAttack||a.didMove)||g.unitData().uclass==unitClass.fortification||0>=F)return a.noReinforce=!0,!1;if(a.noAttack&&a.noMove||g.strength<Q){var d=GameRules.calculateUnitCostPerStrength(g),q=GameRules.getReinforceValue(b.map,g),s=F/d>>0;s>q&&(s=q);if(0<q&&0<s)return f(actionType.reinforce,[g]),F-=s*d,a.didResupplyReinforce=!0}a.noAttack&&a.noMove&&(a.noReinforce=
!0);return!1}function n(a){var q=a.unit;if(a.didMove||a.didResupplyReinforce||!q)return a.noMove=!0,!1;var s=GameRules.getMoveRange(b,q);if(!s||0==s.length)return a.noMove=!0,!1;var k=q.getPos();k.canMove=!0;var p=g(q,k);if(GameRules.isGround(q))var y=m(k),p=p+y.score;for(var p=p+q.entrenchment*z,y=d(q,k),p=p+y,k=null,l=0,r=0;r<s.length;r++)y=m(s[r]),GameRules.isAir(q)&&(y.score*=0.3),GameRules.isSea(q)&&(y.score=0),l=g(q,s[r])+y.score,-2E3>l||(y=d(q,s[r]),l+=y,l>p&&(k=s[r],p=l));if(null!==k){var s=
k,p=q.getPos(),D;J.push(s);0<=(D=x(s))&&L.splice(D,1);L.push(p);f(actionType.move,[q,k]);a.didMove=!0;a.newPosition=k;return!0}a.noMove=!0;return!1}function k(a,g,q){var d=0,s=0;g=b.map[g.row][g.col].getAttackableUnit(a,!1);var m=g.getHex();if(g&&GameRules.canInitiateAttack(a,g)){if("undefined"!==typeof y[g.id]&&null!==y[g.id]){s=y[g.id];if(s.isKilled)return q?{score:0,kills:0}:{score:C,kills:0};s.isAttacked&&(d+=100)}var k=GameRules.calculateCombatResults(a,g,b.getUnits(),!0,!0),d=d+(k.kills*O[g.unitData().uclass]-
k.losses*A[a.unitData().uclass]),s=k.kills;if(k.losses>=a.strength||a.strength/k.losses<H)return q?{score:d,kills:k.kills}:{score:C,kills:k.kills};-1!==m.victorySide&&(d+=350);m.isSpotted(a.player.side)||(d*=B)}return{score:d*W[p(0,7)],kills:s}}function d(a,g){var q=0,d=0,s=a.getHex();a.setHex(b.map[g.row][g.col]);for(var m=GameRules.getUnitAttackCells(b.map,a,b.rows,b.cols),f=0;f<m.length;f++)q=k(a,m[f],!0),d+=q.score;a.setHex(s);return d}function g(g,q){var d=0,s=g.getHex(),m=g.unitData().uclass,
k=g.player.side,f=~k&1,l=!1,D;a:{for(D=0;D<J.length;D++)if(J[D].row==q.row&&J[D].col==q.col)break a;D=-1}if(0<=D)return-5E3;0<=x(q)&&(l=!0);if(!q.canMove&&!l)return-5E3;D=b.map[q.row][q.col];D.isSpotted(f)||(d-=40);D.isSpotted(k)||(d+=30);f=D.isDeployment;-1==D.victorySide&&(-1<f&&f==a.id)&&(d-=100);if(m==unitClass.fighter||m==unitClass.tacticalBomber||m==unitClass.levelBomber)return d*W[p(0,7)];GameRules.canEntrench(g)&&g.entrenchment<terrainEntrenchment[D.terrain]&&(d+=50);terrainInitiative[s.terrain]<
terrainInitiative[D.terrain]&&(d+=20);D.terrain!=terrainType.River&&D.terrain!=terrainType.Stream||D.road!=roadType.none||(d-=70);GameRules.isCloseCombatTerrain(D.terrain)&&(d=m==unitClass.infantry?d+120:m==unitClass.artillery||m==unitClass.antiTank||m==unitClass.airDefence?d+10:d-50);-1!=D.flag&&(D.flag!=g.player.country&&GameRules.isGround(g))&&(d+=50);(s=-1!=D.victorySide)&&!(s=null===D.unit)&&(l||(l=D.unit.id==g.id)||(l=null===D.unit?!0:"undefined"!==typeof y[D.unit.id]&&null!==y[D.unit.id]&&
y[D.unit.id].isKilled?!0:!1),s=l);s&&(s=b.getPlayer(D.owner).side==k,d=m==unitClass.artillery?d+50:m==unitClass.infantry?d+600:m==unitClass.tank?d+350:d+300);l=GameRules.getAdjacent(q.row,q.col);for(D=0;D<l.length;D++)0>l[D].row||0>l[D].col||(l[D].row>=b.rows-1||l[D].col>=b.cols-1)||(s=b.map[l[D].row][l[D].col],(f=s.getUnit())&&f.id!==g.id&&(!GameRules.isEnemy(g,f)&&0>x(l[D])?(d+=20,f.unitData().uclass==unitClass.artillery&&(d+=80)):d=m==unitClass.artillery?d-100:d+40),-1!=s.victorySide&&(s=b.getPlayer(s.owner).side==
k,d=m==unitClass.artillery||m==unitClass.flak?d+50:m==unitClass.infantry?s?d+70:d+100:s?d+50:d+70));return d*W[p(0,7)]}function m(a,g){var d=M;defined(g)&&!g&&(d=G);for(var q={cell:null,score:0},s=0;s<d.length;s++){var m=GameRules.distance(a.row,a.col,d[s].row,d[s].col);if(0<m)m=N/m,m>q.score&&(q.score=m,q.cell=d[s]);else return{cell:a,score:N+100}}q.score=Math.round(q.score);return q}function x(a){for(var g=0;g<L.length;g++)if(L[g].row==a.row&&L[g].col==a.col)return g;return-1}function p(a,g){return Math.floor(Math.random()*
(g-a+1)+a)}function r(g,d){for(var q=[],s=a.country+1,m=0,k=!1;0<g;){if(m>d.length-1){if(k)break;m=0}for(var k=Equipment.getCountryEquipmentByClass(d[m],s),b=k.length-1;0<=b;b--){var f=GameRules.calculateUnitCosts(k[b]);(f>g||f>X||f<S||Equipment.equipment[k[b]].movmethod==movMethod.deepnaval||Equipment.equipment[k[b]].yearavailable>game.scenario.date.getFullYear())&&k.splice(b,1)}0<k.length?(f=p(0,k.length-1),k=k[f],f=GameRules.calculateUnitCosts(k),g-=f,q.push(k),k=!1):k=!0;m++}return{prestige:g,
units:q}}var s=[],q=[],y={},I=[],J=[],L=[],G=[],M=[],F=a.prestige;this.buildActions=function(){F=a.prestige;var g=a.prestige;if(!(g<=T)){var g=g-T,d=g*P;300>d&&(d=0);for(var g=g-d,d=r(d,Y),g=r(g,v),m=d.units,p=m.length-1;0<=p;p--)a.buyUnit(m[p]);d.units=[];m=g.units;for(p=m.length-1;0<=p;p--)a.buyUnit(m[p]);g.units=[]}d=a.getCoreUnitList();g=b.getDeployHexes(a.side);for(h=0;h<g.length;h++)for(m=0;m<d.length;m++)d[m].isDeployed||(p=g[h],b.deployPlayerUnit(a,m,p.row,p.col));for(m=0;m<d.length;m++);
game.ui.handleReinforcementDeployment();s=b.getUnits();J=[];L=[];M=b.sidesVictoryHexes[a.side];G=b.sidesVictoryHexes[+!a.side];y={};q=[];for(d=0;d<s.length;d++)s[d].player.id==a.id&&(s[d].unitData().uclass==unitClass.artillery||s[d].unitData().uclass==unitClass.fortification||GameRules.isAir(s[d])&&s[d].unitData().uclass!=unitClass.airTransport||GameRules.isSea(s[d])&&s[d].unitData().uclass!=unitClass.navalTransport?q.unshift(new AIUnit(s[d])):q.push(new AIUnit(s[d])));for(d=null;0<q.length;){d=q[0];
l(d);g=d;m=g.unit;!GameRules.canResupply(b.map,m)||g.didResupplyReinforce||g.didAttack||g.didMove?g.noResupply=!0:g.noAttack&&g.noMove||m.ammo<U||GameRules.unitUsesFuel(m)&&m.fuel<E?(f(actionType.resupply,[m]),g.didResupplyReinforce=!0):g.noAttack&&g.noMove&&(g.noResupply=!0);n(d);g=d;m=g.unit;if(m.hasFired||g.didAttack||g.didResupplyReinforce)g.noAttack=!0;else{var p=null,x=void 0,I=void 0,R={},R=null,z=m.getHex(),D=null,D=z,x=-(w*A[m.unitData().uclass]),I=0;g.didMove&&null!==g.newPosition&&(D=b.map[g.newPosition.row][g.newPosition.col],
m.setHex(D));-1!=D.victorySide&&(x-=50);for(var D=GameRules.getUnitAttackCells(b.map,m,b.rows,b.cols),da=0;da<D.length;da++)R=k(m,D[da],!1),R.score>x&&(x=R.score,I=R.kills,R=b.map[D[da].row][D[da].col],p=R.getAttackableUnit(m,!1));g.didMove&&null!==z&&m.setHex(z);if(p){if(x=p)"undefined"===typeof y[x.id]&&(y[x.id]=new EnemyUnit(x)),y[x.id].isAttacked=!0,y[x.id].losses+=I,y[x.id].losses>x.strength&&(y[x.id].isKilled=!0);f(actionType.attack,[m,p]);g.didAttack=g.noResupplyReinforce=!0}else if(g.noMove||
g.didMove)g.noAttack=!0}d.noReinforce&&(d.noResupply&&d.noAttack&&d.noMove)&&q.shift()}};this.getAction=function(){if(0==I.length)return null;var a=I[0];I.splice(0,1);return a};var Q=4,U=2,E=5,N=4E3,w=4,z=50,H=2.5,C=-1E3,B=0.3,W=[0.8,0.85,0.9,0.95,1,1.1,1.15,1.2],T=1E3,P=0.3,X=900,S=120,Y=[unitClass.fighter,unitClass.tacticalBomber],v=[unitClass.infantry,unitClass.infantry,unitClass.artillery,unitClass.antiTank,unitClass.tank,unitClass.infantry,unitClass.tank],A=[0,5,5,10,10,5,10,40,20,10,5,30,30,
40,15,10,10,40,40,10,10,10],O=[0,50,25,30,10,10,5,150,150,10,50,100,100,150,50,50,50,100,150,50,50,50]};function AIScripted(a,b){function f(a,g){n.push({type:a,param:g})}function l(){switch(b.turn){case 1:if(a.side==playerSide.axis){f(actionType.message,["The objective of the game is to conquer all enemy positions marked by a golden frame and enemy flag. This is one of the positions. Moving one of your units into this position will capture this city and raise your flag over it.",{row:8,col:15}]);f(actionType.message,["This is the second primary objective since it has your enemy flag (Republican Spain) and a golden frame around. Capturing primary objectives gives you a good amount of points called prestige which can be used to upgrade or buy new troops.",
{row:16,col:8}]);f(actionType.message,["This is an optional objective with your enemy flag. Although capturing these  objectives won't count towards victory is good to do so for extra prestige and troops experience. Also troops are better reinforced or resupplied in a city.",{row:11,col:22}]);var d=k.axis.legioninf;f(actionType.select,[d]);f(actionType.message,["This is one of your units and usually represent a historical battalion, the number below is battalion size, usually named strength. Since you are playing as Axis the number is on a grey box. Your enemies (Allied Side) will have this number box in green.",
{row:4,col:2}]);f(actionType.message,["Units have several stats, click the <span class='smallButtonSubMenu'>i</span> button on the right menu to open a panel with unit stats on the bottom of the screen. Notice the movement range <span class='statsGlyph'>?</span> for this unit is 3. The grey hexes around this unit represent this movement range.",{row:4,col:2}]);f(actionType.message,["This unit has a transport, shown by the <span class='smallButtonSubMenu'>[</span> button on the bottom of the screen. While on transports moving range is increased but, except infantry, units become vulnerable to enemy fire. I will now mount and move this unit for you toward objective.",
{row:4,col:2}]);f(actionType.mount,[d]);f(actionType.select,[d]);f(actionType.move,[d,{row:7,col:9}]);d=k.axis.recon;f(actionType.select,[d]);f(actionType.message,["This is a recon unit. Recon units can move multiple times per turn and have bigger spotting range <span class='statsGlyph'>'</span> as the game will only show enemy units in the spotting range of your units. Let's check if there aren't any hidden units near the city.",{row:8,col:12}]);f(actionType.move,[d,{row:10,col:14}]);f(actionType.message,
["The objective is lightly defended by just one infantry unit. Let's move the rest of the units into fire range, destroy the defender and capture the city. When units move watch how the strength number color changes indicating that unit has moved.",{row:8,col:15}]);d=k.axis.pz2a;f(actionType.move,[d,{row:7,col:11}]);d=k.axis.ssinf1;f(actionType.mount,[d]);f(actionType.move,[d,{row:7,col:15}]);d=k.axis.ssinf2;f(actionType.mount,[d]);f(actionType.move,[d,{row:8,col:14}]);d=k.axis.ssinf3;f(actionType.mount,
[d]);f(actionType.move,[d,{row:9,col:14}]);d=k.axis.arty;f(actionType.mount,[d]);f(actionType.move,[d,{row:7,col:13}]);f(actionType.message,["As we moved all our units and no the targets are in fire range, we should end turn <span class='smallButtonSubMenu'>t</span>which will start enemy turn. If we don't capture all primary objectives in the maximum number of turns (shown left of the top bar) the scenario will end in defeat.",{row:7,col:13}])}else f(actionType.attack,[k.allies.inf1,k.axis.ssinf1]);
break;case 2:if(a.side==playerSide.axis){f(actionType.message,["Notice how this infantry unit jumped out of transport when attacked, instead of staying in the vulnerable transport. Only infantry units will do this others will not dismount when attached. All units are dismounted at the start of your turn.",{row:7,col:15}]);f(actionType.message,["This is an artillery unit, depending on it's fire range <span class='statsGlyph'>&gt;</span> it can fire on enemy positions from afar without suffering losses. Also each attack will soften enemy positions reducing their <span class='statsGlyph'>&quot;</span> entrenchment.",
{row:7,col:13}]);var d=k.axis.arty,g=k.allies.inf1;f(actionType.attack,[d,g]);f(actionType.message,["We inflicted losses to at least 1 company from the enemy battalion and reduced their entrenchment. Both attacker and defender received combat experience <span class='statsGlyph'>@</span> the later only a small amount since it hasn't inflicted any casualties.",{row:8,col:15}]);f(actionType.message,["Entrenchment <span class='statsGlyph'>&quot;</span> of a unit is important as it can avoid loses completely. It's a good idea to always check and reduce entrenchment with artillery or bombers before attacking in close combat. Entrenchment is automatically increased depending on terrain each turn when a unit doesn't move.",
{row:8,col:15}]);d=b.map[8][14].getUnit(!1);f(actionType.message,["Notice the small circle on the left of the unit strength box. The presence of this circle signifies that the unit hasn't fired yet and can do so. Some units like mounted artillery and mobile air defense can't move and fire in the same turn.",{row:8,col:14}]);f(actionType.attack,[d,g]);f(actionType.message,["Infantry units are usually good at defending cities, as they force attacker in close combat <span class='statsGlyph'>6</span> instead of normal ground combat defense <span class='statsGlyph'>5</span>. Other terrain types (shown right of the top bar) influence combat differently for each unit type.",
{row:8,col:15}]);d=b.map[9][14].getUnit(!1);f(actionType.attack,[d,g]);d=b.map[7][15].getUnit(!1);f(actionType.attack,[d,g]);f(actionType.message,["Since the unit defending the city was destroyed or retreated because of heavy casualties we can now move one of our units to capture this objective and get our prestige reward.",{row:8,col:15}]);d=b.map[7][11].getUnit(!1);f(actionType.move,[d,{row:8,col:15}]);f(actionType.message,["The city is now ours, and it's flag changed to your flag. This objective capture also increased your prestige by 150&nbsp;"+
UIBuilder.currencyIcon+". You can check prestige, score, remaining turns  and objectives by clicking anywhere on the top bar.",{row:8,col:15}]);f(actionType.attack,[d,g]);f(actionType.message,["This is the last remaining primary objective. Let's gamble and try capturing it without trying to spot enemy. Capturing objectives in early turns gives a better score.",{row:16,col:8}]);d=b.map[10][14].getUnit(!1);f(actionType.select,[d]);f(actionType.move,[d,{row:16,col:8}]);f(actionType.message,["Our unit was surprised by an enemy unit. This happens when you move a unit into an unspotted hex that's occupied by an enemy unit. Surprise attack reduces unit defense and attack values resulting in heavy casualties. Let move to the next turn.",
{row:15,col:10}]);f(actionType.select,[d])}break;case 3:a.side==playerSide.axis&&(u=b.map[15][10].getUnit(!1),f(actionType.select,[u]),f(actionType.message,["You can reinforce this unit casualties by clicking on the <span class='smallButtonSubMenu'>#</span> button at the bottom of the screen. Reinforcements costs prestige and the amount is reduced by enemy units adjacent to your unit. After reinforce unit can no longer attack or move.",{row:15,col:10}]),f(actionType.reinforce,[u]),u=b.map[7][15].getUnit(!1),
f(actionType.select,[u]),f(actionType.message,["Let's move the rest of the units towards the objective, note how terrain influence movement range. The longest move range is on road or clear terrain but it also depends on unit movement type shown with symbol <span class='statsGlyph' style='float:none;'>~</span>",{row:7,col:15}]),f(actionType.mount,[u]),f(actionType.move,[u,{row:14,col:11}]),u=b.map[8][14].getUnit(!1),f(actionType.mount,[u]),f(actionType.select,[u]),f(actionType.move,[u,{row:14,col:9}]),
u=b.map[9][14].getUnit(!1),f(actionType.mount,[u]),f(actionType.select,[u]),f(actionType.move,[u,{row:14,col:8}]),u=b.map[7][9].getUnit(!1),f(actionType.mount,[u]),f(actionType.select,[u]),f(actionType.move,[u,{row:11,col:9}]),u=b.map[7][13].getUnit(!1),f(actionType.mount,[u]),f(actionType.select,[u]),f(actionType.move,[u,{row:13,col:13}]),u=b.map[8][15].getUnit(!1),f(actionType.select,[u]),f(actionType.move,[u,{row:12,col:12}]));break;case 4:if(a.side==playerSide.axis){u=b.map[14][9].getUnit(!1);
f(actionType.select,[u]);f(actionType.message,["Let's attack the weakest enemy unit on the front line. The attack cursor gives an estimate of your casualties on the left and enemy casualties on the right below the flags of the units involved in combat.",{row:15,col:9}]);e=b.map[15][9].getUnit(!1);f(actionType.attack,[u,e]);f(actionType.message,["This artillery unit has automatically fired when we attacked. That's because artillery provides support fire to friendly units in their range if attacked. Other units with combat support include air defense and fighter planes when attacked by an enemy plane.",
{row:16,col:7}]);f(actionType.message,["Luckily our artillery unit has a bigger range than enemy artillery so we can safely move it into fire range without making us vulnerable to enemy fire while in transport.",{row:13,col:13}]);u=b.map[13][13].getUnit(!1);f(actionType.mount,[u]);f(actionType.move,[u,{row:14,col:12}]);f(actionType.message,["Armored units are considered hard targets <span class='statsGlyph'>`</span> and will take less casualties from artillery fire than a soft target like infantry or artillery. In some cases armored units are used to deplete the ammo of the defending artillery.",
{row:12,col:12}]);u=b.map[12][12].getUnit(!1);f(actionType.move,[u,{row:14,col:7}]);e=b.map[15][8].getUnit(!1);f(actionType.attack,[u,e]);if(u=b.map[15][10].getUnit(!1))u.fuel=0;f(actionType.select,[u]);f(actionType.message,["This unit it's out of fuel and it can no longer move.You can always supply ammo <span class='statsGlyph'></span> and fuel to your units by clicking on the <span class='smallButtonSubMenu'>!</span>   button on the bottom of the screen",{row:15,col:10}]);f(actionType.resupply,
[u]);game.ui&&game.ui.mainMenuButton("mainmenu");f(actionType.message,["This concludes the tutorial and gives you the control of the army to capture the last objective. Remember to use your prestige to upgrade or buy new units by clicking on the <span class='smallButtonSubMenu'>w</span>  button from the menu on the right side of the screen.",{row:16,col:8}]);f(actionType.message,["You should attack enemy artillery with your own artillery and move your tanks and attack the enemy artillery. There is a possibility that your armor attack will result in an OverRun which completely destroys an unit and allows your armor to continue move and attack.",
{row:16,col:8}]);f(actionType.message,["Remember to tap or click the <span class='smallButtonSubMenu'>t</span> end turn button twice to end your turns. Depending on scenario you or the enemy might also receive reinforcements. On this tutorial you will receive reinforcements next turn.",{row:16,col:8}])}break;default:0==a.side?(a.handler=null,a.type=playerType.humanLocal):(a.handler=new AI(a,game.scenario.map),a.type=playerType.aiLocal)}}var n=[],k={axis:{},allies:{}};k.axis.recon=b.map[8][12].getUnit(!1);
k.axis.legioninf=b.map[4][2].getUnit(!1);k.axis.pz2a=b.map[9][6].getUnit(!1);k.axis.ssinf1=b.map[8][6].getUnit(!1);k.axis.ssinf2=b.map[9][5].getUnit(!1);k.axis.ssinf3=b.map[9][4].getUnit(!1);k.axis.arty=b.map[8][4].getUnit(!1);k.allies.inf1=b.map[8][15].getUnit(!1);l();this.buildActions=function(){l();firstTurn=!1};this.getAction=function(){if(0==n.length)return null;var a=n[0];n.splice(0,1);return a}};var hexstyle={move:{fillColor:"rgba(120,100,100,0.5)",lineColor:"rgba(0,0,0,0.4)",lineWidth:1,lineJoin:"miter"},movespotted:{fillColor:"rgba(128,128,128,0.5)",lineColor:"rgba(0,0,0,0.4)",lineWidth:1,lineJoin:"miter"},attack:{fillColor:null,lineColor:"rgba(239, 0, 0,0.8)",lineWidth:3,lineJoin:"miter"},current:{fillColor:null,lineColor:"rgba(255, 240, 0, 0.8)",lineWidth:3,lineJoin:"round"},currentstroke:{fillColor:null,lineColor:"rgba(0, 0, 0, 0.9)",lineWidth:2,shadowOffsetX:1,shadowOffsetY:2,shadowColor:"black",
lineJoin:"round"},generic:{fillColor:null,lineColor:"rgba(39,44,47,0.9)",lineWidth:0.4,lineJoin:"miter"},deploy:{fillColor:"rgba(128,128,128,0.8)",lineColor:"rgba(0,0,0,0.4)",lineWidth:1,lineJoin:"miter"},ownunit:{fillColor:"rgba(30,144,255,0.3)",lineColor:"rgba(0,0,0,0.4)",lineWidth:0,lineJoin:"miter"},airunit:{fillColor:"rgba(30,144,255,0.3)",lineColor:"rgba(50, 110, 240,0.6)",lineWidth:2,lineJoin:"miter"},combat:{fillColor:"rgba(255, 255, 255,0.15)",lineColor:"rgba(239,0,0,0.7)",lineWidth:2,lineJoin:"miter"}},
unitstyle={axisBox:"#383838",alliedBox:"#808000",axisBorder:"rgba(211, 211, 211, 1)",alliedBorder:"rgba(127, 255, 0, 1)",enemyBoxMarked:"#FF0000",playerText:"white",alliedPlayerText:"#696969",movedUnitText:"#BDBDBD",terrainText:"#333333",terrainTextStroke:"#f8e064"},tooltipColor={player:0,enemy:1},tooltipStyle={text:0,pin:1},terrainencoding="ABCDDEFGHIJKLMNOQ".split("");var soundData={track:new soundSprite("resources/sounds/move/track.wav"),htrack:new soundSprite("resources/sounds/move/htrack.wav"),leg:new soundSprite("resources/sounds/move/leg.wav"),air:new soundSprite("resources/sounds/move/air.wav"),naval:new soundSprite("resources/sounds/move/naval.wav"),gun:new soundSprite("resources/sounds/fire/gun.wav"),smallgun:new soundSprite("resources/sounds/fire/smallgun.wav"),explosion:new soundSprite("resources/sounds/fire/explosion.wav"),dummy:new soundSprite("")},
moveSoundByMoveMethod="track htrack htrack leg leg air naval naval leg track naval leg".split(" ");function soundSprite(a){var b;try{b=new Audio(a),b.load()}catch(f){}this.play=function(){if(b&&!uiSettings.muteUnitSounds){try{b.currentTime=0}catch(a){}return b.play()}}};function AnimationChain(){var a=[],b=0;this.add=function(b){a.push(new Animation(b))};this.clear=function(){a=[];b=0};this.start=function(f){var l=this;b<a.length?(a[b].start(),setTimeout(function(){l.start(f)},a[b].getDuration()+500),b++):(null!==f&&"undefined"!==typeof f&&f.cbfunc(f),setTimeout(function(){l.clear()},100))}}
function Animation(a){function b(){l?a.ctx.clearRect(a.x,a.y,a.sprite.width,a.sprite.image.height):f(a,k-1,"destination-out");k>a.sprite.frames&&clearInterval(n);k<=a.sprite.frames&&f(a,k,"source-over");k++}function f(a,g,m){0>g||!a||(a.ctx.save(),a.ctx.globalCompositeOperation=m,a.ctx.translate(a.x+a.sprite.width/2,a.y+a.sprite.image.height/2),a.ctx.rotate(a.rotate),a.ctx.drawImage(a.sprite.image,a.sprite.width*g,0,a.sprite.width,a.sprite.image.height,-a.sprite.width/2,-a.sprite.image.height/2,a.sprite.width,
a.sprite.image.height),a.ctx.restore())}var l=!1,n,k=0;this.delay=uiSettings.quickAnimation?50:150;this.start=function(){a.sprite.sound.play();n=setInterval(b,this.delay)};this.getDuration=function(){return this.delay*a.sprite.frames}}
var animationsData={explosion:new animationSprite("resources/animations/explosions.png",12,120,"explosion"),gun:new animationSprite("resources/animations/fire-gun.png",5,150,"gun"),smallgun:new animationSprite("resources/animations/fire-smallgun.png",7,80,"smallgun")},attackAnimationByClass="none smallgun gun gun gun gun smallgun smallgun gun gun smallgun smallgun smallgun none gun gun gun none none gun gun gun".split(" ");
function animationSprite(a,b,f,l){this.image=new Image;this.image.src=a;this.width=f;this.frames=b-1;this.sound=l&&"undefined"!==typeof l?soundData[l]:soundData.dummy};var GameRules=function(a){function b(d,q,m,k,b){var f=m.unitData().uclass;d-=q;q=15;var p=0;4<d&&(d=4+(2*d-8)/5);Leaders.unitHasLeader(m,leaderType.overwhelmingAttack)&&(d+=2);Leaders.unitHasLeader(k,leaderType.resilience)&&(d-=2);if(f==unitClass.artillery||f==unitClass.levelBomber||f==unitClass.fortification||g(m)&&!g(k))q=19;if(b)p=d+21-q,1>p&&(p=1),19<p&&(p=19),p=(5*p*m.strength+50)/100;else for(k=0;k<m.strength;k++)b=a.rollDice(1,20),1<b&&20>b&&(b+=d),b>=q&&p++;Leaders.unitHasLeader(m,leaderType.overwhelmingAttack)&&
(p+=1);return Math.round(p)}function f(g,q){return null===g||g.destroyed||0>=g.getAmmo()||(null===q||q.destroyed)||!a.isEnemy(g,q)||d(q)&&0>=g.unitData().airatk?!1:!0}function l(a,q,k){a=a[k.row][k.col];return(m(q)||g(q))&&null===a.unit||d(q)&&null===a.airunit?!0:!1}function n(a,q,k){a=a[k.row][k.col];if(m(q)||g(q))if(null===a.unit||a.unit.player.side==q.player.side)return!0;return!d(q)||null!==a.airunit&&a.airunit.player.side!=q.player.side?!1:!0}function k(a,g){var d=g.getPos(),m=a[d.row][d.col];
if(null===m)return!1;if(m.terrain==terrainType.Airfield&&m.flag==g.player.country||null!==m.unit&&m.unit.unitData().uclass==unitClass.carrier&&m.unit.owner==g.player.id)return!0;var d=p(d.row,d.col),k;for(k in d){var m=d[k].row,b=d[k].col;if(!(0>m||!defined(a[m])||0>b||!defined(a[m][b])||a[m][b].terrain!=terrainType.Airfield||a[m][b].flag!=g.player.country))return!0}return!1}function d(a){return null===a?!1:a.unitData().movmethod==movMethod.air?!0:!1}function g(a){if(null===a)return!1;a=a.unitData();
return a.uclass>=unitClass.submarine&&a.uclass<=unitClass.lightCruiser?!0:!1}function m(a){return null===a?!1:a.unitData().uclass<=unitClass.airDefence?!0:!1}function x(a,g,d,m){return a-1+g%2==d&&g-1==m||a+g%2==d&&g-1==m||a-1==d&&g==m||a+1==d&&g==m||a-1+g%2==d&&g+1==m||a+g%2==d&&g+1==m?!0:!1}function p(a,g){var d=[];d.push(new Cell(1*a-1,g));d.push(new Cell(a-1+g%2,g-1));d.push(new Cell(1*a+g%2,g-1));d.push(new Cell(1*a+1,g));d.push(new Cell(1*a+g%2,1*g+1));d.push(new Cell(1*a-1+g%2,1*g+1));return d}
function r(g,d,m,k,b,f){var p=[],x=null;if(0>=m)return p;for(var l=g-m,r=g+m,n=l;n<=r;n++)0>n||(n>=k||n==g)||(f?(x=new extendedCell(n,d),x.range=Math.abs(g-n)):x=new Cell(n,d),p.push(x));for(var E=1;E<=m;E++)for(1==(d+E)%2?0<r&&r--:l<k&&l++,n=l;n<=r;n++)0>n||n>=k||(d+E<b&&(f?(x=new extendedCell(n,d+E),x.range=a.distance(g,d,n,d+E)):x=new Cell(n,d+E),p.push(x)),0<d-E&&(f?(x=new extendedCell(n,d-E),x.range=a.distance(g,d,n,d-E)):x=new Cell(n,d-E),p.push(x)));return p}a.getMoveRange=function(g,m){var k=
0,b=g.map,f=g.rows,p=g.cols,G=null,M=[];if(null===m||m.hasMoved)return[];for(var G=m.getPos(),F=m.unitData(),Q=a.getUnitMoveRange(m),F=movTable[F.movmethod],U=m.player.side,E=~U&1,N=a.isTrain(m),w=r(G.row,G.col,Q,f,p,!0),z=w.length-1;0<=z;z--){var H=!1;0==w[z].row&&0==w[z].col%2&&(H=!0);g.isLastColPartial&&w[z].col==p-1&&(H=!0);g.isLastRowPartial&&w[z].row==f-1&&1==w[z].col%2&&(H=!0);H&&w.splice(z,1)}if(d(m)){for(z=0;z<w.length;z++)if(G=b[w[z].row][w[z].col],!(G.isSpotted(U)||null!==G.airunit&&G.airunit.tempSpotted)||
l(b,m,w[z]))w[z].canMove=!0,w[z].cost=1,M.push(w[z]);return M}for(w.push(new extendedCell(G.row,G.col));k<=Q;){for(z=0;z<w.length;z++)if(w[z].range==k)for(f=0;f<w.length;f++)!(w[f].range<k)&&x(w[z].row,w[z].col,w[f].row,w[f].col)&&(G=b[w[f].row][w[f].col],!N&&G.road>roadType.none||a.isBridgeForSide(G,U)?w[f].cost=F[17]:w[f].cost=F[G.terrain],(G.isSpotted(U)||null!==G.unit&&G.unit.tempSpotted)&&(G.isZOC(E)&&254>w[f].cost)&&(w[f].cost=254),0==w[f].cin&&(w[f].cin=w[z].cout),0==w[f].cout&&(w[f].cout=
w[f].cin+w[f].cost),w[f].cin>w[z].cout&&254>=w[f].cost&&(w[f].cin=w[z].cout,w[f].cout=w[f].cin+w[f].cost),w[f].cout<=Q||254>=w[f].cost&&w[f].cin<=Q)&&(n(b,m,w[f])&&(w[f].canPass=!0),!(G.isSpotted(U)||null!==G.unit&&G.unit.tempSpotted)||l(b,m,w[f]))&&(w[f].canMove=!0);k++}for(z=0;z<w.length;z++)(w[z].canPass||w[z].canMove)&&M.push(w[z]);return M};a.getUnitMoveRange=function(g){var d=g.getMovesLeft(),m=g.unitData();a.unitUsesFuel(g)&&g.getFuel()<d&&(d=g.getFuel());Leaders.unitHasLeader(g,leaderType.aggressiveTankManeuver)&&
(d+=1);Leaders.unitHasLeader(g,leaderType.aggressiveManeuver)&&(d+=1);m.movmethod==movMethod.towed&&(null===g.transport&&0==d&&m.uclass!=unitClass.fortification)&&(d=1);return d};a.getUnitAttackCells=function(g,d,m,k){var b=[],f=null;if(null===d||d.hasFired||0>=d.getAmmo())return[];var p=d.getPos(),x=a.getUnitAttackRange(d);m=r(p.row,p.col,x,m,k,!1);m.push(new Cell(p.row,p.col));for(k=0;k<m.length;k++){var l=m[k],n=g[l.row][l.col];if(null!==n.getAttackableUnit(d,0))if(a.isAir(d)&&1>=x)p.row==l.row&&
p.col==l.col&&b.push(l);else{b.push(l);continue}null!==(f=n.getAttackableUnit(d,1))&&(a.isAir(d)?a.isAir(f)&&b.push(l):b.push(l))}return b};a.getUnitAttackRange=function(a){if(!a)return 0;var g=a.unitData().gunrange;0==g&&(g=1);Leaders.unitHasLeader(a,leaderType.marksman)&&(g+=1);return g};a.setZOCRange=function(a,g,m,k,b){if(g&&!d(g)){var f=g.getPos();if(f){g=g.player.side;var x,l=p(f.row,f.col),r;for(r in l)f=l[r].row,x=l[r].col,f>=k||0>f||x>=b||0>x||a[f][x].setZOC(g,m)}}};a.setSpotRange=function(g,
d,m,k,b){if(!d)return 0;var f=d.getPos();if(f){var p=d.player.side,x=a.getUnitSpotRange(d);d=0;k=r(f.row,f.col,x,k,b,!1);k.push(new Cell(f.row,f.col));for(x=0;x<k.length;x++){f=k[x].row;b=k[x].col;if(m&&!g[f][b].isSpotted(p)){var l=g[f][b].getUnit(!1);l&&l.player.side!=p&&(d++,l.tempSpotted=!0)}g[f][b].setSpotted(p,m)}return d}};a.getUnitSpotRange=function(a){if(!a)return 0;var g=a.unitData().spotrange;Leaders.unitHasLeader(a,leaderType.eliteReconVeteran)&&(g+=2);Leaders.unitHasLeader(a,leaderType.skilledReconnaissance)&&
(g+=1);return g};a.getShortestPath=function(a,g,d){var m=[],k=[],b=[],f=null,p=0,l=new pathCell(a);l.dist=0;l.prev=l;m.push(l);for(l=0;l<d.length;l++)f=new pathCell(d[l]),f.cost=d[l].cost,m.push(f);for(;0<m.length;){p=0;f=m[0];for(l=1;l<m.length;l++)Infinity!=m[l].dist&&m[l].dist<=f.dist&&(f=m[l],p=l);if(Infinity==f.dist)break;for(l=0;l<m.length;l++)x(f.row,f.col,m[l].row,m[l].col)&&(Infinity==m[l].dist||f.dist+f.cost<m[l].dist)&&(m[l].dist=f.dist+f.cost,m[l].prev=f);if(f.row==g.row&&f.col==g.col){for(g=
f;;){b.unshift(g);if(g.row==a.row&&g.col==a.col)break;if(null!==g.prev||"undefined"!==typeof g)g=g.prev;else break}return b}k.push(m[p]);m.splice(p,1)}return[]};a.calculateCombatResults=function(g,d,m,k,b){var f=[],p=0,l=0,x=0,r=0,n=g.player.side;g.isSurprised||(f=a.getSupportFireUnits(m,g,d));for(var E in f){var N=f[E].getHex();m=a.calculateAttackResults(f[E],g,b);if(N.isSpotted(n)||f[E].tempSpotted)x+=m.kills,r+=m.losses;p+=m.kills;l+=m.losses}m=a.calculateAttackResults(g,d,b);x+=m.losses;r+=m.kills;
p+=m.losses;l+=m.kills;k?(m.losses=p,m.kills=l):(m.losses=Math.min(x,g.strength),m.kills=Math.min(r,d.strength));return m};a.calculateAttackResults=function(k,q,p){var l=k.getPos(),x=q.getPos(),r=k.unitData(),n=q.unitData(),M=r.target,F=n.target,Q=k.getHex(),U=q.getHex(),E=k.experience/100>>0,N=q.experience/100>>0,w=0,z=0,H=0,C=0,B=new combatResults,l=a.distance(l.row,l.col,x.row,x.col),W=Q.terrain,T=U.terrain;d(k)&&(W=terrainType.Clear);d(q)&&(T=terrainType.Clear);q.isMounted&&(!q.isSurprised&&q.unitData(!0).uclass==
unitClass.infantry)&&(n=Equipment.equipment[q.eqid]);var x=a.isEntrenchmentIntact(k,q,T),P=a.isEntrenchmentIntact(q,k,W);switch(M){case unitType.air:H=n.airatk;C=n.airdef;break;case unitType.soft:H=n.softatk;C=n.grounddef;break;case unitType.hard:H=n.hardatk;C=n.grounddef;break;case unitType.sea:H=n.navalatk,C=n.grounddef,n.uclass==unitClass.submarine&&(z=r.closedef)}switch(F){case unitType.air:w=r.airatk;z=r.airdef;break;case unitType.soft:w=r.softatk;z=r.grounddef;break;case unitType.hard:w=r.hardatk;
z=r.grounddef;break;case unitType.sea:w=r.navalatk,z=r.grounddef,r.uclass==unitClass.submarine&&(C=n.closedef)}var X=(a.isCloseCombatTerrain(T)||n.uclass==unitClass.fortification)&&r.uclass==unitClass.infantry;X&&(C=n.closedef,n.uclass==unitClass.infantry?z=r.closedef:w+=4);Leaders.unitHasLeader(k,leaderType.aggressiveAttack)&&(w+=4,z+=2);Leaders.unitHasLeader(q,leaderType.aggressiveAttack)&&(H+=2,C+=2);Leaders.unitHasLeader(k,leaderType.determinedDefense)&&(z+=2);Leaders.unitHasLeader(q,leaderType.determinedDefense)&&
(H+=2,C+=4);Leaders.unitHasLeader(k,leaderType.tenaciousDefense)&&F!=unitType.air&&(z+=4);Leaders.unitHasLeader(q,leaderType.tenaciousDefense)&&M!=unitType.air&&(C+=4);d(k)&&(Leaders.unitHasLeader(k,leaderType.skilledGroundAttack)&&m(q))&&(w+=4);n.uclass==unitClass.artillery&&(z+=3);T==terrainType.City&&(C+=4);T!=terrainType.River&&T!=terrainType.Stream||U.road!=roadType.none||(w+=4,z+=4);W!=terrainType.River&&W!=terrainType.Stream||Q.road!=roadType.none||(H+=4,C+=4);F=M=0;P&&!X&&(M=k.entrenchment);
x&&(F=q.entrenchment);Leaders.unitHasLeader(k,leaderType.infiltrationTactics)&&!Leaders.unitHasLeader(q,leaderType.ferociousDefense)&&(F=0);Leaders.unitHasLeader(q,leaderType.infiltrationTactics)&&!Leaders.unitHasLeader(k,leaderType.ferociousDefense)&&(M=0);z+=M;C+=F;n.uclass==unitClass.infantry&&a.isCloseCombatTerrain(T)&&!X&&r.uclass>unitClass.infantry&&r.uclass<unitClass.groundTransport&&(C+=F);w+=E;z+=E;H+=N;C+=N;r.uclass!=unitClass.artillery&&(r.uclass!=unitClass.fortification&&(r.uclass<unitClass.submarine||
r.uclass>unitClass.lightCruiser))&&(E=2*q.hits,C=C<=E?0:C-E);E=r.uclass==unitClass.antiTank&&k.hasMoved&&!Leaders.unitHasLeader(k,leaderType.tankKiller);m(k)&&(m(q)&&!X)&&(1>=l||a.getUnitAttackRange(q)<l?(E||(z+=r.rangedefmod>>1),C+=n.rangedefmod>>1):(E||(z+=r.rangedefmod),C+=n.rangedefmod));aInitiative=r.initiative;dInitiative=n.initiative;E=r.initiative-n.initiative;Leaders.unitHasLeader(k,leaderType.firstStrike)&&(E=Math.abs(E));Leaders.unitHasLeader(q,leaderType.firstStrike)&&(E=-Math.abs(E));
0<=E?(z+=4,w+=Math.min(4,E)):(C+=4,H+=Math.min(4,-E));1==l&&(x&&a.isRuggedDefense(k,q))&&(B.isRugged=!0);if(k.isSurprised||B.isRugged)z=0,w/=2;1<l&&!(g(k)&&g(q)&&n.gunrange>=l)&&(B.defcanfire=!1);f(q,k)||(B.defcanfire=!1);B.kills=b(w,C,k,q,p);B.defcanfire&&(B.losses=b(H,z,q,k,p));r.uclass==unitClass.tank&&(1>=B.losses&&B.kills>=q.strength&&1==l&&!k.isSurprised)&&(B.isOverrun=!0);p=H+6-z;r=w+6-C;1>p&&(p=1);1>r&&(r=1);w=C+6-w;z=z+6-H;1>w&&(w=1);1>z&&(z=1);B.atkExpGained=(p*(q.strength/10)+w)*B.kills>>
0;B.defExpGained=2*B.kills>>0;B.defcanfire&&(B.atkExpGained+=+(2*B.losses),B.defExpGained+=+((r*(k.strength/10)+z)*B.losses));k.experience+B.atkExpGained>UNIT_MAX_EXPERIENCE&&(B.atkExpGained=UNIT_MAX_EXPERIENCE-k.experience);q.experience+B.defExpGained>UNIT_MAX_EXPERIENCE&&(B.defExpGained=UNIT_MAX_EXPERIENCE-q.experience);return B};a.isLossOverRetreatThreshold=function(a,g){return(g-a)/g>=UNIT_RETREAT_THRESHOLD-(10-g)/2/10?!0:!1};a.shouldDefenderRetreat=function(g,d,k){var b=g.unitData().uclass;return m(g)&&
m(d)&&b!=unitClass.artillery&&b!=unitClass.tacticalBomber&&b!=unitClass.fortification?a.isLossOverRetreatThreshold(d.strength,k):!1};a.getRetreatPosition=function(g,d,m,k){if(!d)return null;var b=d.unitData();k=movTable[b.movmethod];if(0==b.movpoints)return null;b=d.getPos();d=Math.abs(d.facing-8);var f=a.facingToAdjacentIndex(d);d=p(b.row,b.col);d.unshift(d[f]);for(var l in d)if(b=d[l].row,f=d[l].col,(0!=b||0!=f%2)&&(b!=m-1||1!=f%2)&&"undefined"!==typeof g[b]&&"undefined"!==typeof g[b][f]&&null===
g[b][f].unit&&255>k[g[b][f].terrain])return new Cell(b,f);return null};a.isRuggedDefense=function(a,g){var d=(a.experience/100>>0)+2,m=(g.experience/100>>0)+2;Leaders.unitHasLeader(a,leaderType.tenaciousDefense)&&(d+=2);Leaders.unitHasLeader(g,leaderType.tenaciousDefense)&&(m+=2);var k=unitEntrenchRate[a.unitData().uclass]+1,b=unitEntrenchRate[g.unitData().uclass]+1;return 50<5*(50*m/d)*b*g.entrenchment/(50*k)};a.isEntrenchmentIntact=function(a,g,d){return Leaders.unitHasLeader(g,leaderType.ferociousDefense)?
!0:Equipment.ignoresEntrenchment(a.eqid)||(Leaders.unitHasLeader(a,leaderType.infiltrationTactics)||Leaders.unitHasLeader(a,leaderType.streetFighter))&&(d==terrainType.City||d==terrainType.Rough||d==terrainType.Port)?!1:!0};a.getResupplyValue=function(m,k,b){"undefined"===typeof b&&(b=!1);if(!a.canResupply(m,k))return new Supply(0,0);var f=k.unitData(!0).ammo-k.ammo,l=k.unitData(!0).fuel-k.fuel,x=k.getHex().terrain;if(d(k)||g(k))return new Supply(f,l);var r=0,n=0;null!==k.transport&&(r=k.transport.unitData().ammo-
k.transport.ammo,n=k.transport.unitData().fuel-k.transport.fuel);var F=k.getPos(),F=p(F.row,F.col),Q=0,U;for(U in F){var E=F[U].row,N=F[U].col;"undefined"!==typeof m[E]&&"undefined"!==typeof m[E][N]&&null!=m[E][N].unit&&m[E][N].unit.player.side!=k.player.side&&Q++}if(b&&(0<Q||x!=terrainType.City))return new Supply(0,0);x!=terrainType.City&&(f/=1.3,l/=1.3,r/=1.3,n/=1.3);0<Q&&2>=Q&&(f/=1.5,l/=1.5,r/=1.5,n/=1.5);2<Q&&(f/=3,l/=3,r/=3,n/=3);1>f&&(f=1);1>l&&(l=1);return new Supply(Math.round(f),Math.round(l),
Math.round(r),Math.round(n))};a.getReinforceValue=function(g,m,k){defined(k)||(k=!1);if(!a.canReinforce(g,m,k))return 0;var b=10-m.strength;k&&(b=10+Math.round(m.experience/100)-m.strength);if(d(m))return b;k=m.getPos();k=p(k.row,k.col);var f=0,l;for(l in k){var x=k[l].row,r=k[l].col;"undefined"!==typeof g[x]&&"undefined"!==typeof g[x][r]&&null!==g[x][r].unit&&g[x][r].unit.player.side!=m.player.side&&f++}m.getHex().terrain!=terrainType.City&&(b/=1.3);0<f&&2>=f&&(b/=1.5);2<f&&(b/=3);return Math.round(b)};
a.canInitiateAttack=function(g,d){var m;if(null===g||g.destroyed||null===d||d.destroyed)m=!1;else{m=g.getEqid();var k=d.getEqid();m=a.isEnemy(g,d)&&!Equipment.canInitiateAttackOnUnitType(m,k)?!1:f(g,d)}return m};a.canFire=function(a,g){return f(a,g)};a.canPassInto=function(a,g,d){return n(a,g,d)};a.isBridgeForSide=function(a,g){return!a||!a.unit||a.terrain!=terrainType.River&&a.terrain!=terrainType.Stream||a.unit.isMounted||a.unit.player.side!=g?!1:Equipment.isBridge(a.unit.eqid)};a.canResupply=function(a,
b){if(b.hasMoved||b.hasFired||b.hasResupplied)return!1;var f=b.ammo<b.unitData(!0).ammo,p=b.fuel<b.unitData(!0).fuel;null!==b.transport&&(f=f||b.transport.ammo<b.transport.unitData().ammo,p=p||b.transport.fuel<b.transport.unitData().fuel);return f||p?m(b)||d(b)&&k(a,b)||g(b)&&b.getHex().terrain!=terrainType.Port?!0:!1:!1};a.canReinforce=function(a,b,f){defined(f)||(f=!1);if(b.hasOverstrength)return!1;if(f){if(10>b.strength||100>b.experience||b.strength>=10+Math.round(b.experience/100))return!1}else if(b.hasResupplied||
10<=b.strength)return!1;b.unitData(!0);return m(b)||d(b)&&k(a,b)||g(b)&&b.getHex().terrain!=terrainType.Port?!0:!1};a.canCapture=function(a){var g=a.unitData().uclass;return d(a)||a.isMounted&&(g==unitClass.antiTank||g==unitClass.flak||g==unitClass.artillery||g==unitClass.airDefence)?!1:!0};a.canEntrench=function(a){if(null===a||0!=a.carrier)return!1;a=a.unitData().uclass;return 0<unitEntrenchRate[a]?!0:!1};a.isEnemy=function(a,g){return null===a||null===g?!1:a.player.side!=g.player.side?!0:!1};a.getSupportFireUnits=
function(g,m,k){var b=m.getPos(),p=k.getPos();if(1<a.distance(b.row,b.col,p.row,p.col))return[];var p=[],l=null,x;for(x in g)if(l=g[x],l.player.side==k.player.side&&l.id!=k.id){var r=l.getPos(),n=l.unitData(),Q=n.gunrange;0==Q&&(Q=1);a.distance(r.row,r.col,b.row,b.col)>Q||(d(m)?n.uclass!=unitClass.flak&&n.uclass!=unitClass.airDefence&&n.uclass!=unitClass.fighter||!f(l,m)||p.push(l):n.uclass==unitClass.artillery&&f(l,m)&&p.push(l))}return p};a.isInAttackRange=function(g,d){var m=g.getPos(),k=d.getPos(),
b=a.getUnitAttackRange(g);return defined(m)&&defined(k)?a.distance(m.row,m.col,k.row,k.col)<=b?!0:!1:!1};a.getEmbarkType=function(a,g){var d=g.getPos(),d=a[d.row][d.col],m=g.unitData();return d.terrain==terrainType.Airfield&&0<g.player.airTransports&&m.embark>embarkType.naval&&null===d.airunit?unitClass.airTransport:d.terrain==terrainType.Port&&0<g.player.navalTransports&&m.embark>embarkType.none?unitClass.navalTransport:unitClass.none};a.getDisembarkPositions=function(a,g){var d=[],m=g.unitData();
if(!g.hasMoved&&(m.uclass==unitClass.airTransport||m.uclass==unitClass.navalTransport)){var k=g.getPos(),m=movTable[Equipment.equipment[g.eqid].movmethod],k=p(k.row,k.col),b;for(b in k){var f=k[b].row,l=k[b].col;"undefined"!==typeof a[f]&&"undefined"!==typeof a[f][l]&&(f=a[f][l],null===f.unit&&255>m[f.terrain]&&d.push(k[b]))}}return d};a.getReinforcementDeployPositions=function(a,g,d,m){g.unitData();var k=movTable[Equipment.equipment[g.eqid].movmethod],b=p(d,m);b.unshift(new Cell(d,m));for(var f in b)if(d=
b[f].row,m=b[f].col,defined(a[d])&&defined(a[d][m])&&!(0>d||0>m)&&(d=a[d][m],l(a,g,b[f])&&255>k[d.terrain]))return b[f];return null};a.canEmbark=function(g,d){return 0<a.getEmbarkType(g,d)||0>d.carrier?!0:!1};a.canDisembark=function(g,d){return 0<a.getDisembarkPositions(g,d).length?!0:!1};a.canMount=function(a){return!a.hasMoved&&m(a)&&null!==a.transport?!0:!1};a.canUnmount=function(a){return!a.hasMoved&&a.isMounted?!0:!1};a.isTransportable=function(a){return 1>a||"undefined"===typeof a||0==Equipment.equipment[a].groundweight?
!1:!0};a.isAir=function(a){return d(a)};a.isSea=function(a){return g(a)};a.isGround=function(a){return m(a)};a.isTrain=function(a){if(null===a)return!1;var g=a.unitData();return m(a)&&g.movmethod==movMethod.deepnaval?!0:!1};a.isCloseCombatTerrain=function(a){return a==terrainType.City||a==terrainType.Forest||a==terrainType.Mountain||a==terrainType.Fortification?!0:!1};a.unitUsesFuel=function(a){if(0==a.unitData().fuel)return!1;a=a.unitData().movmethod;return a==movMethod.leg||a==movMethod.towed||
a==movMethod.allTerrainLeg?!1:!0};a.unitLowFuel=function(g,d){if(!a.unitUsesFuel(g))return!1;if(!g.isMounted){if(g.fuel<d)return!0}else if(g.transport.fuel<d)return!0;return!1};a.unitUsesAmmo=function(a){return 0==a.unitData().ammo?!1:!0};a.unitLowAmmo=function(g,d){if(!a.unitUsesAmmo(g))return!1;if(!g.isMounted){if(g.ammo<d)return!0}else if(g.transport.ammo<d)return!0;return!1};a.calculateUnitCosts=function(a,g){var d=0;0<a&&"undefined"!==typeof a&&(d+=Equipment.equipment[a].cost*CURRENCY_MULTIPLIER);
0<g&&"undefined"!==typeof g&&(d+=Equipment.equipment[g].cost*CURRENCY_MULTIPLIER);return d};a.calculateUpgradeCosts=function(g,d,m){if(null===g)return 0;var k=0,b=0,f=0,b="undefined"!==typeof d&&0<d?g.eqid==d?a.calculateUnitCosts(g.eqid,-1):a.calculateUnitCosts(d,-1)*UPGRADE_PENALTY:a.calculateUnitCosts(g.eqid,-1);"undefined"!==typeof m&&0<m&&(f=null!==g.transport&&g.transport.eqid==m?a.calculateUnitCosts(-1,m):a.calculateUnitCosts(-1,m)*UPGRADE_PENALTY);k=null!==g.transport?-1==m?a.calculateUnitCosts(g.eqid,
-1):a.calculateUnitCosts(g.eqid,g.transport.eqid):a.calculateUnitCosts(g.eqid,-1);return b+f-k>>0};a.calculateUnitCostPerStrength=function(a){return null===a?-1:a.unitData().cost*CURRENCY_MULTIPLIER/10>>0};a.calculateUnitSellCost=function(g){if(!defined(g))return-1;var d=-1;defined(g.transport)&&(d=g.transport.eqid);return a.calculateUnitCosts(g.eqid,d)/UPGRADE_PENALTY/10*g.strength>>0};a.getDirection=function(a,g,d,m){g&1&&a==d&&a++;m&1&&a==d&&d++;a-=d;g-=m;m=0;d=1;0!=a&&(d=Math.abs(g/a));3<d&&(m=
1);0>d&&(m=-1);if(0<a){if(0<g)return direction.NW+m;if(0>g)return direction.NE+m;if(0==g)return direction.N}if(0>a){if(0<g)return direction.SW+m;if(0>g)return direction.SE+m;if(0==g)return direction.S}if(0==a){if(0<=g)return direction.W;if(0>g)return direction.E}};a.distance=function(a,g,d,m){a=Math.abs((m%2?2*d+1:2*d)-(g%2?2*a+1:2*a));g=Math.abs(m-g);return a>g?(a-g)/2+g>>0:g};a.getAdjacent=function(a,g){return p(a,g)};a.facingToAdjacentIndex=function(a){return a==direction.N?0:a==direction.NW||
a==direction.NNW||a==direction.WNW||a==direction.W?1:a==direction.SW||a==direction.WSW||a==direction.SSW?2:a==direction.S?3:a==direction.SE||a==direction.SSE||a==direction.ESE?4:a==direction.NE||a==direction.E||a==direction.ENE||a==direction.NNE?5:0};a.rollDice=function(a,g){a=Math.ceil(a);g=Math.floor(g);return Math.floor(Math.random()*(g-a+1))+a};return a}(GameRules||{});function Transport(a){this.eqid="undefined"===typeof Equipment.equipment[a]?Object.keys(Equipment.equipment)[0]:a;this.ammo=Equipment.equipment[this.eqid].ammo;this.fuel=Equipment.equipment[this.eqid].fuel;this.icon=Equipment.equipment[this.eqid].icon}Transport.prototype.copy=function(a){null!==a&&(this.eqid=a.eqid,this.ammo=a.ammo,this.fuel=a.fuel)};Transport.prototype.unitData=function(){return Equipment.equipment[this.eqid]};
function Unit(a){this.eqid="undefined"===typeof Equipment.equipment[a]?Object.keys(Equipment.equipment)[0]:a;this.owner=this.id=-1;this.tempSpotted=this.isCore=this.isDeployed=this.isSurprised=this.isMounted=this.hasOverstrength=this.hasResupplied=this.hasFired=this.hasMoved=!1;this.strength=10;this.facing=2;this.flag=this.owner;this.destroyed=!1;this.transport=this.player=null;this.carrier=0;this.moveLeft=Equipment.equipment[this.eqid].movpoints;this.ammo=Equipment.equipment[this.eqid].ammo;this.fuel=
Equipment.equipment[this.eqid].fuel;this.hasAnimation=!1;this.entrenchTicks=this.entrenchment=this.experience=this.hits=0;this.leader=-1;this.getHex=function(){return b};this.setHex=function(a){b=a;null!==a&&(this.isDeployed=!0)};this.getPos=function(){return null===b?null:b.getPos()};var b=null}
Unit.prototype.copy=function(a){null!==a&&(this.eqid="undefined"===typeof Equipment.equipment[a.eqid]?Object.keys(Equipment.equipment)[0]:a.eqid,this.id=a.id,this.owner=a.owner,this.hasMoved=a.hasMoved,this.hasFired=a.hasFired,this.hasOverstrength=a.hasOverstrength,this.hasResupplied=a.hasResupplied,this.isMounted=a.isMounted,this.isSurprised=a.isSurprised,this.isDeployed=a.isDeployed,this.isCore=a.isCore,this.carrier=a.carrier,this.moveLeft=a.moveLeft,this.ammo=a.ammo,this.fuel=a.fuel,this.strength=
a.strength,this.facing=a.facing,this.flag=a.flag,this.destroyed=a.destroyed,this.hits=a.hits,this.experience=a.experience,this.entrenchment=a.entrenchment,this.entrenchTicks=a.entrenchTicks,this.leader=a.leader,this.player=new Player,this.player.copy(game.scenario.map.getPlayer(this.owner)),null!==a.transport&&(this.transport=new Transport(a.transport.eqid),this.transport.copy(a.transport)))};
Unit.prototype.getEqid=function(a){return 0<this.carrier&&!a?this.carrier:this.isMounted&&null!==this.transport&&!a?this.transport.eqid:this.eqid};Unit.prototype.unitData=function(a){defined(a)||(a=!1);return Equipment.equipment[this.getEqid(a)]};Unit.prototype.getMovesLeft=function(){return 0<this.carrier?Equipment.equipment[this.carrier].movpoints:this.isMounted&&null!==this.transport?Equipment.equipment[this.transport.eqid].movpoints:this.hasMoved?0:this.moveLeft};
Unit.prototype.getAmmo=function(){return this.isMounted&&null!==this.transport?this.transport.ammo:this.ammo};Unit.prototype.getFuel=function(){return this.isMounted&&null!==this.transport?this.transport.fuel:this.fuel};Unit.prototype.hit=function(a){this.strength-=a;this.hits++;0<this.entrenchment&&this.entrenchment--;0>=this.strength&&(this.destroyed=!0)};Unit.prototype.fire=function(a){this.tempSpotted=!0;this.ammo--;a&&(this.hasOverstrength=this.hasFired=!0)};
Unit.prototype.move=function(a){var b=this.entrenchment=0,b=254<=a?a/254+a%254>>0:a;this.isMounted&&null!==this.transport?(this.hasFired=!0,GameRules.unitUsesFuel(this.transport)&&(this.transport.fuel-=b),this.moveLeft=0):(GameRules.unitUsesFuel(this)&&0==this.carrier&&(this.fuel-=b),this.moveLeft-=b);if(this.unitData().uclass!=unitClass.recon||0>=this.moveLeft)this.hasOverstrength=this.hasMoved=!0;0>this.carrier&&(this.carrier=0)};
Unit.prototype.upgrade=function(a,b){0>=a&&(a=this.eqid);var f=Equipment.equipment[this.eqid].uclass,l=Equipment.equipment[a].uclass;f==unitClass.flak&&l==unitClass.airDefence&&(f=unitClass.airDefence);if(f!=l)return!1;this.eqid=a;GameRules.isTransportable(this.eqid)?0<b&&this.setTransport(b):null!==this.transport&&(this.transport=null);this.refillAmmoFuel();this.entrenchment=0;this.isDeployed&&(this.hasMoved=this.hasFired=this.hasOverstrength=this.hasResupplied=!0);return!0};
Unit.prototype.resupply=function(a){this.ammo+=a.ammo;this.fuel+=a.fuel;null!==this.transport&&(this.transport.ammo+=a.transportAmmo,this.transport.fuel+=a.transportFuel);this.hasMoved=this.hasFired=this.hasResupplied=!0};Unit.prototype.reinforce=function(a,b){this.strength+=a;this.hasMoved=this.hasFired=this.hasRessuplied=!0;b&&(this.hasOverstrength=!0)};Unit.prototype.setTransport=function(a){delete this.transport;this.transport=new Transport(a)};Unit.prototype.mount=function(){this.isMounted=!0};
Unit.prototype.unmount=function(){this.isMounted=!1};Unit.prototype.embark=function(a){a=Equipment.getCountryEquipmentByClass(a,this.player.country+1)[0];if(!a||"undefined"===typeof a)return!1;this.carrier=a;return!0};
Unit.prototype.entrench=function(){var a=null,b=this.unitData().uclass,f=0;if(!GameRules.canEntrench(this))return!1;a=this.getHex();if(!a)return!1;f=terrainEntrenchment[a.terrain];if(this.entrenchment>=terrainEntrenchment[a.terrain]){var a=this.entrenchment-f,l=9*a+4;for(this.entrenchTicks+=+(this.experience/100)+(f+1)*unitEntrenchRate[b];this.entrenchTicks>=l&&this.entrenchment<f+5;)this.entrenchTicks-=l,this.entrenchment++,a++,l=9*a+4}else this.entrenchment=f,this.entrenchTicks=0;return!0};
Unit.prototype.toggleEmbark=function(){this.carrier=-this.carrier};Unit.prototype.getIcon=function(){return this.unitData().icon};Unit.prototype.refillAmmoFuel=function(){this.ammo=Equipment.equipment[this.eqid].ammo;this.fuel=Equipment.equipment[this.eqid].fuel;null!==this.transport&&defined(Equipment.equipment[this.transport.eqid])&&(this.transport.ammo=Equipment.equipment[this.transport.eqid].ammo,this.transport.fuel=Equipment.equipment[this.transport.eqid].fuel)};
Unit.prototype.unitEndTurn=function(){this.entrench();this.moveLeft=Equipment.equipment[this.eqid].movpoints;this.hasOverstrength=this.hasMoved=this.hasFired=this.hasResupplied=this.isSurprised=!1;this.hits=0;if(this.unitData().uclass!==unitClass.fortification){var a=this.getHex();null===a||a.isSpotted(game.spotSide)||(this.tempSpotted=!1)}};Unit.prototype.cleanup=function(){};function Player(){this.country=this.side=this.id=-1;this.score=this.prestige=0;this.dossier={};this.playedTurn=-1;this.type=playerType.humanLocal;this.handler=null;this.navalTransports=this.airTransports=0;this.supportCountries=[];this.prestigePerTurn=[];this.getCoreUnitList=function(){return a};this.addCoreUnit=function(b){if(!b||"undefined"===typeof b)return!1;b.isCore=!0;a.push(b);return!0};this.removeUndeployedCoreUnit=function(b){a.splice(b,1)};this.setCoreUnitList=function(b){if(!b||0==b.length)return!1;
var f;a=[];for(f=0;f<b.length;f++)a.push(b[f]);return!0};var a=[]}
Player.prototype.copy=function(a,b){var f;if(null!==a){defined(b)||(b=!1);this.id=a.id;this.side=a.side;this.country=a.country;this.prestige=a.prestige;this.playedTurn=a.playedTurn;this.type=a.type;if(b)this.score+=a.score;else{this.score=a.score;this.airTransports=a.airTransports;this.navalTransports=a.navalTransports;if(a.supportCountries)for(f=0;f<a.supportCountries.length;f++)this.supportCountries.push(a.supportCountries[f]);if(a.prestigePerTurn)for(f=0;f<a.prestigePerTurn.length;f++)this.prestigePerTurn.push(a.prestigePerTurn[f])}"function"===
typeof a.getCoreUnitList&&this.setCoreUnitList(a.getCoreUnitList());a.hasOwnProperty("dossier")&&a.dossier.hasOwnProperty("units")&&this.copyDossier(a)}};
Player.prototype.initDossier=function(){this.dossier.units={};this.dossier.units.lostaux={};this.dossier.units.lostcore={};this.dossier.units.killed={};for(var a in unitClass){var b=unitClass[a];this.dossier.units.lostaux[b]=0;this.dossier.units.lostcore[b]=0;this.dossier.units.killed[b]=0}this.dossier.outcomes={};for(var f in outcomeNames)this.dossier.outcomes[f]=[]};
Player.prototype.copyDossier=function(a){this.initDossier();for(var b in unitClass){var f=unitClass[b];this.dossier.units.lostaux[f]=a.dossier.units.lostaux[f];this.dossier.units.lostcore[f]=a.dossier.units.lostcore[f];this.dossier.units.killed[f]=a.dossier.units.killed[f]}for(var l in outcomeNames)for(b=0;b<a.dossier.outcomes[l].length;b++)this.dossier.outcomes[l].push(a.dossier.outcomes[l][b])};Player.prototype.getCountryName=function(){return Equipment.getCountryName(this.country)};
Player.prototype.getSideName=function(){return sideNames[this.side]};Player.prototype.hasUndeployedUnits=function(){var a,b=this.getCoreUnitList();for(a=0;a<b.length;a++)if(!b[a].isDeployed)return!0;return!1};Player.prototype.buyUnit=function(a,b){var f=GameRules.calculateUnitCosts(a,b);if(f>this.prestige)return!1;this.acquireUnit(a,b)&&(this.prestige-=f);return!0};
Player.prototype.acquireUnit=function(a,b){var f=new Unit(a);0<b&&"undefined"!==typeof b&&f.setTransport(b);f.owner=this.id;f.flag=1*this.country+1;f.player=this;null===game.campaign&&(f.experience=+game.scenario.getSideUnitsAvgExp(+!this.side));this.addCoreUnit(f);return!0};Player.prototype.upgradeUnit=function(a,b,f){var l=GameRules.calculateUpgradeCosts(a,b,f);if(l>this.prestige||!a.upgrade(b,f))return!1;this.prestige-=l;return!0};
Player.prototype.sellUnit=function(a){if(!defined(a))return!1;a=GameRules.calculateUnitSellCost(a);this.prestige+=a;return!0};Player.prototype.resupplyUnit=function(a,b){this.updateScore(scoreGains.resupply);a.resupply(b)};Player.prototype.reinforceUnit=function(a,b,f){var l=1;f&&(l=OVERSTRENGTH_PENALTY);var l=Math.round(GameRules.calculateUnitCostPerStrength(a)*l),n=this.prestige/l>>0;if(1>n)return 0;n>b&&(n=b);this.prestige-=n*l;this.updateScore(scoreGains.reinforce,b);a.reinforce(n,f);return n};
Player.prototype.updateScore=function(a,b){if(null==b||"undefined"===typeof b)b=1;var f=1;null!==game.campaign&&(f=difficultyModifiers[game.campaign.difficulty].scoreCoef);this.score+=a*b*f>>0};Player.prototype.addDestroyedUnitToDossier=function(a){this.dossier.hasOwnProperty("units")||this.initDossier();var b=a.unitData(!0).uclass;this.id===a.player.id?a.isCore?this.dossier.units.lostcore[b]++:this.dossier.units.lostaux[b]++:this.dossier.units.killed[b]++};
Player.prototype.addOutcomeToDossier=function(a,b){this.dossier.hasOwnProperty("outcomes")||this.initDossier();this.dossier.outcomes[a].push(b)};Player.prototype.endTurn=function(a){this.playedTurn=a;a<this.prestigePerTurn.length&&(this.prestige+=this.prestigePerTurn[a]);this.updateScore(scoreGains.endTurn)};
Player.prototype.setPlayerToHQ=function(){var a,b;this.supportCountries=[];this.prestigePerTurn=[];this.navalTransports=this.airTransports=0;var f=this.getCoreUnitList();for(a=0;a<f.length;a++)b=f[a],b.destroyed?(f[a]=null,f.splice(a,1),a--):(b.unmount(),b.carrier=0,b.hasMoved=b.hasFired=b.hasResupplied=!1,b.isDeployed=!1,10>b.strength&&(b.strength=10),b.refillAmmoFuel(),b.moveLeft=b.unitData().movpoints,b.entrenchment=0,b.hits=0,b.setHex(null))};Player.prototype.cleanup=function(){};
function Hex(a,b){this.airunit=this.unit=null;this.terrain=terrainType.Clear;this.road=roadType.none;this.victorySide=this.isDeployment=this.flag=this.owner=-1;this.name="";this.isAttackSel=this.isMoveSel=!1;this.isZOC=function(a){return a<f.length&&0<f[a]?!0:!1};this.isSpotted=function(a){return uiSettings.noFOW?!0:a<l.length&&0<l[a]?!0:!1};this.setZOC=function(a,k){var d=f;a<d.length&&(k?d[a]++:0<d[a]&&d[a]--)};this.setSpotted=function(a,k){var d=l;a<d.length&&(k?d[a]++:0<d[a]&&d[a]--)};this.getPos=
function(){return new Cell(1*a,1*b)};var f=[0,0],l=[0,0]}Hex.prototype.copy=function(a){null!==a&&(this.terrain=a.terrain,this.road=a.road,this.owner=a.owner,this.flag=a.flag,this.isDeployment=a.isDeployment,this.victorySide=a.victorySide,this.name=a.name,this.setUnit(a.unit),this.setUnit(a.airunit))};Hex.prototype.getUnit=function(a){return null!==this.unit&&null!==this.airunit?a?this.airunit:this.unit:null!==this.unit?this.unit:null!==this.airunit?this.airunit:null};
Hex.prototype.setUnit=function(a){null!==a&&"function"===typeof a.setHex&&(a.setHex(this),GameRules.isAir(a)?this.airunit=a:this.unit=a)};Hex.prototype.delUnit=function(a){null!==a&&"function"===typeof a.setHex&&(a.setHex(null),null!==this.unit&&this.unit.id==a.id&&(this.unit=null),null!==this.airunit&&this.airunit.id==a.id&&(this.airunit=null))};
Hex.prototype.getAttackableUnit=function(a,b){var f=this.isSpotted(a.player.side),l=-1,n=this.getUnit(b);if(n){if((f||n.tempSpotted)&&GameRules.canInitiateAttack(a,n))return n;l=n.id}return(n=this.getUnit(!b))&&n.id!==l&&(f||n.tempSpotted)&&GameRules.canInitiateAttack(a,n)?n:null};Hex.prototype.cleanup=function(){this.unit&&(this.unit.cleanup(),delete this.unit,this.unit=null);this.airunit&&(this.airunit.cleanup(),delete this.airunit,this.airunit=null)};
function Map(){this.cols=this.rows=0;this.isLastColPartial=this.isLastRowPartial=!1;this.terrainImage=this.map=null;this.victoryTurns=[];this.turn=this.maxTurns=1;this.currentUnit=null;this.sidesVictoryHexes=[[],[]];this.currentPlayer=null;var a={},b=[],f=[],l=[],n=[],k=0;this.allocMap=function(){this.map=Array(this.rows);for(var a=0;a<this.rows;a++){this.map[a]=Array(this.cols);for(var d=0;d<this.cols;d++)this.map[a][d]=new Hex(a,d)}};this.addUnit=function(g){g.id=k;k++;l.push(g);a[g.eqid]=Equipment.equipment[g.eqid].icon;
null!==g.transport&&(a[g.transport.eqid]=g.transport.icon);0<g.carrier&&(a[g.carrier]=Equipment.equipment[g.carrier].icon);g.player=this.getPlayer(g.owner);-1==g.flag&&(g.flag=g.player.country+1);GameRules.setZOCRange(this.map,g,!0,this.rows,this.cols);GameRules.setSpotRange(this.map,g,!0,this.rows,this.cols)};this.getUnits=function(){return l};this.getUnitById=function(a){if(0>a||"undefined"===typeof a)return null;for(var d=0;d<l.length;d++)if(null!==l[d]&&l[d].id==a)return l[d];return null};this.getUnitImagesList=
function(){return a};this.hasAliveUnits=function(a){for(var d=0;d<l.length;d++)if(l[d].player.side==a&&!l[d].destroyed)return!0;return!1};this.removeAllSideUnits=function(a){for(var d=0;d<l.length;d++)l[d].player.side==a&&(l[d].destroyed=!0);this.updateUnitList()};this.getPlayers=function(){return n};this.addPlayer=function(g){if(g){n.push(g);null===this.currentPlayer&&(this.currentPlayer=n[0]);if(0<g.airTransports){var d=Equipment.getCountryEquipmentByClass(unitClass.airTransport,g.country+1)[0];
d&&"undefined"!==typeof d&&(a[d]=Equipment.equipment[d].icon)}0<g.navalTransports&&(d=Equipment.getCountryEquipmentByClass(unitClass.navalTransport,g.country+1)[0])&&"undefined"!==typeof d&&(a[d]=Equipment.equipment[d].icon)}};this.getPlayer=function(a){return a<n.length?n[a]:n[0]};this.getPlayersByCountry=function(a){for(var d=[],k=this.getPlayers(),b=0;b<k.length;b++)k[b].country==a&&d.push(k[b]);return d};this.getCountriesBySide=function(a){for(var d=[],k=this.getPlayers(),b=0;b<k.length;b++)if(k[b].side==
a){d.push(k[b].country);for(var f=0;f<k[b].supportCountries.length;f++)0<k[b].supportCountries[f]&&d.push(k[b].supportCountries[f]-1)}return d};this.setCurrentUnit=function(a){this.currentUnit=a};this.delCurrentUnit=function(){null!==this.currentUnit&&0>this.currentUnit.carrier&&this.currentUnit.toggleEmbark();this.currentUnit=null;this.delMoveSel();this.delAttackSel()};this.getUnitNeighbor=function(a,d,k){var b,f=l.length,s=a.id,q=a.owner,n=[];b=-1;for(var I=0;I<f;I++){var J=l[I];null!==J&&J.owner==
q&&(J.id==s?(n.push(J),b=n.length-1):k&&!J.hasMoved&&n.push(J))}return-1!==b?(a=b-1,0==b&&(a=n.length-1),b=(b+1)%n.length,0<d?n[b]:n[a]):a};this.delMoveSel=function(){for(var a=0;a<b.length;a++){var d=b[a];this.map[d.row][d.col].isMoveSel=!1}b=[]};this.delAttackSel=function(){for(var a=0;a<f.length;a++){var d=f[a];this.map[d.row][d.col].isAttackSel=!1}f=[]};this.setHex=function(a,d,k){k&&"undefined"!==typeof k?this.map[a][d].copy(k):k=this.map[a][d];a=k.victorySide;if(-1!=a){-1!=k.owner&&a==this.getPlayer(k.owner).side&&
(a=~a&1);d=k.getPos();for(var b=!1,f=0;f<this.sidesVictoryHexes[a].length;f++){var l=this.sidesVictoryHexes[a][f];if(l.row==d.row&&l.col==d.col){b=!0;break}}b||this.sidesVictoryHexes[a].push(d)}null!==k.unit&&this.addUnit(k.unit);null!==k.airunit&&this.addUnit(k.airunit)};this.updateVictorySides=function(a,d){for(var k=this.sidesVictoryHexes[~a&1],b=this.sidesVictoryHexes[a],f=0,l=b.length-1;0<=l;l--)b[l].row==d.row&&b[l].col==d.col&&(b.splice(l,1),f++);0<f&&k.push(d);return 0==this.sidesVictoryHexes[a].length?
!0:!1};this.setMoveRange=function(a){this.delMoveSel();a=GameRules.getMoveRange(this,a);for(var d=0;d<a.length;d++)b.push(a[d]),a[d].canMove&&(this.map[a[d].row][a[d].col].isMoveSel=!0)};this.getCurrentMoveRange=function(){return b};this.setAttackRange=function(a){this.delAttackSel();a=GameRules.getUnitAttackCells(this.map,a,this.rows,this.cols);for(var d=0;d<a.length;d++)f.push(a[d]),this.map[a[d].row][a[d].col].isAttackSel=!0};this.endTurn=function(){this.delMoveSel();this.delAttackSel();this.delCurrentUnit();
d.clear();this.currentPlayer.endTurn(this.turn);for(var a=this.getPlayers(),m=0;m<a.length;m++)if(a[m].id==this.currentPlayer.id){this.currentPlayer=m+1<a.length?a[m+1]:a[0];break}if(0==this.currentPlayer.id)for(this.turn++,a=0;a<l.length;a++)if(null!==l[a]){l[a].isMounted&&this.unmountUnitHandler(l[a]);m=GameRules.getResupplyValue(this.map,l[a],!0);if(0<m.ammo||0<m.fuel||0<m.transportAmmo||0<m.transportFuel)l[a].resupply(m),CombatLog.addResupply(l[a]);l[a].unitEndTurn()}this.currentPlayer.type!=
playerType.aiLocal&&this.currentPlayer.type!=playerType.aiScripted||this.currentPlayer.handler.buildActions()};this.attackUnit=function(a,m,k,b){if(null===a||null===m)return null;b="undefined"!==typeof b?b:!1;d.unit=null;var f=a.getPos(),l=m.getPos(),q=GameRules.calculateAttackResults(a,m,!1),n=CombatLog.addCombatStart(a,m,map.turn);GameRules.isBridgeForSide(a.getHex(),a.player.side)||(a.facing=GameRules.getDirection(f.row,f.col,l.row,l.col));GameRules.isBridgeForSide(m.getHex(),m.player.side)||(m.facing=
GameRules.getDirection(l.row,l.col,f.row,f.col));m.isMounted&&(!m.isSurprised&&m.unitData(!0).uclass==unitClass.infantry)&&this.unmountUnitHandler(m);b&&(q.kills=m.strength,q.isOverrun=!0,q.defcanfire=!1,0<a.moveLeft&&(a.hasMoved=!1),a.moveLeft+=1);a.experience=Math.round(a.experience+ +q.atkExpGained);m.experience=Math.round(m.experience+ +q.defExpGained);k||b?a.fire(!1):a.fire(!0);m.hit(q.kills);q.defcanfire&&!k&&(m.fire(!1),a.hit(q.losses));k||this.delAttackSel();a.player.updateScore(scoreGains.damage,
q.kills);a.player.updateScore(a.isCore?scoreGains.casualtyCore:scoreGains.casualty,q.losses);m.player.updateScore(scoreGains.damage,q.losses);m.player.updateScore(m.isCore?scoreGains.casualtyCore:scoreGains.casualty,q.kills);b=Leaders.generateLeaderWithChance(a,q.atkExpGained);-1!=b&&(a.leader=b,q.atkLeaderGain=!0,CombatLog.addLeader(a));b=Leaders.generateLeaderWithChance(m,q.defExpGained);-1!=b&&(m.leader=b,q.defLeaderGain=!0,CombatLog.addLeader(m));CombatLog.addCombatEnd(a,m,n,k);return q};this.updateUnitList=
function(){for(var a=0;a<l.length;a++){if(l[a].destroyed){var d=l[a].getPos();d&&(GameRules.setZOCRange(this.map,l[a],!1,this.rows,this.cols),GameRules.setSpotRange(this.map,l[a],!1,this.rows,this.cols),this.map[d.row][d.col].delUnit(l[a]));null!==game.campaign&&(defined(l[a].nodossier)&&!1!=l[a].nodossier||game.getCampaignPlayer().addDestroyedUnitToDossier(l[a]));l.splice(a,1);a--}null===l[a]&&(l.splice(a,1),a--)}};this.moveUnit=function(a,m,k){var f=a.getPos(),l=this.map[f.row][f.col],n=a.player.side,
q=~n&1,y=new movementResults,I=GameRules.canCapture(a),J=0,L=GameRules.getShortestPath(f,new Cell(m,k),b);if(!L||!L[0])return y;a.player.type==playerType.humanLocal&&(d.clear(),d.savedUnit=new Unit(a.eqid),d.savedUnit.copy(a),d.savedUnit.setHex(a.getHex()));for(var G=0;G<L.length;G++){if(0<G&&!GameRules.canPassInto(this.map,a,L[G])){Leaders.unitHasLeader(a,leaderType.battlefieldIntelligence)||Leaders.unitHasLeader(a,leaderType.skilledAssault)||(a.isSurprised=!0,y.surpriseCell=L[G]);break}if(a.player.type==
playerType.humanLocal||a.player.type==playerType.aiScripted||this.map[L[G].row][L[G].col].isSpotted(q))y.isVisible=!0,L[G].isVisible=!0;y.passedCells.push(L[G]);J+=L[G].cost}q=y.passedCells[y.passedCells.length-1];L=this.map[q.row][q.col];q.row==m&&q.col==k&&I&&(m=this.captureHex(L,a),m.isCapture&&(y.isCapture=!0),m.isWin&&(y.isVictorySide=n));if(!J||0>J)J=0;a.move(J);GameRules.setZOCRange(this.map,a,!1,this.rows,this.cols);GameRules.setSpotRange(this.map,a,!1,this.rows,this.cols);l.delUnit(a);L.setUnit(a);
a.facing=GameRules.getDirection(f.row,f.col,q.row,q.col);GameRules.setZOCRange(this.map,a,!0,this.rows,this.cols);f=GameRules.setSpotRange(this.map,a,!0,this.rows,this.cols);this.setMoveRange(a);this.setAttackRange(a);0!=f||a.isSurprised||a.player.type!=playerType.humanLocal?d.clear():d.unit=a;return y};this.retreatUnit=function(a,d){var k=this.currentUnit;b.push(d);var f=a.moveLeft,l=a.hasMoved,n=a.hasOverstrength,q=this.moveUnit(a,d.row,d.col);a.moveLeft=f;a.hasMoved=l;a.hasOverstrength=n;null!==
k&&this.selectUnit(k);return q};this.resupplyUnit=function(a){d.unit=null;var m=GameRules.getResupplyValue(this.map,a);a.player.resupplyUnit(a,m);this.delAttackSel();this.delMoveSel();return m};this.reinforceUnit=function(a,m){d.unit=null;var k=GameRules.getReinforceValue(this.map,a,m),b=GameRules.getResupplyValue(this.map,a),f=a.player;if(0>=(k=f.reinforceUnit(a,k,m)))return{strength:0,ammo:0,fuel:0};f.resupplyUnit(a,b);this.delAttackSel();this.delMoveSel();return{strength:k,ammo:b.ammo,fuel:b.fuel}};
this.mountUnit=function(a){this.mountUnitHandler(a);this.delMoveSel();this.delAttackSel();this.selectUnit(a)};this.mountUnitHandler=function(a){GameRules.setSpotRange(this.map,a,!1,this.rows,this.cols);a.mount();GameRules.setSpotRange(this.map,a,!0,this.rows,this.cols)};this.unmountUnit=function(a){this.delMoveSel();this.delAttackSel();this.unmountUnitHandler(a);this.selectUnit(a)};this.unmountUnitHandler=function(a){GameRules.setSpotRange(this.map,a,!1,this.rows,this.cols);a.unmount();GameRules.setSpotRange(this.map,
a,!0,this.rows,this.cols)};this.embarkUnit=function(a){var d=!1;if(0>a.carrier)a.carrier=-a.carrier,d=!0;else{var k=GameRules.getEmbarkType(this.map,a);if(0<k){if(!a.embark(k))return!1;k==unitClass.airTransport?a.player.airTransports--:k==unitClass.navalTransport&&a.player.navalTransports--;d=!0}}d&&(this.delMoveSel(),this.delAttackSel(),this.selectUnit(a));return d};this.disembarkUnit=function(a){var d=GameRules.getDisembarkPositions(this.map,a);if(0>=d.length)return!1;this.delMoveSel();this.delAttackSel();
for(var k=0;k<d.length;k++)b.push(d[k]),this.map[d[k].row][d[k].col].isMoveSel=!0;a.toggleEmbark();return!0};this.upgradeUnit=function(g,k,b){var f=null;if(null==(f=this.getUnitById(g))||!f.player.upgradeUnit(f,k,b))return!1;d.unit=null;a[f.eqid]=f.getIcon();null!==f.transport&&(a[f.transport.eqid]=f.transport.icon);return!0};this.disbandUnit=function(a){var k=null;if(null==(k=this.getUnitById(a)))return!1;k.destroyed=!0;k.nodossier=!0;d.unit=null;k.player.sellUnit(k);this.delCurrentUnit();this.updateUnitList();
return!0};this.deployPlayerUnit=function(a,d,k,b){if(!a)return!1;a=a.getCoreUnitList();if(0>d||d>=a.length)return!1;d=a[d];if(null===d||d.isDeployed)return!1;k=this.map[k][b];if((b=GameRules.isAir(d))&&null!==k.airunit||!b&&null!==k.unit)return!1;b||k.terrain!=terrainType.Ocean||d.embark(unitClass.navalTransport);k.setUnit(d);this.addUnit(d);return!0};this.deployNewUnitByEqId=function(a,d,k,b){a=new Unit(a);a.owner=b;this.map[d][k].setUnit(a);this.addUnit(a)};this.deployReinforcement=function(a,d,
k){if(!a)return null;d=GameRules.getReinforcementDeployPositions(this.map,a,d,k);if(null===d)return null;this.map[d.row][d.col].setUnit(a);this.addUnit(a);return d};this.selectUnit=function(a){if(null===a||a.player.id!=this.currentPlayer.id)return!1;this.delCurrentUnit();this.delMoveSel();this.delAttackSel();this.setCurrentUnit(a);0>a.carrier&&(a.carrier=-a.carrier,this.disembarkUnit(a));!a.hasMoved&&0<=a.carrier&&this.setMoveRange(a);a.hasFired||this.setAttackRange(a);return!0};this.buildCoreUnitList=
function(a){var d;for(d=0;d<l.length;d++)l[d].player.id==a.id&&l[d].getHex().isDeployment==a.id&&a.addCoreUnit(l[d])};this.restoreCoreUnitList=function(a,d){var k,b;for(k=0;k<l.length;k++)l[k].isCore&&l[k].isDeployed&&a.addCoreUnit(l[k]);for(k=0;k<d.length;k++)d[k].isDeployed||(b=new Unit(d[k].eqid),b.copy(d[k]),a.addCoreUnit(b))};this.removeNonCampaignUnits=function(a){var d,k,b=!1;for(d=0;d<l.length;d++)l[d].player.id!=a.id||l[d].isCore||(k=l[d].getHex())&&k.isDeployment==a.id&&(k.delUnit(l[d]),
l[d].destroyed=!0,b=l[d].nodossier=!0);b&&this.updateUnitList()};this.canUndoMove=function(a){return null!==d.unit&&d.unit.id==a.id?!0:!1};this.undoLastMove=function(){if(null!=d.unit){var a=d.unit,k=d.savedUnit,b=a.getPos(),f=k.getPos(),b=this.map[b.row][b.col],f=this.map[f.row][f.col];a.copy(k);GameRules.setZOCRange(this.map,a,!1,this.rows,this.cols);GameRules.setSpotRange(this.map,a,!1,this.rows,this.cols);b.delUnit(a);f.setUnit(a);GameRules.setZOCRange(this.map,a,!0,this.rows,this.cols);GameRules.setSpotRange(this.map,
a,!0,this.rows,this.cols);this.selectUnit(a);a=this.getPlayer(a.player.id);null!==d.oldOwner&&(b.owner=d.oldOwner);null!==d.oldFlag&&(b.flag=d.oldFlag);null!==d.oldVictorySide&&(this.updateVictorySides(~a.side&1,b.getPos()),b.victorySide=d.oldVictorySide);a.prestige-=d.prestigeGain;a.updateScore(-d.scoreGain);d.clear()}};this.captureHex=function(a,k){var b={isWin:!1,isCapture:!1},f=0,l=1,n=0,q=-1,y=k.player;if(-1==a.owner&&-1==a.flag)return b;-1!=a.owner&&(q=this.getPlayer(a.owner).side);if(q==y.side)return b;
d.oldOwner=a.owner;a.owner=y.id;Leaders.unitHasLeader(k,leaderType.liberator)&&(l=2);-1!=a.flag&&(d.oldFlag=a.flag,a.flag=y.country,-1==a.victorySide&&(f+=prestigeGains.flagCapture*l,n+=scoreGains.flagCapture,b.isCapture=!0));-1!=a.victorySide&&(d.oldVictorySide=a.victorySide,a.victorySide=~y.side&1,this.updateVictorySides(y.side,a.getPos())&&(b.isWin=!0),f+=prestigeGains.objectiveCapture*l,n+=scoreGains.objectiveCapture,b.isCapture=!0,CombatLog.addObjectiveCapture(a.getPos(),y.side));d.prestigeGain=
f;d.scoreGain=n;y.prestige+=f;y.updateScore(n);return b};this.getDeployHexes=function(a){for(var d=[],k=0;k<this.rows;k++)for(var b=0;b<this.cols;b++){var f=this.map[k][b].isDeployment;-1<f&&this.getPlayer(f).side==a&&d.push(this.map[k][b].getPos())}return d};this.copy=function(a){if(null!==a){this.rows=a.rows;this.cols=a.cols;this.terrainImage=a.terrainImage;this.name=a.name;this.turn=a.turn;this.maxTurns=a.maxTurns;this.allocMap();for(var d=0;d<a.rows;d++)for(var k=0;k<a.cols;k++){var b=a.map[d][k],
f=this.map[d][k];if(0!==Object.keys(b).length){f.copy(b);if(null!==b.unit){var l=new Unit(b.unit.eqid);l.copy(b.unit);f.setUnit(l)}null!==b.airunit&&(l=new Unit(b.airunit.eqid),l.copy(b.airunit),f.setUnit(l))}this.setHex(d,k)}this.sidesVictoryHexes=[[],[]];for(d=0;d<a.sidesVictoryHexes[0].length;d++)this.sidesVictoryHexes[0].push(a.sidesVictoryHexes[0][d]);for(d=0;d<a.sidesVictoryHexes[1].length;d++)this.sidesVictoryHexes[1].push(a.sidesVictoryHexes[1][d]);for(d=0;d<a.victoryTurns.length;d++)this.victoryTurns.push(a.victoryTurns[d])}};
this.cleanup=function(){for(var a=0;a<this.rows;a++)for(var d=0;d<this.cols;d++)this.map[a][d].cleanup(),delete this.map[a][d];this.map=null};this.dumpMap=function(){for(var a=0;a<n.length;a++);};var d={unit:null,savedUnit:null,oldOwner:null,oldFlag:null,oldVictorySide:null,prestigeGain:0,scoreGain:0,clear:function(){this.oldVictorySide=this.oldOwner=this.oldFlag=this.unit=this.savedUnit=null;this.scoreGain=this.prestigeGain=0}}};function ScenarioLoader(){function a(a){var g;if(!(g=null==a)){if(g=a.getElementsByTagName("map")[0]){var f=+g.getAttribute("rows"),n=+g.getAttribute("cols"),p=g.getAttribute("eqp"),r=1;game&&game.campaign&&(r=difficultyModifiers[game.campaign.difficulty].extraTurns);k.map.rows=f;k.map.cols=n;p&&(k.eqp=p,Equipment.name=p);k.map.victoryTurns=g.getAttribute("turns").split(", ");for(f=0;f<k.map.victoryTurns.length;f++)k.map.victoryTurns[f]=+k.map.victoryTurns[f];k.map.victoryTurns[2]=Math.round(k.map.victoryTurns[2]*
r);k.map.maxTurns=k.map.victoryTurns[2];k.maxTurns=k.map.victoryTurns[2];k.date.setTime(Date.parse(g.getAttribute("date")));k.atmosferic=+g.getAttribute("atmosferic");k.latitude=+g.getAttribute("latitude");k.ground=+g.getAttribute("ground");k.turnsPerDay=+g.getAttribute("dayturns")||1;k.turnsPerDay*=2;k.map.terrainImage=g.getAttribute("image");l(a);a=!0}else a=!1;g=!a}g&&b()}function b(){k.isLoaded=!1;k.onLoadFinished()}function f(a,g){if(!--Equipment.equipmentToLoad){for(var b=0;b<a.length;b++){var f=
new Player;f.copy(a[b]);k.map.addPlayer(f)}if(b=g.getElementsByTagName("reinforce"))for(var l=0;l<b.length;l++)if(null!==(f=+b[l].getAttribute("turn")))for(var r=0;r<b[l].childNodes.length;r++)if("at"==b[l].childNodes[r].nodeName){var s=b[l].childNodes[r],q=+s.getAttribute("row"),y=+s.getAttribute("col");if(null!=q&&null!=y)for(var I=0;I<s.childNodes.length;I++)"unit"==s.childNodes[I].nodeName&&(u=n(s.childNodes[I]),null!==u&&k.addReinforcement(f,q,y,u))}if(b=g.getElementsByTagName("hex"))for(q=f=
null,s=0;s<b.length;s++)if(l=+b[s].getAttribute("row"),r=+b[s].getAttribute("col"),!(l>=k.map.rows||r>=k.map.cols)&&(f=k.map.map[l][r])&&"undefined"!==typeof f){null!==(q=b[s].getAttribute("terrain"))&&(f.terrain=+q);null!==(q=b[s].getAttribute("road"))&&(f.road=+q);null!==(q=b[s].getAttribute("name"))&&(f.name=q);null!==(q=b[s].getAttribute("flag"))&&(f.flag=+q);null!==(q=b[s].getAttribute("owner"))&&(f.owner=+q);null!==(q=b[s].getAttribute("victory"))&&(f.victorySide=+q);null!==(q=b[s].getAttribute("deploy"))&&
(f.isDeployment=+q);null!==(q=b[s].getAttribute("supply"))&&-1==f.isDeployment&&(f.isDeployment=+q);for(y=0;y<b[s].childNodes.length;y++)"unit"==b[s].childNodes[y].nodeName&&(q=n(b[s].childNodes[y]),null!==q&&f.setUnit(q));k.map.setHex(l,r)}k.isLoaded=!0;k.onLoadFinished()}}function l(a){var g=new Image;g.src=k.map.terrainImage;g.onload=function(b){b=k.map.rows;for(var l=k.map.cols,p=g.width,r=1,n=g.height/50,q=!1,y=!1;30<=p;)p=r%2?p-60:p-30,r++;var q=0>p,p=n,I=n-Math.floor(n);0.39<=I&&0.8>I?(y=!0,
p=Math.ceil(n)):0.8<=I?(y=!1,p=Math.ceil(n)):0.39>I&&(y=!1,p=Math.floor(n));0<p&&(b>p||0==b)&&(b=p);0<r&&(l>r||0==l)&&(l=r);k.map.rows=b;k.map.cols=l;k.map.isLastColPartial=q;k.map.isLastRowPartial=y;k.map.allocMap();b=a.getElementsByTagName("player");l=[];r=0;game&&game.campaign&&(r=Math.round(game.campaign.startprestige*difficultyModifiers[game.campaign.difficulty].turnPrestige));if(b)for(n=0;n<b.length;n++){q=new Player;q.id=+b[n].getAttribute("id");q.side=+b[n].getAttribute("side");q.country=
+b[n].getAttribute("country");q.airTransports=+b[n].getAttribute("airtrans");q.navalTransports=+b[n].getAttribute("navaltrans");q.prestigePerTurn=b[n].getAttribute("turnprestige").split(", ");for(y=0;y<q.prestigePerTurn.length;y++)p=+q.prestigePerTurn[y],q.prestigePerTurn[y]=p,p<r&&(q.prestigePerTurn[y]=r);q.prestige=q.prestigePerTurn[0];q.supportCountries=[];p=b[n].getAttribute("support").split(", ");for(y=0;y<p.length;y++)0<+p[y]&&q.supportCountries.push(+p[y]);l.push(q)}Equipment.addPlayersEquipment(l,
f.bind(null,l,a))};g.onerror=b}function n(a){var g=+a.getAttribute("id"),b=+a.getAttribute("owner"),f=null,l;return 0<=g&&0<=b?(f=new Unit(g),f.owner=b>>0,null!==(g=a.getAttribute("face"))&&(f.facing=+g),null!==(g=a.getAttribute("flag"))&&(f.flag=+g),null!==(l=a.getAttribute("transport"))&&f.setTransport(+l),null!==(l=a.getAttribute("carrier"))&&(f.carrier=+l),null!==(l=a.getAttribute("exp"))&&(f.experience=+l),null!==(l=a.getAttribute("ent"))&&(f.entrenchment=+l),null!==(l=a.getAttribute("str"))&&
(f.strength=+l),null!==a.getAttribute("ldr")&&(f.leader=Leaders.generateLeader(f)),a=f,GameRules.isSea(a)||(l=k.map.getPlayer(a.owner).side,a.unitData(!0),k.unitsCostPerSide[l]+=GameRules.calculateUnitCosts(a.eqid,a.transport?a.transport.eqid:null),k.expPerSide[l].exp+=a.experience,k.expPerSide[l].count++),f):null}var k=null;this.noCache=!0;this.loadScenario=function(d){var g=new XMLHttpRequest;k=d;d=Scenario.scenarioPath+k.file;this.noCache&&(d+="?_="+(new Date).getTime());g.onload=function(){4===
g.readyState&&(200===g.status||0===g.status?a(g.responseXML):a(null))};g.open("GET",d,!0);g.send(null)}};function Render(a){function b(a){var b=0,k=0,m=a.unit,l=a.moveResults.passedCells,q,p,n,r,x,s,K,v=!0;this.movTimer=null;this.delay=uiSettings.quickAnimation?5:30;this.directDraw=function(a,d){T.clearRect(a.x-20,a.y-20,80,70);a.x+=x;a.y+=s;g(T,a.x,a.y,d,!1)};this.cssDraw=function(a,g,b){b&&(X.clearRect(0,0,X.canvas.width,X.canvas.height),d(X,-ba,-ca,g),"none"==C.style.display&&(C.style.display="inline"));a.x+=x;a.y+=s;uiSettings.use3D?(a="translate3d("+1*(a.x+ba)+"px, "+1*(a.y+ca)+"px, 0)","linear"!=
C.style.transition&&(C.style.MozTransition="linear",C.style.webkitTransition="linear",C.style.transition="linear"),C.style.MozTransform=a,C.style.webkitTransform=a,C.style.transform=a):(C.style.top=a.y+ca+"px",C.style.left=a.x+ba+"px")};this.start=function(){b>=l.length-1?(b=k=0,clearInterval(this.movTimer),m.hasAnimation=!1,C.style.display="none",a.cbfunc(a)):(0==k&&(n=l[b],r=l[b+1],q=f(n.row,n.col),p=f(r.row,r.col),x=(p.x-q.x)/5>>0,s=(p.y-q.y)/5>>0,K=GameRules.getDirection(n.row,n.col,r.row,r.col),
1<Math.abs(K-m.facing)&&(m.facing=K,v=!0)),l[b].isVisible&&this.cssDraw(q,m,v),v=!1,k++,5<=k&&(b++,k=0))}}function f(a,d,g){a=d&1?2*a*v+v+ca:2*a*v+ca;d=d*(S+Y)+Y+ba;g&&(g=$("game"),d+=V-g.clientLeft-g.offsetLeft,a+=aa-g.clientTop-g.offsetTop,d*=uiSettings.zoomLevel,a*=uiSettings.zoomLevel);return new screenPos(d,a)}function l(){var a=!1,d=!1,g=0,b=0;V=window.innerWidth/2-y.width/2;0>V&&(V=0);w.style.cssText+="z-index: 0; position:absolute; left: 0px; top: 0px;";N.style.cssText+="z-index: 1; position:absolute; left: 0px; top: 0px;";
z.style.cssText+="z-index: 2; position:absolute; left: 0px; top: 0px;";C.style.cssText+="z-index: 3; position:absolute; left: 0px; top: 0px;";C.style.display="none";w.style.cssText+="background-color: none; background-image:url('"+y.src+"');background-size:"+y.width+"px "+y.height+"px;background-repeat: no-repeat;background-attachment: scroll;";window.innerWidth>=y.width?a=!0:g=10;window.innerHeight>=y.height+aa?d=!0:b=30;a?$("game").style.width=y.width+b+"px":$("game").style.width=window.innerWidth+
"px";d?$("game").style.height=y.height+aa+g+"px":$("game").style.height=window.innerHeight-aa+"px";$("game").style.cssText+="position:absolute;left:"+V+"px;top:"+aa+"px;";$("game").tabIndex=1;$("game").focus()}function n(a,d,g){var b=P.canvas.width,k=P.canvas.height;if(!a||!d)return null;var f=a.flag-1,m=d.flag-1;a=GameRules.calculateCombatResults(a,d,p.getUnits(),!1,!0);P.clearRect(0,0,b,k);P.drawImage(s,b/2-s.width/2,k/2-s.height/2);P.drawImage(q,A*f,0,A,O,0,0,A,O);P.drawImage(q,A*m,0,A,O,b-A,0,
A,O);P.font=R+"px coreUnitFont, sans-serif";P.fillStyle="yellow";P.textBaseline="top";k=A/2-4;f=O;P.strokeText(a.losses,k+1,f+1);P.fillText(a.losses,k,f);k=b-A/2-4;P.strokeText(a.kills,k+1,f+1);P.fillText(a.kills,k,f);if(g)return H.toDataURL();g=document.createElement("canvas");g.width=H.width;g.height=H.height;g.getContext("2d").drawImage(H,0,0);return g}function k(a,d){var g=0,b=Object.keys(a).length,k=!1,f;for(f in a)"undefined"!==typeof r[a[f]]?g++:(k=!0,r[a[f]]=new Image,r[a[f]].onload=function(){g++;
g==b&&d&&d()},r[a[f]].src=a[f]);k||d&&d()}function d(a,d,g,b){if(null===b)return!1;var k=null,k=b.hasAnimation||p.currentUnit&&p.currentUnit.id==b.id||!GameRules.isGround(b)||!GameRules.isBridgeForSide(b.getHex(),b.player.side)?r[b.getIcon()]:L;if(!k)return!1;var f=!1,m=k.width/9,l=k.height;d=d-m/2+S/2>>0;g=g-l/2+v-R>>0;b=b.facing;8<b&&(b=16-b,f=!0);b*=m;if(f){var q=d+m/2;a.save();a.translate(q,0);a.scale(-1,1);a.translate(-q,0)}a.drawImage(k,b,0,m,l,d,g,m,l);f&&a.restore();return!0}function g(a,
g,b,k,f){if(d(a,g,b,k)&&f&&!(1>k.strength)){f=!0;null===game.campaign||k.isCore||(f=!1);a.font=f?R+"px coreUnitFont, sans-serif":R+"px unitInfo, sans-serif";var m=""+k.strength,l=g+Y/2>>0,q=b+2*v-(R+4),ba=1,n=k.player.side,r=19;10>k.strength&&(r=12,ba=2);a.fillStyle=1==n?unitstyle.alliedBox:unitstyle.axisBox;uiSettings.markEnemyUnits&&n!=game.spotSide&&(a.fillStyle=unitstyle.enemyBoxMarked);f&&(a.strokeStyle=1==n?unitstyle.alliedBorder:unitstyle.axisBorder,a.lineWidth=2,a.strokeRect(l,q-1,r,R+4));
a.fillRect(l,q-1,r,R+4);a.fillStyle=k.player.id!=p.currentPlayer.id&&k.player.side==p.currentPlayer.side?unitstyle.alliedPlayerText:unitstyle.playerText;k.hasMoved&&k.player.id==p.currentPlayer.id&&(a.fillStyle=unitstyle.movedUnitText);a.fillText(m,l+ba,q+9);!k.hasFired&&(GameRules.unitUsesAmmo(k)&&n==p.currentPlayer.side)&&(0<k.getAmmo()?a.drawImage(I,g-4,b+2*v-12):a.drawImage(J,g-4,b+2*v-12));-1!=k.leader&&a.drawImage(1==n?M:G,l+r+1,b+2*v-13)}}function m(a,d,g,b,k){a.beginPath();a.moveTo(d,g);a.lineTo(d+
S,g);a.lineTo(d+S+Y,g+v);a.lineTo(d+S,g+2*v);a.lineTo(d,g+2*v);a.lineTo(d-Y,g+v);null!==b.fillColor&&(a.fillStyle=b.fillColor,a.fill());a.closePath();0<b.lineWidth&&(a.lineWidth=b.lineWidth,a.lineJoin=b.lineJoin,a.strokeStyle=b.lineColor,b.hasOwnProperty("shadowColor")?(a.shadowOffsetX=b.shadowOffsetX,a.shadowOffsetY=b.shadowOffsetY,a.shadowColor=b.shadowColor):(a.shadowOffsetX=null,a.shadowOffsetY=null,a.shadowColor=null),a.stroke());if(uiSettings.showGridTerrain&&"undefined"!==typeof k&&k!=terrainType.Clear){var f=
d+Y+Y/2-2>>0,m=g+2*v-12;a.font="24px openpanzer, sans-serif";a.strokeStyle=unitstyle.terrainTextStroke;a.lineWidth=1;a.strokeText(terrainencoding[k],f-1,m-1);a.fillStyle=unitstyle.terrainText;a.fillText(terrainencoding[k],f,m)}b===hexstyle.deploy&&(f=d+4>>0,m=g+2*v-12,a.font="24px openpanzer, sans-serif",a.strokeStyle=unitstyle.terrainTextStroke,a.lineWidth=1,a.strokeText("Z",f-1,m-1),a.fillStyle=unitstyle.terrainText,a.fillText("Z",f,m));uiSettings.showGridTerrain&&b===hexstyle.move&&(m=g+2*v-12,
a.font="26px openpanzer-menu, sans-serif",a.strokeStyle=unitstyle.terrainText,a.lineWidth=1,a.strokeText("'",(d+4>>0)-1,m-1))}function x(a,d,g){var b={srow:0,scol:0,erow:p.rows,ecol:p.cols};if(null===a||null===d)a=d=0;null!==g&&0<=g&&(b.srow=a-g,b.scol=d-g,b.erow=a+g,b.ecol=d+g,0>b.srow&&(b.srow=0),0>b.scol&&(b.scol=0),b.erow>p.rows&&(b.erow=p.rows),b.ecol>p.cols&&(b.ecol=p.cols));return b}var p=a,r={},s=null,q=null,y=null,I=null,J=null,L=null,G=null,M=null,F=!1,Q=null,U=null,E=null,N,w,z,H,C,B=null,
W=null,T=null,P=null,X=null,S=30,Y=S/2,v=25,A=21,O=14,V=0,aa=30,ba=-(S+Y),ca=-v,K=S+Y,Z=S/100,R=8,ea=new AnimationChain;null===(w=$("map"))&&(w=addTag("game","canvas"));w.id="map";null===(N=$("hexes"))&&(N=addTag("game","canvas"));N.id="hexes";null===(z=$("cursor"))&&(z=addTag("game","canvas"));z.id="cursor";H=addTag(null,"canvas");H.id="backbuffer";null===(C=$("unitbackbuffer"))&&(C=addTag("game","canvas"));C.id="unitbackbuffer";W=w.getContext("2d");B=N.getContext("2d");T=z.getContext("2d");P=H.getContext("2d");
X=C.getContext("2d");H.width=H.height=54;C.width=C.height=120;this.render=function(a,d,b){var k,l,r=x(a,d,b+1);a=x(a,d,b+2);var s,K=d=null;b=!1;uiSettings.hexGrid!=F&&(F=b=uiSettings.hexGrid,W.clearRect(0,0,y.width,y.height+65));null!==p.currentUnit&&(d=p.currentUnit.getPos());var R=f(r.srow,r.scol,!1),r=f(r.erow,r.ecol,!1);B.clearRect(R.x,R.y,r.x-R.x,r.y-R.y);for(r=a.srow;r<a.erow;r++)for(R=a.scol;R<a.ecol;R++)if(s=p.map[r][R],l=R&1?2*r*v+v+ca:2*r*v+ca,k=R*(S+Y)+Y+ba,null!==d&&("undefined"!==typeof d&&
r==d.row&&R==d.col)&&(m(B,k,l,hexstyle.currentstroke),m(B,k,l,hexstyle.current)),uiSettings.deployMode&&-1<s.isDeployment&&p.getPlayer(s.isDeployment).side==p.currentPlayer.side&&m(B,k,l,hexstyle.deploy),uiSettings.strategicZoom){k=k+(S-Y)/2-A/2>>0;l=l+v-O-2>>0;var K=-1,Z=0,w=null;B.save();s.isSpotted(p.currentPlayer.side)&&(w=uiSettings.airMode?s.airunit:s.unit,null!==w&&(K=w.player.country,Z=1.4,w.hasMoved&&(B.globalAlpha=0.6)));-1!=s.flag&&-1!=s.victorySide&&(K=s.flag,Z=3);-1!=K&&(B.drawImage(q,
A*K,0,A,O,k,l,Z*S,Z*S/(A/O)),B.restore())}else{if(uiSettings.showHiddenVictoryHexes){var K=k+S/2-A/2>>0,Z=l+2*v-O-2>>0,w=2,z=s.flag;-1!=s.victorySide&&(-1==z&&-1!=s.owner&&(z=p.getPlayer(s.owner).country,w=6),B.beginPath(),B.lineWidth=w,B.strokeStyle="rgba(139,0,0,1)",B.strokeRect(K-1,Z-1,A+2,O+2),B.strokeStyle="rgba(127,255,0,1)",B.strokeRect(K-3,Z-3,A+6,O+6),B.strokeStyle="rgba(0,0,0,1)",B.lineWidth=1,B.strokeRect(K-4,Z-4,A+8,O+8),B.closePath());-1!=z&&B.drawImage(q,A*z,0,A,O,K,Z,A,O)}else K=s,
-1!=K.flag&&(Z=k+S/2-A/2>>0,w=l+2*v-O-2>>0,B.drawImage(q,A*K.flag,0,A,O,Z,w,A,O),-1!=K.victorySide&&(B.beginPath(),B.lineWidth=2,B.strokeStyle="rgba(139,0,0,1)",B.strokeRect(Z-1,w-1,A+2,O+2),B.strokeStyle="rgba(127,255,0,1)",B.strokeRect(Z-3,w-3,A+6,O+6),B.strokeStyle="rgba(0,0,0,1)",B.lineWidth=1,B.strokeRect(Z-4,w-4,A+8,O+8),B.closePath()));b&&m(W,k,l,hexstyle.generic,s.terrain);K=s.getUnit(!uiSettings.airMode);null===K||(K.hasAnimation||!s.isSpotted(game.spotSide)&&!K.tempSpotted&&K.player.side!=
game.spotSide)||(uiSettings.markOwnUnits&&K.player.id==p.currentPlayer.id&&m(B,k,l,hexstyle.ownunit),g(B,k,l,K,!1));K=s.getUnit(uiSettings.airMode);null===K||(K.hasAnimation||!s.isSpotted(game.spotSide)&&!K.tempSpotted&&K.player.side!=game.spotSide)||(uiSettings.airMode&&null!==s.airunit&&m(B,k,l,hexstyle.airunit),g(B,k,l,K,!0));uiSettings.deployMode||p.currentPlayer.side!=game.spotSide||(s.isMoveSel&&(s.isSpotted(p.currentPlayer.side)?m(B,k,l,hexstyle.movespotted):m(B,k,l,hexstyle.move)),s.isAttackSel&&
m(B,k,l,hexstyle.attack));uiSettings.hasTouch&&(s.isAttackSel&&p.currentUnit)&&(k-=S/2,K=p.currentUnit,s=s.getAttackableUnit(K,uiSettings.airMode),B.drawImage(n(K,s,!1),k,l))}};this.drawCursor=function(a){var d=a.row,b=a.col,g=p.map[d][b],k=P.canvas.width,f=P.canvas.height,m=!1;E!==p.currentUnit&&(m=!0);if(g.isAttackSel&&null!==p.currentUnit&&!p.currentUnit.hasFired){if(!0==m||null===Q||null===U||Q.row!=d||Q.col!=b)m=!0,d=p.currentUnit,g=g.getAttackableUnit(d,uiSettings.airMode),E=d,Q=a,U=n(d,g,!0);
if("default"==z.style.cursor||"pointer"==z.style.cursor||"auto"==z.style.cursor||!0==m)z.style.cursor="url('"+U+"') "+k/2+" "+f/2+", auto"}else z.style.cursor="default"};this.drawHexByCell=function(a,d){var b=f(a.row,a.col,!1);m(B,b.x,b.y,d)};this.runAnimation=function(a){ea.start(a)};this.addAnimation=function(a,d,b,g){if(!(b in animationsData))return!1;"undefined"===typeof g&&(g=direction.N);b=animationsData[b];a=f(a,d);ea.add({ctx:T,x:a.x-b.width/2+S/2>>0,y:a.y-b.image.height/2+v>>0,rotate:directionToRadians[g],
sprite:b});return!0};this.moveAnimation=function(a){if(null!==a.unit){var d=new b(a);d.movTimer=setInterval(function(){d.start()},d.delay)}};this.screenToCell=function(a,d){var b,g;uiSettings.mapZoom&&(a/=uiSettings.zoomLevel,d/=uiSettings.zoomLevel);uiSettings.strategicZoom&&(a*=uiSettings.strategicZoomLevel,d*=uiSettings.strategicZoomLevel);g=Math.round((a-ba)/K+Z)-1;b=(d-ca*(~g&1))/v;b=Math.round(b/2-1*(b&1));0>b&&(b=0);b>p.rows-1&&(b=p.rows-1);g>p.cols-1&&(g=p.cols-1);return new Cell(b,g)};this.cellToScreen=
function(a,d,b){return f(a,d,b)};this.cacheImages=function(a){s||(s=new Image,s.src="resources/ui/cursors/attack.png");q||(q=new Image,q.src="resources/ui/flags/"+Equipment.name+"/flags_med.png");I||(I=new Image,I.src="resources/ui/indicators/unit-fire.png");J||(J=new Image,J.src="resources/ui/indicators/unit-fire-no-ammo.png");G||(G=new Image,G.src="resources/ui/indicators/unit-leader-axis.png");M||(M=new Image,M.src="resources/ui/indicators/unit-leader-allied.png");L||(L=new Image,L.src="resources/units/images/bridg.png");
y||(y=new Image,y.src=p.terrainImage,y.onload=function(){w.width=N.width=z.width=y.width;w.height=N.height=z.height=y.height+65;w.style.cssText=N.style.cssText=z.style.cssText="";w.style.width=N.style.width=z.style.width=y.width+"px";w.style.height=N.style.height=z.style.height=y.height+65+"px";W.imageSmoothingEnabled=!1;W.webkitImageSmoothingEnabled=!1;W.mozImageSmoothingEnabled=!1;B.imageSmoothingEnabled=!1;B.webkitImageSmoothingEnabled=!1;B.mozImageSmoothingEnabled=!1;T.imageSmoothingEnabled=!1;
T.webkitImageSmoothingEnabled=!1;T.mozImageSmoothingEnabled=!1;X.imageSmoothingEnabled=!1;X.webkitImageSmoothingEnabled=!1;X.mozImageSmoothingEnabled=!1;l();a()},y.onerror=function(){UIBuilder.message("Error",OSGlue.canvasErrorMsg)});k(p.getUnitImagesList(),a)};this.getHexesCanvas=function(){return N};this.getMapCanvas=function(){return w};this.getCursorCanvas=function(){return z};this.setNewMap=function(a){p=a;F=!1;q=y=null;a=p.getUnitImagesList();for(var d in r)"undefined"===typeof a[r[d]]&&(r[d]=
null,delete r[d])};this.positionLayers=function(){return l()}};Scenario.loader=new ScenarioLoader;Scenario.scenarioPath="resources/scenarios/data/";Scenario.getScenarioDataByFileName=function(a){for(var b=0;b<scenariolist.length;b++)if(scenariolist[b][0]==a)return scenariolist[b];return null};
function Scenario(a){this.name="";this.maxTurns=0;this.date=new Date;this.ground=this.latitude=this.atmosferic=0;this.turnsPerDay=1;this.dayTurn=0;this.reinforcements={};this.map=new Map;this.file=a;this.expPerSide=[{exp:0,count:0},{exp:0,count:0}];this.unitsCostPerSide=[0,0];this.isLoaded=!1;this.eqp="eqp-adlerkorps";var b="",f=null;"undefined"!==typeof a&&(a=Scenario.getScenarioDataByFileName(a))&&(this.name=a[1],b=a[2]);this.load=function(a){f=a;Scenario.loader.loadScenario(this)};this.onLoadFinished=
function(){if(this.isLoaded){this.setMoveTable();for(var a=this.map,b={},k=a.getPlayers(),d=0;d<k.length;d++)b[k[d].id]=a.sidesVictoryHexes[k[d].side].length*scoreGains.objectivePerTurn/a.maxTurns>>0;a=a.getUnits();for(d=0;d<a.length;d++)b[a[d].player.id]+=a[d].isCore?scoreGains.coreUnit:scoreGains.normalUnit;for(d=0;d<k.length;d++)k[d].updateScore(b[k[d].id])}f&&f()};this.addReinforcement=function(a,b,k,d){if(null===this.reinforcements[a]||"undefined"===typeof this.reinforcements[a])this.reinforcements[a]=
[];this.reinforcements[a].push({row:b,col:k,unit:d,turn:a,id:this.reinforcements[a].length+1})};this.getReinforcements=function(a,b){var k=[],d;for(d in this.reinforcements)if(!(d>a)&&null!==this.reinforcements[d]&&"undefined"!==typeof this.reinforcements[d])for(var g=0;g<this.reinforcements[d].length;g++)this.reinforcements[d][g].unit.owner==b&&k.push(this.reinforcements[d][g]);return k};this.removeReinforcement=function(a,b){if(null===this.reinforcements[a]||"undefined"===typeof this.reinforcements[a])return!1;
for(var k=0;k<this.reinforcements[a].length;k++)if(this.reinforcements[a][k].id==b)return this.reinforcements[a].splice(k,1),!0;return!1};this.checkDefeat=function(a,b){if(this.map.turn>=this.map.maxTurns&&(a==b||2==b)){var k;a:{k=this.map.getPlayers();for(var d=0;d<k.length;d++)if(k[d].side==a&&k[d].playedTurn<this.map.maxTurns){k=!1;break a}k=!0}if(k)return!0}return!1};this.checkVictory=function(){return this.map.turn<=this.map.victoryTurns[0]?"briliant":this.map.turn<=this.map.victoryTurns[1]?
"victory":this.map.turn<=this.map.victoryTurns[2]?"tactical":"lose"};this.getDescription=function(){return b};this.setDescription=function(a){b=a};this.endTurn=function(){this.dayTurn++;this.dayTurn>=this.turnsPerDay&&(this.dayTurn=0,this.date.setDate(this.date.getDate()+1));this.map.endTurn()};this.setMoveTable=function(){switch(this.ground){case groundCondition.dry:movTable=movTableDry;break;case groundCondition.frozen:movTable=movTableFrozen;break;case groundCondition.mud:movTable=movTableMud;
break;default:movTable=movTableDry}};this.getPrototypeUnitsAvailable=function(a){var b=this.date.getFullYear()+1;a=Equipment.getCountryEquipmentByYearRange(b,b,a);for(b=0;b<a.length;b++){var k=Equipment.equipment[a[b]],d=k.uclass;if((d<unitClass.tank||d>unitClass.antiTank)&&(d<unitClass.artillery||d>unitClass.tacticalBomber)||k.cost*CURRENCY_MULTIPLIER<PROTOTYPE_MIN_COST)a.splice(b,1),b--}return a};this.getRandomPrototype=function(a){a=this.getPrototypeUnitsAvailable(a);var b=Math.random()*a.length>>
0;return a[b]};this.getBalancedPrestige=function(a){a=SCENARIO_START_PRESTIGE+this.unitsCostPerSide[+!a]-this.unitsCostPerSide[a];a<SCENARIO_START_PRESTIGE&&(a=SCENARIO_START_PRESTIGE);return a};this.getSideUnitsAvgExp=function(a){return Math.round(this.expPerSide[a].exp/+this.expPerSide[a].count||0)};this.showStatistics=function(){};this.copy=function(a){this.maxTurns=a.maxTurns;this.date=new Date(a.date);this.atmosferic=a.atmosferic;this.latitude=a.latitude;this.ground=a.ground;this.turnsPerDay=
a.turnsPerDay;this.eqp=a.eqp;if(a.reinforcements)for(t in a.reinforcements)for(var b=0;b<a.reinforcements[t].length;b++){var k=new Unit(a.reinforcements[t][b].unit.eqid);k.copy(a.reinforcements[t][b].unit);this.addReinforcement(t,a.reinforcements[t][b].row,a.reinforcements[t][b].col,k)}this.map.copy(a.map);this.file=a.file;this.setMoveTable()}};Campaign.findCampaignByFile=function(a){for(var b=0;b<campaignlist.length;b++)if(campaignlist[b].file===a)return b;return-1};
function Campaign(a,b,f){var l=campaignlist[a];this.startprestige=l.prestige+difficultyModifiers[b].startPrestige*l.prestige>>0;this.name=l.title;this.country=l.flag;this.file=l.file;this.id=a;this.difficulty=b;var n=0,k=null;this.isLoaded=!1;(function(a,b){if(null==a||"undefined"===typeof a)return null;var f=new XMLHttpRequest,l=function(){k=JSON.parse(f.responseText);this.isLoaded=!0;b()};f.onload=function(){4===f.readyState&&(200===f.status||0===f.status?l():b())};f.open("GET","resources/campaigns/data/"+
a,!0);f.send(null)})(l.file,f);this.setScenarioById=function(a){a<k.length&&(n=a)};this.setScenarioByName=function(a){var b;b=a.lastIndexOf("/");-1<b&&(a=a.substring(b+1));for(b=0;b<k.length;b++)if(k[b].scenario===a)return n=b,!0;return!1};this.getCurrentScenario=function(){return k[n]};this.loadNextScenario=function(a){a=k[n].outcome[a];return a.goto<k.length?(n=a.goto,k[a.goto]):null};this.getOutcomePrestige=function(a){return k[n].outcome[a].prestige};this.getOutcomeText=function(a){return k[n].outcome[a].text||
"Continue to the next phase."};this.getCampaignFlow=function(){for(var a="",b=0;b<k.length;b++)var f=this.getScenarioNameFromId(b),l=this.getScenarioNameFromId(k[b].outcome.lose.goto),p=this.getScenarioNameFromId(k[b].outcome.tactical.goto),r=this.getScenarioNameFromId(k[b].outcome.victory.goto),n=this.getScenarioNameFromId(k[b].outcome.briliant.goto),a=p==r&&r==n?a+("- <b>"+f+"</b><br/>&nbsp;&nbsp;&nbsp;&nbsp;Lose: "+l+"<br/>&nbsp;&nbsp;&nbsp;&nbsp;Victory: "+p+"<br/><br/>"):a+("- <b>"+f+"</b><br/>&nbsp;&nbsp;&nbsp;&nbsp;Lose: "+
l+"<br/>&nbsp;&nbsp;&nbsp;&nbsp;Tactical: "+p+"<br/>&nbsp;&nbsp;&nbsp;&nbsp;Victory: "+r+"<br/>&nbsp;&nbsp;&nbsp;&nbsp;Brilliant: "+n+"<br/><br/>");return a};this.getScenarioNameFromId=function(a){return 255==a?"Defeat (End Campaign)":254==a?"Victory (End Campaign)":Scenario.getScenarioDataByFileName(k[a].scenario)[1]};this.getCampaignData=function(){return k}};var UIBuilder=function(a){function b(b,d){if(b)return!1;var g=!1,f="(Scenario) ";null!==game.campaign&&(f="(Campaign) ");for(var f=f+(game.scenario.name+" Turn "+game.scenario.map.turn),l=0;l<uiSettings.lastCloudSave.length;l++)if(uiSettings.lastCloudSave[l].id==d){uiSettings.lastCloudSave[l].name=f;g=!0;break}g||(2<uiSettings.lastCloudSave.length&&uiSettings.lastCloudSave.shift(),uiSettings.lastCloudSave.push({name:f,id:d}));game.state.saveSettings();a.fillCloudSavesList();return!0}function f(){$("diskloaderror").textContent=
"Error loading game. Cannot parse save game data."}function l(){makeHidden("smState");makeHidden("smMain");$("diskloaderror").textContent="";game.ui.startMenuButton("continuegame")}a.startMenuImgPath="resources/ui/dialogs/startmenu/images/";a.menuImgPath="resources/ui/menu/images/";a.eqImgPath="resources/ui/dialogs/equipment/images/";a.currencyIcon="<img src='"+a.eqImgPath+"currency.png'/>";a.navalReplacementIcon="resources/units/images/le211.png";a.eqClassButtons={9:["*","Air defence"],4:["/","Anti-tank"],
8:[")","Artillery"],1:["(","Infantry"],3:["=","Recon"],2:["]","Tank"],10:["%","Air Fighter"],11:["4","Air Bomber"]};a.unitContextButtons={mount:"[",embark:"2",resupply:"!",reinforce:"#",overstrength:"J",undo:"_"};a.unitstats=[["uCost","Unit price",1,"cost","B",0],["uStr","Unit strength",0,null,":",0],["uFuel","Unit fuel",0,"fuel",";",0],["uAmmo","Unit Ammo",1,"ammo","<",0],["uGunRange","Firing range",1,"gunrange",">",0],["uMovement","Movement range",1,"movpoints","?",0],["uExp","Combat Experience",
0,null,"@",0],["uEnt","Entrenchment",0,null,'"',0],["uIni","Combat initiative",1,"initiative","|",0],["uSpot","Spotting range",1,"spotrange","'",0],["uAHard","Power vs Hard targets",1,"hardatk","{",0],["uASoft","Power vs Soft targets",1,"softatk","$",0],["uAAir","Power vs Air targets",1,"airatk","&",0],["uANaval","Power vs Naval targets",1,"navalatk","}",0],["uDHard","Defence vs ground attacker",1,"grounddef","5",0],["uDAir","Defence vs air attacker",1,"airdef","3",0],["uDClose","Defence in close combat",
1,"closeddef","6",0],["uDRange","Defence in ranged combat",1,"rangedefmod","7",0],["uMoveType","Movement type",0,null,"~",0],["uTarget","Target type",0,null,"`",0],["uLeader","See unit leader",0,null,null,1],["uTransport","See unit/transport",0,null,null,1],["uCarrier","See naval/air carrier",0,null,null,1],["uNext","Go to next unit",0,null,null,1],["uFlag","country flag",0,null,null,0]];a.smallToolTipList=[];var n=[["gameToolTip",null],["ui-message",null],["startmenu",null],["statusbar",0],["statusbar-extension",
25],["menu",null],["unit-context",-95],["unit-info",-70],["container-unitlist",30],["equipment",125],["combatLog",25],["combatLogButton",25],["statusBarButton",15],["unitsBarButton",95],["dossier",25],["uiToolTip",null]];a.flagStyleSheets=[];a.buildStartMenu=function(){var b=[["newgame","New Game"],["settings","Settings"],["saveload","Save / Load"],["continuegame","Continue Game"]],d=[["newcampaign","Campaigns","Lead your troops to victory over multiple scenarios. Troops gain experience and leaders which will carry over next scenarios. Campaign flow depends on how quickly player conquers all objectives. "],
["newscenario","Scenarios","Play a single scenario. Most scenarios are designed  for campaign mode, this mode is recommended for players that want to learn the specifics of scenarios or try different things. "],["tutorial","Tutorial","Learn the basic mechanics of the game. First turns are automatically played by the computer but later the control is given to the player."]],g=[[difficultyType.historical,"Historical",0],[difficultyType.tactical,"Tactical",1],[difficultyType.operational,"Operational",
0]],f=[["showGridTerrain","Show terrain with Hex Grid"],["quickAnimation","Quick combat and move animations"],["muteUnitSounds","Mute unit combat sounds"],["noFOW","Disable Fog of War"],["useRetina","Zoom to full device resolution"],["markOwnUnits","Mark own units on map"],["markEnemyUnits","Mark enemy strength in red"],["showDetailInfoToolTips","Show optional objectives tooltips"],["showHiddenVictoryHexes","Show hidden victory hexes"]],l,p;isDesktop()&&($("smClose").style.display="inline",$("smClose").onclick=
function(){nw.Window.get().close()});for(l=0;l<b.length;l++)p=addTag("smButtons","div"),p.id=b[l][0],p.title=b[l][1],p.className="smMainButton",p.textContent=b[l][1],p.onclick=function(){game.ui.startMenuButton(this.id)};for(l=0;l<d.length;l++)b=addTag("smNewGameContent","div"),b.className="newGameContainer",l<d.length-1&&(b.style.marginRight="15px"),p=addTag(b,"div"),p.id=d[l][0],p.title=d[l][1],p.className="smMainButtonLight",p.textContent=d[l][1],p.style.margin="0px auto",p.onclick=function(){game.ui.startMenuButton(this.id)};
$("smLogoText").innerHTML="version "+VERSION;$("smCredits").innerHTML="Copyright Nicu Pavel";l=addTag("smCampSel","select");for(d=0;d<campaignlist.length;d++)p=addTag(l,"option"),p.value=d,p.text=campaignlist[d].title;p=addTag($("smCampDif"),"select");p.id="smCampDifSel";p.style.fontSize="14px";p.style.fontWeight="normal";p.style.color="#f8e064";p.style.height="26px";for(d=0;d<g.length;d++)addSelectOption(p,g[d][1],g[d][0],g[d][2]);$("smCampDifHelp").onclick=function(){var a;a="Historical - Highest difficulty<br>Tactical - Medium difficulty +20% starting prestige, +10% starting prestige per turn, +20% extra turns, -20% score.<br>Operational - Lowest difficulty + 50% starting prestige, +25% starting prestige per turn, +50% extra turns. -50% score";
$("smCampDesc").innerHTML=a};l.onchange=function(){var d=this.options[this.selectedIndex].value;$("smCampDesc").innerHTML=campaignlist[d].desc;$("smCampCountry").innerHTML="<b>Country</b><br/>"+Equipment.getCountryNameByEqp(campaignlist[d].flag,campaignlist[d].eqp);$("smCampScenarios").innerHTML="<b>Scenarios</b><br/>"+campaignlist[d].scenarios;$("smCampPrestige").innerHTML="<b>Start prestige</b><br/>"+campaignlist[d].prestige+"&nbsp;"+a.currencyIcon;$("smCamp").selectedCampaign=d};$("smCBackBut").onclick=
function(){makeHidden("smCamp");makeVisible("smMain")};$("smCPlayBut").onclick=function(){var a=$("smCamp").selectedCampaign,d=$("smCampDifSel"),d=d.options[d.selectedIndex].value;a&&(game.newCampaign(a,d),makeHidden("gameToolTip"),makeHidden("smCamp"),makeHidden("startmenu"),toggleButton($("options"),!1),game.state.saveSettings())};$("smCFlowBut").onclick=function(){var a=$("smCamp").selectedCampaign,d=new Campaign(a,difficultyType.historical,function(){$("smCampDesc").innerHTML=d.getCampaignFlow()})};
DEBUG_CAMPAIGN&&($("smCV").onclick=function(){makeHidden("smCamp");makeHidden("startmenu");game.continueCampaign("victory")},$("smCVB").onclick=function(){makeHidden("smCamp");makeHidden("startmenu");game.continueCampaign("briliant")},$("smCVT").onclick=function(){makeHidden("smCamp");makeHidden("startmenu");game.continueCampaign("tactical")},$("smCL").onclick=function(){makeHidden("smCamp");makeHidden("startmenu");game.continueCampaign("lose")});g=addTag("smScenSel","select");for(d=0;d<scenariolist.length;d++)l=
addTag(g,"option"),1==scenariolist[d].length?(l.disabled=!0,l.text="\u00bb\u00a0"+scenariolist[d][0]):(l.value=d,l.text="\u00a0\u00a0\u00a0\u00a0"+scenariolist[d][1]);g.onchange=function(){var d=this.options[this.selectedIndex].value;$("smScenDesc").innerHTML=scenariolist[d][2];clearTag("smSide0");$("smVS").innerHTML="VS";clearTag("smSide1");a.setEquipmentFlags(scenariolist[d][5]);for(var b=0;1>=b;b++){var g=scenariolist[d][3+b],k="smSide"+b,f=addTag(k,"div");f.className="smSideHeader";f.innerHTML=
sideNames[b];addTag(f,"img").src=a.startMenuImgPath+"side"+b+".png";for(f=0;f<g.length;f++){var m=addTag(k,"div");m.className="smPlayerContainer";var l=addTag(m,"div");l.className="playerCountry";l.style.backgroundPosition=""+-21*g[f].country+"px 0px";l=addTag(m,"div");l.className="playerName";l.innerHTML=Equipment.getCountryNameByEqp(g[f].country,scenariolist[d][5]);m=addTag(m,"div");uiSettings.isAI[g[f].id]?(m.innerHTML="d",uiSettings.isAI[g[f].id]=1):m.innerHTML="D";m.id="ai"+g[f].id;m.playerid=
g[f].id;m.className="smallButton right";m.style.marginRight="5px";m.onclick=function(){uiSettings.isAI[this.playerid]=uiSettings.isAI[this.playerid]?0:1;toggleCheckbox(this)}}}$("smScen").selectedScenario=d};$("smSBackBut").onclick=function(){makeHidden("smScen");makeVisible("smMain");a.setEquipmentFlags(game.scenario.eqp)};$("smSPlayBut").onclick=function(){var a=$("smScen").selectedScenario;a&&(game.campaign=null,game.newScenario(scenariolist[a][0],scenariolist[a][2]),makeHidden("gameToolTip"),
makeHidden("smScen"),makeHidden("startmenu"),toggleButton($("options"),!1),game.state.saveSettings())};a.resizeUI(uiSettings.uiSize);a.scaleUI(uiSettings.uiScale);a.setLayoutConstrains(!1);b=addTag("smSettingsContainer","div");b.className="settingContainer left";p=addTag(b,"div");p.className="settingText left";p.textContent="Interface width (px)";p=addTag(b,"div");p.style.float="right";a.createSlider(p,"uiresize",uiSettings.uiSize,10,uiSettings.uiSmallSize,1920,function(){a.resizeUI($("uiresize").value)});
b=addTag("smSettingsContainer","div");b.className="settingContainer left";p=addTag(b,"div");p.className="settingText left";p.textContent="Interface scale";p=addTag(b,"div");p.style.float="right";a.createSlider(p,"uiscale",uiSettings.uiScale,0.1,0.5,3,function(){a.scaleUI($("uiscale").value)});b=addTag("smSettingsContainer","div");b.className="settingContainer left";p=addTag(b,"div");p.className="settingText left";p.textContent="Game Map scale";p=addTag(b,"div");p.style.float="right";a.createSlider(p,
"mapscale",uiSettings.zoomLevel,0.1,1,3,function(){game.ui.scaleMap($("mapscale").value)});for(l=0;l<f.length;l++)b=addTag("smSettingsContainer","div"),b.className="settingContainer left",p=addTag(b,"div"),p.title=f[l][1],p.className="settingText left",p.textContent=f[l][1],p=addTag(b,"div"),p.id=f[l][0],p.className="settingValue right",p.innerHTML=uiSettings[f[l][0]]?"C":"c",p.onclick=function(){uiSettings[this.id]=!uiSettings[this.id];toggleCheckbox(this);"useRetina"==this.id&&($("smSettings").needPageReload=
!0,1<=window.devicePixelRatio&&(uiSettings.useRetina&&1>=uiSettings.uiScale&&($("uiscale").value=1.6),!uiSettings.useRetina&&1.5<=uiSettings.uiScale&&($("uiscale").value=1)))};$("smSetOkBut").onclick=function(){makeHidden("smSettings");makeVisible("startmenu");a.resizeUI($("uiresize").value);a.scaleUI($("uiscale").value);game.state.saveSettings();$("smSettings").needPageReload&&location.reload(!0);$("smSettings").messageHidden&&makeVisible("ui-message")};a.buildGameStateMenu()};a.buildGameStateMenu=
function(){for(var b,d,g=[["disksave","Save to Disk <a id='savedata' hidden download='none'></a>"],["diskload",OSGlue.diskloadHTML],["cloudsave","Cloud Save"],["cloudload","Cloud Load"]],f=["<b>Last saved to disk</b> <div id='disksaveupdate'> none</div><hr>","<input type='text' id='cloudid' style='-webkit-user-select:text;' placeholder='Enter numeric ID to Load from Cloud'><br><b>Last known cloud saves</b><div class='hcenter blackBoxBorder' id='cloudid_lastsaves'></div><div id='diskloaderror' class='smStateDesc'></div>"],
l=0;l<g.length;l++)0==l%2&&(b=addTag("smState","div"),b.className="smCenter"),d=addTag(b,"div"),d.id=g[l][0],d.className="smMainButton",d.innerHTML=g[l][1],"diskload"==d.id?OSGlue.diskloadEvent(d,function(){a.gameStateButton("diskload")}):d.onclick=function(){a.gameStateButton(this.id)},1==l%2&&(d=addTag("smState","div"),d.className="smStateDesc",d.innerHTML=f[(l-1)/2]);a.fillCloudSavesList();$("smStOkBut").onclick=function(){makeHidden("smState");makeVisible("smMain");$("diskloaderror").textContent=
""}};a.fillCloudSavesList=function(){clearTag("cloudid_lastsaves");defined(uiSettings.lastCloudSave)&&0<uiSettings.lastCloudSave.length&&($("cloudid").value=uiSettings.lastCloudSave[uiSettings.lastCloudSave.length-1].id);for(var a=0;3>a;a++)div=addTag($("cloudid_lastsaves"),"div"),div.style.height="22px",defined(uiSettings.lastCloudSave)&&uiSettings.lastCloudSave.length>a?(div.textContent=uiSettings.lastCloudSave[a].name,div.cloudid=uiSettings.lastCloudSave[a].id,div.onclick=function(){$("cloudid").value=
this.cloudid}):(div.textContent="",div.onclick=function(){$("cloudid").value=""})};a.gameStateButton=function(a){switch(a){case "disksave":a=new Date;a=a.toDateString()+" "+a.toLocaleTimeString();var d;d=null!==game.campaign?"(Campaign) ":"(Scenario) ";d+=game.scenario.name+" Turn "+game.scenario.map.turn+" "+a+".json";OSGlue.disksave(d);break;case "diskload":OSGlue.diskload(l,f);break;case "cloudsave":game.state.saveToCloud($("cloudid"),b);break;case "cloudload":game.state.restoreFromCloud($("cloudid"),
l)}};a.buildMainMenu=function(){for(var a=[["inspectunit","Inspect Unit","i",0,0],["endturn","End Turn","t",0,0],["mainmenu","Main  Menu","o",1,0],["buy","Upgrade/Buy Units","w",0,1],["hex","Toggle Hex Grid","h",0,1],["air","Toggle Air Mode On","p",0,1],["zoom","Strategic Map","m",0,1],["options","Options","s",0,1]],d=0;d<a.length;d++){var b;b=a[d][4]?addTag("slidemenu","div"):insertTag("menu","div","slidemenu");b.id=a[d][0];b.title=a[d][1];b.className="smallButtonMenu";"endturn"===a[d][0]&&(b.className+=
" smallButtonEndTurn");b.style.marginTop="3px";b.innerHTML=a[d][2];b.onclick=function(){game.ui.mainMenuButton(this.id)};a[d][3]&&(b.hasSelectedGlyph=!0)}$("combatLogButton").hasSelectedGlyph=!0;$("statusbar").onclick=$("combatLogButton").onclick=function(){UICombatLog.toggleCombatLog(!1,!0)};$("statusBarButton").onclick=function(){game.ui.toggleUnitsAndEquipmentWindow(!1)};$("unitsBarButton").onclick=function(){makeHidden("unitsBarButton");makeVisible("equipment")}};a.setDefaultUserSelections=function(){$("eqSelCountry").country=
0;$("eqSelCountry").owner=0;$("eqUserSel").deployunit=-1;$("eqUserSel").userunit=-1;$("eqUserSel").equnit=-1;$("eqUserSel").eqtransport=-1;$("eqUserSel").sortorder=0;$("eqUserSel").sortproperty="cost"};a.buildEquipmentWindow=function(){a.setDefaultUserSelections();$("eqSortOrderBut").title="Click to change sorting order ascending/descenting";$("eqSortOrderBut").hasSelectedGlyph=!0;$("eqSortOrderBut").onclick=function(){var a=$("eqUserSel").sortorder||0,a=~a&1;$("eqUserSel").sortorder=a;game.ui.updateEquipmentWindow($("eqUserSel").eqclass);
toggleButton($("eqSortOrderBut"),a)};$("eqSortOptionsBut").title="Click to change sort category";$("eqSortOptionsBut").hasSelectedGlyph=!0;$("eqSortOptionsBut").onclick=function(){isVisible("eqSortOptions")?(makeHidden("eqSortOptions"),makeVisible("eqButtonsContainer"),toggleButton($("eqSortOptionsBut"),!1)):(makeHidden("eqButtonsContainer"),makeVisible("eqSortOptions"),toggleButton($("eqSortOptionsBut"),!0))};for(var b in a.eqClassButtons){var d=addTag("eqSelClass","div");d.className="smallButtonSubMenu";
d.title=a.eqClassButtons[b][1];d.id="eqclass-"+b;d.eqclass=b;d.innerHTML=a.eqClassButtons[b][0];d.onclick=function(){$("eqUserSel").userunit=-1;$("eqUserSel").equnit=-1;$("eqUserSel").eqtransport=-1;game.ui.updateEquipmentWindow(this.eqclass)}}$("eqSelCountry").title="Click to change country";$("eqSelCountry").onclick=function(){game.ui.equipmentWindowButtons("changecountry")};$("eqNewBut").title="Buy unit as a new unit";$("eqNewBut").onclick=function(){game.ui.equipmentWindowButtons("buy")};$("eqUpgradeBut").title=
"Upgrade selected unit to this unit";$("eqUpgradeBut").onclick=function(){game.ui.equipmentWindowButtons("upgrade")};$("eqSellBut").title="Disband and sell this unit";$("eqSellBut").onclick=function(){game.ui.equipmentWindowButtons("sell")};$("eqCloseBut").title="Close";$("eqCloseBut").onclick=function(){makeHidden("equipment");isVisible("container-unitlist")&&makeVisible("unitsBarButton")}};a.buildEquipmentSortOptions=function(){$("eqSortInfo").innerHTML="Sort equipment by: ";for(var b=0;b<a.unitstats.length;b++)a.unitstats[b][2]&&
a.unitstats[b][3]&&(div=addTag("eqSortOptionsContainer","div"),div.title=a.unitstats[b][1],div.id="eqsort-"+a.unitstats[b][3],div.className="smallButtonSubMenu",div.style.marginRight="0px",div.sortproperty=a.unitstats[b][3],div.innerHTML=a.unitstats[b][4],div.onclick=function(){$("eqSortOptions").style.display="none";var a=$("eqUserSel").sortproperty||"cost";toggleButton($("eqsort-"+a),!1);$("eqUserSel").sortproperty=this.sortproperty;toggleButton($("eqsort-"+this.sortproperty),!0);game.ui.updateEquipmentWindow($("eqUserSel").eqclass);
$("eqSortInfo").innerHTML="Sorted by: "+this.title;$("eqSortOptions").style.display="inline"});$("eqSortCloseBut").title="Close sorting options";$("eqSortCloseBut").onclick=function(){makeHidden("eqSortOptions");makeVisible("eqButtonsContainer")}};a.buildUnitInfoWindow=function(){var b=addTag("statsRow","div");b.id="uImageBg";b=addTag("uImageBg","div");b.id="uImage";for(var d=0;d<a.unitstats.length;d++)"uCost"!=a.unitstats[d][0]&&(b=a.unitstats[d][5]?addTag("statsRowTop","div"):addTag("statsRow",
"div"),null!==a.unitstats[d][4]&&(b.title=a.unitstats[d][1],b.className="statsGlyph",b.textContent=a.unitstats[d][4],b=addTag(b,"div")),b.id=a.unitstats[d][0],b.className="statsText")};a.showEquipmentCosts=function(b,d,g,f){0<d&&d<=b?($("eqNewText").innerHTML="Buy ",$("eqNewCost").innerHTML=d+a.currencyIcon,$("eqNewBut").style.display="inline"):(d>b?(d-=b,$("eqNewText").innerHTML="<span style='color:#BB7575'>Need "+d+" more prestige to buy.</span>"):$("eqNewText").textContent="",$("eqNewBut").style.display=
"none",$("eqNewCost").textContent="");0<g&&g<=b?($("eqUpgradeText").innerHTML=" Upgrade ",$("eqUpgradeCost").innerHTML=g+a.currencyIcon,$("eqUpgradeBut").style.display="inline"):(g>b?(d=g-b,$("eqUpgradeText").innerHTML="<span style='color:#BB7575'>Need "+d+" more prestige to upgrade.</span>"):$("eqUpgradeText").textContent="",$("eqUpgradeBut").style.display="none",$("eqUpgradeCost").textContent="");0<f?($("eqSellText").innerHTML=" Sell ",$("eqSellCost").innerHTML=f+a.currencyIcon,$("eqSellBut").style.display=
"inline"):($("eqSellBut").style.display="none",$("eqSellCost").textContent="",$("eqSellText").textContent="");800<=window.innerWidth?$("currentPrestige").textContent="Available Prestige: ":$("currentPrestige").textContent="Now: ";$("currentPrestigeAmount").innerHTML=b+a.currencyIcon};a.showAttackInfo=function(a,d){var b=a.unitData(),f=d.unitData(),l;clearTag($("statusmsg"));l=addTag($("statusmsg"),"div");l.className="playerCountry";l.style.marginTop="0px";l.style.backgroundPosition=""+-21*(a.flag-
1)+"px 0px";l=addTag($("statusmsg"),"div");l.className="combatInfoStatusBar";l.innerHTML="<b>"+b.name+"</b> "+unitClassNames[b.uclass];l=addTag($("statusmsg"),"div");l.style.cssFloat="left";l.style.fontFamily="openpanzer";l.style.fontSize="18px";l.innerHTML="&nbsp!&nbsp;";l=addTag($("statusmsg"),"div");l.className="playerCountry";l.style.marginTop="0px";l.style.backgroundPosition=""+-21*(d.flag-1)+"px 0px";l=addTag($("statusmsg"),"div");l.className="combatInfoStatusBar";l.innerHTML="<b>"+f.name+"</b> "+
unitClassNames[f.uclass]};a.showAIStatus=function(a){a?(makeVisible("statusbar-extension"),$("statusbar-extension").className="statusbar-extension-animation",$("statusbar-extension").innerHTML="Computer turn in progress"):(makeVisible("statusbar-extension"),$("statusbar-extension").className="statusbar-extension-animation-reverse",$("statusbar-extension").style.top="-20px",$("statusbar-extension").innerHTML="<span style='color: #33ccff'> Finished computer turn ! </span>")};a.scaleUI=function(a){if("zoom"in
document.body.style)for(var d=0;d<n.length;d++)$(n[d][0]).style.zoom=a;else for(d=0;d<n.length;d++){var b=$(n[d][0]),f="scale("+a+","+a+")";b.style.webkitTransform=f;b.style.MozTransform=f;b.style.transform=f;"menu"==n[d][0]||"startmenu"==n[d][0]||"ui-message"==n[d][0]?(b.style.webkitTransformOrigin="50% 50%",b.style.mozTransformOrigin="50% 50%",b.style.transformOrigin="50% 50%"):(b.style.webkitTransformOrigin="50% 0",b.style.mozTransformOrigin="50% 0",b.style.transformOrigin="50% 0");f=Math.round(n[d][1]*
a);null!==n[d][1]&&0<=n[d][1]&&(b.style.top=f+"px");null!==n[d][1]&&0>n[d][1]&&(b.style.marginTop=f+"px")}uiSettings.uiScale=a};a.createSlider=function(a,d,b,f,l,p,r){function n(a){var b=parseFloat($(d).value),b=b+a;b<l&&(b=l);b>p&&(b=p);0!=b%1&&(b=b.toFixed(1));$(d).value=b}var q;q=addTag(a,"div");q.className="smallButton";q.style.cssFloat="left";q.style.marginBottom="5px";q.innerHTML="-";q.onclick=function(){n(-f);r&&r()};q=addTag(a,"div");q.style.cssFloat="left";q.style.marginTop="5px";q.innerHTML=
"<input type='text' id='"+d+"' style='-webkit-user-select:text; width:80px;' value='"+b+"'>";q=addTag(a,"div");q.className="smallButton";q.style.cssFloat="left";q.innerHTML="+";q.onclick=function(){n(f);r&&r()}};a.resizeUI=function(a){for(var d="statusbar unit-info container-unitlist equipment combatLog dossier".split(" "),b=a,f=0;f<d.length;f++){var l=$(d[f]);"combatLog"==d[f]&&(b=0.95*b>>0);l.style.width=b+"px";l.style.marginLeft=-(b/2>>0)+"px"}uiSettings.uiSize=a};a.setLayoutConstrains=function(a){800>
window.innerWidth&&($("eqInfoText").style.width="0px",$("eqSortInfo").style.width="0px",$("eqSortInfo").style.height="0px",$("eqSelClass").style.marginLeft="0px",$("menu").style.right="1px",n[9][1]=112,$("equipment").style.top="112px",$("eqUpgradeText").style.display="none",$("eqNewText").style.display="none",$("eqSellText").style.display="none",a&&(840==uiSettings.uiSize&&1==uiSettings.uiScale)&&(uiSettings.uiSize=uiSettings.uiSmallSize,uiSettings.uiScale=0.9))};a.message=function(a,d,b){$("title").innerHTML=
a;$("message").innerHTML=d;makeVisible("ui-message");$("message").scrollTop=0;game.uiMessageClicked=!1;"function"!==typeof b?$("uiokbut").onclick=function(){makeHidden("ui-message");game.uiMessageClicked=!0}:$("uiokbut").onclick=b};a.messageDynamic=function(a,d){var b=$("mainbody"),f=addTag(b,"div"),b=addTag(f,"div"),l=addTag(f,"div"),p=addTag(f,"div");f.className="uiMessageBox";f.id="uiMessageBoxDynamic";f.style.zIndex="98";b.className="uiMessageBoxTitle";l.className="uiMessageBoxBody";p.className=
"smallButton uiMessageBoxButton";b.innerHTML=a;l.innerHTML=d;p.innerHTML="1";makeVisible("uiMessageBoxDynamic");p.onclick=function(){clearTag(f);delTag(f)}};a.showPrototypeAwardMessage=function(b){var d="<br>Due to your brilliant tactical performance on previous battle High Command awarded you a prototype core unit available for deployment.";b=Equipment.equipment[b];"undefined"!==typeof b&&b&&(d+="<div class='uImageAnimation' style='margin-left: 120px;background-image: url("+b.icon+")'></div><b>"+
b.name+" "+unitClassNames[b.uclass]+"</b>");a.messageDynamic("You have been awarded a prototype unit",d)};a.gameToolTip=function(a,d,b){var f=$("gameToolTip");f.setAttribute("type","game");f.style.top=b-55+"px";f.style.left=d+55+"px";$("gameToolTipMessage").innerHTML=a;f.setAttribute("orientation","left");makeVisible("gameToolTip");$("gameToolTipOk").onclick=function(){makeHidden("gameToolTip");game.waitUIAnimation=!1}};a.gameSmallToolTip=function(b,d,f,l,n,p){var r=$("game"),r=addTag(r,"div");defined(n)||
(n="gstt"+a.smallToolTipList.length);r.id=n;r.className="smallToolTip";r.setAttribute("orientation","bottom");defined(l)&&l==tooltipColor.enemy&&(r.style.color="#F8F864");defined(p)&&p==tooltipStyle.pin?(r.setAttribute("shape","pin"),r.style.top=f-15+"px",r.style.left=d-8+"px"):(r.style.top=f-15+"px",r.style.left=d-38+"px");r.style.display="inline";r.innerHTML=b;a.smallToolTipList.push(n);r.onclick=function(){var d=a.smallToolTipList.indexOf(this.id);a.smallToolTipList.splice(d,1);delTag(this)}};
a.uiToolTip=function(a,d,b,f){var l=$("uiToolTip");l.setAttribute("type","ui");l.style.top=b+"px";l.style.left=d+"px";$("uiToolTipMessage").innerHTML=a;f?l.setAttribute("orientation","right"):l.setAttribute("orientation","left");makeVisible("uiToolTip");l.onclick=function(){makeHidden("uiToolTip")}};a.uiToolTipAtElement=function(b,d,f){var l=$("uiToolTip");a.uiToolTip(d,0,0,f);b=getCoordinates(b);a.uiToolTip(d,b.x-l.clientWidth-5,b.y,f)};a.unitIDToOrdinal=function(a){var d=a%10;return 0>a?"":0==a?
"101st":1==d&&11!=a?a+"st":2==d&&12!=a?a+"nd":3==d&&13!=a?a+"rd":a+"th"};a.simulateDossier=function(){for(var a=game.scenario.map.currentPlayer,d=a.dossier,b=game.scenario.map.getUnits(),f=0;f<b.length;f++)0.5<Math.random()&&a.addDestroyedUnitToDossier(b[f]);b=game.campaign.getCampaignData();for(f=0;f<b.length;f++){var l=Math.floor(3*Math.random()),l=0==l?"victory":1==l?"tactical":"briliant",p=game.campaign.getScenarioNameFromId(f);a.addOutcomeToDossier(l,p)}return d};a.showCampaignEnd=function(b,
d,f){if(!a.showDossier(!1,f))return!1;var l=$("dossierCampaign");f=addTag(l,"div");var n=addTag(l,"div"),p=addTag(l,"div");addTag(l,"br");l="resources/ui/dossier/campaign_victory.png";f.style.fontSize="40px";f.style.fontWeight="bold";n.style.letterSpacing="10px";n.style.marginBottom="10px";n.style.fontSize="12px";n.textContent="CAMPAIGN FINISHED";"lose"===b?(f.textContent="Defeat",f.style.color="red",l="resources/ui/dossier/campaign_defeat.png"):(f.textContent="Victory",f.style.color="white");p.className=
"hcenter";p.style.color="white";p.style.width="80%";p.innerHTML=d;$("dossier").style.backgroundImage="url('"+l+"')";$("dossier").style.backgroundRepeat="no-repeat";$("dossier").style.backgroundSize="cover";return!0};a.showDossier=function(b,d){if(null===game.campaign)return!1;var f=$("dossier");clearTag(f);b?(insertTemplate("template__dossier",f),f.style.top="25px",f.style.borderTopLeftRadius="0",f.style.borderTopRightRadius="0",f.style.zIndex="200"):(insertTemplate("template__dossier_scroll",f),
insertTemplate("template__dossier",$("dossierScroll")),f.style.top="50%",f.style.borderRadius="5px",f.style.zIndex="290");f.style.display="block";var l=game.getCampaignPlayer(),n=l.dossier;n.hasOwnProperty("units")||l.initDossier();$("dossierTitle").textContent=game.campaign.name+" "+l.getCountryName()+" Campaign";$("dossierTitle").className="combatLogHeader";game.campaign.getCurrentScenario();game.campaign.getCampaignData();for(var p in a.eqClassButtons)l=addTag("dossierClasses","td"),l.className=
"combatLogHeader",l.style.fontFamily="openpanzer-menu",l.style.fontWeight="bold",l.style.fontSize="26px",l.title=a.eqClassButtons[p][1],l.textContent=a.eqClassButtons[p][0],addTag("dossierDestroyed","td").textContent=n.units.killed[p],addTag("dossierLostCore","td").textContent=n.units.lostcore[p],addTag("dossierLostAux","td").textContent=n.units.lostaux[p];p=!1;for(var r in{briliant:0,victory:1,tactical:2,lose:3})if(!(1>n.outcomes[r].length)){l=addTag("dossierMedals","div");l.textContent=outcomeNames[r];
l.style.fontSize="16px";l.style.textAlign="left";l.style.paddingLeft="10%";addTag("dossierMedals","hr");var l=addTag("dossierMedals","div"),s=addTag(l,"div"),l=addTag(l,"div");s.style.display="inline-block";s.style.width="40%";s.style.verticalAlign="top";if("lose"!==r){p=!0;var q=addTag(s,"img"),s=addTag(s,"div");s.className="counterBox";s.textContent=n.outcomes[r].length;q.src="resources/ui/dossier/"+game.campaign.country+"_"+r+".png";q.style.height="150px"}l.style.display="inline-block";l.style.color=
"#33ccff";l.style.fontSize="12px";l.style.textAlign="justify";l.style.width="55%";s="";for(q=0;q<n.outcomes[r].length;q++)s+=n.outcomes[r][q]+"<br>";l.innerHTML=s}p||($("dossierMedals").innerHTML="You have no medals awarded yet. <br><br>");n=getPosition("unit-info");b?(n=Math.round((n.top-30)/uiSettings.uiScale),r=f):(r=$("dossierScroll"),n=Math.round((n.bottom-70)/uiSettings.uiScale),$("dossierCloseBut").onclick=function(){a.closeDossier();defined(d)&&d()});r=r.childNodes[r.childNodes.length-1];
r=r.offsetTop+r.offsetHeight;n>r&&(n=r);f.style.marginTop=b?"0":(-n/2+15>>0)+"px";f.style.height=n+"px";return!0};a.closeDossier=function(){$("dossier").style.display="none"};a.setEquipmentFlags=function(b){defined(b)||(b=Equipment.defaultName);0==a.flagStyleSheets.length&&(a.flagStyleSheets.push(getStyleSheet("#eqSelCountry")),a.flagStyleSheets.push(getStyleSheet(".playerCountry")),a.flagStyleSheets.push(getStyleSheet(".uSmallFlag")));for(var d=0;d<a.flagStyleSheets.length;d++)a.flagStyleSheets[d].backgroundImage=
"url('../resources/ui/flags/"+b+"/flags_med.png')"};a.setDeployOrCombatLogState=function(a){a?(makeHidden("combatLogButton"),makeVisible("statusBarButton"),makeVisible("unitsBarButton"),$("statusbar").onclick=null,$("weathermsg").onclick=$("combatLogButton").onclick):($("statusbar").onclick=$("combatLogButton").onclick,$("weathermsg").onclick=null,makeHidden("statusBarButton"),makeHidden("unitsBarButton"),makeVisible("combatLogButton"))};return a}(UIBuilder||{});var curDown=!1,curYPos=0,curXPos=0;
function UI(a){function b(a){var b=B(aa,a),b=A.screenToCell(b.x,b.y);null==v.currentUnit||uiSettings.strategicZoom||A.drawCursor(b);E(b.row,b.col);$("game");!0===curDown&&($("game").scrollLeft=curXPos-a.pageX,$("game").scrollTop=curYPos-a.pageY)}function f(b){switch(b.code){case "KeyM":V.hasOwnProperty("mount")&&M("mount",v.currentUnit);break;case "KeyE":V.hasOwnProperty("embark")&&M("embark",v.currentUnit);break;case "KeyS":V.hasOwnProperty("resupply")&&M("resupply",v.currentUnit);break;case "KeyR":V.hasOwnProperty("reinforce")&&
M("reinforce",v.currentUnit);break;case "KeyO":V.hasOwnProperty("overstrength")&&M("overstrength",v.currentUnit);break;case "KeyU":V.hasOwnProperty("undo")&&M("undo",v.currentUnit);break;case "KeyN":defined(v.currentUnit)&&G(v.currentUnit,1,!0);break;case "KeyP":defined(v.currentUnit)&&G(v.currentUnit,0,!0);break;case "KeyA":a.ui.mainMenuButton("air");break;case "KeyH":a.ui.mainMenuButton("hex");break;case "KeyB":a.ui.mainMenuButton("buy");break;case "KeyI":a.ui.mainMenuButton("inspectunit");break;
case "KeyZ":a.ui.mainMenuButton("zoom");break;case "KeyL":a.ui.removeAllSmallToolTips()}if("Escape"==b.key||"Esc"==b.key)defined(v.currentUnit)?n():a.ui.mainMenuButton("options")}function l(a,b){var d=$("eqUserSel").deployunit;v.deployPlayerUnit(v.currentPlayer,d,a,b)&&(A.cacheImages(function(){A.render(a,b,1)}),n(),F($("eqUserSel").eqclass))}function n(){if(null!==v.currentUnit){var a=v.currentUnit.getPos(),b=P(v.currentUnit);v.delCurrentUnit();A.render(a.row,a.col,b)}}function k(b,f){if(v.currentPlayer.type!=
playerType.humanLocal)return!1;var g=v.map[b][f],k=g.getUnit(uiSettings.airMode);if(null==k||k.player.id!=v.currentPlayer.id)if(k=g.getUnit(!uiSettings.airMode),null==k||k.player.id!=v.currentPlayer.id)return!1;$("eqUserSel").userunit=k.id;F(k.unitData(!0).uclass);a.ui.removeUnitToolTip(k.id);return d(k)}function d(a){if(null===a)return!1;var b=a.getPos();n();v.selectUnit(a);I(a);E(b.row,b.col);a=P(a);A.render(b.row,b.col,a);return!0}function g(a,b,d){var f=a.unitData().movmethod;GameRules.isTrain(a)&&
(f=movMethod.tracked);var g=P(a),k=a.getPos();b=v.moveUnit(a,b,d);d={unit:a,moveResults:b,cbfunc:m};if(!b.isVisible)return m(d),!1;soundData[moveSoundByMoveMethod[f]].play();a.hasAnimation=!0;A.moveAnimation(d);A.render(k.row,k.col,g);return!0}function m(b){var d=b.moveResults,f=b.unit,g=P(f),k=f.getPos();A.render(k.row,k.col,g);f.isSurprised&&(g=d.surpriseCell,q(g.row,g.col,"Surprised"),p(b.unit,g.row,g.col),f.isSurprised=!1);d.isCapture&&q(k.row,k.col,"Captured",f.player.side==a.spotSide||2==a.spotSide);
0<=d.isVictorySide&&x(d.isVictorySide);a.waitUIAnimation=!1}function x(b){var d=a.scenario.checkVictory();if(null!==a.campaign)a.getCampaignPlayer().side==b?a.continueCampaign(d,endGameType.moveCapture):a.continueCampaign("lose",endGameType.moveCapture);else{var f;v.currentPlayer.type!=playerType.humanLocal?(d="DEFEAT",f="You have lost ! Your enemy "):(d=outcomeNames[d],f="You have won this scenario ! ");H(d,"<br/><br/><br/><br/>"+f+v.currentPlayer.getCountryName()+" on "+sideNames[b]+" side wins by capturing all victory hexes with a final score of <b>"+
v.currentPlayer.score+"</b>. ",function(){a.ui.mainMenuButton("options")});a.gameEnded=!0}}function p(a,b,d){var f=null;return null!==(f=v.map[b][d].getAttackableUnit(a,uiSettings.airMode))?r(a,f):!1}function r(a,b){var d=7,f=a.getPos(),g=b.getPos();if(!f||!g)return!1;var k=g.row,l=g.col,m=a.unitData().uclass,n=b.unitData().uclass,p=!1,r={attacking:{unit:a,cell:f,oldstr:a.strength,newstr:0,leaderGain:!1,attackStopped:!1},defending:{unit:b,cell:g,oldstr:b.strength,newstr:0,leaderGain:!1},cbfunc:s};
UIBuilder.showAttackInfo(a,b);var y=GameRules.calculateAttackResults(a,b,!0);if(!a.isSurprised&&!y.isOverrun){var p=GameRules.getSupportFireUnits(v.getUnits(),a,b),w;for(w in p){var x=p[w].getPos(),z=p[w].unitData().uclass;if(a.destroyed)break;v.attackUnit(p[w],a,!0);A.addAnimation(x.row,x.col,attackAnimationByClass[z],p[w].facing)}}p=GameRules.isLossOverRetreatThreshold(a.strength,r.attacking.oldstr);a.destroyed||p||(y=v.attackUnit(a,b,!1,y.isOverrun),y.isOverrun&&(q(g.row-0.2,g.col-0.6,"OverRun ",
!0),d=1),y.isRugged&&!y.isOverrun&&q(g.row-0.2,g.col-0.6,"Rugged Defense ",!1),A.addAnimation(f.row,f.col,attackAnimationByClass[m],a.facing),!b.destroyed&&y.defcanfire&&A.addAnimation(k,l,attackAnimationByClass[n],b.facing),r.attacking.leaderGain=y.atkLeaderGain,r.defending.leaderGain=y.defLeaderGain);p&&(r.attacking.attackStopped=!0,a.hasFired=!0);A.render(f.row,f.col,d);uiSettings.markCombatUnits&&v.currentPlayer.type==playerType.aiLocal&&(A.drawHexByCell(f,hexstyle.combat),A.drawHexByCell(g,hexstyle.combat));
A.runAnimation(r);r.attacking.newstr=a.strength;r.defending.newstr=b.strength;return!0}function s(b){var d,f,g=!1,k=b.attacking;b=b.defending;var l=GameRules.getUnitAttackRange(k.unit),n=!1,p=!1;d=k.oldstr-k.newstr;0<d&&d<k.oldstr&&q(k.cell.row,k.cell.col,-d);f=b.oldstr-b.newstr;0<f&&f<b.oldstr&&q(b.cell.row,b.cell.col,-f);d>=k.oldstr&&(n=!0,A.addAnimation(k.cell.row,k.cell.col,"explosion"),A.runAnimation(null));f>=b.oldstr&&(p=!0,A.addAnimation(b.cell.row,b.cell.col,"explosion"),A.runAnimation(null));
if(n||p)v.updateUnitList(),g=!0;v.currentUnit&&(k.unit.destroyed&&v.currentUnit.id==k.unit.id?(v.delCurrentUnit(),A.drawCursor(k.cell)):v.selectUnit(v.currentUnit),b.unit.destroyed&&!v.currentUnit.hasMoved&&(v.setMoveRange(v.currentUnit),d=P(v.currentUnit),d>l&&(l=d)));k.attackStopped&&q(k.cell.row-0.2,k.cell.col-0.6,"Attack Stopped ",!1);!n&&(k.leaderGain&&k.unit.player.side==a.spotSide)&&q(k.cell.row-0.2,k.cell.col-0.6,"New Leader",!0);!p&&(b.leaderGain&&b.unit.player.side==a.spotSide)&&q(b.cell.row-
0.2,b.cell.col-0.6,"New Leader",!0);!p&&GameRules.shouldDefenderRetreat(k.unit,b.unit,b.oldstr)&&(g=!0,(n=GameRules.getRetreatPosition(v.map,b.unit,v.rows,v.cols))?(q(n.row-0.2,n.col-0.6,"Retreat ",!1),n=v.retreatUnit(b.unit,n),n={unit:b.unit,moveResults:n,cbfunc:m},b.unit.hasAnimation=!0,A.moveAnimation(n)):(q(b.cell.row-0.2,b.cell.col-0.6,"Surrender ",!1),b.unit.destroyed=!0,v.updateUnitList(),A.addAnimation(b.cell.row,b.cell.col,"explosion"),A.runAnimation(null)));v.hasAliveUnits(playerSide.axis)||
x(playerSide.allies);v.hasAliveUnits(playerSide.allies)||x(playerSide.axis);g&&A.render(k.cell.row,k.cell.col,l);a.waitUIAnimation=!1;z()}function q(a,b,d,f){a=A.cellToScreen(a,b,!0);"undefined"===typeof f&&(f=!1);bounceText(a.x,a.y,d,f)}function y(a){v.currentPlayer.type==playerType.humanLocal&&((a?isVisible("equipment"):isVisible("container-unitlist"))?(makeHidden("equipment"),makeHidden("container-unitlist"),makeHidden("unitsBarButton"),uiSettings.deployMode=!1,toggleButton($("buy"),!1),z()):(L(!0),
makeVisible("container-unitlist"),a&&(makeVisible("equipment"),makeHidden("eqSortOptions"),makeVisible("eqButtonsContainer")),F(unitClass.tank),toggleButton($("buy"),!0),isVisible("equipment")?makeHidden("unitsBarButton"):makeVisible("unitsBarButton"),makeHidden("combatLog")),A.render())}function I(a){var b,d=0;V={};clearTag("unit-context");if(a&&a.player&&a.player.id==v.currentPlayer.id){GameRules.canMount(a)&&(d++,b=addTag("unit-context","div"),b.className="smallButtonSubMenu",b.innerHTML=UIBuilder.unitContextButtons.mount,
b.title="Mount/Umount this unit in/from a transport",b.onclick=function(){M("mount",a)},V.mount=!0);if(GameRules.canEmbark(v.map,a)||GameRules.canDisembark(v.map,a))d++,b=addTag("unit-context","div"),b.className="smallButtonSubMenu",b.innerHTML=UIBuilder.unitContextButtons.embark,b.title="Embark/DisEmbark this unit in/from a air/naval transport",b.onclick=function(){M("embark",a)},V.embark=!0;GameRules.canResupply(v.map,a)&&(d++,b=addTag("unit-context","div"),b.className="smallButtonSubMenu",b.innerHTML=
UIBuilder.unitContextButtons.resupply,b.title="Resupply Ammo and Fuel for this unit",b.onclick=function(){M("resupply",a)},V.resupply=!0);v.currentPlayer.prestige>=GameRules.calculateUnitCostPerStrength(a)&&(GameRules.canReinforce(v.map,a,!1)&&(d++,b=addTag("unit-context","div"),b.className="smallButtonSubMenu",b.innerHTML=UIBuilder.unitContextButtons.reinforce,b.title="Reinforce unit strength",b.onclick=function(){M("reinforce",a)},V.reinforce=!0),GameRules.canReinforce(v.map,a,!0)&&(d++,b=addTag("unit-context",
"div"),b.className="smallButtonSubMenu",b.innerHTML=UIBuilder.unitContextButtons.overstrength,b.title="Overstrength unit",b.onclick=function(){M("overstrength",a)},V.overstrength=!0));v.canUndoMove(a)&&(d++,b=addTag("unit-context","div"),b.className="smallButtonSubMenu",b.innerHTML=UIBuilder.unitContextButtons.undo,b.title="Undo last move",b.onclick=function(){M("undo",a)},V.undo=!0);0<d?makeVisible("unit-context"):makeHidden("unit-context")}else makeHidden("unit-context")}function J(b){var d=!1,
f,g,k="-",l=0,m=0,q="";if(isVisible("unit-info")&&uiSettings.unitInfoVisibility&&(L(!0),clearTag($("uLeader")),clearTag($("uTransport")),clearTag($("uCarrier")),delTag($("leaderInfo")),makeVisible("statsRow"),$("uLeader").className="",$("uTransport").className="",$("uCarrier").className="","undefined"===typeof b.unitData?(d=!0,f=b,b.flag=b.country,b.strength=10,g=b.ammo,0!=b.fuel&&(k=b.fuel),m=l=0):(f=0!=b.carrier?b.isMounted?b.transport.unitData():b.unitData(!0):b.unitData(),g=b.getAmmo(),GameRules.unitUsesFuel(b)&&
(k=b.getFuel()),l=b.experience,m=b.entrenchment,f.uclass!==unitClass.fortification&&(q=UIBuilder.unitIDToOrdinal(b.id))),g<f.ammo/4&&(g="<span style='color: #FF6347'>"+g+"</span>"),k<f.fuel/4&&(k="<span style='color: #FF6347'>"+k+"</span>"),0==f.gunrange&&(f.gunrange=1),$("uImage").style.backgroundImage="url("+f.icon+")",$("uSmallFlag").style.backgroundPosition=""+-21*(b.flag-1)+"px 0px",$("uFlag").style.backgroundImage="url('resources/ui/flags/"+Equipment.name+"/flag_big_"+b.flag+".png')",$("uFlag").textContent=
Equipment.getCountryName(b.flag-1),$("uName").textContent=q+" "+f.name+" "+unitClassNames[f.uclass],d||(b.isCore&&($("uName").innerHTML+=" (Core Unit)"),-1!=b.leader&&($("uName").innerHTML+=" (Leader)")),$("uTarget").textContent=unitTypeNames[f.target],f.uclass<=unitClass.airDefence&&f.movmethod==movMethod.deepnaval?$("uMoveType").textContent="Rail Road":$("uMoveType").textContent=movMethodNames[f.movmethod],$("uStr").textContent=b.strength+"/10",$("uFuel").innerHTML=k,$("uAmmo").innerHTML=g,$("uGunRange").textContent=
f.gunrange,$("uMovement").textContent=f.movpoints,$("uExp").textContent=l,$("uEnt").textContent=m,$("uIni").textContent=f.initiative,$("uSpot").textContent=f.spotrange,$("uAHard").textContent=f.hardatk,$("uASoft").textContent=f.softatk,$("uAAir").textContent=f.airatk,$("uANaval").textContent=f.navalatk,$("uDHard").textContent=f.grounddef,$("uDAir").textContent=f.airdef,$("uDClose").textContent=f.closedef,$("uDRange").textContent=f.rangedefmod,!d)){0!=b.carrier&&($("uCarrier").className="smallButtonSubMenu",
$("uCarrier").innerHTML="2",$("uCarrier").onclick=function(){J(Equipment.equipment[b.carrier])});if(b.transport){var n;$("uTransport").className="smallButtonSubMenu";b.isMounted?($("uTransport").innerHTML="9",n=!1):($("uTransport").innerHTML="8",n=!0);$("uTransport").onclick=function(){var a=b.isMounted;b.isMounted=n;J(b);b.isMounted=a}}-1<b.leader&&($("uLeader").className="smallButtonSubMenu",$("uLeader").textContent="z",$("uLeader").onclick=function(){if(null!==$("leaderInfo"))J(b);else{makeHidden("statsRow");
var a=Leaders.getUnitLeaderDescriptions(b),d=addTag("statsRowContainer","div");d.id="leaderInfo";d.style.paddingLeft="20px";d.style.paddingTop="10px";var f="<b>"+a[0][0]+"</b>: ",f=f+(a[0][1]+"<br/>"),f=f+("<b>"+a[1][0]+"</b>: "),f=f+a[1][1];d.innerHTML=f}});b.player.side===a.spotSide&&($("uNext").className="smallButtonSubMenu",$("uNext").style.fontSize="16px",$("uNext").innerHTML="y",$("uNext").onclick=function(){G(b,1,!0)})}}function L(a){a?makeVisible("unit-info"):makeHidden("unit-info");uiSettings.unitInfoVisibility=
a;toggleButton($("inspectunit"),a)}function G(a,b,f){a=v.getUnitNeighbor(a,b,f);d(a);a&&C(a.getPos());J(a)}function M(a,b){var d=P(b),f=b.getPos(),g=!1,k=!1;switch(a){case "mount":b.isMounted?v.unmountUnit(b):v.mountUnit(b);g=!0;break;case "embark":0<b.carrier?(v.disembarkUnit(b),g=!0):v.embarkUnit(b)&&(g=!0);break;case "resupply":var k=v.resupplyUnit(b),l=b.getPos(),m="";0<k.ammo&&(m+="+"+k.ammo+" ammo ");0<k.fuel&&(m+="+"+k.fuel+" fuel");""==m?q(l.row,l.col,"Can't resupply",!1):q(l.row,l.col,m,
!0);break;case "overstrength":k=!0;case "reinforce":d=v.reinforceUnit(b,k);l=b.getPos();m="";0<d.strength&&(m="+"+d.strength+" units ");0<d.ammo&&(m+="+"+d.ammo+" ammo ");0<d.fuel&&(m+="+"+d.fuel+" fuel");""==m?q(l.row,l.col,k?"No overstrength":"Can't reinforce",!1):q(l.row,l.col,m,!0);break;case "undo":v.undoLastMove(),g=!0}I(b);J(b);A.render(f.row,f.col,d);g&&(d=P(b),f=b.getPos(),A.render(f.row,f.col,d))}function F(b){if(isVisible("container-unitlist")&&v.currentPlayer.side===a.spotSide){clearTag("unitlist");
clearTag("eqUnitList");clearTag("eqTransportList");var f=$("eqSelCountry").country,g=+O[f]+1;$("eqSelCountry").style.backgroundPosition=""+-21*O[f]+"px 0px";var k=a.scenario.date.getFullYear(),l=[],l=[],m,q,n,p,r,s;n=uiSettings.deployMode;v.currentPlayer.hasUndeployedUnits()?(r=$("eqUserSel").deployunit,l=v.currentPlayer.getCoreUnitList(),l.sort(Q(!1)),uiSettings.deployMode=!0,$("statusmsg").innerHTML="Deploy (on map grey hexes) or upgrade your core units"):(r=$("eqUserSel").userunit,l=v.getUnits(),
l.sort(Q(!0)),uiSettings.deployMode=!1,$("statusmsg").innerHTML="Units currently deployed on map.");UIBuilder.setDeployOrCombatLogState(uiSettings.deployMode);n!==uiSettings.deployMode&&A.render();!0==n&&!1==uiSettings.deployMode&&y(!1);for(var w=0;w<l.length;w++)n=l[w],uiSettings.deployMode&&n.isDeployed||(!n||n.player.id!=v.currentPlayer.id)||(p=n.unitData(!0),s=N("unitlist",n),uiSettings.deployMode&&(-1==r||l[r].isDeployed)&&($("eqUserSel").deployunit=r=w),s.unitid=uiSettings.deployMode?w:n.id,
s.uniteqid=n.eqid,s.eqclass=p.uclass,s.country=p.country-1,n.isCore&&s.unitid!=r&&s.setAttribute("coreUnit",p.name),s.unitid==r&&(null===n.transport||-1!=$("eqUserSel").eqtransport||-1!=$("eqUserSel").equnit&&!GameRules.isTransportable($("eqUserSel").equnit)||($("eqUserSel").eqtransport=n.transport.eqid),s.setAttribute("selectedUnit",p.name),uiSettings.deployMode||(d(n),n&&C(n.getPos()),b=p.uclass),m=$("unitlist").offsetWidth-($("container-unitlist").offsetWidth+s.offsetWidth)/2),s.onclick=function(){f=
v.getCountriesBySide(a.spotSide);for(w=0;w<f.length&&f[w]!=this.country;w++);uiSettings.deployMode?($("eqUserSel").deployunit=this.unitid,$("eqUserSel").userunit=-1):($("eqUserSel").userunit=this.unitid,$("eqUserSel").deployunit=-1);$("eqSelCountry").country=w;$("eqUserSel").eqtransport=-1;$("eqUserSel").equnit=this.uniteqid;$("eqUserSel").unitscroll=$("hscroll-unitlist").scrollLeft;var b;b=uiSettings.deployMode?v.currentPlayer.getCoreUnitList()[this.unitid]:v.getUnitById(this.unitid);J(b);F(this.eqclass);
$("hscroll-unitlist").scrollLeft=$("eqUserSel").unitscroll});uiSettings.deployMode||($("hscroll-unitlist").scrollLeft=m);b==unitClass.flak&&(b=unitClass.airDefence);"undefined"===typeof UIBuilder.eqClassButtons[b]&&(b=unitClass.tank);n=$("eqUserSel").eqclass||unitClass.tank;"undefined"!==typeof UIBuilder.eqClassButtons[n]&&toggleButton($("eqclass-"+n),!1);"undefined"!==typeof UIBuilder.eqClassButtons[b]&&toggleButton($("eqclass-"+b),!0);$("eqUserSel").eqclass=b;$("eqInfoText").innerHTML=k+" "+unitClassNames[b]+
" upgrades for "+Equipment.getCountryName(g-1);r=$("eqUserSel").equnit;p=$("eqUserSel").sortorder;for(var x=$("eqUserSel").sortproperty||"cost",l=Equipment.getCountryEquipmentByClass(b,g,x,p),w=0;w<l.length;w++)m=l[w],n=Equipment.equipment[m],n.yearavailable>k||n.yearexpired<k||(s=N("eqUnitList",n),s.equnitid=m,m==r&&(s.setAttribute("selectedUnit",m),q=$("eqUnitList").offsetWidth-($("hscroll-eqUnitList").offsetWidth+s.offsetWidth)/2),s.onclick=function(){$("eqUserSel").equnit=this.equnitid;$("eqUserSel").eqtransport=
-1;$("eqUserSel").eqscroll=$("hscroll-eqUnitList").scrollLeft;J(Equipment.equipment[this.equnitid]);F(b);$("hscroll-eqUnitList").scrollLeft=$("eqUserSel").eqscroll});0<r&&($("hscroll-eqUnitList").scrollLeft=q);q=$("eqUserSel").eqtransport;s=!1;if(GameRules.isTransportable(r)||0<q){n=Equipment.equipment[r];l=Equipment.getCountryEquipmentByClass(unitClass.groundTransport,g,x,p);for(w=0;w<l.length;w++)m=l[w],g=Equipment.equipment[m],g.yearavailable>k||g.yearexpired<k||(!n||0==(n.groundweight&g.groundweight))||
(r=N("eqTransportList",g),r.eqtransportid=m,m==q&&(r.setAttribute("selectedUnit",g.name),s=!0),r.onclick=function(){$("eqUserSel").eqtransport==this.eqtransportid?$("eqUserSel").eqtransport=-2:$("eqUserSel").eqtransport=this.eqtransportid;J(Equipment.equipment[this.eqtransportid]);F(b)});s||($("eqUserSel").eqtransport=-1)}U()}}function Q(a){return function(b,d){var f=b.unitData(!0),g=d.unitData(!0),k=f.uclass-g.uclass;0==k&&(k=f.name<g.name?-1:+(f.name>g.name));0==k&&(k=b.id-d.id);return a?b.isCore?
d.isCore?k:-1:d.isCore?1:k:k}}function U(){var b=$("eqUserSel").userunit,d=$("eqUserSel").deployunit,f=$("eqUserSel").equnit,g=$("eqUserSel").eqtransport,k=0,l=0,m=0,n=v.currentPlayer.prestige,q=null,p=a.scenario.date.getFullYear(),q=-1==d||"undefined"===typeof d?v.getUnitById(b):v.currentPlayer.getCoreUnitList()[d];if("undefined"!==typeof q&&null!==q){var r=q.unitData(!0).uclass,b=q.unitData(!0).country-1;r==unitClass.flak&&(r=unitClass.airDefence);if(0<f&&"undefined"!==typeof f){var d=Equipment.equipment[f].uclass,
s=Equipment.equipment[f].country-1;d==unitClass.flak&&(d=unitClass.airDefence);r==d&&b==s&&(l=GameRules.calculateUpgradeCosts(q,f,g))}if(null==a.campaign||q.isCore)m=GameRules.calculateUnitSellCost(q)}-1!=f&&(s=Equipment.equipment[f].country-1,k=defined(q)&&"undefined"===typeof UIBuilder.eqClassButtons[r]?-1:Equipment.equipment[f].yearavailable>p||Equipment.equipment[f].yearexpired<p?-1:null!==a.campaign&&a.campaign.country!==s?-1:GameRules.calculateUnitCosts(f,g));UIBuilder.showEquipmentCosts(n,
k,l,m)}function E(a,b){var d,f=v.map[a][b];if(!f||"undefined"===typeof f)return!1;var g=terrainNames[f.terrain];f.road>roadType.none&&(g+="/Road");var g=g+(" ("+a+","+b+")"),k="";null!==f.name&&(k=f.name+" ");var l="";f.terrain==terrainType.Airfield&&0<v.currentPlayer.airTransports&&(l=" Air Transports: "+v.currentPlayer.airTransports+" ");f.terrain==terrainType.Port&&0<v.currentPlayer.navalTransports&&(l+="Naval Transports: "+v.currentPlayer.navalTransports+" ");var m="";null!==(d=f.getUnit(uiSettings.airMode))&&
(f.isSpotted(v.currentPlayer.side)||d.tempSpotted||d.player.side==v.currentPlayer.side)&&(m=" Unit: "+d.unitData(!0).name+" ");30<k.length+m.length&&(15<k.length?k=k.slice(0,10)+"... ":m=m.slice(0,20)+" ");$("locmsg").innerHTML=m+k+l+g;return!0}function N(a,b){var d=addTag(a,"div"),f=addTag(d,"img"),g=addTag(d,"div"),k=addTag(d,"div");d.className="eqUnitBox";if("undefined"!==typeof b.unitData){var l=b.unitData(!0);if(l.uclass>unitClass.submarine){var m={};m.name=l.name;m.icon=UIBuilder.navalReplacementIcon;
m.cost=l.cost;l=m}m="";f.src=l.icon;g.textContent=l.name;if(b.isDeployed){if(k.className="eqUnitBoxIconsMenu",b.hasFired||(m+=">"),b.hasMoved||(m+="|"),GameRules.unitUsesFuel(b)&&5>b.fuel||2>b.ammo)m+=";"}else k.className="eqUnitBoxIcons",m="Z";k.textContent=m}else f.src=b.icon,g.textContent=b.name,k.innerHTML+="<b>"+b.cost*CURRENCY_MULTIPLIER+UIBuilder.currencyIcon+"</b>";return d}function w(){makeHidden("statusbar-extension");$("statusbar-extension").style.top="25px";$("statusbar-extension").className=
"";var b=v.currentPlayer;z();b.type==playerType.humanLocal||b.type==playerType.aiScripted?(UICombatLog.toggleCombatLog(!0,!1),a.ui.removeAllSmallToolTips(!0),a.ui.addSmallToolTips(!0)):UIBuilder.showAIStatus(!0)}function z(){clearTag($("statusmsg"));$("statusmsg").innerHTML="&nbsp; "+v.currentPlayer.getCountryName()+" Turn: "+v.turn+"/"+v.maxTurns+" "+a.scenario.name;$("weathermsg").innerHTML=groundFontEncoding[a.scenario.ground]+weatherFontEncoding[a.scenario.atmosferic];$("weathermsg").title=groundConditionNames[a.scenario.ground]+
" ground and "+weatherConditionNames[a.scenario.atmosferic]+" weather"}function H(a,b,d){UIBuilder.message(a,b,d)}function C(a){if(!a||"undefined"===typeof a)return!1;a=A.cellToScreen(a.row,a.col,!0);$("game").scrollLeft=a.x-window.innerWidth/2;$("game").scrollTop=a.y-window.innerHeight/2;return!0}function B(a,b){var d,f=$("game");b.which?d=3==b.which:b.button&&(d=2==b.button);return new mouseInfo(b.pageX-a.offsetLeft-f.clientLeft-f.offsetLeft+f.scrollLeft,b.pageY-a.offsetTop-f.clientTop-f.offsetTop+
f.scrollTop,d)}function W(){A.render();if(v.currentPlayer.type==playerType.humanLocal)for(var a=v.getUnits(),b=0;b<a.length;b++)if(a[b].player.id==v.currentPlayer.id&&a[b].unitData().uclass!=unitClass.fighter&&a[b].unitData().uclass!=unitClass.levelBomber&&a[b].unitData().uclass!=unitClass.tacticalBomber){var d=a[b].getPos();k(d.row,d.col);J(a[b]);break}X()||v.currentUnit&&C(v.currentUnit.getPos());Y(uiSettings.zoomLevel)}function T(){hasBrokenClearRect()?A.cacheImages(function(){window.setTimeout(W,
4E3)}):A.cacheImages(W)}function P(a){if(null===a)return 0;var b=GameRules.getUnitMoveRange(a),d=GameRules.getUnitAttackRange(a);d>b&&(b=d);d=a.unitData().spotrange;d>b&&(b=d);return b}function X(){var a=v.currentPlayer;if(!a.hasUndeployedUnits()||a.type!=playerType.humanLocal)return!1;makeVisible("container-unitlist");a:for(a=0;a<v.rows;a++)for(var b=0;b<v.cols;b++){var d=v.map[a][b];if(d&&-1!=d.isDeployment&&d.isDeployment==v.currentPlayer.id){C({row:a,col:b});break a}}toggleButton($("buy"),!0);
return!0}function S(){var a=$("game"),b=Math.min(100*(window.innerWidth/(aa.width*uiSettings.zoomLevel)),100*(window.innerHeight/(aa.height*uiSettings.zoomLevel)))>>0,d;uiSettings.strategicZoom?(a.style.width=window.innerWidth+"px",a.style.height=window.innerHeight+"px","ios"==NATIVE_PLATFORM?a.style.zoom="100%":(d="",a.style.webkitTransform=d,a.style.MozTransform=d,a.style.transform=d),uiSettings.strategicZoom=!1,uiSettings.strategicZoomLevel=1):("ios"==NATIVE_PLATFORM?a.style.zoom=b+"%":(d="scale("+
b/100+","+b/100+")",a.style.webkitTransform=d,a.style.MozTransform=d,a.style.transform=d),a.style.width=(100*window.innerWidth/b>>0)+"px",a.style.height=(100*window.innerHeight/b>>0)+"px",uiSettings.strategicZoom=!0,uiSettings.strategicZoomLevel=100/b);toggleButton($("zoom"),uiSettings.strategicZoom);A.render()}function Y(a){var b=100*a>>0,d,f,g,k;f=$("map");var l=$("game"),m=uiSettings.zoomLevel;d=f.width;f=f.height;g=l.scrollLeft;k=l.scrollTop;$("map").style.zoom=b+"%";$("hexes").style.zoom=b+"%";
$("cursor").style.zoom=b+"%";$("unitbackbuffer").style.zoom=b+"%";l.scrollLeft=g+d*(a-m)/2;l.scrollTop=k+f*(a-m)/2;uiSettings.mapZoom=1!=a?!0:!1;uiSettings.zoomLevel=a;$("mapscale").value=a;A.positionLayers()}var v=a.scenario.map,A=new Render(v),O=v.getCountriesBySide(a.spotSide),V={};T();var aa=A.getCursorCanvas();uiSettings.hasTouch=hasTouch();uiSettings.hasTouch?(uiSettings.showGridTerrain=!0,hasBrokenScroll()&&(touchScroll("game"),touchScroll("hscroll-unitlist"),touchScroll("hscroll-eqUnitList"),
touchScroll("hscroll-eqTransportList")),UIBuilder.setLayoutConstrains(!0)):(addStyleSheet("scrollbars.css"),aa.addEventListener("mousemove",b,!1),window.addEventListener("mouseup",function(a){curDown=!1},!1),window.addEventListener("keyup",f,!1),window.onresize=function(){A.positionLayers()});aa.addEventListener("mousedown",function(b){if(!a.gameStarted||a.gameEnded)return!1;b=B(aa,b);var d=A.screenToCell(b.x,b.y),f=d.row,m=d.col,q=!1;uiSettings.hasTouch||(curDown=!0,curXPos=b.x,curYPos=b.y);var r=
v.map[f][m];if("undefined"===typeof r)return!0;if(uiSettings.strategicZoom)return S(),C(d),!0;(d=r.getUnit(uiSettings.airMode))&&(r.isSpotted(v.currentPlayer.side)||d.tempSpotted||d.player.side==v.currentPlayer.side||(d=null));if(b.rclick)return d?(L(!0),J(d)):n(),!0;d?(uiSettings.unitInfoVisibility&&makeVisible("unit-info"),J(d),null===v.currentUnit||uiSettings.deployMode?q=k(f,m):r.isAttackSel&&!v.currentUnit.hasFired?p(v.currentUnit,f,m):r.isMoveSel?g(v.currentUnit,f,m):v.currentUnit===d?(n(),
uiSettings.unitInfoVisibility&&makeHidden("unit-info")):q=k(f,m)):uiSettings.deployMode&&-1<r.isDeployment&&v.getPlayer(r.isDeployment).side==v.currentPlayer.side?l(f,m):r.isMoveSel&&!v.currentUnit.hasMoved&&null!==v.currentUnit?g(v.currentUnit,f,m):(n(),uiSettings.unitInfoVisibility&&makeHidden("unit-info"));!q&&uiSettings.hasTouch&&E(f,m);uiSettings.airMode=GameRules.isAir(v.currentUnit);toggleButton($("air"),uiSettings.airMode);I(v.currentUnit);return!1},!1);toggleRightClick(!1);UIBuilder.buildStartMenu();
UIBuilder.buildMainMenu();UIBuilder.buildUnitInfoWindow();UIBuilder.buildEquipmentWindow();UIBuilder.buildEquipmentSortOptions();UIBuilder.setDefaultUserSelections();UIBuilder.setEquipmentFlags(a.scenario.eqp);z();X();F();H(a.scenario.name,a.scenario.getDescription());this.handleReinforcementDeployment=function(){A.cacheImages(function(){A.render()})};this.uiUnitSelect=function(a){return d(a)};this.uiUnitMove=function(a,b,d){return g(a,b,d)};this.uiUnitAttack=function(a,b){return r(a,b)};this.showAlert=
function(a,b,d,f){return q(a,b,d,f)};this.showGameToolTip=function(a,b,d){b=A.cellToScreen(b,d,!0);UIBuilder.gameToolTip(a,b.x,b.y)};this.showSmallToolTip=function(a,b,d,f,g,k){b=A.cellToScreen(b,d,!0);UIBuilder.gameSmallToolTip(a,b.x,b.y,f,g,k)};this.addSmallToolTips=function(a){for(var b=v.map,d=v.currentPlayer,f=d.side,g=0;g<b.length;g++)for(var k=0;k<b[g].length;k++){var l=b[g][k],m=null,q=tooltipColor.enemy,n=tooltipStyle.text;a||(-1==l.flag||-1==l.owner)||(null!==l.name&&""!=l.name?m=l.name:
-1!==l.victorySide&&(m="Objective"),uiSettings.showDetailInfoToolTips||-1!=l.victorySide||(m=null),l.owner==f&&(q=tooltipColor.player),l.terrain==terrainType.Airfield&&0<d.airTransports&&(m=d.airTransports+"&nbsp;<span style='font-family: openpanzer-menu;'>&#xe900;</span> ",n=tooltipStyle.pin),l.terrain==terrainType.Port&&0<d.navalTransports&&(m=d.navalTransports+"&nbsp;<span style='font-family: openpanzer-menu;'>&#xe901;</span>",n=tooltipStyle.pin),m&&this.showSmallToolTip(m,g,k,q,void 0,n));(l=
l.getUnit(uiSettings.airMode))&&(l.player.side==f&&null==m)&&(m="gsttu"+l.id,GameRules.unitLowAmmo(l,1)&&this.showSmallToolTip("No Ammo",g,k,0,m),GameRules.unitLowFuel(l,1)&&this.showSmallToolTip("No Fuel",g,k,0,m))}};this.removeUnitToolTip=function(a){for(var b=UIBuilder.smallToolTipList.length-1;0<=b;b--){var d=UIBuilder.smallToolTipList[b];if(d=="gsttu"+a){delTag($(d));break}}};this.removeAllSmallToolTips=function(a){for(var b=UIBuilder.smallToolTipList.length-1;0<=b;b--){var d=UIBuilder.smallToolTipList[b];
a&&0!==d.lastIndexOf("gsttu",0)||delTag($(d))}UIBuilder.smallToolTipList=[]};this.setNewScenario=function(){v=a.scenario.map;A.setNewMap(v);T();O=v.getCountriesBySide(a.spotSide);UIBuilder.setEquipmentFlags(a.scenario.eqp);UIBuilder.setDefaultUserSelections();CombatLog.reset();makeHidden("combatLog");makeHidden("statusbar-extension");UIBuilder.closeDossier();a.ui.removeAllSmallToolTips();a.ui.addSmallToolTips();F(unitClass.tank);z();X();H(a.scenario.name,a.scenario.getDescription())};this.startMenuButton=
function(b){switch(b){case "newgame":makeVisible("smNewGame");break;case "newcampaign":makeHidden("smNewGame");makeHidden("smMain");makeVisible("smCamp");null===a.campaign?setSelectOption($("smCampSel").firstChild,$("smCampSel").firstChild.options[0].text):setSelectOption($("smCampSel").firstChild,a.campaign.name);$("smCampSel").firstChild.onchange();break;case "newscenario":makeHidden("smNewGame");makeHidden("smMain");makeVisible("smScen");setSelectOption($("smScenSel").firstChild,a.scenario.name);
break;case "tutorial":makeHidden("smMain");makeHidden("startmenu");a.campaign=null;uiSettings.noFOW=!1;uiSettings.isAI[0]=2;uiSettings.isAI[1]=2;a.newScenario(Game.defaultScenario);toggleButton($("options"),!1);break;case "continuegame":makeHidden("startmenu");toggleButton($("options"),!1);break;case "saveload":makeHidden("smMain");makeHidden("smNewGame");makeVisible("smState");break;case "settings":makeHidden("startmenu"),makeHidden("smNewGame"),makeVisible("smSettings"),isVisible("ui-message")&&
(makeHidden("ui-message"),$("smSettings").messageHidden=!0)}};this.mainMenuButton=function(b){switch(b){case "air":uiSettings.airMode&&GameRules.isAir(v.currentUnit)&&n();uiSettings.airMode=!uiSettings.airMode;toggleButton($("air"),uiSettings.airMode);A.render();break;case "hex":uiSettings.hexGrid=!uiSettings.hexGrid;toggleButton($("hex"),uiSettings.hexGrid);this.removeAllSmallToolTips();this.addSmallToolTips();A.render();break;case "zoom":S();A.render();break;case "inspectunit":isVisible("unit-info")?
L(!1):(L(!0),null!==v.currentUnit&&J(v.currentUnit));break;case "buy":y(!0);break;case "endturn":var d=$("endturn");null==d.getAttribute("confirmation")?(d.innerHTML="1",uiSettings.shownEndTurnTip||UIBuilder.uiToolTipAtElement(d,"Tap again to confirm End Turn",1),b=function(){this.removeAttribute("confirmation");d.innerHTML="t";uiSettings.shownEndTurnTip||UIBuilder.uiToolTipAtElement(d,"Tap twice to confirm End Turn",1)},d.setAttribute("confirmation","on"),d.addEventListener("animationend",b,!1),
d.addEventListener("webkitAnimationEnd",b,!1)):(d.innerHTML="t",d.removeAttribute("confirmation"),isVisible("equipment")&&(makeHidden("equipment"),makeHidden("container-unitlist"),uiSettings.deployMode=!1,toggleButton($("buy"),!1)),isVisible("unit-info")&&L(!1),makeHidden("combatLog"),uiSettings.shownEndTurnTip||(makeHidden("uiToolTip"),uiSettings.shownEndTurnTip=!0,a.state.saveSettings()),v.currentPlayer.type==playerType.humanLocal&&(a.endTurn(),a.gameEnded&&a.gameStarted?H("DEFEAT","<br><br>You didn't capture the objectives in time"):
(O=v.getCountriesBySide(a.spotSide),UIBuilder.setDefaultUserSelections(),CombatLog.reset(),F(unitClass.tank),I(),w(),W())));break;case "mainmenu":isVisible("slidemenu")?(makeHidden("slidemenu"),toggleButton($("mainmenu"),!1)):(makeVisible("slidemenu"),toggleButton($("mainmenu"),!0));break;case "options":isVisible("startmenu")?(makeHidden("smMain"),makeHidden("smScen"),makeHidden("smSettings"),makeHidden("smState"),makeHidden("startmenu"),toggleButton($("options"),!1)):(makeVisible("startmenu"),makeVisible("smMain"),
toggleButton($("options"),!0))}};this.toggleUnitsAndEquipmentWindow=y;this.equipmentWindowButtons=function(b){switch(b){case "changecountry":$("eqSelCountry").country>=O.length-1?$("eqSelCountry").country=0:$("eqSelCountry").country++;$("eqUserSel").userunit=-1;$("eqUserSel").equnit=-1;a.ui.updateEquipmentWindow($("eqUserSel").eqclass||unitClass.tank);break;case "buy":var d=$("eqUserSel").equnit,f=$("eqUserSel").eqtransport;if("undefined"===typeof d||0>=d)break;if("undefined"===typeof f||""==f)f=
-1;v.currentPlayer.buyUnit(d,f);F(Equipment.equipment[d].uclass);break;case "upgrade":b=$("eqUserSel").userunit;var g=$("eqUserSel").deployunit,d=$("eqUserSel").equnit,f=$("eqUserSel").eqtransport,k=v.currentPlayer,l=null;if("undefined"===typeof f||""==f)f=-1;"undefined"===typeof b||-1==b?(l=k.getCoreUnitList()[g],k.upgradeUnit(l,d,f)&&F(Equipment.equipment[l.eqid].uclass)):v.upgradeUnit(b,d,f)&&(A.cacheImages(function(){A.render()}),0<d&&F(Equipment.equipment[d].uclass));break;case "sell":k=v.currentPlayer,
l=null,b=$("eqUserSel").userunit,g=$("eqUserSel").deployunit,d=$("eqUserSel").equnit,"undefined"===typeof b||-1==b?(l=k.getCoreUnitList()[g],k.sellUnit(l)&&(k.removeUndeployedCoreUnit(g),F(Equipment.equipment[l.eqid].uclass))):v.disbandUnit(b)&&(A.cacheImages(function(){A.render()}),$("eqUserSel").userunit=-1,0<d&&F(Equipment.equipment[d].uclass))}};this.updateEquipmentWindow=function(a){return F(a)};this.uiEndTurnInfo=function(){A.render();w()};this.uiSetUnitOnViewPort=function(a){return a?C(a.getPos()):
!1};this.uiSetCellOnViewPort=function(a){return C(a)};this.scaleMap=function(a){return Y(a)}};var UICombatLog=function(a){function b(a){return"<span class='combatLogNum'>"+a+"</span>"}a.showCombatLog=function(b){var l=$("combatLog"),n=game.scenario.map.map;clearTag(l);a.buildCombatSummary(l,n);a.buildObjectiveSummary(l,n);a.buildResupplySummary(l,n);a.buildReinforceSummary(l,n);a.buildLeadersSummary(l,n);b||a.buildExtendButton(l);a.buildTurnInfo(l);makeVisible("combatLog");var n=getPosition("unit-info"),n=Math.round((n.top-30)/uiSettings.uiScale),k=l.childNodes[l.childNodes.length-1],k=k.offsetTop+
k.offsetHeight;n>k&&(n=k);b?l.style.height=n+"px":(175<n&&(n=175),l.style.height=n+"px",l.scrollTop=0)};a.buildExtendButton=function(b){b=insertTag(b,"div",b.firstChild);b.className="combatLogHeader";b.style.paddingTop="5px";b.innerHTML="Show Turn Summary";b.innerHTML+="<span style='font-family: openpanzer-menu; font-size: 22px;font-weight: normal;color: #f8e064;line-height: 0px;display: block;'>l</span><br/>";b.onclick=function(){a.showCombatLog(!0)}};a.buildTurnInfo=function(a){var l=game.scenario.map,
n=l.currentPlayer,k=0;a=insertTag(a,"div",a.firstChild);a.className="combatLogHeader";a.style.paddingTop="15px";var d="<span style='font-weight: bold; text-align: center; color: #33ccff;'>"+n.getCountryName()+" Turn "+l.turn+" of "+l.maxTurns+"</span>";null!==game.campaign&&(d+="<span class='smallButtonMenu combatLogInfoButton' style='left: 15px' onclick=\"(function() { makeHidden('combatLog'); UIBuilder.showDossier(true, false); })();\">@</span><br>");d+="<span class='smallButtonMenu combatLogInfoButton' style='right: 15px; font-size: 16px'onclick=\"(function(){ UICombatLog.toggleCombatLog(); UIBuilder.message(game.scenario.name, game.scenario.getDescription());})();\">g</span><hr/><span style='color: #f8e064;text-align: center;font-family: Arial;font-size: 14px;font-weight: normal;'>";
d+="<i>"+game.scenario.name+"</i>, "+game.scenario.date.toDateString()+"<br/> ";d+=b(l.sidesVictoryHexes[n.side].length)+"</b> objectives left to conquer, in ";0<(k=l.victoryTurns[0]-(l.turn-1))&&(d+=b(k)+" turns for <i>"+outcomeNames.briliant+"</i>, ");0<(k=l.victoryTurns[1]-(l.turn-1))&&(d+=b(k)+" turns for <i>"+outcomeNames.victory+"</i> and ");0<(k=l.victoryTurns[2]-(l.turn-1))&&(d+=b(k)+" turns for <i>"+outcomeNames.tactical+"</i>");d+="<br/>Current score is "+b(n.score)+" and ";d+="prestige is "+
b(n.prestige)+"&nbsp;"+UIBuilder.currencyIcon;d+=" gaining "+b(n.prestigePerTurn[l.turn+1])+"&nbsp;"+UIBuilder.currencyIcon+" next turn<br/>";d+="<span style='font-family: openpanzer;color: #33ccff; font-size:22px;'>"+weatherFontEncoding[game.scenario.atmosferic]+"</span> "+weatherConditionNames[game.scenario.atmosferic]+" weather ";d+=" and <span style='font-family: openpanzer; color: #33ccff; font-size: 22px;'>"+groundFontEncoding[game.scenario.ground]+"</span> "+groundConditionNames[game.scenario.ground]+
" ground.";d+="</span>";a.innerHTML=d};a.buildCombatSummary=function(a,l){var n=0,k;for(k in CombatLog.log.combat){var d=CombatLog.log.combat[k];if(d.side==game.spotSide){var g="",m="",x="",p="",r="",s,q,y=Equipment.equipment[d.eqid];n++;q=d.isCore?insertTag(a,"div",a.firstChild):addTag(a,"div");m=addTag(q,"div");s=addTag(q,"div");q.className="combatLogLine";m.className="combatLogUnitBox";s.className="combatLogInfoBox";addTag(m,"img").src=y.uclass>unitClass.airTransport?UIBuilder.navalReplacementIcon:
y.icon;m=d.assaults>=d.defends||d.supports>=d.defends?d.supports>=d.assaults?" provided fire support from ":" while assaulting from ":" while defending ";""!=l[d.pos.row][d.pos.col].name&&(r=l[d.pos.row][d.pos.col].name+" ");l[d.pos.row][d.pos.col].terrain!==terrainType.Clear&&(r+=terrainNames[l[d.pos.row][d.pos.col].terrain]+" ");g=d.isCore?g+b("Core "):g+"Auxiliary ";g+="Unit <b>"+UIBuilder.unitIDToOrdinal(d.id)+" "+y.name+"</b>"+m+r+" <b>("+d.pos.row+","+d.pos.col+")</b> ";0<d.assaults&&(x=" in "+
d.assaults+" assaults",p=" and");p=0<d.defends?p+(" defending from "+d.defends+" attacks "):"";0<d.kills&&(g+=" inflicted "+b(d.kills)+" casualties ");0!=d.losses&&(0<d.kills&&(g+="and "),g+="lost "+b("-"+d.losses)+" strength",0<d.str?g+=" with "+b(d.str)+" surviving ":(g+=" being completely destroyed ",s.className="combatLogInfoBoxRed"));g+=x;g+=p;0!=d.xp&&0<d.str&&(g+=" and gained +"+b(d.xp)+" experience. ");d.ammo<y.ammo/4&&(g+=" Unit is low on ammo "+b(d.ammo+"/"+y.ammo)+" remaining. ");0<d.entrenchLost?
g+=b(d.entrenchLost)+" entrenchments had been destroyed during combat with "+b(d.entrench)+" remaining.":0<d.entrench&&(g+=" Unit has "+b(d.entrench)+" remaining entrenchments");s.innerHTML=g;q.row=d.pos.row;q.col=d.pos.col;q.onclick=function(){return game.ui.uiSetCellOnViewPort({row:this.row,col:this.col})};d.isCore?insertTag(a,"hr",q.nextSibling):addTag(a,"hr")}}k=insertTag(a,"div",a.firstChild);k.className="combatLogHeader";k.innerHTML="Unit Combat Report";insertTag(a,"hr",k.nextSibling);0==n&&
(q=addTag(a,"div"),q.innerHTML="All quiet on this front");return n};a.buildResupplySummary=function(a,l){var n=0,k=addTag(a,"div");k.className="combatLogHeader";k.innerHTML="Resupply Report";insertTag(a,"hr",k.nextSibling);for(var d in CombatLog.log.resupply)if(k=CombatLog.log.resupply[d],k.side==game.spotSide&&!(0>k.ammo&&0>k.fuel&&0>k.entrench)){var g="",m,x,p,r=Equipment.equipment[k.eqid];n++;p=addTag(a,"div");m=addTag(p,"div");x=addTag(p,"div");p.className="combatLogLine";m.className="combatLogUnitBox";
x.className="combatLogInfoBox";addTag(m,"img").src=r.uclass>unitClass.airTransport?UIBuilder.navalReplacementIcon:r.icon;g=k.isCore?g+b("Core "):g+"Auxiliary ";g+="Unit <b>"+UIBuilder.unitIDToOrdinal(d)+" "+r.name+"</b>";0<k.ammo&&(g+=" resupplied automatically with "+b(k.ammo+"/"+r.ammo)+" ammunition ");0<k.fuel&&0<r.fuel&&(0<k.ammo&&(g+="and "),g+=b(k.fuel+"/"+r.fuel)+" fuel.");x.innerHTML=g;addTag(a,"hr")}0==n&&(p=addTag(a,"div"),p.innerHTML="No units had been provided with automatic resupply.");
return n};a.buildReinforceSummary=function(a,b){var n=0,k=addTag(a,"div");k.className="combatLogHeader";k.innerHTML="Reinforcements Report";insertTag(a,"hr",k.nextSibling);for(k=0;k<CombatLog.log.reinforce.length;k++){var d=CombatLog.log.reinforce[k];if(d.side==game.spotSide){var g="",m,x,p,r=Equipment.equipment[d.eqid];n++;p=addTag(a,"div");m=addTag(p,"div");x=addTag(p,"div");p.className="combatLogLine";m.className="combatLogUnitBox";x.className="combatLogInfoBox";addTag(m,"img").src=r.uclass>unitClass.airTransport?
UIBuilder.navalReplacementIcon:r.icon;g+="Unit <b>"+r.name+"</b>";g+=" received as reinforcement at <b>("+d.pos.row+","+d.pos.col+")</b> ";x.innerHTML=g;p.row=d.pos.row;p.col=d.pos.col;p.onclick=function(){return game.ui.uiSetCellOnViewPort({row:this.row,col:this.col})};addTag(a,"hr")}}0==n&&(p=addTag(a,"div"),p.innerHTML="No reinforcements arrived.");return n};a.buildLeadersSummary=function(a,l){var n=0,k=addTag(a,"div");k.className="combatLogHeader";k.innerHTML="Unit Leaders Report";insertTag(a,
"hr",k.nextSibling);for(k=0;k<CombatLog.log.leaders.length;k++){var d=CombatLog.log.leaders[k];if(d.side==game.spotSide){var g="",m,x,p,r=Equipment.equipment[d.eqid];n++;p=addTag(a,"div");m=addTag(p,"div");x=addTag(p,"div");p.className="combatLogLine";m.className="combatLogUnitBox";x.className="combatLogInfoBox";addTag(m,"img").src=r.icon;g=d.isCore?g+b("Core "):g+"Auxiliary ";g+="Unit <b>"+UIBuilder.unitIDToOrdinal(d.id)+" "+r.name+"</b>";g+=" received a new Leader with "+b(Leaders.description[d.classLeader][0]);
g+=" and "+b(Leaders.description[d.leader][0])+" abilities";p.row=d.pos.row;p.col=d.pos.col;x.innerHTML=g;p.onclick=function(){return game.ui.uiSetCellOnViewPort({row:this.row,col:this.col})};addTag(a,"hr")}}0==n&&(p=addTag(a,"div"),p.innerHTML="No units received leaders");return n};a.buildObjectiveSummary=function(a,l){var n=0,k=addTag(a,"div");k.className="combatLogHeader";k.innerHTML="Objectives Report";insertTag(a,"hr",k.nextSibling);for(k=0;k<CombatLog.log.objectives.length;k++){var d=CombatLog.log.objectives[k],
g="",m,x=l[d.pos.row][d.pos.col];x&&"undefined"!==typeof x&&(n++,m=addTag(a,"div"),g=d.side==game.spotSide?g+("Captured objective  "+x.name+" at <b>("+d.pos.row+","+d.pos.col+")</b>, prestige increased by "+b(prestigeGains.objectiveCapture)+"&nbsp;"+UIBuilder.currencyIcon):g+("Lost objective  "+x.name+" at <b>("+d.pos.row+","+d.pos.col+")</b>"),m.innerHTML=g,m.row=d.pos.row,m.col=d.pos.col,m.onclick=function(){return game.ui.uiSetCellOnViewPort({row:this.row,col:this.col})},addTag(a,"hr"))}0==n&&
(m=addTag(a,"div"),m.innerHTML="No objectives has been captured or lost");return n};a.toggleCombatLog=function(b,l){var n=game.scenario.map.currentPlayer;if(n.type==playerType.humanLocal||n.type==playerType.aiScripted)b||!isVisible("combatLog")?(a.showCombatLog(l),toggleButton($("combatLogButton"),!0)):(makeHidden("combatLog"),toggleButton($("combatLogButton"),!1)),UIBuilder.closeDossier()};return a}(UICombatLog||{});var game=new Game;
function Game(){function a(a){var b,d=a.scenario.map.getPlayers();if(null===d)return!1;for(b=0;b<d.length;b++)if(null!==a.campaign)d[b].country!=a.campaign.country?(d[b].type=playerType.aiLocal,d[b].handler=new AI(d[b],a.scenario.map)):(n=d[b],null===k?(k=new Player,k.copy(d[b])):d[b].copy(k,!0));else if(1==uiSettings.isAI[d[b].id]||d[b].type==playerType.aiLocal)d[b].type=playerType.aiLocal,d[b].handler=new AI(d[b],a.scenario.map);else if(2==uiSettings.isAI[d[b].id]||d[b].type==playerType.aiScripted)d[b].type=
playerType.aiScripted,d[b].handler=new AIScripted(d[b],a.scenario.map);return!0}function b(a,b){if(!b)return!1;var d=b.param;if(!d)return!1;switch(b.type){case actionType.move:a.scenario.map.setMoveRange(d[0]);a.waitUIAnimation=!0;a.ui.uiUnitMove(d[0],d[1].row,d[1].col)?a.ui.uiSetUnitOnViewPort(d[0]):a.waitUIAnimation=!1;break;case actionType.attack:a.waitUIAnimation=!0;GameRules.isInAttackRange(d[0],d[1])&&a.ui.uiUnitAttack(d[0],d[1])?a.ui.uiSetUnitOnViewPort(d[0]):a.waitUIAnimation=!1;break;case actionType.resupply:a.scenario.map.resupplyUnit(d[0]);
break;case actionType.reinforce:a.scenario.map.reinforceUnit(d[0],!1);break;case actionType.mount:a.scenario.map.mountUnit(d[0]);break;case actionType.umount:a.scenario.map.unmountUnit(d[0]);break;case actionType.upgrade:break;case actionType.buy:break;case actionType.deploy:break;case actionType.select:a.ui.uiSetUnitOnViewPort(d[0]);a.ui.uiUnitSelect(d[0]);break;case actionType.endturn:return!1;case actionType.message:a.waitUIAnimation=!0;a.ui.showGameToolTip(d[0],d[1].row,d[1].col);a.ui.uiSetCellOnViewPort(d[1]);
break;case actionType.viewport:a.ui.uiSetCellOnViewPort(d[0]);break;default:return!1}return!0}function f(a){for(var b=1,d=-1,f=0;f<a.length;f++)if(a[f].type==playerType.humanLocal||a[f].type==playerType.aiScripted)-1!=d&&d!=a[f].side&&b++,d=a[f].side;1<b&&(d=2);DEBUG_AI_MOVES&&(d=2);return d}this.scenario=this.campaign=this.state=this.ui=null;this.waitUIAnimation=this.gameEnded=this.gameStarted=!1;this.spotSide=-1;this.uiMessageClicked=!1;var l=-1,n=null,k=null,d=!1,g=null,m=!1,x=!1,p=!1;this.init=
function(){this.state=new GameState(this);this.state.restore(this.onScenarioLoadFinished.bind(this,null,!0),this.newScenario.bind(this,"failRestore"))};this.processTurn=function(){if(game.gameStarted&&!game.gameEnded)if(null!==g&&d&&game.uiMessageClicked)game.newScenario(g.scenario,g.intro);else{var a=game.scenario.map.currentPlayer;a&&a.type!=playerType.aiLocal&&a.type!=playerType.aiScripted||!game.waitUIAnimation&&game.uiMessageClicked&&game.processAIActions()}};this.startTurn=function(){};this.processAIActions=
function(){var a=this.scenario.map.currentPlayer.handler.getAction();b(this,a)||(UIBuilder.showAIStatus(!1),game.waitUIAnimation=!0,game.endTurn(),setTimeout(function(){game.gameEnded||game.ui.uiEndTurnInfo()},2500))};this.endTurn=function(){var a=this.scenario.map.currentPlayer.side;this.waitUIAnimation=!1;this.scenario.endTurn();this.scenario.checkDefeat(a,l)?null!==this.campaign?this.continueCampaign("lose",endGameType.noTurnsLeft):this.gameEnded=!0:(this.state.save(),null!==this.campaign&&game.state.saveCampaign(),
this.setCurrentSide(),this.deployReinforcements(this.scenario.map.turn,this.scenario.map.currentPlayer.id))};this.loop=setInterval(this.processTurn,1E3);this.setupGameState=function(){k=null;a(this);l=f(this.scenario.map.getPlayers());this.setCurrentSide();this.gameStarted=!0;d=this.gameEnded=!1;null!==this.campaign&&this.state.saveCampaign();this.state.save();this.ui.setNewScenario()};this.newScenario=function(a,b){if("failRestore"===a){for(var d=0;d<uiSettings.isAI.length;d++)uiSettings.isAI[d]=
Game.defaultScenarioAI[d];a=Game.defaultScenario}this.cleanup();this.scenario=new Scenario(a);this.scenario.load(this.onScenarioLoadFinished.bind(this,b,!1))};this.onScenarioLoadFinished=function(b,g){if(!this.scenario.isLoaded)return UIBuilder.messageDynamic("Error","Error Loading scenario "+this.scenario.file),game.gameEnded=!0,!1;defined(b)&&this.scenario.setDescription(b);a(this);var k=this.scenario.map.getPlayers();l=f(k);this.setCurrentSide();this.waitUIAnimation=!1;this.gameStarted=!0;d=this.gameEnded=
!1;if(null!==this.campaign)p&&(n.prestige=this.campaign.startprestige,n.initDossier(),this.scenario.map.buildCoreUnitList(n)),m&&this.scenario.map.removeNonCampaignUnits(n),x&&(k=this.scenario.getRandomPrototype(n.country+1),"undefined"!==typeof k&&0<k&&(n.acquireUnit(k,0),x=!1,UIBuilder.showPrototypeAwardMessage(k))),this.state.saveCampaign();else if(this.scenario.showStatistics(),!g&&"tutorial.xml"!==this.scenario.file)for(var y=0;y<k.length;y++){var I=k[y];I.prestige=this.scenario.getBalancedPrestige(I.side)}this.state.save();
this.ui?this.ui.setNewScenario():(this.ui=new UI(this),this.ui.mainMenuButton("options"))};this.newCampaign=function(a,b){this.campaign=new Campaign(a,b,this.onCampaignLoadFinished.bind(this))};this.onCampaignLoadFinished=function(){k=null;m=!1;p=!0;var a=this.campaign.getCurrentScenario();this.newScenario(a.scenario,a.intro)};this.continueCampaign=function(a,b){n.prestige+=this.campaign.getOutcomePrestige(a);n.addOutcomeToDossier(a,this.scenario.name);OSGlue.reportScore(n.score);n.setPlayerToHQ();
k.supportCountries=[];k.prestigePerTurn=[];k.copy(n);m=!0;p=!1;var f=this.campaign.getOutcomeText(a);g=this.campaign.loadNextScenario(a);null==g?("lose"==a&&(f=endGameLossText[b]+f),UIBuilder.showCampaignEnd(a,f,function(){game.ui.mainMenuButton("options")}),this.gameEnded=!0,this.gameStarted=!1,"lose"!=a&&OSGlue.reportAchievement(this.campaign.file)):(UIBuilder.message(outcomeNames[a],f),d=!0,"briliant"==a&&(x=!0))};this.getCampaignPlayer=function(){return null!==this.campaign?n:null};this.setCurrentSide=
function(){this.spotSide=2==l?this.scenario.map.currentPlayer.side:l};this.deployReinforcements=function(a,b){var d=!1,f=this.scenario.getReinforcements(a,b);if(0>=f.length)return!1;for(var g=0;g<f.length;g++){var k=null;if(null!==(k=this.scenario.map.deployReinforcement(f[g].unit,f[g].row,f[g].col))&&(d=!0,CombatLog.addReinforcement(f[g].unit),this.scenario.removeReinforcement(f[g].turn,f[g].id),this.scenario.map.map[k.row][k.col].isSpotted(this.spotSide))){var l=this.scenario.map.getPlayer(b).side,
m=!1;this.spotSide==l&&(m=!0);this.ui.showAlert(k.row,k.col,"Reinforced!",m)}}d&&game.ui.handleReinforcementDeployment();return!0};this.cleanup=function(){this.state.clear();this.scenario&&null!==this.scenario.map&&(this.scenario.map.cleanup(),delete this.scenario.map,this.scenario.map=null);delete this.scenario;this.scenario=null}}Game.defaultScenario="tutorial.xml";Game.defaultScenarioAI=[0,1,0,0];function gameStart(){game.init()}window.addEventListener("load",gameStart);var OSGlue=function(a){a.ios=function(){this.diskloadHTML="Load from Disk";this.diskloadEvent=function(a,f){a.addEventListener("click",f,!1)};this.diskload=function(){window.location="openpanzer://loadfromdisk"};this.disksave=function(a){window.location="openpanzer://savetodisk/"+a};this.reportScore=function(a){};this.reportAchievement=function(a){};this.canvasErrorMsg="<b>Couldn't create game surface.</b> <br/>This usually means that your device doesn't allow game surface to be created with dimensions over a certain limit (iPhone 3GS/iPod Touch 4).<br/><br/>You can play smaller scenarios like Huertgen Forest or Bizerte from New Scenario in Main Menu."};
a.generic=function(){this.diskloadHTML="Load from Disk <input id='diskloadfile' type='file'/>";this.diskloadEvent=function(a,f){a.addEventListener("change",f,!1)};this.diskload=function(a,f){game.state.restoreFromFile($("diskloadfile").files[0],a,f);$("diskloadfile").value=""};this.disksave=function(a){$("savedata").download=a;$("savedata").href="data:application/force-download,"+encodeURIComponent(game.state.exportGameState());$("savedata").click();$("disksaveupdate").innerHTML=a};this.reportScore=
function(a){};this.reportAchievement=function(a){};this.canvasErrorMsg="Couldn't load map image !"};return"ios"==NATIVE_PLATFORM||"android"==NATIVE_PLATFORM?new a.ios:new a.generic}(OSGlue||{});var Leaders=function(a){a.unitClassLeaders={};a.description=[];a.LEADER_CHANCE_THRESHOLD=8;a.unitClassLeaders[unitClass.none]=[];a.unitClassLeaders[unitClass.infantry]=[leaderType.tenaciousDefense,leaderType.aggressiveAttack,leaderType.aggressiveManeuver,leaderType.battlefieldIntelligence,leaderType.determinedDefense,leaderType.ferociousDefense,leaderType.firstStrike,leaderType.infiltrationTactics,leaderType.liberator];a.unitClassLeaders[unitClass.tank]=[leaderType.aggressiveTankManeuver,leaderType.aggressiveAttack,
leaderType.aggressiveManeuver,leaderType.battlefieldIntelligence,leaderType.determinedDefense,leaderType.firstStrike,leaderType.infiltrationTactics,leaderType.liberator];a.unitClassLeaders[unitClass.recon]=[leaderType.eliteReconVeteran,leaderType.aggressiveAttack,leaderType.aggressiveManeuver,leaderType.battlefieldIntelligence,leaderType.determinedDefense,leaderType.firstStrike,leaderType.infiltrationTactics,leaderType.liberator];a.unitClassLeaders[unitClass.antiTank]=[leaderType.tankKiller,leaderType.aggressiveAttack,
leaderType.aggressiveManeuver,leaderType.battlefieldIntelligence,leaderType.determinedDefense,leaderType.ferociousDefense,leaderType.firstStrike,leaderType.infiltrationTactics,leaderType.liberator];a.unitClassLeaders[unitClass.flak]=[];a.unitClassLeaders[unitClass.fortification]=[];a.unitClassLeaders[unitClass.groundTransport]=[];a.unitClassLeaders[unitClass.artillery]=[leaderType.marksman,leaderType.aggressiveAttack,leaderType.aggressiveManeuver,leaderType.battlefieldIntelligence,leaderType.determinedDefense,
leaderType.fireDiscipline,leaderType.infiltrationTactics];a.unitClassLeaders[unitClass.airDefence]=[leaderType.mechanizedVeteran,leaderType.aggressiveAttack,leaderType.aggressiveManeuver,leaderType.determinedDefense,leaderType.fireDiscipline,leaderType.infiltrationTactics];a.unitClassLeaders[unitClass.fighter]=[leaderType.skilledInterceptor,leaderType.aggressiveAttack,leaderType.aggressiveManeuver,leaderType.battlefieldIntelligence,leaderType.determinedDefense,leaderType.firstStrike];a.unitClassLeaders[unitClass.tacticalBomber]=
[leaderType.skilledAssault,leaderType.aggressiveAttack,leaderType.aggressiveManeuver,leaderType.determinedDefense,leaderType.fireDiscipline,leaderType.firstStrike];a.unitClassLeaders[unitClass.levelBomber]=[];a.unitClassLeaders[unitClass.airTransport]=[];a.unitClassLeaders[unitClass.submarine]=[];a.unitClassLeaders[unitClass.destroyer]=[];a.unitClassLeaders[unitClass.battleship]=[];a.unitClassLeaders[unitClass.carrier]=[];a.unitClassLeaders[unitClass.navalTransport]=[];a.unitClassLeaders[unitClass.battleCruiser]=
[];a.unitClassLeaders[unitClass.cruiser]=[];a.unitClassLeaders[unitClass.lightCruiser]=[];a.description[leaderType.mechanizedVeteran]=["Mechanized Veteran","Air Defence unit may move and fire in the same turn."];a.description[leaderType.tankKiller]=["Tank Killer","Anti-Tank unit will not receive a penalty for movement into combat."];a.description[leaderType.marksman]=["Marksman","The artillery unit attack range is increased by one hex."];a.description[leaderType.skilledInterceptor]=["Skilled Interceptor",
"Fighter unit can intercept multiple enemy fighters in the defensive phase."];a.description[leaderType.tenaciousDefense]=["Tenacious Defense","The infantry unit ground defense factor is increased by 4."];a.description[leaderType.eliteReconVeteran]=["Elite Recon Veteran","Recon unit spotting range is increased by two hexes."];a.description[leaderType.skilledAssault]=["Skilled Assault","The tactical bomber cannot be surprised (out of the sun) while moving."];a.description[leaderType.aggressiveTankManeuver]=
["Aggressive Tank Maneuver","Tank movement factor is increased by 1."];a.description[leaderType.aggressiveAttack]=["Aggressive Attack","Each of the unit attack values is increased by 2."];a.description[leaderType.aggressiveManeuver]=["Aggressive Maneuver","The unit movement factor is increased by 1."];a.description[leaderType.allWeatherCombat]=["All Weather Combat","The air unit is not affected by weather conditions. Note: This can only be awarded air units."];a.description[leaderType.alpineTraining]=
["Alpine Training","When moving the unit treats forest and mountain hexes as clear terrain."];a.description[leaderType.battlefieldIntelligence]=["Battlefield Intelligence","The unit cannot be surprised."];a.description[leaderType.bridging]=["Bridging","When moving the unit treats passable river hexes as rough terrain."];a.description[leaderType.combatSupport]=["Combat Support","The unit provides both Resilience and Skilled Ground Attack abilities to all adjoining units during combat phases. Will aid inflicting losses and save from loses by 2 to 3 points each battle."];
a.description[leaderType.determinedDefense]=["Determined Defense","Each of the unit defense factors is increased by 2."];a.description[leaderType.devastatingFire]=["Devastating Fire","The unit may fire twice in a turn."];a.description[leaderType.ferociousDefense]=["Ferocious Defense","The unit entrenchment cannot be ignored by enemy units."];a.description[leaderType.fireDiscipline]=["Fire Discipline","The unit will expend only one-half of an ammunition point each time it attacks."];a.description[leaderType.firstStrike]=
["First Strike","The unit will fire first against an enemy unit if it wins the initiative in a combat round."];a.description[leaderType.forestCamouflage]=["Forest Camouflage","If in a forest hex the unit cannot be spotted by enemy units unless they move adjacent to it."];a.description[leaderType.infiltrationTactics]=["Infiltration Tactics","The unit ignores enemy unit entrenchment when calculating combat results."];a.description[leaderType.influence]=["Influence","Allows the unit to upgrade to better equipment at reduced prestige point cost."];
a.description[leaderType.liberator]=["Liberator","You receive double the normal number of prestige points for all objective and victory hexes captured by the unit."];a.description[leaderType.overwatch]=["Overwatch","The unit will fire at any enemy unit that moves within its range. The enemy unit is automatically surprised, allowing your unit to fire first and at the enemy\u2019s close assault, rather than its ground defense, factor."];a.description[leaderType.overwhelmingAttack]=["Overwhelming Attack",
"When attacking the unit will have an indeterminate number of the suppression points it would otherwise inflict converted to kills."];a.description[leaderType.reconMovement]=["Recon Movement","The unit is permitted phased movement, just like reconnaissance units."];a.description[leaderType.resilience]=["Resilience","The unit will suffer 1 to 3 fewer step casualties than normal units when attacked."];a.description[leaderType.shockTactics]=["Shock Tactics","Any suppression which the unit inflicts on an enemy unit will last the entire player turn, not just the specific combat round."];
a.description[leaderType.skilledGroundAttack]=["Skilled Ground Attack","The unit will inflict 1 to 3 more step casualties than normal units when attacking."];a.description[leaderType.skilledReconnaissance]=["Skilled Reconnaissance","The unit spotting range is increased by one hex."];a.description[leaderType.streetFighter]=["Street Fighter","The unit ignores an enemy unit city entrenchment when calculating combat results."];a.description[leaderType.superiorManeuver]=["Superior Maneuver","The unit may bypass enemy unit zones of control."];
a.generateLeader=function(b){if(!b)return-1;b=b.unitData().uclass;var f=a.unitClassLeaders[b].length;if(2>f)return-1;f=Math.floor(Math.random()*(f-1-2))+1;return a.unitClassLeaders[b][f]};a.generateLeaderWithChance=function(b,f){if(!b||-1!=b.leader)return-1;var l=b.experience/100>>0,n=(b.experience-f)/100>>0,k=Math.floor(Math.random()*(10-l+1))+l;return b.experience>=UNIT_MAX_EXPERIENCE?a.generateLeader(b):0>=l-n?-1:k>a.LEADER_CHANCE_THRESHOLD?a.generateLeader(b):-1};a.getUnitClassLeader=function(b){return b&&
-1!=b.leader?a.unitClassLeaders[b.unitData().uclass][0]:-1};a.unitHasLeader=function(b,f){if(!b||-1==b.leader)return!1;if(b.leader==f)return!0;var l=a.getUnitClassLeader(b);return f==l?!0:!1};a.getUnitLeaderDescriptions=function(b){if(!b||-1==b.leader)return[];var f=[],l=a.getUnitClassLeader(b);f.push(a.description[b.leader]);f.push(a.description[l]);return f};return a}(Leaders||{});
